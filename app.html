<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DMS Portal</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg: #f8fafc;
        --card: #ffffff;
        --accent: #3b82f6;
        --accent-light: #dbeafe;
        --accent-dark: #1d4ed8;
        --text: #1e293b;
        --text-muted: #64748b;
        --text-light: #94a3b8;
        --sidebar: #ffffff;
        --danger: #ef4444;
        --success: #10b981;
        --warning: #f59e0b;
        --border: #e2e8f0;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --radius: 12px;
        --transition: all 0.2s ease-in-out;
      }

      .dark-mode {
        --bg: #0f172a;
        --card: #1e293b;
        --accent: #60a5fa;
        --accent-light: #1e3a8a;
        --accent-dark: #93c5fd;
        --text: #f1f5f9;
        --text-muted: #cbd5e1;
        --text-light: #94a3b8;
        --sidebar: #1e293b;
        --danger: #f87171;
        --success: #34d399;
        --warning: #fbbf24;
        --border: #334155;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2),
          0 2px 4px -1px rgba(0, 0, 0, 0.1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Inter", ui-sans-serif, system-ui, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        display: flex;
        flex-direction: column;
        transition: var(--transition);
      }

      /* ---------- TOPBAR ---------- */
      .topbar {
        height: 72px;
        background: var(--card);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 28px;
        border-bottom: 1px solid var(--border);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        z-index: 40;
        position: sticky;
        top: 0;
        transition: var(--transition);
        backdrop-filter: blur(10px);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 18px;
        flex: 0 0 auto;
      }

      .brand h1 {
        font-size: 22px;
        font-weight: 700;
        margin: 0;
        line-height: 1.2;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -0.3px;
      }

      .brand .small-muted {
        font-size: 11px;
        margin-top: 2px;
        opacity: 0.7;
      }

      .logo {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 19px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
        transition: var(--transition);
        flex-shrink: 0;
      }

      .logo:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
      }

      .top-actions {
        display: flex;
        align-items: center;
        gap: 20px;
        flex: 1;
        justify-content: flex-end;
        max-width: 800px;
      }

      .avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        transition: var(--transition);
        flex-shrink: 0;
        cursor: pointer;
      }

      .avatar:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .search-wrapper {
        position: relative;
        flex: 1;
        max-width: 400px;
        min-width: 200px;
      }

      .search-wrapper i {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 14px;
        pointer-events: none;
        transition: var(--transition);
      }

      .search-wrapper:focus-within i {
        color: var(--accent);
      }

      .search {
        padding: 12px 16px 12px 44px;
        border-radius: 12px;
        border: 1.5px solid var(--border);
        background: var(--bg);
        color: var(--text);
        width: 100%;
        font-size: 14px;
        transition: var(--transition);
        font-weight: 400;
      }

      .search::placeholder {
        color: var(--text-muted);
        font-weight: 400;
      }

      .search:focus {
        outline: none;
        border-color: var(--accent);
        background: var(--card);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      }

      .search:hover:not(:focus) {
        border-color: var(--accent-light);
        background: var(--card);
      }

      .theme-toggle {
        background: var(--bg);
        border: 1.5px solid var(--border);
        font-size: 18px;
        color: var(--text-muted);
        cursor: pointer;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        flex-shrink: 0;
      }

      .theme-toggle:hover {
        background: var(--accent-light);
        color: var(--accent);
        border-color: var(--accent);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
      }

      .top-user-info {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 6px 12px 6px 6px;
        border-radius: 12px;
        transition: var(--transition);
        cursor: pointer;
        flex-shrink: 0;
      }

      .top-user-info:hover {
        background: var(--bg);
      }

      .top-user-info .user-details {
        text-align: right;
        min-width: 0;
      }

      .top-user-info .user-details div:first-child {
        font-weight: 600;
        font-size: 14px;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
      }

      .top-user-info .user-details div:last-child {
        font-size: 12px;
        margin-top: 2px;
      }

      @media (max-width: 768px) {
        .topbar {
          padding: 0 16px;
          height: 64px;
        }

        .brand {
          gap: 12px;
        }

        .brand h1 {
          font-size: 18px;
        }

        .brand .small-muted {
          display: none;
        }

        .logo {
          width: 40px;
          height: 40px;
          font-size: 17px;
        }

        .mobile-toggle {
          width: 40px;
          height: 40px;
        }

        .top-actions {
          gap: 12px;
        }

        .search-wrapper {
          max-width: 180px;
          min-width: 120px;
        }

        .top-user-info {
          gap: 10px;
          padding: 4px 8px 4px 4px;
        }

        .top-user-info .user-details {
          display: none;
        }

        .avatar {
          width: 40px;
          height: 40px;
        }

        .theme-toggle {
          width: 40px;
          height: 40px;
        }
      }

      /* Enhanced File Input Styling */
      .file-input-wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
        margin-bottom: 8px;
      }

      .file-input-wrapper input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        z-index: 2;
      }

      .file-input-custom {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 16px 20px;
        background: var(--accent-light);
        border: 2px dashed var(--accent);
        border-radius: 12px;
        color: var(--accent);
        font-weight: 600;
        font-size: 14px;
        transition: var(--transition);
        cursor: pointer;
        text-align: center;
        width: 100%;
        box-sizing: border-box;
      }

      .file-input-custom:hover {
        background: var(--accent);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .file-input-custom:active {
        transform: translateY(0);
      }

      .file-input-custom i {
        font-size: 18px;
      }

      .file-input-info {
        font-size: 13px;
        color: var(--text-muted);
        text-align: center;
        margin-top: 8px;
        line-height: 1.4;
      }

      .file-input-selected {
        margin-top: 12px;
        padding: 12px;
        background: var(--bg);
        border-radius: 8px;
        border-left: 4px solid var(--success);
      }

      .file-input-selected-title {
        font-weight: 600;
        color: var(--success);
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
      }

      .file-input-selected-list {
        font-size: 13px;
        color: var(--text-muted);
        max-height: 120px;
        overflow-y: auto;
      }

      .file-input-selected-list div {
        padding: 4px 0;
        border-bottom: 1px solid var(--border);
      }

      .file-input-selected-list div:last-child {
        border-bottom: none;
      }

      /* Dark mode adjustments */
      .dark-mode .file-input-custom {
        background: var(--accent-light);
        border-color: var(--accent);
      }

      .dark-mode .file-input-custom:hover {
        background: var(--accent);
      }

      .dark-mode .file-input-selected {
        background: var(--card);
      }

      /* Search highlight styles */
      .search-highlight {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.15),
          rgba(59, 130, 246, 0.25)
        );
        border: 2px solid var(--accent);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1),
          0 4px 12px rgba(59, 130, 246, 0.2);
        animation: searchPulse 0.6s ease-out;
      }

      @keyframes searchPulse {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
        }
      }

      .search-highlight-row {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1),
          rgba(59, 130, 246, 0.15)
        );
        border-left: 4px solid var(--accent);
        animation: searchPulseRow 0.6s ease-out;
      }

      @keyframes searchPulseRow {
        0% {
          background: rgba(59, 130, 246, 0.2);
        }
        100% {
          background: linear-gradient(
            135deg,
            rgba(59, 130, 246, 0.1),
            rgba(59, 130, 246, 0.15)
          );
        }
      }

      /* ---------- LAYOUT ---------- */
      .container {
        display: flex;
        flex: 1;
        min-height: 0;
      }

      .sidebar {
        width: 260px;
        background: var(--sidebar);
        border-right: 1px solid var(--border);
        padding-top: 24px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: transform 0.3s ease, width 0.3s ease;
        overflow-y: auto;
      }

      .nav-item {
        padding: 14px 20px;
        cursor: pointer;
        color: var(--text-muted);
        display: flex;
        gap: 12px;
        align-items: center;
        white-space: nowrap;
        overflow: hidden;
        border-radius: 10px;
        margin: 0 12px;
        transition: var(--transition);
        font-weight: 500;
      }

      .nav-item:hover {
        background: var(--accent-light);
        color: var(--accent);
      }

      .nav-item.active {
        background: var(--accent-light);
        color: var(--accent);
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
      }

      .nav-item i {
        font-size: 18px;
        width: 20px;
        text-align: center;
      }

      .main {
        flex: 1;
        padding: 24px;
        overflow: auto;
        transition: margin-left 0.3s ease;
        background: var(--bg);
      }

      .card {
        background: var(--card);
        padding: 20px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        transition: var(--transition);
        color: var(--text);
      }

      .card:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      .row {
        display: flex;
        gap: 16px;
        align-items: center;
      }

      .col {
        flex: 1;
      }

      h2 {
        margin: 0 0 16px;
        font-weight: 700;
        font-size: 24px;
        color: var(--text);
      }

      h3 {
        font-weight: 600;
        font-size: 18px;
        margin-bottom: 16px;
        color: var(--text);
      }

      button {
        background: var(--accent);
        color: #fff;
        border: 0;
        padding: 10px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      button:hover {
        background: var(--accent-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
      }

      .btn-secondary {
        background: var(--card);
        color: var(--text-muted);
        border: 1px solid var(--border);
        align-content: center;
      }

      .btn-secondary:hover {
        background: var(--bg);
        color: var(--accent);
        border-color: var(--accent);
        transform: translateY(-1px);
      }

      .btn-danger {
        background: var(--danger);
      }

      .btn-danger:hover {
        background: #dc2626;
        box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
      }

      .muted {
        color: var(--text-muted);
        font-size: 14px;
      }

      input,
      select,
      textarea {
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        font-size: 14px;
        transition: var(--transition);
        width: 100%;
      }

      input::placeholder,
      textarea::placeholder {
        color: var(--text-muted);
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
      }

      .doc {
        padding: 16px;
        border-radius: 10px;
        background: var(--card);
        border: 1px solid var(--border);
        display: flex;
        gap: 12px;
        align-items: center;
        transition: var(--transition);
        cursor: pointer;
        color: var(--text);
      }

      .doc:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-color: var(--accent);
      }

      .doc .icon {
        font-size: 24px;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--accent-light);
        color: var(--accent);
      }

      .small {
        font-size: 13px;
        color: var(--text-muted);
      }

      .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        color: var(--text);
      }

      .table th,
      .table td {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
        text-align: left;
        color: var(--text);
      }

      .table th {
        font-weight: 600;
        color: var(--text-muted);
        background: var(--bg);
      }

      .badge {
        background: var(--accent-light);
        color: var(--accent);
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .badge-success {
        background: #d1fae5;
        color: var(--success);
      }

      .badge-warning {
        background: #fef3c7;
        color: var(--warning);
      }

      .badge-danger {
        background: #fee2e2;
        color: var(--danger);
      }

      .dark-mode .badge-success {
        background: #064e3b;
        color: #34d399;
      }

      .dark-mode .badge-warning {
        background: #78350f;
        color: #fbbf24;
      }

      .dark-mode .badge-danger {
        background: #7f1d1d;
        color: #f87171;
      }

      .danger {
        background: #fef2f2;
        color: var(--danger);
        border: 1px solid #fecaca;
        padding: 8px 12px;
        border-radius: 8px;
      }

      .modal-back {
        position: fixed;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
        backdrop-filter: blur(4px);
        padding: 20px; /* ensure modal doesn't touch viewport edges */
      }

      .modal {
        width: 640px;
        max-width: 96%;
        max-height: 90vh;
        overflow-y: auto;
        background: var(--card);
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        color: var(--text);
        box-sizing: border-box;
      }

      .modal-large {
        width: 900px;
        max-width: 96%;
      }

      .modal-fullscreen {
        width: 95vw;
        max-width: 95vw;
        height: 90vh;
        max-height: 90vh;
      }

      .modal h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: var(--text);
      }

      .flex-between {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .small-muted {
        font-size: 13px;
        color: var(--text-light);
      }

      .icon-btn {
        background: var(--bg);
        border: 1px solid var(--border);
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        color: var(--text-muted);
      }

      .icon-btn:hover {
        background: var(--accent-light);
        color: var(--accent);
        border-color: var(--accent);
        transform: translateY(-1px);
      }

      .stat-card {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 20px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--text);
      }

      .stat-label {
        font-size: 14px;
        color: var(--text-muted);
      }

      .stat-trend {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .trend-up {
        color: var(--success);
      }

      .trend-down {
        color: var(--danger);
      }

      .mobile-toggle {
        display: flex;
        background: var(--bg);
        border: 1.5px solid var(--border);
        font-size: 20px;
        cursor: pointer;
        color: var(--text-muted);
        transition: var(--transition);
        z-index: 100;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .mobile-toggle:hover {
        background: var(--accent-light);
        color: var(--accent);
        border-color: var(--accent);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 90;
        backdrop-filter: blur(2px);
      }

      .overlay.active {
        opacity: 1;
        pointer-events: all;
      }

      .sidebar.collapsed {
        width: 80px;
      }

      .sidebar.collapsed .nav-item {
        padding: 14px;
        justify-content: center;
      }

      .sidebar.collapsed .nav-item span {
        display: none;
      }

      .sidebar.collapsed .nav-item i {
        margin-right: 0;
      }

      .sidebar.collapsed .sidebar-user-info {
        display: none;
      }

      .sidebar.collapsed .logout-btn {
        display: none;
      }

      @media (max-width: 991px) {
        .sidebar {
          position: fixed;
          top: 70px;
          left: 0;
          height: calc(100% - 70px);
          transform: translateX(-100%);
          z-index: 100;
        }

        .sidebar.active {
          transform: translateX(0);
        }

        .main {
          margin-left: 0 !important;
          width: 100%;
        }

        .search {
          min-width: 180px;
        }
      }
      /* Enhanced checkbox styling */
      .checkbox-option:hover {
        background: var(--accent-light);
        border-color: var(--accent);
      }

      .checkbox-option input[type="checkbox"] {
        accent-color: var(--accent);
      }

      .checkbox-option input[type="checkbox"]:checked + label {
        color: var(--accent);
      }

      /* Desktop behavior */
      @media (min-width: 992px) {
        .overlay {
          display: none !important;
        }
      }

      /* Form elements */
      .form-row {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 16px;
      }

      .form-row label {
        font-weight: 500;
        font-size: 14px;
        color: var(--text-muted);
      }

      .activity-item {
        display: flex;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
        color: var(--text);
      }

      .activity-item:last-child {
        border-bottom: none;
      }

      .activity-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--accent-light);
        color: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .activity-content {
        flex: 1;
        color: var(--text);
      }

      .activity-time {
        font-size: 12px;
        color: var(--text-light);
      }

      .workspace-card {
        padding: 20px;
        border-radius: 12px;
        background: var(--card);
        border: 1px solid var(--border);
        transition: var(--transition);
        cursor: pointer;
        color: var(--text);
      }

      .workspace-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-color: var(--accent);
      }

      .workspace-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }

      .workspace-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
      }

      .workspace-meta {
        display: flex;
        gap: 12px;
        margin-top: 12px;
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--text-muted);
      }

      /* ---------- ADAPTIVE FILE CARDS ---------- */
      .doc-adaptive {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        border-radius: 10px;
        background: var(--card);
        border: 1px solid var(--border);
        transition: var(--transition);
        cursor: pointer;
        color: var(--text);
      }

      .doc-adaptive:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-color: var(--accent);
      }

      .doc-header {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }

      .doc-icon {
        font-size: 24px;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--accent-light);
        color: var(--accent);
        flex-shrink: 0;
      }

      .doc-info {
        flex: 1;
        min-width: 0;
      }

      .doc-name {
        font-weight: 600;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        padding: 2px 4px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }

      .doc-name:hover {
        background-color: var(--bg-hover);
      }

      .doc-name.editing {
        background-color: var(--bg);
        border: 2px solid var(--accent);
        outline: none;
        cursor: text;
      }

      .doc-name-input {
        font-weight: 600;
        color: var(--text);
        background: var(--bg);
        border: 2px solid var(--accent);
        border-radius: 4px;
        padding: 2px 6px;
        width: 100%;
        font-size: inherit;
        font-family: inherit;
        outline: none;
      }

      .doc-checkbox {
        position: absolute;
        top: 8px;
        left: 8px;
        width: 20px;
        height: 20px;
        cursor: pointer;
        z-index: 10;
        accent-color: var(--accent);
      }

      .doc-adaptive {
        position: relative;
      }

      .doc-adaptive:hover .doc-checkbox {
        opacity: 1;
      }

      .doc-checkbox:not(:checked) {
        opacity: 0;
        transition: opacity 0.2s;
      }

      .doc-checkbox:checked {
        opacity: 1;
      }

      .bulk-actions-bar {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg);
        border: 2px solid var(--accent);
        border-radius: 12px;
        padding: 12px 20px;
        display: none;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        z-index: 1000;
      }

      .bulk-actions-bar.visible {
        display: flex;
      }

      .bulk-actions-bar .selected-count {
        font-weight: 600;
        color: var(--accent);
        margin-right: 8px;
      }

      .bulk-actions-bar button {
        padding: 8px 16px;
        font-size: 14px;
      }

      .doc-meta {
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 4px;
      }

      .doc-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        flex-wrap: wrap;
      }

      /* ---------- MEMBER AVATAR GRID ---------- */
      .member-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }

      .member-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 12px;
        box-shadow: var(--shadow);
        position: relative;
      }

      .member-more {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--bg);
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-size: 12px;
      }

      @media (max-width: 768px) {
        .doc-actions {
          justify-content: space-between;
        }

        .doc-actions button {
          flex: 1;
          justify-content: center;
        }

        .toolbar {
          flex-direction: column;
          align-items: stretch;
        }

        .toolbar input,
        .toolbar select {
          max-width: 100%;
        }
      }

      .multi-select-container {
        position: relative;
      }

      .multi-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: var(--shadow);
        z-index: 10;
        max-height: 200px;
        overflow-y: auto;
        display: none;
      }

      .multi-select-dropdown.active {
        display: block;
      }

      .multi-select-option {
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--text);
      }

      .multi-select-option:hover {
        background: var(--accent-light);
        color: var(--accent);
      }

      .multi-select-selected {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .selected-member {
        background: var(--accent-light);
        color: var(--accent);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .remove-member {
        background: none;
        border: none;
        color: var(--accent);
        cursor: pointer;
        padding: 0;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .workspace-detail-header {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }

      .workspace-detail-back {
        margin-bottom: 20px;
      }

      .workspace-detail-main {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 24px;
      }

      .workspace-detail-info {
        display: flex;
        gap: 20px;
        align-items: stretch;
        flex: 1;
        min-width: 0;
      }

      .workspace-detail-icon {
        width: 72px;
        height: 72px;
        border-radius: 16px;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 28px;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
      }

      .workspace-detail-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 72px;
        height: 100%;
      }

      .workspace-detail-content h2 {
        margin: 0 0 8px 0;
        font-size: 24px;
        font-weight: 700;
        color: var(--text);
        line-height: 1.2;
      }

      .workspace-detail-content .small-muted {
        margin-bottom: 20px;
        font-size: 14px;
        line-height: 1.5;
      }

      .workspace-detail-bottom {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .workspace-detail-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .workspace-detail-actions button {
        width: 48px;
        height: 48px;
        padding: 0;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 500;
        gap: 0;
        flex-shrink: 0;
      }

      .workspace-detail-actions button i {
        margin: 0;
      }

      @media (max-width: 768px) {
        .workspace-detail-header {
          padding: 16px;
        }

        .workspace-detail-main {
          flex-direction: column;
          gap: 20px;
        }

        .workspace-detail-info {
          flex-direction: column;
          gap: 16px;
        }

        .workspace-detail-icon {
          width: 56px;
          height: 56px;
          font-size: 24px;
        }

        .workspace-detail-content {
          min-height: auto;
        }

        .workspace-detail-content h2 {
          font-size: 20px;
        }

        .workspace-detail-actions {
          flex-direction: row;
          justify-content: flex-start;
          width: 100%;
        }

        .workspace-detail-actions button {
          flex: 1;
          max-width: 120px;
        }
      }

      /* ---------- CATEGORY ---------- */
      .category-header:hover {
        background: var(--accent-light);
        border-radius: 8px;
        padding: 8px;
        margin: -8px;
        transition: var(--transition);
      }

      .category-files .doc-adaptive {
        padding: 12px;
        gap: 8px;
      }

      .category-files .doc-header {
        gap: 8px;
      }

      .category-files .doc-icon {
        width: 32px;
        height: 32px;
        font-size: 18px;
      }

      .category-files .doc-name {
        font-size: 14px;
      }

      .category-files .doc-meta {
        font-size: 12px;
      }

      .category-files .doc-actions {
        gap: 6px;
      }

      .category-files .icon-btn {
        padding: 6px;
        width: 32px;
        height: 32px;
      }

      .category-unclassified {
        background: var(--border);
        border-color: var(--text-muted);
      }

      .dark-mode .category-unclassified {
        background: #222b37;
        border-color: rgb(39, 46, 57);
      }

      .category-unclassified .category-header:hover {
        background: var(--text-muted);
        color: var(--card);
      }

      .dark-mode .category-unclassified .category-header:hover {
        background: #475569;
      }

      /* ---------- FILE PREVIEW MODAL ---------- */
      .file-preview-modal {
        width: 100%;
        max-width: 900px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        padding: 20px;
        background: var(--card);
        border-radius: 10px;
      }

      .file-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }

      .file-preview-content {
        flex: 1;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-height: 60vh;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        background: var(--bg);
      }

      .file-preview-content iframe {
        width: 100%;
        height: 500px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: white;
      }

      .file-preview-content img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .rich-preview {
        max-height: 520px;
        overflow: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        background: var(--card);
      }

      .rich-preview .preview-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 16px;
      }

      .rich-preview .preview-table th,
      .rich-preview .preview-table td {
        border: 1px solid var(--border);
        padding: 8px;
        font-size: 13px;
        text-align: left;
      }

      .rich-preview h4 {
        margin: 16px 0 8px;
        font-size: 15px;
      }

      .file-preview-main {
        display: flex;
        gap: 20px;
      }

      .file-preview-icon {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        background: var(--accent-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        color: var(--accent);
        flex-shrink: 0;
      }

      .file-preview-details {
        flex: 1;
      }

      .file-preview-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 20px;
      }

      .meta-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .meta-label {
        font-size: 12px;
        color: var(--text-muted);
        font-weight: 500;
      }

      .meta-value {
        font-size: 14px;
        color: var(--text);
      }

      .file-preview-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        justify-content: flex-end;
        width: 100%;
        padding-top: 8px;
        flex-wrap: wrap;
      }

      .back-button {
        background: var(--card);
        color: var(--text-muted);
        border: 1px solid var(--border);
        padding: 10px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .back-button:hover {
        background: var(--accent-light);
        color: var(--accent);
        border-color: var(--accent);
      }

      /* ---------- USER SETTINGS MODAL ---------- */

      .user-settings-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
      }

      .user-settings-content {
        width: 480px;
        max-width: 90%;
        max-height: 90vh;
        background: var(--card);
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .user-settings-header {
        padding: 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .user-settings-body {
        padding: 24px;
        flex: 1;
        overflow-y: auto;
      }

      .user-settings-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      .profile-image-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border);
      }

      .profile-image-container {
        position: relative;
        width: 100px;
        height: 100px;
        margin-bottom: 16px;
      }

      .profile-image {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 32px;
        cursor: pointer;
        transition: var(--transition);
      }

      .profile-image:hover {
        transform: scale(1.05);
      }

      .profile-image-upload {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 32px;
        height: 32px;
        background: var(--accent);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        border: 2px solid var(--card);
      }

      .profile-image-upload input {
        display: none;
      }

      .profile-image-remove {
        position: absolute;
        top: -4px;
        right: -4px;
        width: 24px;
        height: 24px;
        background: var(--danger);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        border: 2px solid var(--card);
        font-size: 12px;
        opacity: 0;
        transition: var(--transition);
        z-index: 10;
      }

      .profile-image-container:hover .profile-image-remove {
        opacity: 1;
        transform: scale(1.1);
      }

      .profile-image-remove:hover {
        background: #dc2626;
        transform: scale(1.2);
      }

      .form-section {
        margin-bottom: 24px;
      }

      .form-section:last-child {
        margin-bottom: 0;
      }

      .form-section h4 {
        margin-bottom: 16px;
        color: var(--text);
        font-weight: 600;
      }

      .password-fields {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .current-password-field {
        margin-bottom: 8px;
      }
    </style>

    <!-- Report export libraries -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  </head>
  <body>
    <div class="topbar">
      <div class="brand">
        <button class="mobile-toggle" id="menuToggle" title="Toggle Menu">
          <i class="fa-solid fa-bars"></i>
        </button>

        <div class="logo">DM</div>

        <div>
          <h1>DMS</h1>
          <div class="small-muted">Document Management System</div>
        </div>
      </div>

      <div class="top-actions">
        <button class="theme-toggle" id="themeToggle" title="Toggle Theme">
          <i class="fa-solid fa-moon"></i>
        </button>
        <div class="search-wrapper">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input
            class="search"
            id="globalSearch"
            placeholder="Search files, users, workspaces..."
            oninput="onGlobalSearch(event)"
          />
        </div>
        <div id="topUser" class="top-user-info" onclick="openUserSettings()">
          <div class="avatar" id="topAvatar">JD</div>
          <div class="user-details">
            <div id="topName">Guest</div>
            <div class="small-muted" id="topRole">Visitor</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay for mobile view -->
    <div class="overlay" id="overlay"></div>

    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div
          class="sidebar-user-info"
          style="padding: 0 20px; margin-bottom: 16px"
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div class="small-muted">Signed in as</div>
            <div class="small-muted"><span id="sidebarRole">Guest</span></div>
          </div>
          <div style="margin-top: 8px; font-weight: 600" id="sidebarUser">
            Not signed
          </div>
        </div>
        <div id="nav">
          <div
            class="nav-item active"
            data-view="dashboard"
            onclick="navigate(event)"
          >
            <i class="fa-solid fa-grip"></i><span>Dashboard</span>
          </div>
          <div class="nav-item" data-view="library" onclick="navigate(event)">
            <i class="fa-solid fa-folder-open"></i><span>My Library</span>
          </div>
          <div
            class="nav-item"
            data-view="workspaces"
            onclick="navigate(event)"
          >
            <i class="fa-solid fa-layer-group"></i><span>Workspaces</span>
          </div>
          <div class="nav-item" data-view="userMgmt" onclick="navigate(event)">
            <i class="fa-solid fa-users-gear"></i><span>User Management</span>
          </div>
          <div
            class="nav-item"
            data-view="departments"
            onclick="navigate(event)"
          >
            <i class="fa-solid fa-users-rectangle"></i><span>Departments</span>
          </div>
          <div
            class="nav-item"
            data-view="categories"
            onclick="navigate(event)"
          >
            <i class="fa-solid fa-list"></i><span>Categories</span>
          </div>
          <div class="nav-item" data-view="archives" onclick="navigate(event)">
            <i class="fa-solid fa-box-archive"></i><span>Archives</span>
          </div>
          <div class="nav-item" data-view="settings" onclick="navigate(event)">
            <i class="fa-solid fa-gear"></i><span>System Settings</span>
          </div>
          <div style="flex: 1"></div>
          <div class="logout-btn" style="padding: 12px">
            <button
              class="btn-secondary"
              onclick="logout()"
              style="width: 100%; justify-content: center"
            >
              <i class="fa-solid fa-right-from-bracket"></i> Logout
            </button>
          </div>
        </div>
      </div>

      <main class="main" id="main">
        <div id="appViews" style="display: none">
          <section id="dashboard" class="view">
            <div class="flex-between" style="margin-bottom: 24px">
              <div>
                <h2>Admin Dashboard</h2>
                <div class="small-muted">
                  Overview of system activity and quick actions
                </div>
              </div>
              <div style="display: flex; gap: 12px">
                <button onclick="openAddFileModal()">
                  <i class="fa-solid fa-upload"></i> Upload File
                </button>
                <button
                  onclick="openCreateWorkspace()"
                  data-role-action="workspace-create"
                >
                  <i class="fa-solid fa-plus"></i> Create Workspace
                </button>
              </div>
            </div>

            <div
              class="grid"
              style="
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                margin-bottom: 24px;
              "
            >
              <div class="card stat-card">
                <div class="flex-between">
                  <div class="stat-value" id="statTotal">0</div>
                  <div class="badge"><i class="fa-solid fa-file"></i></div>
                </div>
                <div class="stat-label">Total Documents</div>
                <div class="stat-trend trend-up">
                  <i class="fa-solid fa-arrow-up"></i> 12% from last week
                </div>
              </div>
              <div class="card stat-card">
                <div class="flex-between">
                  <div class="stat-value" id="statShared">0</div>
                  <div class="badge">
                    <i class="fa-solid fa-share-nodes"></i>
                  </div>
                </div>
                <div class="stat-label">Shared Files</div>
                <div class="stat-trend trend-up">
                  <i class="fa-solid fa-arrow-up"></i> 5% from last week
                </div>
              </div>
              <div class="card stat-card">
                <div class="flex-between">
                  <div class="stat-value" id="statRecent">0</div>
                  <div class="badge"><i class="fa-solid fa-clock"></i></div>
                </div>
                <div class="stat-label">Recent Files</div>
                <div class="stat-trend trend-down">
                  <i class="fa-solid fa-arrow-down"></i> 3% from last week
                </div>
              </div>
              <div class="card stat-card">
                <div class="flex-between">
                  <div class="stat-value" id="statUsers">0</div>
                  <div class="badge"><i class="fa-solid fa-users"></i></div>
                </div>
                <div class="stat-label">Total Users</div>
                <div class="stat-trend trend-up">
                  <i class="fa-solid fa-arrow-up"></i> 8% from last week
                </div>
              </div>
            </div>

            <div class="card">
              <h3>Recent Activity</h3>
              <div
                id="activityFeed"
                style="min-height: 90px"
                class="small-muted"
              >
                No activity yet
              </div>
            </div>
          </section>

          <section id="library" class="view" style="display: none">
            <div class="flex-between" style="margin-bottom: 24px">
              <div>
                <h2>My Library</h2>
                <div class="small-muted">
                  Upload, organize and preview your documents
                </div>
              </div>
              <div style="display: flex; gap: 12px; align-items: center">
                <button onclick="openAddFileModal()">
                  <i class="fa-solid fa-upload"></i> Upload
                </button>
              </div>
            </div>

            <div class="toolbar">
              <select
                id="filterType"
                onchange="renderFiles()"
                style="max-width: 200px"
              >
                <option value="">All File Types</option>
                <!-- Options will be auto-populated by JavaScript -->
              </select>
              <select id="sortFiles" onchange="renderFiles()">
                <option value="new">Sort: Newest</option>
                <option value="old">Sort: Oldest</option>
                <option value="name_asc">Sort: Name (A-Z)</option>
                <option value="name_desc">Sort: Name (Z-A)</option>
              </select>
              <div style="flex: 1"></div>
              <div style="display: flex; align-items: center; gap: 8px">
                <input
                  type="checkbox"
                  id="selectAllFiles"
                  onchange="toggleSelectAllFiles()"
                  style="width: 18px; height: 18px; cursor: pointer"
                />
                <label
                  for="selectAllFiles"
                  style="cursor: pointer; user-select: none"
                  >Select All</label
                >
              </div>
            </div>

            <div id="filesGrid" class="grid"></div>
          </section>

          <section id="workspaces" class="view" style="display: none">
            <div class="flex-between" style="margin-bottom: 24px">
              <h2>Workspaces</h2>
              <button
                onclick="openCreateWorkspace()"
                data-role-action="workspace-create"
              >
                <i class="fa-solid fa-plus"></i> New Workspace
              </button>
            </div>
            <div style="margin-top: 12px" id="workspacesList"></div>
          </section>

          <section
            id="workspace-detail"
            class="view"
            style="display: none"
          ></section>

          <section id="userMgmt" class="view" style="display: none">
            <div class="flex-between" style="margin-bottom: 24px">
              <h2>User Management</h2>
              <div>
                <button onclick="openAddUser()">
                  <i class="fa-solid fa-user-plus"></i> Add User
                </button>
              </div>
            </div>
            <div class="toolbar" style="margin-bottom: 20px">
              <input
                type="text"
                id="searchUsers"
                placeholder="Search by name or email..."
                oninput="renderUsers()"
                style="max-width: 250px"
              />
              <select
                id="filterUserRole"
                onchange="renderUsers()"
                style="max-width: 180px"
              >
                <option value="">All Roles</option>
                <option value="system_admin">System Admin</option>
                <option value="department_admin">Department Admin</option>
                <option value="staff">Staff</option>
              </select>
              <select
                id="filterUserStatus"
                onchange="renderUsers()"
                style="max-width: 150px"
              >
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="archived">Archived</option>
              </select>
              <select
                id="filterUserDept"
                onchange="renderUsers()"
                style="max-width: 180px"
              >
                <option value="">All Departments</option>
              </select>
              <select
                id="sortUsers"
                onchange="renderUsers()"
                style="min-width: 180px; max-width: 200px"
              >
                <option value="id">Sort: ID (Default)</option>
                <option value="name_asc">Sort: Name A-Z</option>
                <option value="name_desc">Sort: Name Z-A</option>
              </select>
              <div style="flex: 1"></div>
              <div style="display: flex; gap: 8px; align-items: center">
                <button class="btn-secondary" onclick="openExportMenu()">
                  <i class="fa-solid fa-download"></i> Export
                </button>
              </div>
            </div>
            <div class="card" style="margin-bottom: 20px; padding: 20px">
              <div style="display: flex; gap: 32px; justify-content: center">
                <div style="text-align: center">
                  <div
                    style="
                      font-size: 32px;
                      font-weight: 600;
                      color: var(--accent);
                    "
                    id="totalUsersCount"
                  >
                    0
                  </div>
                  <div class="small-muted">Total Users</div>
                </div>
                <div style="text-align: center">
                  <div
                    style="
                      font-size: 32px;
                      font-weight: 600;
                      color: var(--success);
                    "
                    id="activeUsersCount"
                  >
                    0
                  </div>
                  <div class="small-muted">Active Users</div>
                </div>
                <div style="text-align: center">
                  <div
                    style="
                      font-size: 32px;
                      font-weight: 600;
                      color: var(--warning);
                    "
                    id="archivedUsersCount"
                  >
                    0
                  </div>
                  <div class="small-muted">Archived Users</div>
                </div>
              </div>
            </div>
            <div class="card">
              <table class="table" id="usersTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th style="text-align: center">Role</th>
                    <th style="text-align: center">Department</th>
                    <th style="text-align: center">Status</th>
                    <th style="text-align: center">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <!-- Departments -->
          <section id="departments" class="view" style="display: none">
            <div class="flex-between" style="margin-bottom: 24px">
              <h2>Departments</h2>
              <button onclick="openAddDepartment()">
                <i class="fa-solid fa-plus"></i> Add Department
              </button>
            </div>
            <div id="departmentsList" style="margin-top: 12px"></div>
          </section>

          <!-- Categories -->
          <section id="categories" class="view" style="display: none">
            <div class="flex-between" style="margin-bottom: 24px">
              <h2>Categories</h2>
              <div style="display: flex; gap: 12px; align-items: center">
                <button
                  class="btn-secondary"
                  onclick="sortCategories()"
                  id="sortCategoriesBtn"
                >
                  <i class="fa-solid fa-sort-alpha-down" id="sortIcon"></i> Sort
                </button>
                <button onclick="openAddCategory()">
                  <i class="fa-solid fa-plus"></i> Add Category
                </button>
              </div>
            </div>
            <div id="categoriesList" style="margin-top: 12px"></div>
          </section>

          <section id="archives" class="view" style="display: none">
            <div class="flex-between" style="margin-bottom: 24px">
              <h2>Archives / Recycle Bin</h2>
              <div style="display: flex; gap: 12px; align-items: center">
                <div style="display: flex; align-items: center; gap: 8px">
                  <input
                    type="checkbox"
                    id="selectAllArchived"
                    onchange="toggleSelectAllArchived()"
                    style="width: 18px; height: 18px; cursor: pointer"
                  />
                  <label
                    for="selectAllArchived"
                    style="cursor: pointer; user-select: none"
                    >Select All</label
                  >
                </div>
              </div>
            </div>
            <div class="toolbar" style="margin-bottom: 16px">
              <select
                id="archiveFilterType"
                onchange="renderArchives()"
                style="max-width: 200px"
              >
                <option value="all">All Items</option>
                <option value="files">Archived Files</option>
                <option value="users">Archived Users</option>
              </select>
              <select
                id="archiveSortOrder"
                onchange="renderArchives()"
                style="max-width: 200px"
              >
                <option value="newest">Sort: Newest</option>
                <option value="oldest">Sort: Oldest</option>
                <option value="name_asc">Sort: Name (A-Z)</option>
                <option value="name_desc">Sort: Name (Z-A)</option>
              </select>
              <div style="flex: 1"></div>
              <button
                class="btn-secondary"
                id="bulkRestoreBtn"
                onclick="bulkRestoreArchived()"
                style="display: none"
              >
                <i class="fa-solid fa-rotate-left"></i> Restore Selected
              </button>
              <button
                class="btn-danger"
                id="bulkDeleteBtn"
                onclick="bulkDeleteArchived()"
                style="display: none"
              >
                <i class="fa-solid fa-trash"></i> Delete Selected
              </button>
            </div>
            <div id="archivesList" style="margin-top: 12px"></div>
          </section>

          <section id="settings" class="view" style="display: none">
            <h2 style="margin-bottom: 24px">System Settings</h2>
            <div class="card">
              <div class="form-row">
                <label class="small-muted">Company name</label
                ><input id="settingCompany" />
              </div>
              <div class="form-row">
                <label class="small-muted">Max file size (MB)</label
                ><input id="settingMax" type="number" min="1" />
              </div>
              <div class="form-row">
                <label class="small-muted"
                  >Allowed types (comma separated)</label
                ><input id="settingTypes" />
              </div>
              <div style="margin-top: 16px">
                <button onclick="saveSettings()">
                  <i class="fa-solid fa-floppy-disk"></i> Save Changes
                </button>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <div id="modalRoot" style="display: none"></div>

    <!-- User Setting Modal -->
    <div
      id="userSettingsModal"
      class="user-settings-modal"
      style="display: none"
    >
      <div class="user-settings-content">
        <div class="user-settings-header">
          <h3 style="margin: 0; color: var(--text)">User Settings</h3>
          <button class="icon-btn" onclick="closeUserSettings()">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div class="user-settings-body">
          <!-- Profile Image Section -->
          <div class="profile-image-section">
            <div class="profile-image-container">
              <div class="profile-image" id="profileImageDisplay">JD</div>
              <div
                class="profile-image-upload"
                onclick="document.getElementById('profileImageInput').click()"
              >
                <i class="fa-solid fa-camera"></i>
                <input
                  type="file"
                  id="profileImageInput"
                  accept="image/*"
                  onchange="handleProfileImageUpload(event)"
                  style="display: none"
                />
              </div>
            </div>
            <div class="small-muted" style="text-align: center">
              Click the camera icon to upload a new profile image
            </div>
          </div>

          <!-- Personal Information Section -->
          <div class="form-section">
            <h4>Personal Information</h4>
            <div class="form-row">
              <label>Full Name</label>
              <input
                type="text"
                id="userNameInput"
                placeholder="Enter your full name"
              />
            </div>
            <div class="form-row">
              <label>Email Address</label>
              <input
                type="email"
                id="userEmailInput"
                placeholder="Enter your email address"
              />
            </div>
          </div>

          <!-- Password Change Section -->
          <div class="form-section">
            <h4>Change Password</h4>
            <div class="password-fields">
              <div class="form-row current-password-field">
                <label>Current Password</label>
                <input
                  type="password"
                  id="currentPasswordInput"
                  placeholder="Enter current password"
                />
              </div>
              <div class="form-row">
                <label>New Password</label>
                <input
                  type="password"
                  id="newPasswordInput"
                  placeholder="Enter new password"
                />
              </div>
              <div class="form-row">
                <label>Confirm New Password</label>
                <input
                  type="password"
                  id="confirmPasswordInput"
                  placeholder="Confirm new password"
                />
              </div>
            </div>
          </div>
        </div>

        <div class="user-settings-footer">
          <button class="btn-secondary" onclick="closeUserSettings()">
            Cancel
          </button>
          <button onclick="saveUserSettings()">
            <i class="fa-solid fa-floppy-disk"></i> Save Changes
          </button>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:5000/api";

      // Utilities
      function uid(prefix = "id") {
        return prefix + "_" + Math.random().toString(36).slice(2, 9);
      }

      function nowStr() {
        return new Date().toISOString();
      }

      let currentToast = null;
      let toastTimeout = null;

      function showToast(msg, type = "info") {
        console.log(`DEBUG: Showing toast: ${msg} (${type})`);

        // Clear existing toast and timeout
        if (currentToast) {
          document.body.removeChild(currentToast);
          currentToast = null;
        }
        if (toastTimeout) {
          clearTimeout(toastTimeout);
          toastTimeout = null;
        }

        const toast = document.createElement("div");
        let bgColor = "var(--accent)";
        let icon = "fa-circle-info";

        if (type === "success") {
          bgColor = "var(--success)";
          icon = "fa-circle-check";
        } else if (type === "error") {
          bgColor = "var(--danger)";
          icon = "fa-circle-exclamation";
        }

        toast.style.cssText = `position:fixed;bottom:20px;right:20px;background:${bgColor};color:white;padding:12px 20px;border-radius:8px;z-index:1000;box-shadow:0 4px 6px rgba(0,0,0,0.1);display:flex;align-items:center;gap:8px;`;
        toast.innerHTML = `<i class="fa-solid ${icon}"></i><span>${msg}</span>`;
        document.body.appendChild(toast);

        currentToast = toast;

        toastTimeout = setTimeout(() => {
          if (currentToast === toast) {
            document.body.removeChild(toast);
            currentToast = null;
            toastTimeout = null;
          }
        }, 3000);
      }

      // Database API functions
      function getAuthHeaders() {
        const session = JSON.parse(
          localStorage.getItem("dms_session_v1") || "null"
        );
        if (session?.userId) {
          return { "X-User-Id": session.userId };
        }
        return {};
      }

      async function authFetch(url, options = {}) {
        const headers = {
          ...(options.headers || {}),
          ...getAuthHeaders(),
        };
        return fetch(url, { ...options, headers });
      }

      async function apiCall(endpoint, options = {}) {
        try {
          const config = {
            headers: {
              "Content-Type": "application/json",
              ...options.headers,
              ...getAuthHeaders(),
            },
            ...options,
          };

          if (config.body && typeof config.body === "object") {
            config.body = JSON.stringify(config.body);
          }

          const response = await fetch(`${API_BASE_URL}${endpoint}`, config);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          return await response.json();
        } catch (error) {
          console.error("API call failed:", error);
          showToast("Database operation failed", "error");
          return null;
        }
      }

      // User management
      async function getCurrentUser() {
        const session = JSON.parse(
          localStorage.getItem("dms_session_v1") || "null"
        );
        if (!session) return null;

        const users = await apiCall("/users");
        return users
          ? users.find((u) => u.user_id === session.userId) || null
          : null;
      }

      async function getAllUsers() {
        return await apiCall("/users");
      }

      async function createUser(userData) {
        return await apiCall("/users", {
          method: "POST",
          body: userData,
        });
      }

      async function updateUser(userId, userData) {
        return await apiCall(`/users/${userId}`, {
          method: "PUT",
          body: userData,
        });
      }

      async function archiveUser(userId, archiveData) {
        return await apiCall(`/users/${userId}/archive`, {
          method: "POST",
          body: archiveData,
        });
      }

      // File operations
      async function getAllFiles() {
        return await apiCall("/files");
      }

      async function createFile(fileData) {
        return await apiCall("/files", {
          method: "POST",
          body: fileData,
        });
      }

      async function updateFile(fileId, updates) {
        return await apiCall(`/files/${fileId}`, {
          method: "PUT",
          body: updates,
        });
      }

      async function archiveFile(fileId) {
        return await apiCall(`/files/${fileId}/archive`, {
          method: "POST",
        });
      }

      async function deleteFile(fileId) {
        return await apiCall(`/files/${fileId}`, {
          method: "DELETE",
        });
      }

      // Department operations
      async function getAllDepartments() {
        return await apiCall("/departments");
      }

      async function createDepartment(departmentData) {
        return await apiCall("/departments", {
          method: "POST",
          body: departmentData,
        });
      }

      async function deleteDepartmentAPI(departmentId) {
        return await apiCall(`/departments/${departmentId}`, {
          method: "DELETE",
        });
      }

      // Category operations
      async function getAllCategories() {
        return await apiCall("/categories");
      }

      async function createCategory(categoryData) {
        return await apiCall("/categories", {
          method: "POST",
          body: categoryData,
        });
      }

      async function updateCategory(categoryId, categoryData) {
        return await apiCall(`/categories/${categoryId}`, {
          method: "PUT",
          body: categoryData,
        });
      }

      // Workspace operations
      async function getAllWorkspaces() {
        return await apiCall("/workspaces");
      }

      async function createWorkspace(workspaceData) {
        return await apiCall("/workspaces", {
          method: "POST",
          body: workspaceData,
        });
      }

      async function updateWorkspace(workspaceId, workspaceData) {
        return await apiCall(`/workspaces/${workspaceId}`, {
          method: "PUT",
          body: workspaceData,
        });
      }

      async function deleteWorkspaceAPI(workspaceId) {
        return await apiCall(`/workspaces/${workspaceId}`, {
          method: "DELETE",
        });
      }

      // Settings operations
      async function getSettings() {
        return await apiCall("/settings");
      }

      async function updateSettings(settingsData) {
        return await apiCall("/settings", {
          method: "PUT",
          body: settingsData,
        });
      }

      // Activity operations
      async function getActivities() {
        return await apiCall("/activities");
      }

      async function logActivity(activityData) {
        return await apiCall("/activities", {
          method: "POST",
          body: activityData,
        });
      }

      // Authentication
      function checkAuth() {
        const session = JSON.parse(
          localStorage.getItem("dms_session_v1") || "null"
        );
        if (!session) {
          window.location.href = "login.html";
          return false;
        }
        return true;
      }

      function clearSession() {
        localStorage.removeItem("dms_session_v1");
        window.location.href = "login.html";
      }

      let currentView = "dashboard";
      let sidebarCollapsed = false;
      let currentWorkspaceId = null;
      let categoriesSortOrder = "asc";
      let currentUserData = null;

      const ROLE_VIEW_ACCESS = {
        system_admin: [
          "dashboard",
          "library",
          "workspaces",
          "userMgmt",
          "departments",
          "categories",
          "archives",
          "settings",
        ],
        department_admin: [
          "dashboard",
          "library",
          "workspaces",
          "userMgmt",
          "departments",
          "categories",
          "archives",
        ],
        staff: ["dashboard", "library", "workspaces", "archives"],
      };

      function getAllowedViewsForRole(role) {
        if (!role) return ROLE_VIEW_ACCESS.staff;
        return ROLE_VIEW_ACCESS[role] || ROLE_VIEW_ACCESS.staff;
      }

      function applyRoleNavigation(user) {
        if (!user) return;
        const allowedViews = getAllowedViewsForRole(user.role);
        document.querySelectorAll(".nav-item").forEach((item) => {
          const view = item.getAttribute("data-view");
          if (!view) return;
          item.style.display = allowedViews.includes(view) ? "flex" : "none";
        });
      }

      function updateRoleBasedUI(user) {
        const workspaceButtons = document.querySelectorAll(
          '[data-role-action="workspace-create"]'
        );
        workspaceButtons.forEach((btn) => {
          if (!btn) return;
          btn.style.display = user.role === "staff" ? "none" : "inline-flex";
        });
      }

      // Initialize application
      async function init() {
        if (!checkAuth()) return;

        const user = await getCurrentUser();
        if (user) {
          updateTopUser(user);
          enterApp();
          initSidebarToggle();
          initThemeToggle();
        } else {
          clearSession();
        }
      }

      function initThemeToggle() {
        const themeToggle = document.getElementById("themeToggle");
        const icon = themeToggle.querySelector("i");

        const savedTheme = localStorage.getItem("dms-theme") || "light";
        if (savedTheme === "dark") {
          document.body.classList.add("dark-mode");
          icon.classList.remove("fa-moon");
          icon.classList.add("fa-sun");
        }

        themeToggle.addEventListener("click", () => {
          document.body.classList.toggle("dark-mode");
          if (document.body.classList.contains("dark-mode")) {
            localStorage.setItem("dms-theme", "dark");
            icon.classList.remove("fa-moon");
            icon.classList.add("fa-sun");
          } else {
            localStorage.setItem("dms-theme", "light");
            icon.classList.remove("fa-sun");
            icon.classList.add("fa-moon");
          }
        });
      }

      function initSidebarToggle() {
        const menuToggle = document.getElementById("menuToggle");
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("overlay");
        const main = document.getElementById("main");

        menuToggle.addEventListener("click", () => {
          if (window.innerWidth < 992) {
            sidebar.classList.toggle("active");
            overlay.classList.toggle("active");
          } else {
            sidebarCollapsed = !sidebarCollapsed;
            if (sidebarCollapsed) {
              sidebar.classList.add("collapsed");
            } else {
              sidebar.classList.remove("collapsed");
            }
          }
        });

        overlay.addEventListener("click", () => {
          sidebar.classList.remove("active");
          overlay.classList.remove("active");
        });
      }

      function logout() {
        if (confirm("Are you sure you want to logout?")) {
          clearSession();
        }
      }

      function updateTopUser(user) {
        const topName = document.getElementById("topName");
        const topRole = document.getElementById("topRole");
        const topAvatar = document.getElementById("topAvatar");
        const sidebarUser = document.getElementById("sidebarUser");
        const sidebarRole = document.getElementById("sidebarRole");

        if (user) {
          currentUserData = user;
          topName.textContent = user.name;
          const roleLabel =
            user.role === "system_admin"
              ? "System Administrator"
              : user.role === "department_admin"
              ? "Department Administrator"
              : "Staff";
          topRole.textContent = roleLabel;

          if (user.profile_image) {
            // Ensure image URL is absolute
            let imageUrl = user.profile_image;
            if (imageUrl.startsWith("/")) {
              imageUrl = API_BASE_URL.replace("/api", "") + imageUrl;
            } else if (!imageUrl.startsWith("http")) {
              imageUrl = API_BASE_URL.replace("/api", "") + "/" + imageUrl;
            }
            topAvatar.innerHTML = `<img src="${imageUrl}" alt="Profile" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.parentElement.innerHTML='${user.name
              .split(" ")
              .map((s) => s[0])
              .slice(0, 2)
              .join("")
              .toUpperCase()}';this.parentElement.style.background='linear-gradient(135deg, var(--accent), var(--accent-dark))';this.parentElement.style.color='white';this.parentElement.style.display='flex';this.parentElement.style.alignItems='center';this.parentElement.style.justifyContent='center';">`;
          } else {
            topAvatar.textContent = user.name
              .split(" ")
              .map((s) => s[0])
              .slice(0, 2)
              .join("")
              .toUpperCase();
            topAvatar.style.background =
              "linear-gradient(135deg, var(--accent), var(--accent-dark))";
            topAvatar.style.color = "white";
            topAvatar.style.display = "flex";
            topAvatar.style.alignItems = "center";
            topAvatar.style.justifyContent = "center";
          }

          sidebarUser.textContent = user.name;
          sidebarRole.textContent = user.role;
          applyRoleNavigation(user);
          updateRoleBasedUI(user);
        }
      }

      function enterApp() {
        document.getElementById("appViews").style.display = "block";
        document.getElementById("sidebar").style.display = "flex";

        // Restore previous view from localStorage
        const savedView = localStorage.getItem("dms_current_view");
        const savedWorkspace = localStorage.getItem("dms_current_workspace");

        if (savedView && savedView !== "dashboard") {
          // Remove active class from all nav items
          document
            .querySelectorAll(".nav-item")
            .forEach((n) => n.classList.remove("active"));

          // Set the saved view
          currentView = savedView;

          // Restore workspace if applicable
          if (savedWorkspace && savedView === "workspace-detail") {
            currentWorkspaceId = parseInt(savedWorkspace);
          }

          // Activate the correct nav item
          const navItem = document.querySelector(
            `.nav-item[data-view="${savedView}"]`
          );
          if (navItem) {
            navItem.classList.add("active");
          } else {
            // Fallback to dashboard if saved view doesn't exist
            currentView = "dashboard";
            document
              .querySelector('.nav-item[data-view="dashboard"]')
              .classList.add("active");
          }
        }

        renderCurrentView();
        refreshStats();
      }

      // User Settings Modal Functions
      let originalProfileImage = null;
      let tempProfileImage = null;

      function openUserSettings() {
        getCurrentUser().then((user) => {
          if (!user) return;

          originalProfileImage = user.profile_image || null;
          tempProfileImage = null;

          document.getElementById("userNameInput").value = user.name || "";
          document.getElementById("userEmailInput").value = user.email || "";

          updateProfileImageDisplay(user.profile_image, user.name);

          document.getElementById("currentPasswordInput").value = "";
          document.getElementById("newPasswordInput").value = "";
          document.getElementById("confirmPasswordInput").value = "";

          document.getElementById("userSettingsModal").style.display = "flex";
        });
      }

      function closeUserSettings() {
        if (tempProfileImage && originalProfileImage !== tempProfileImage) {
          getCurrentUser().then((user) => {
            if (user) {
              updateProfileImageDisplay(originalProfileImage, user.name);
            }
          });
        }

        tempProfileImage = null;
        originalProfileImage = null;
        document.getElementById("userSettingsModal").style.display = "none";
      }

      function updateProfileImageDisplay(profileImage, userName) {
        const profileImageDisplay = document.getElementById(
          "profileImageDisplay"
        );
        const profileImageContainer = document.querySelector(
          ".profile-image-container"
        );

        profileImageDisplay.innerHTML = "";
        profileImageDisplay.style.background = "";
        profileImageDisplay.style.color = "";

        const existingRemoveBtn = profileImageContainer.querySelector(
          ".profile-image-remove"
        );
        if (existingRemoveBtn) {
          existingRemoveBtn.remove();
        }

        if (profileImage) {
          // Ensure image URL is absolute
          let imageUrl = profileImage;
          if (imageUrl.startsWith("/")) {
            imageUrl = API_BASE_URL.replace("/api", "") + imageUrl;
          } else if (!imageUrl.startsWith("http")) {
            imageUrl = API_BASE_URL.replace("/api", "") + "/" + imageUrl;
          }
          profileImageDisplay.innerHTML = `<img src="${imageUrl}" alt="Profile" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.parentElement.innerHTML='${userName
            .split(" ")
            .map((s) => s[0])
            .slice(0, 2)
            .join("")
            .toUpperCase()}';this.parentElement.style.background='linear-gradient(135deg, var(--accent), var(--accent-dark))';this.parentElement.style.color='white';this.parentElement.style.display='flex';this.parentElement.style.alignItems='center';this.parentElement.style.justifyContent='center';">`;

          const removeBtn = document.createElement("div");
          removeBtn.className = "profile-image-remove";
          removeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
          removeBtn.onclick = (e) => {
            e.stopPropagation();
            removeProfileImage();
          };
          profileImageContainer.appendChild(removeBtn);
        } else {
          const initials = userName
            .split(" ")
            .map((s) => s[0])
            .slice(0, 2)
            .join("")
            .toUpperCase();
          profileImageDisplay.textContent = initials;
          profileImageDisplay.style.background =
            "linear-gradient(135deg, var(--accent), var(--accent-dark))";
          profileImageDisplay.style.color = "white";
          profileImageDisplay.style.display = "flex";
          profileImageDisplay.style.alignItems = "center";
          profileImageDisplay.style.justifyContent = "center";
        }

        profileImageDisplay.style.cursor = "pointer";
        profileImageDisplay.onclick = () =>
          document.getElementById("profileImageInput").click();
      }

      function removeProfileImage() {
        if (!confirm("Remove profile image?")) return;

        tempProfileImage = null;

        getCurrentUser().then((user) => {
          if (user) {
            updateProfileImageDisplay(
              null,
              document.getElementById("userNameInput").value || user.name
            );
            showToast("Profile image removed. Don't forget to save changes!");
          }
        });
      }

      async function handleProfileImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.startsWith("image/")) {
          showToast("Please select a valid image file");
          return;
        }

        if (file.size > 5 * 1024 * 1024) {
          showToast("Image size should be less than 5MB");
          return;
        }

        const user = await getCurrentUser();
        if (!user) {
          showToast("User not found", "error");
          return;
        }

        // Upload image to server
        showToast("Uploading profile image...", "info");

        const formData = new FormData();
        formData.append("image", file);
        formData.append("user_id", user.user_id);

        try {
          const response = await authFetch(
            `${API_BASE_URL}/upload-profile-image`,
            {
              method: "POST",
              body: formData,
            }
          );

          // Check if response is OK
          if (!response.ok) {
            const errorText = await response.text();
            console.error("Upload error response:", errorText);
            showToast(
              "Failed to upload profile image: " +
                (errorText || response.statusText),
              "error"
            );
            return;
          }

          // Check content type
          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            const errorText = await response.text();
            console.error("Non-JSON response:", errorText);
            showToast("Server error: Invalid response format", "error");
            return;
          }

          const result = await response.json();

          if (result && result.success && result.image_url) {
            // Construct full URL for the image
            let imageUrl = result.image_url;
            if (imageUrl.startsWith("/")) {
              imageUrl = API_BASE_URL.replace("/api", "") + imageUrl;
            } else if (!imageUrl.startsWith("http")) {
              imageUrl = API_BASE_URL.replace("/api", "") + "/" + imageUrl;
            }
            tempProfileImage = imageUrl;
            updateProfileImageDisplay(
              tempProfileImage,
              document.getElementById("userNameInput").value || user.name
            );
            showToast(
              "Profile image uploaded. Don't forget to save changes!",
              "success"
            );
          } else {
            showToast(
              result.error || "Failed to upload profile image",
              "error"
            );
          }
        } catch (error) {
          console.error("Error uploading profile image:", error);
          showToast(
            "Failed to upload profile image: " +
              (error.message || "Network error"),
            "error"
          );
        }
      }

      async function saveUserSettings() {
        const user = await getCurrentUser();
        if (!user) return;

        const name = document.getElementById("userNameInput").value.trim();
        const email = document.getElementById("userEmailInput").value.trim();
        const currentPassword = document.getElementById(
          "currentPasswordInput"
        ).value;
        const newPassword = document.getElementById("newPasswordInput").value;
        const confirmPassword = document.getElementById(
          "confirmPasswordInput"
        ).value;

        if (!name || !email) {
          showToast("Name and email are required");
          return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showToast("Please enter a valid email address");
          return;
        }

        // For password change - in real app, verify current password via API
        if (currentPassword || newPassword || confirmPassword) {
          if (!currentPassword) {
            showToast("Current password is required to change password");
            return;
          }

          if (!newPassword) {
            showToast("New password is required");
            return;
          }

          if (newPassword.length < 6) {
            showToast("New password must be at least 6 characters long");
            return;
          }

          if (newPassword !== confirmPassword) {
            showToast("New passwords do not match");
            return;
          }
        }

        const updateData = {
          name: name,
          email: email,
          role: user.role,
          department_id: user.department_id,
          status: user.status,
        };

        // Profile image is already uploaded and URL is stored in tempProfileImage
        if (tempProfileImage !== undefined) {
          updateData.profile_image = tempProfileImage;
        }

        if (newPassword) {
          updateData.password = newPassword;
        }

        const result = await updateUser(user.user_id, updateData);
        if (result && result.success) {
          showToast("User settings saved successfully", "success");
          closeUserSettings();

          // Refresh user data
          const updatedUser = await getCurrentUser();
          updateTopUser(updatedUser);
        }
      }

      // Navigation
      function navigate(e) {
        const target = e.currentTarget || e.target;
        const view = target.dataset.view;
        if (!view) return;

        const user = currentUserData;
        if (!user) return;
        const allowedViews = getAllowedViewsForRole(user.role);
        if (!allowedViews.includes(view)) {
          showToast("Access denied for your role.", "error");
          return;
        }

        document
          .querySelectorAll(".nav-item")
          .forEach((n) => n.classList.remove("active"));
        target.classList.add("active");
        currentView = view;
        currentWorkspaceId = null;

        // Save current view to localStorage
        localStorage.setItem("dms_current_view", view);

        renderCurrentView();

        if (window.innerWidth < 992) {
          document.getElementById("sidebar").classList.remove("active");
          document.getElementById("overlay").classList.remove("active");
        }
      }

      function goHome() {
        currentView = "dashboard";
        currentWorkspaceId = null;
        document
          .querySelectorAll(".nav-item")
          .forEach((n) => n.classList.remove("active"));
        document
          .querySelector('.nav-item[data-view="dashboard"]')
          .classList.add("active");

        // Save current view to localStorage
        localStorage.setItem("dms_current_view", "dashboard");

        renderCurrentView();
      }

      async function renderCurrentView() {
        const user = currentUserData || (await getCurrentUser());
        if (!user) return;
        currentUserData = user;
        applyRoleNavigation(user);

        const allowedViews = getAllowedViewsForRole(user.role);
        if (!allowedViews.includes(currentView)) {
          currentView = allowedViews.includes("library")
            ? "library"
            : allowedViews[0];
          document
            .querySelectorAll(".nav-item")
            .forEach((n) => n.classList.remove("active"));
          const navItem = document.querySelector(
            `.nav-item[data-view="${currentView}"]`
          );
          if (navItem) navItem.classList.add("active");
        }

        document.querySelectorAll(".view").forEach((v) => {
          v.style.display = v.id === currentView ? "block" : "none";
        });

        if (currentView === "dashboard") await renderDashboard();
        if (currentView === "library") await renderFiles();
        if (currentView === "workspaces") await renderWorkspaces();
        if (currentView === "workspace-detail") await renderWorkspaceDetail();
        if (currentView === "userMgmt") await renderUsers();
        if (currentView === "departments") await renderDepartments();
        if (currentView === "categories") await renderCategories();
        if (currentView === "archives") await renderArchives();
        if (currentView === "settings") await renderSettings();
      }

      function fileIcon(name) {
        const ext = (name.split(".").pop() || "").toLowerCase();
        if (["png", "jpg", "jpeg", "gif", "bmp", "svg"].includes(ext))
          return "";
        if (ext === "pdf") return "";
        if (["doc", "docx"].includes(ext)) return "";
        if (["xls", "xlsx", "csv"].includes(ext)) return "";
        if (["ppt", "pptx"].includes(ext)) return "";
        if (["zip", "rar", "7z"].includes(ext)) return "";
        if (ext === "txt") return "";
        return "";
      }

      function getPermissionLabel(permission) {
        if (!permission) return "";
        if (permission === "owner") return "Owner";
        if (permission === "admin") return "Administrator";
        if (permission === "editor") return "Editor";
        if (permission === "viewer") return "Viewer";
        return permission;
      }

      // File Management
      async function openAddFileModal() {
        const workspaces = await getAllWorkspaces();
        const categories = await getAllCategories();
        const departments = await getAllDepartments();
        const currentUser = await getCurrentUser();
        const settings = await getSettings();

        // Filter workspaces where current user is a member
        const userWorkspaces = workspaces.filter((w) => {
          return (
            w.members &&
            Array.isArray(w.members) &&
            w.members.includes(currentUser.user_id)
          );
        });

        const workspaceCheckboxes = userWorkspaces
          .map(
            (w) => `
            <div class="checkbox-option" style="display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all 0.2s ease;">
                <input type="checkbox" id="upload_workspace_${
                  w.workspace_id
                }" value="${
              w.workspace_id
            }" style="margin:0;width:16px;height:16px;">
                <label for="upload_workspace_${
                  w.workspace_id
                }" style="cursor:pointer;margin:0;flex:1;display:flex;align-items:center;gap:10px;">
                    <div style="width:32px;height:32px;border-radius:8px;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center;">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                    <div>
                        <div style="font-weight:600;color:var(--text)">${
                          w.name
                        }</div>
                        <div class="small-muted">${
                          w.description || "No description"
                        }  ${w.members ? w.members.length : 0} members</div>
                    </div>
                </label>
            </div>
        `
          )
          .join("");

        const categoryOptions = (categories || [])
          .map((c) => `<option value="${c.category_id}">${c.name}</option>`)
          .join("");

        const departmentOptions = (departments || [])
          .map((d) => `<option value="${d.department_id}">${d.name}</option>`)
          .join("");

        openModal(`<h3>Upload Files</h3>
    <div style="display:flex;flex-direction:column;gap:16px">
        <!-- Enhanced File Input Section -->
        <div class="form-row">
            <label>Select Files</label>
            <div class="file-input-wrapper">
                <input type="file" id="fileInputModal" multiple />
                <div class="file-input-custom" id="fileInputCustom">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                    <span>Choose Files or Drag & Drop</span>
                </div>
            </div>
            <div class="file-input-info">
                Maximum file size: ${
                  settings?.max_file_mb || 50
                }MB  Supported: ${settings?.allowed_types || "All file types"}
            </div>
            <div id="fileInputSelected" style="display: none;">
                <div class="file-input-selected">
                    <div class="file-input-selected-title">
                        <i class="fa-solid fa-check-circle"></i>
                        Selected Files
                    </div>
                    <div class="file-input-selected-list" id="selectedFilesList"></div>
                </div>
            </div>
        </div>
        
        <div class="form-row">
            <label style="font-weight:600;color:var(--text);margin-bottom:8px;">Add to Workspace(s) (Optional)</label>
            <div id="uploadWorkspaceCheckboxes" style="max-height:200px;overflow-y:auto;padding:8px;border:1px solid var(--border);border-radius:8px;">
                ${
                  userWorkspaces.length > 0
                    ? workspaceCheckboxes
                    : '<div class="small-muted" style="text-align:center;padding:20px;">You are not a member of any workspaces</div>'
                }
            </div>
            <div class="small-muted" style="margin-top:8px;display:flex;align-items:center;gap:6px;">
                <i class="fa-solid fa-circle-info" style="color:var(--accent);"></i> 
                Files will be uploaded once to each selected workspace. No duplicates in My Library.
            </div>
        </div>
        
        <div id="uploadSelectedWorkspaces" style="display:none;background:var(--accent-light);padding:12px;border-radius:8px;border-left:4px solid var(--accent);">
            <div style="font-weight:600;color:var(--accent);margin-bottom:6px;display:flex;align-items:center;gap:6px;">
                <i class="fa-solid fa-check-circle"></i>
                Selected Workspaces:
            </div>
            <div id="uploadSelectedWorkspacesList" class="small-muted" style="color:var(--accent-dark);"></div>
        </div>
        
        <div class="form-row">
            <label>Send to Department (Optional)</label>
            <select id="uploadDepartment" onchange="updateEmailCheckbox()">
                <option value="" selected>Select Department</option>
                ${departmentOptions}
            </select>
            <div style="margin-top:8px;">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="uploadSendEmail" disabled style="margin:0;width:16px;height:16px;">
                    <span id="emailCheckboxLabel" class="small-muted">Select a department to enable email notification</span>
                </label>
            </div>
        </div>
        
        <div style="display:flex;gap:12px;justify-content:flex-end">
            <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
            <button onclick="handleFilesFromModal()"><i class="fa-solid fa-upload"></i> Upload Files</button>
        </div>
    </div>`);

        // Update email checkbox label based on selected department
        window.updateEmailCheckbox = function () {
          const deptSelect = document.getElementById("uploadDepartment");
          const emailCheckbox = document.getElementById("uploadSendEmail");
          const emailLabel = document.getElementById("emailCheckboxLabel");

          if (deptSelect && emailLabel) {
            const selectedDeptId = deptSelect.value;
            if (selectedDeptId) {
              const selectedDept = departments.find(
                (d) => d.department_id == selectedDeptId
              );
              if (selectedDept) {
                emailLabel.textContent = `Send email to: ${selectedDept.name}`;
                emailCheckbox.disabled = false;
              }
            } else {
              emailLabel.textContent =
                "Select a department to enable email notification";
              emailCheckbox.checked = false;
              emailCheckbox.disabled = true;
            }
          }
        };

        // Add click handlers for workspace checkboxes
        setTimeout(() => {
          document
            .querySelectorAll("#uploadWorkspaceCheckboxes .checkbox-option")
            .forEach((option) => {
              option.addEventListener("click", function (e) {
                if (e.target.type !== "checkbox") {
                  const checkbox = this.querySelector('input[type="checkbox"]');
                  checkbox.checked = !checkbox.checked;
                  updateUploadSelectedWorkspaces();
                }
              });
            });

          // Add change handlers for checkboxes
          document
            .querySelectorAll(
              '#uploadWorkspaceCheckboxes input[type="checkbox"]'
            )
            .forEach((checkbox) => {
              checkbox.addEventListener(
                "change",
                updateUploadSelectedWorkspaces
              );
            });

          // Setup enhanced file input
          setupFileInput();
        }, 100);
      }

      // Enhanced File Input Functionality
      function setupFileInput() {
        const fileInput = document.getElementById("fileInputModal");
        const fileInputCustom = document.getElementById("fileInputCustom");
        const fileInputSelected = document.getElementById("fileInputSelected");
        const selectedFilesList = document.getElementById("selectedFilesList");

        if (!fileInput) return;

        // Update custom button text when files are selected
        fileInput.addEventListener("change", function (e) {
          const files = Array.from(e.target.files);

          if (files.length > 0) {
            // Update custom button
            const fileText =
              files.length === 1
                ? `1 file selected`
                : `${files.length} files selected`;

            fileInputCustom.innerHTML = `
                <i class="fa-solid fa-check-circle"></i>
                <span>${fileText}</span>
            `;
            fileInputCustom.style.background = "var(--success)";
            fileInputCustom.style.borderColor = "var(--success)";
            fileInputCustom.style.color = "white";
            fileInputCustom.style.borderStyle = "solid";

            // Show selected files list
            selectedFilesList.innerHTML = files
              .slice(0, 10) // Show first 10 files
              .map(
                (file) => `
                    <div title="${file.name}">
                        <i class="fa-solid fa-file"></i> ${
                          file.name
                        } (${formatFileSize(file.size)})
                    </div>
                `
              )
              .join("");

            if (files.length > 10) {
              selectedFilesList.innerHTML += `<div style="color: var(--text-muted); font-style: italic;">... and ${
                files.length - 10
              } more files</div>`;
            }

            fileInputSelected.style.display = "block";
          } else {
            // Reset to default state
            resetFileInput();
          }
        });

        // Add drag and drop functionality
        const wrapper = fileInput.closest(".file-input-wrapper");

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          wrapper.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
          wrapper.addEventListener(eventName, highlight, false);
        });

        ["dragleave", "drop"].forEach((eventName) => {
          wrapper.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
          fileInputCustom.style.background = "var(--accent)";
          fileInputCustom.style.color = "white";
          fileInputCustom.style.borderStyle = "solid";
          fileInputCustom.style.transform = "translateY(-2px)";
          fileInputCustom.style.boxShadow =
            "0 4px 12px rgba(59, 130, 246, 0.3)";
        }

        function unhighlight() {
          if (!fileInput.files || fileInput.files.length === 0) {
            resetFileInput();
          }
        }

        function resetFileInput() {
          fileInputCustom.innerHTML = `
            <i class="fa-solid fa-cloud-arrow-up"></i>
            <span>Choose Files or Drag & Drop</span>
        `;
          fileInputCustom.style.background = "";
          fileInputCustom.style.borderColor = "";
          fileInputCustom.style.color = "";
          fileInputCustom.style.borderStyle = "dashed";
          fileInputCustom.style.transform = "";
          fileInputCustom.style.boxShadow = "";
          fileInputSelected.style.display = "none";
        }

        wrapper.addEventListener("drop", handleDrop, false);

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;
          fileInput.files = files;

          // Trigger change event
          const event = new Event("change", { bubbles: true });
          fileInput.dispatchEvent(event);
        }
      }

      // Helper function to format file size
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";

        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // Function to update selected workspaces in upload modal
      function updateUploadSelectedWorkspaces() {
        const selectedCheckboxes = document.querySelectorAll(
          '#uploadWorkspaceCheckboxes input[type="checkbox"]:checked'
        );
        const summaryContainer = document.getElementById(
          "uploadSelectedWorkspaces"
        );
        const selectedList = document.getElementById(
          "uploadSelectedWorkspacesList"
        );

        if (selectedCheckboxes.length > 0) {
          const selectedNames = Array.from(selectedCheckboxes).map(
            (checkbox) => {
              const label = checkbox
                .closest(".checkbox-option")
                .querySelector("label");
              return label.querySelector("div > div:first-child").textContent;
            }
          );

          selectedList.innerHTML = selectedNames
            .map((name) => ` ${name}`)
            .join("<br>");
          summaryContainer.style.display = "block";
        } else {
          summaryContainer.style.display = "none";
        }
      }

      // Make sure uploadSingleFile is using the new parameter order
      async function uploadSingleFile(
        file,
        userId,
        workspaceIds,
        categoryId,
        departmentId = null,
        sendEmail = false
      ) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("user_id", userId);

        // Pass workspace IDs as array
        if (workspaceIds && workspaceIds.length > 0) {
          workspaceIds.forEach((workspaceId) => {
            formData.append("workspace_ids", workspaceId);
          });
        }

        if (categoryId) formData.append("category_id", categoryId);
        if (departmentId) formData.append("department_id", departmentId);
        if (sendEmail) formData.append("send_email", "true");

        const response = await authFetch(`${API_BASE_URL}/upload-file`, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(
            errorData.error || `Upload failed: ${response.status}`
          );
        }

        const result = await response.json();

        if (result.error) {
          throw new Error(result.error);
        }

        return result;
      }

      // Guard to prevent multiple simultaneous renders
      let isRenderingFiles = false;

      async function renderFiles() {
        // Prevent multiple simultaneous renders
        if (isRenderingFiles) {
          console.log("DEBUG: renderFiles already in progress, skipping...");
          return;
        }

        isRenderingFiles = true;

        try {
          const grid = document.getElementById("filesGrid");
          if (!grid) {
            console.warn("DEBUG: filesGrid not found");
            return;
          }

          // Clear grid immediately
          grid.innerHTML = "";

          const files = await getAllFiles();

          // Populate the file type dropdown with current files' extensions
          populateFileTypeDropdown(files);

          // Deduplicate files by file_id to prevent duplicates
          const uniqueFiles = [];
          const seenIds = new Set();
          for (const file of files || []) {
            if (file && file.file_id && !seenIds.has(file.file_id)) {
              seenIds.add(file.file_id);
              uniqueFiles.push(file);
            }
          }

          const filterSelect = document.getElementById("filterType");
          const filter = filterSelect ? filterSelect.value : "";
          const sort = document.getElementById("sortFiles")?.value || "new";

          // Only show active files (not archived or deleted)
          let filteredFiles = uniqueFiles.filter((f) => f.status === "active");

          if (filter) {
            filteredFiles = filteredFiles.filter((f) => {
              const fileExtension = getFileExtension(f.name);
              return (
                fileExtension &&
                fileExtension.toLowerCase() === filter.toLowerCase()
              );
            });
          }

          if (sort === "new")
            filteredFiles.sort(
              (a, b) => new Date(b.created_at) - new Date(a.created_at)
            );
          if (sort === "old")
            filteredFiles.sort(
              (a, b) => new Date(a.created_at) - new Date(b.created_at)
            );
          if (sort === "name_asc")
            filteredFiles.sort((a, b) => a.name.localeCompare(b.name));
          if (sort === "name_desc")
            filteredFiles.sort((a, b) => b.name.localeCompare(a.name));

          if (!filteredFiles.length) {
            grid.innerHTML =
              '<div class="card small-muted" style="text-align:center;padding:40px">No documents found</div>';
            return;
          }

          for (const f of filteredFiles) {
            const div = document.createElement("div");
            div.className = "doc-adaptive";
            div.setAttribute("data-file-id", f.file_id);
            div.onclick = () => openFilePreview(f.file_id);
            const accessLabel = getPermissionLabel(f.current_user_permission);
            const canEdit = !!f.can_edit;
            const canRename = !!f.can_edit;
            const canManageShare = ["owner", "admin"].includes(
              f.current_user_permission
            );
            div.innerHTML = `
                <input type="checkbox" class="doc-checkbox" data-file-id="${
                  f.file_id
                }" 
                       onclick="event.stopPropagation(); updateBulkActionsBar()" 
                       onchange="updateBulkActionsBar()">
                <div class="doc-header">
                    <div class="doc-icon">${fileIcon(f.name)}</div>
                    <div class="doc-info">
                        <div class="doc-name" onclick="event.stopPropagation(); startRenameFile(${
                          f.file_id
                        }, this)">${f.name}</div>
                        <div class="doc-meta">${
                          (f.size / 1024) | 0
                        } KB  ${new Date(f.created_at).toLocaleString()}</div>
                        ${
                          accessLabel
                            ? `<div class="small-muted">Access: ${accessLabel}</div>`
                            : ""
                        }
                    </div>
                </div>
                <div class="doc-actions">
                    ${
                      canEdit
                        ? `
                    <button class="icon-btn" title="Edit Online" onclick="event.stopPropagation(); openFileEditor(${f.file_id})">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </button>`
                        : ""
                    }
                    ${
                      canRename
                        ? `
                    <button class="icon-btn" title="Rename" onclick="event.stopPropagation(); startRenameFileFromButton(${f.file_id})">
                        <i class="fa-solid fa-pen"></i>
                    </button>`
                        : ""
                    }
                    <button class="icon-btn" ${
                      canManageShare
                        ? ""
                        : 'style="opacity:0.4;cursor:not-allowed"'
                    } ${
              canManageShare
                ? `onclick="event.stopPropagation(); openFileShareModal(${f.file_id})"`
                : 'onclick="event.stopPropagation();"'
            } title="${
              canManageShare ? "Manage Sharing" : "Shared access (view only)"
            }">
                        ${
                          f.shared
                            ? '<i class="fa-solid fa-link"></i>'
                            : '<i class="fa-regular fa-circle"></i>'
                        }
                    </button>
                    <button class="icon-btn" onclick="event.stopPropagation(); downloadFile(${
                      f.file_id
                    })">
                        <i class="fa-solid fa-download"></i>
                    </button>
                    <button class="icon-btn" title="Manage Workspaces" onclick="event.stopPropagation(); openAddToWorkspaceModal(${
                      f.file_id
                    })">
                        <i class="fa-solid fa-layer-group"></i>
                    </button>
                    <button class="icon-btn" title="Archive" onclick="event.stopPropagation(); moveToArchive(${
                      f.file_id
                    })">
                        <i class="fa-solid fa-box-archive"></i>
                    </button>
                </div>
            `;
            grid.appendChild(div);
          }

          // Add bulk actions bar if not exists
          if (!document.getElementById("bulkActionsBar")) {
            const bulkBar = document.createElement("div");
            bulkBar.id = "bulkActionsBar";
            bulkBar.className = "bulk-actions-bar";
            bulkBar.innerHTML = `
                <span class="selected-count" id="selectedCount">0 selected</span>
                <button class="btn-secondary" onclick="bulkDownload()">
                    <i class="fa-solid fa-download"></i> Download
                </button>
                <button class="btn-secondary" onclick="bulkAddToWorkspace()">
                    <i class="fa-solid fa-layer-group"></i> Add to Workspace
                </button>
                <button class="btn-secondary" onclick="bulkArchive()">
                    <i class="fa-solid fa-box-archive"></i> Archive
                </button>
                <button class="btn-secondary" onclick="clearSelection()">
                    <i class="fa-solid fa-xmark"></i> Clear
                </button>
            `;
            document.body.appendChild(bulkBar);
          }

          updateBulkActionsBar();
        } catch (error) {
          console.error("DEBUG: Error in renderFiles:", error);
        } finally {
          isRenderingFiles = false;
        }
      }

      // Function to get unique file extensions from all files
      function getUniqueFileExtensions(files) {
        const extensions = new Set();
        if (files && files.length > 0) {
          files.forEach((file) => {
            if (file.name) {
              const extension = getFileExtension(file.name);
              if (extension) {
                extensions.add(extension.toLowerCase());
              }
            }
          });
        }
        return Array.from(extensions).sort();
      }

      // Function to get file extension from filename
      function getFileExtension(filename) {
        const parts = filename.split(".");
        if (parts.length > 1) {
          return parts.pop().toLowerCase();
        }
        return ""; // No extension
      }

      // Function to populate the file type dropdown with actual file extensions
      function populateFileTypeDropdown(files) {
        const filterTypeSelect = document.getElementById("filterType");
        if (!filterTypeSelect) return;

        // Store current selection
        const currentSelection = filterTypeSelect.value;

        // Clear existing options except the first one
        while (filterTypeSelect.options.length > 1) {
          filterTypeSelect.remove(1);
        }

        // Get unique file extensions from actual files
        const fileExtensions = getUniqueFileExtensions(files);

        // Add file extension options
        fileExtensions.forEach((ext) => {
          if (ext) {
            // Only add if extension exists
            const option = document.createElement("option");
            option.value = ext;
            option.textContent = ext.toUpperCase();
            filterTypeSelect.appendChild(option);
          }
        });

        // Restore previous selection if it still exists
        if (currentSelection && fileExtensions.includes(currentSelection)) {
          filterTypeSelect.value = currentSelection;
        }
      }

      // Debug function to check file status
      async function debugFile(fileId) {
        const files = await getAllFiles();
        const file = files.find((f) => f.file_id === fileId);
        if (file) {
          console.log("File details:", file);
          showToast(
            `File: ${file.name}, Status: ${file.status}, Path: ${file.file_path}`,
            "info"
          );
        } else {
          showToast("File not found", "error");
        }
      }
      async function toggleShare(fileId) {
        // Open sharing modal instead of simple toggle
        await openFileShareModal(fileId);
      }

      // Open file sharing modal with Google Docs-style interface
      async function openFileShareModal(fileId) {
        const files = await getAllFiles();
        const file = files.find((f) => f.file_id === fileId);
        if (!file) {
          showToast("File not found", "error");
          return;
        }

        const currentUser = await getCurrentUser();
        if (!currentUser) {
          showToast("User not found", "error");
          return;
        }

        const canManageShare = ["owner", "admin"].includes(
          file.current_user_permission
        );
        if (!canManageShare) {
          showToast(
            "You do not have permission to manage sharing for this file.",
            "error"
          );
          return;
        }
        const canEditFile = !!file.can_edit;

        // Get existing shares
        const existingShares = (await apiCall(`/files/${fileId}/shares`)) || [];
        const users = await getAllUsers();
        const departments = await getAllDepartments();

        // Filter out current user
        const availableUsers = users.filter(
          (u) => u.user_id !== currentUser.user_id && u.status === "active"
        );

        // Build existing shares display
        let sharesHTML = "";
        if (existingShares.length > 0) {
          sharesHTML = existingShares
            .map((share) => {
              let shareWith = "";
              if (share.shared_with_user_id) {
                const user = users.find(
                  (u) => u.user_id === share.shared_with_user_id
                );
                shareWith = user ? user.name : "Unknown User";
              } else if (share.shared_with_department_id) {
                const dept = departments.find(
                  (d) => d.department_id === share.shared_with_department_id
                );
                shareWith = dept ? dept.name : "Unknown Department";
              }
              return `
          <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg);border-radius:8px;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:12px">
              <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent-dark));display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:12px">
                ${shareWith
                  .split(" ")
                  .map((s) => s[0])
                  .slice(0, 2)
                  .join("")
                  .toUpperCase()}
              </div>
              <div>
                <div style="font-weight:600;color:var(--text)">${shareWith}</div>
                <div class="small-muted">${
                  share.permission === "editor" ? "Editor" : "Viewer"
                }</div>
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <select onchange="updateSharePermission(${
                share.share_id
              }, this.value)" style="padding:6px;border:1px solid var(--border);border-radius:6px">
                <option value="viewer" ${
                  share.permission === "viewer" ? "selected" : ""
                }>Viewer</option>
                <option value="editor" ${
                  share.permission === "editor" ? "selected" : ""
                }>Editor</option>
              </select>
              <button class="icon-btn" onclick="removeShare(${
                share.share_id
              }, ${fileId})" title="Remove">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          </div>
        `;
            })
            .join("");
        } else {
          sharesHTML =
            '<div class="small-muted" style="text-align:center;padding:20px">No one has access. Share with users or departments below.</div>';
        }

        openModal(
          `<h3 style="display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:20px">
      <i class="fa-solid fa-share-nodes"></i> Share "${file.name}"
    </h3>
    <div style="display:flex;flex-direction:column;gap:20px">
      <!-- Edit File Option -->
      <div style="padding:12px;background:var(--accent-light);border-radius:8px;border-left:4px solid var(--accent)">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:600;color:var(--text);margin-bottom:4px">
              <i class="fa-solid fa-edit"></i> Edit File
            </div>
            <div class="small-muted">${
              canEditFile
                ? "Convert and edit this file collaboratively"
                : "You currently have view-only access to this file."
            }</div>
          </div>
          <button class="${canEditFile ? "btn-primary" : "btn-secondary"}" ${
            canEditFile ? "" : "disabled"
          } onclick="${
            canEditFile ? `openFileEditor(${fileId})` : ""
          }" style="flex-shrink:0">
            <i class="fa-solid fa-pen"></i> Edit
          </button>
        </div>
      </div>
      
      <!-- Current Shares -->
      <div>
        <div style="font-weight:600;color:var(--text);margin-bottom:12px">People with access</div>
        <div id="existingSharesList" style="max-height:200px;overflow-y:auto">
          ${sharesHTML}
        </div>
      </div>
      
      <!-- Share with User -->
      <div>
        <div style="font-weight:600;color:var(--text);margin-bottom:12px">Share with User</div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input type="text" id="shareUserSearch" placeholder="Search users..." 
                 oninput="filterShareUsers()" 
                 style="flex:1;padding:8px;border:1px solid var(--border);border-radius:6px" />
        </div>
        <div id="shareUsersList" style="max-height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;padding:8px">
          ${availableUsers
            .map(
              (u) => `
            <div class="share-user-item" data-user-id="${u.user_id}" 
                 onclick="addUserShare(${fileId}, ${
                u.user_id
              }, '${u.name.replace(/'/g, "\\'")}')"
                 style="display:flex;align-items:center;gap:12px;padding:10px;cursor:pointer;border-radius:6px;transition:background 0.2s"
                 onmouseover="this.style.background='var(--accent-light)'"
                 onmouseout="this.style.background='transparent'">
              <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent-dark));display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:12px">
                ${u.name
                  .split(" ")
                  .map((s) => s[0])
                  .slice(0, 2)
                  .join("")
                  .toUpperCase()}
              </div>
              <div style="flex:1">
                <div style="font-weight:600;color:var(--text)">${u.name}</div>
                <div class="small-muted">${u.email}</div>
              </div>
            </div>
          `
            )
            .join("")}
        </div>
      </div>
      
      <!-- Share with Department -->
      <div>
        <div style="font-weight:600;color:var(--text);margin-bottom:12px">Share with Department</div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input type="text" id="shareDeptSearch" placeholder="Search departments..." 
                 oninput="filterShareDepartments()" 
                 style="flex:1;padding:8px;border:1px solid var(--border);border-radius:6px" />
        </div>
        <div id="shareDepartmentsList" style="max-height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;padding:8px">
          ${departments
            .map(
              (d) => `
            <div class="share-dept-item" data-dept-id="${d.department_id}" 
                 onclick="addDepartmentShare(${fileId}, ${
                d.department_id
              }, '${d.name.replace(/'/g, "\\'")}')"
                 style="display:flex;align-items:center;gap:12px;padding:10px;cursor:pointer;border-radius:6px;transition:background 0.2s"
                 onmouseover="this.style.background='var(--accent-light)'"
                 onmouseout="this.style.background='transparent'">
              <div style="width:32px;height:32px;border-radius:8px;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center">
                <i class="fa-solid fa-users-rectangle"></i>
              </div>
              <div style="flex:1">
                <div style="font-weight:600;color:var(--text)">${d.name}</div>
                <div class="small-muted">Department</div>
              </div>
            </div>
          `
            )
            .join("")}
        </div>
      </div>
      
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button class="btn-secondary" onclick="closeModal()">
          <i class="fa-solid fa-xmark"></i> Close
        </button>
      </div>
    </div>`,
          "modal-large"
        );

        // Store file ID for share functions
        window.currentShareFileId = fileId;
      }

      // Filter users in share modal
      function filterShareUsers() {
        const search = document
          .getElementById("shareUserSearch")
          .value.toLowerCase();
        const items = document.querySelectorAll(".share-user-item");
        items.forEach((item) => {
          const name = item.textContent.toLowerCase();
          item.style.display = name.includes(search) ? "flex" : "none";
        });
      }

      // Filter departments in share modal
      function filterShareDepartments() {
        const search = document
          .getElementById("shareDeptSearch")
          .value.toLowerCase();
        const items = document.querySelectorAll(".share-dept-item");
        items.forEach((item) => {
          const name = item.textContent.toLowerCase();
          item.style.display = name.includes(search) ? "flex" : "none";
        });
      }

      // Add user share
      async function addUserShare(fileId, userId, userName) {
        const currentUser = await getCurrentUser();
        if (!currentUser) {
          showToast("User not found", "error");
          return;
        }

        const permission = "viewer"; // Default to viewer, can be changed later
        const result = await apiCall(`/files/${fileId}/share`, {
          method: "POST",
          body: {
            shared_with_user_id: userId,
            permission: permission,
            shared_by: currentUser.user_id,
          },
        });

        if (result && result.success) {
          showToast(`Shared with ${userName}`, "success");
          await openFileShareModal(fileId); // Refresh modal
          await renderFiles();
          await refreshStats();
        } else {
          showToast(result?.error || "Failed to share file", "error");
        }
      }

      // Add department share
      async function addDepartmentShare(fileId, deptId, deptName) {
        const currentUser = await getCurrentUser();
        if (!currentUser) {
          showToast("User not found", "error");
          return;
        }

        const permission = "viewer"; // Default to viewer
        const result = await apiCall(`/files/${fileId}/share`, {
          method: "POST",
          body: {
            shared_with_department_id: deptId,
            permission: permission,
            shared_by: currentUser.user_id,
          },
        });

        if (result && result.success) {
          showToast(`Shared with ${deptName} department`, "success");
          await openFileShareModal(fileId); // Refresh modal
          await renderFiles();
          await refreshStats();
        } else {
          showToast(result?.error || "Failed to share file", "error");
        }
      }

      // Update share permission
      async function updateSharePermission(shareId, permission) {
        const result = await apiCall(`/file-shares/${shareId}`, {
          method: "PUT",
          body: { permission: permission },
        });

        if (result && result.success) {
          showToast("Permission updated", "success");
          if (window.currentShareFileId) {
            await openFileShareModal(window.currentShareFileId);
          }
        } else {
          showToast(result?.error || "Failed to update permission", "error");
        }
      }

      // Remove share
      async function removeShare(shareId, fileId) {
        if (!confirm("Remove access for this user/department?")) return;

        const result = await apiCall(`/file-shares/${shareId}`, {
          method: "DELETE",
        });

        if (result && result.success) {
          showToast("Access removed", "success");
          await openFileShareModal(fileId);
          await renderFiles();
          await refreshStats();
        } else {
          showToast(result?.error || "Failed to remove access", "error");
        }
      }

      // Open file editor (Google Docs-style)
      async function openFileEditor(fileId) {
        const files = await getAllFiles();
        const file = files.find((f) => f.file_id === fileId);
        if (!file) {
          showToast("File not found", "error");
          return;
        }

        const editableExtensions = [
          ".txt",
          ".md",
          ".html",
          ".css",
          ".js",
          ".json",
          ".xml",
          ".csv",
        ];
        const convertedExtensions = [".pdf", ".docx"];
        const fileExt = "." + file.name.split(".").pop().toLowerCase();
        const isEditable = editableExtensions.includes(fileExt);
        const requiresConversion = convertedExtensions.includes(fileExt);

        if (!isEditable && !requiresConversion) {
          showToast(
            `"${file.name}" cannot be edited online. Please download to modify.`,
            "error"
          );
          return;
        }

        // For editable files, open in fullscreen editor
        openModal(
          `<h3 style="display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:20px;justify-content:space-between">
      <span style="display:flex;align-items:center;gap:8px">
        <i class="fa-solid fa-edit"></i> Edit "${file.name}"
      </span>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="editorStatus" class="small-muted" style="display:flex;align-items:center;gap:6px">
          <i class="fa-solid fa-circle" style="font-size:8px;color:var(--success)"></i>
          <span>Ready</span>
        </div>
        <button class="icon-btn" onclick="closeModal()" title="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    </h3>
    <div style="display:flex;flex-direction:column;gap:16px;height:calc(90vh - 100px);">
      ${
        requiresConversion
          ? `<div class="small-muted" style="background:var(--accent-light);padding:10px;border-radius:6px">
        <i class="fa-solid fa-circle-info"></i> This ${fileExt
          .toUpperCase()
          .replace(
            ".",
            ""
          )} file has been converted to plain text for editing. Formatting will be regenerated when you save.
      </div>`
          : ""
      }
      <div style="flex:1;display:flex;flex-direction:column;min-height:0">
        <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
          <button class="btn-secondary" onclick="saveFileEdit(${fileId})" style="flex-shrink:0">
            <i class="fa-solid fa-save"></i> Save Changes
          </button>
          <div class="small-muted" style="flex:1;text-align:right">
            Collaborative editing enabled - changes are saved automatically
          </div>
        </div>
        <textarea id="fileEditorContent" style="flex:1;min-height:400px;font-family:'Courier New',monospace;font-size:14px;padding:16px;border:1px solid var(--border);border-radius:6px;resize:none;width:100%;box-sizing:border-box">Loading...</textarea>
      </div>
      <div style="display:flex;gap:12px;justify-content:flex-end;border-top:1px solid var(--border);padding-top:12px">
        <button class="btn-secondary" onclick="closeModal()">
          <i class="fa-solid fa-xmark"></i> Cancel
        </button>
        <button onclick="saveFileEdit(${fileId})" class="btn-primary">
          <i class="fa-solid fa-save"></i> Save Changes
        </button>
      </div>
    </div>`,
          "modal-fullscreen"
        );

        // Load file content
        try {
          const result = await apiCall(`/files/${fileId}/content`);
          if (result && result.content !== undefined) {
            document.getElementById("fileEditorContent").value = result.content;
          } else {
            document.getElementById("fileEditorContent").value =
              "Error loading file content. Please download and edit manually.";
          }
        } catch (error) {
          console.error("Error loading file:", error);
          document.getElementById("fileEditorContent").value =
            "Error loading file content. Please download and edit manually.";
        }
      }

      // Save file edit
      async function saveFileEdit(fileId) {
        const contentElement = document.getElementById("fileEditorContent");
        if (!contentElement) {
          showToast("Editor not found", "error");
          return;
        }

        const content = contentElement.value;
        const statusElement = document.getElementById("editorStatus");

        // Update status to saving
        if (statusElement) {
          statusElement.innerHTML =
            '<i class="fa-solid fa-circle" style="font-size:8px;color:var(--warning)"></i><span>Saving...</span>';
        }

        try {
          const result = await apiCall(`/files/${fileId}/edit`, {
            method: "POST",
            body: { content: content },
          });

          if (result && result.success) {
            // Update status to saved
            if (statusElement) {
              statusElement.innerHTML =
                '<i class="fa-solid fa-circle" style="font-size:8px;color:var(--success)"></i><span>Saved</span>';
              setTimeout(() => {
                if (statusElement) {
                  statusElement.innerHTML =
                    '<i class="fa-solid fa-circle" style="font-size:8px;color:var(--success)"></i><span>Ready</span>';
                }
              }, 2000);
            }
            showToast("File saved successfully", "success");
            await renderFiles();
          } else {
            if (statusElement) {
              statusElement.innerHTML =
                '<i class="fa-solid fa-circle" style="font-size:8px;color:var(--danger)"></i><span>Error</span>';
            }
            showToast(result?.error || "Failed to save file", "error");
          }
        } catch (error) {
          console.error("Error saving file:", error);
          if (statusElement) {
            statusElement.innerHTML =
              '<i class="fa-solid fa-circle" style="font-size:8px;color:var(--danger)"></i><span>Error</span>';
          }
          showToast("Failed to save file. Please try again.", "error");
        }
      }

      // File rename functionality
      function startRenameFile(fileId, currentNameElement) {
        const currentName = currentNameElement.textContent.trim();
        const input = document.createElement("input");
        input.type = "text";
        input.className = "doc-name-input";
        input.value = currentName;

        // Store the original name for extension preservation
        input.setAttribute("data-original-name", currentName);

        // Replace the name element with input
        currentNameElement.replaceWith(input);
        input.focus();
        input.select();

        // Handle Enter key - confirm rename
        input.addEventListener("keydown", async (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            await confirmRename(fileId, input.value.trim(), currentName, input);
          } else if (e.key === "Escape") {
            e.preventDefault();
            cancelRename(input, currentName, currentNameElement);
          }
        });

        // Handle blur - cancel if not confirmed
        let confirmed = false;
        input.addEventListener("blur", async () => {
          if (!confirmed) {
            await confirmRename(fileId, input.value.trim(), currentName, input);
          }
        });
      }

      // Start rename from edit button
      async function startRenameFileFromButton(fileId) {
        const files = await getAllFiles();
        const file = files.find((f) => f.file_id === fileId);
        if (!file) {
          showToast("File not found", "error");
          return;
        }

        // Find the name element in the DOM
        const fileDiv = document.querySelector(
          `.doc-adaptive[data-file-id="${fileId}"]`
        );
        if (!fileDiv) {
          showToast("File element not found", "error");
          return;
        }

        const nameElement = fileDiv.querySelector(".doc-name");
        if (nameElement) {
          startRenameFile(fileId, nameElement);
        } else {
          showToast("Could not find filename element", "error");
        }
      }

      async function confirmRename(
        fileId,
        newName,
        originalName,
        inputElement
      ) {
        if (!newName || newName === originalName) {
          // User didn't change the name or cancelled
          cancelRename(inputElement, originalName);
          return;
        }

        // Validate filename
        if (newName.length === 0) {
          showToast("Filename cannot be empty", "error");
          inputElement.focus();
          return;
        }

        // Get the current file to preserve extension
        const files = await getAllFiles();
        const currentFile = files.find((f) => f.file_id === fileId);
        if (!currentFile) {
          showToast("File not found", "error");
          cancelRename(inputElement, originalName);
          return;
        }

        // Preserve file extension if user didn't include it
        let finalName = newName.trim();

        // Extract extension from original filename
        let originalExtension = "";
        if (originalName.includes(".")) {
          const lastDotIndex = originalName.lastIndexOf(".");
          if (lastDotIndex > 0) {
            // Ensure dot is not at the start
            originalExtension = originalName.substring(lastDotIndex);
          }
        }

        // Check if new name has an extension (has a dot that's not at the start or end)
        const hasExtension =
          finalName.includes(".") &&
          finalName.lastIndexOf(".") > 0 &&
          finalName.lastIndexOf(".") < finalName.length - 1;

        // If user didn't include extension and original had one, preserve it
        if (!hasExtension && originalExtension) {
          finalName = finalName + originalExtension;
        }

        const userFiles = files.filter(
          (f) =>
            f.user_id === currentFile.user_id &&
            f.status === "active" &&
            f.file_id !== fileId
        );
        const existingFile = userFiles.find((f) => f.name === finalName);

        if (existingFile) {
          // File with this name exists - show overwrite confirmation
          showOverwriteDialog(
            fileId,
            finalName,
            originalName,
            inputElement,
            existingFile
          );
        } else {
          // Name is unique - proceed with rename
          await performRename(fileId, finalName, originalName, inputElement);
        }
      }

      function showOverwriteDialog(
        fileId,
        newName,
        originalName,
        inputElement,
        existingFile
      ) {
        const dialog = `
      <h3>File already exists</h3>
      <p style="margin: 20px 0;">A file with this name already exists. Do you want to replace it?</p>
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn-secondary" onclick="window.cancelOverwriteRename()">Cancel</button>
        <button onclick="window.proceedOverwriteRename(${fileId}, '${newName.replace(
          /'/g,
          "\\'"
        )}', '${originalName.replace(/'/g, "\\'")}')">Overwrite</button>
      </div>
    `;

        // Store context for overwrite
        window._renameContext = { fileId, newName, originalName, inputElement };

        openModal(dialog);
      }

      window.proceedOverwriteRename = async function (
        fileId,
        newName,
        originalName
      ) {
        closeModal();
        const context = window._renameContext;
        if (context) {
          await performRename(
            fileId,
            newName,
            originalName,
            context.inputElement,
            true
          );
          delete window._renameContext;
        }
      };

      window.cancelOverwriteRename = function () {
        closeModal();
        const context = window._renameContext;
        if (context) {
          cancelRename(context.inputElement, context.originalName);
          delete window._renameContext;
        }
      };

      async function performRename(
        fileId,
        newName,
        originalName,
        inputElement,
        isOverwrite = false
      ) {
        try {
          await renameFileRequest(fileId, newName);

          // Update the UI
          const nameElement = document.createElement("div");
          nameElement.className = "doc-name";
          nameElement.textContent = newName;
          nameElement.onclick = (e) => {
            e.stopPropagation();
            startRenameFile(fileId, nameElement);
          };

          inputElement.replaceWith(nameElement);

          if (isOverwrite) {
            showToast("File successfully overwritten.", "success");
          } else {
            showToast("File renamed successfully", "success");
          }

          // Refresh views
          await renderFiles();
          if (typeof renderWorkspaceFiles === "function") {
            await renderWorkspaceFiles();
          }
          await refreshStats();

          // Log activity
          const currentUser = await getCurrentUser();
          if (currentUser) {
            await logActivity({
              user_id: currentUser.user_id,
              activity: `Renamed file from "${originalName}" to "${newName}"`,
            });
          }
        } catch (error) {
          console.error("Rename error:", error);
          showToast(`Failed to rename: ${error.message}`, "error");
          cancelRename(inputElement, originalName);
        }
      }

      async function renameFileRequest(fileId, newName) {
        const response = await authFetch(
          `${API_BASE_URL}/files/${fileId}/rename`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ new_name: newName }),
          }
        );

        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result?.error || "Failed to rename file");
        }
        return result;
      }

      function cancelRename(inputElement, originalName) {
        const nameElement = document.createElement("div");
        nameElement.className = "doc-name";
        nameElement.textContent = originalName;

        // Get fileId from the parent element
        const fileDiv = inputElement.closest(".doc-adaptive");
        if (fileDiv) {
          const fileId = fileDiv.getAttribute("data-file-id");
          if (fileId) {
            nameElement.onclick = (e) => {
              e.stopPropagation();
              startRenameFile(parseInt(fileId), nameElement);
            };
          }
        }

        inputElement.replaceWith(nameElement);
      }

      function openRenameFromPreview(fileId, currentName) {
        closeModal();
        const safeName = currentName.replace(/"/g, "&quot;");
        openModal(`<h3>Rename File</h3>
    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="form-row">
        <label>New Filename</label>
        <input id="previewRenameInput" value="${safeName}" placeholder="Enter new filename"/>
      </div>
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button class="btn-secondary" onclick="closeModal()">
          <i class="fa-solid fa-xmark"></i> Cancel
        </button>
        <button onclick="confirmPreviewRename(${fileId}, '${currentName.replace(
          /'/g,
          "\\'"
        )}')">
          <i class="fa-solid fa-check"></i> Rename
        </button>
      </div>
    </div>`);
      }

      async function confirmPreviewRename(fileId, originalName) {
        const input = document.getElementById("previewRenameInput");
        if (!input) return;
        const newName = input.value.trim();
        if (!newName) {
          showToast("Filename cannot be empty", "error");
          return;
        }
        try {
          await renameFileRequest(fileId, newName);
          showToast("File renamed successfully", "success");
          closeModal();
          await renderFiles();
          await refreshStats();
          const currentUser = await getCurrentUser();
          if (currentUser) {
            await logActivity({
              user_id: currentUser.user_id,
              activity: `Renamed file from "${originalName}" to "${newName}"`,
            });
          }
          await openFilePreview(fileId);
        } catch (error) {
          console.error("Preview rename error:", error);
          showToast(error.message || "Failed to rename file", "error");
        }
      }

      // Start rename from edit button
      async function startRenameFileFromButton(fileId) {
        const files = await getAllFiles();
        const file = files.find((f) => f.file_id === fileId);
        if (!file) {
          showToast("File not found", "error");
          return;
        }

        // Find the name element in the DOM
        const fileDiv = document.querySelector(
          `.doc-adaptive[data-file-id="${fileId}"]`
        );
        if (!fileDiv) {
          showToast("File element not found", "error");
          return;
        }

        const nameElement = fileDiv.querySelector(".doc-name");
        if (nameElement) {
          startRenameFile(fileId, nameElement);
        } else {
          showToast("Could not find filename element", "error");
        }
      }

      // Bulk operations functions
      function updateBulkActionsBar() {
        const checkboxes = document.querySelectorAll(".doc-checkbox:checked");
        const selectedCount = checkboxes.length;
        const bulkBar = document.getElementById("bulkActionsBar");
        const countSpan = document.getElementById("selectedCount");

        if (countSpan) {
          countSpan.textContent = `${selectedCount} selected`;
        }

        if (bulkBar) {
          if (selectedCount > 0) {
            bulkBar.classList.add("visible");
          } else {
            bulkBar.classList.remove("visible");
          }
        }
      }

      function getSelectedFileIds() {
        const checkboxes = document.querySelectorAll(".doc-checkbox:checked");
        return Array.from(checkboxes).map((cb) =>
          parseInt(cb.getAttribute("data-file-id"))
        );
      }

      function clearSelection() {
        const checkboxes = document.querySelectorAll(".doc-checkbox");
        checkboxes.forEach((cb) => (cb.checked = false));
        updateBulkActionsBar();
      }

      async function bulkDownload() {
        const fileIds = getSelectedFileIds();
        if (fileIds.length === 0) {
          showToast("No files selected", "error");
          return;
        }

        showToast(`Downloading ${fileIds.length} file(s)...`, "info");

        // Fetch all files once to get filenames
        let filesMap = new Map();
        try {
          const files = await getAllFiles();
          files.forEach((file) => {
            if (file && file.file_id) {
              filesMap.set(file.file_id, file);
            }
          });
        } catch (error) {
          console.warn("Could not fetch file info, will use fallback names");
        }

        for (const fileId of fileIds) {
          try {
            await downloadFileDirectly(fileId, filesMap);
            // Small delay between downloads to avoid browser blocking
            await new Promise((resolve) => setTimeout(resolve, 500));
          } catch (error) {
            console.error(`Error downloading file ${fileId}:`, error);
          }
        }

        clearSelection();
        showToast(`Downloaded ${fileIds.length} file(s)`, "success");
      }

      async function downloadFileDirectly(fileId, filesMap = null) {
        // Get the file information to get the actual filename
        let filename = `file_${fileId}`;

        if (filesMap && filesMap.has(fileId)) {
          const file = filesMap.get(fileId);
          if (file && file.name) {
            filename = file.name;
          }
        } else {
          // Fallback: fetch file info if not provided
          try {
            const files = await getAllFiles();
            const file = files.find((f) => f.file_id === fileId);
            if (file && file.name) {
              filename = file.name;
            }
          } catch (error) {
            console.warn(
              `Could not fetch file info for ${fileId}, using fallback name`
            );
          }
        }

        const response = await authFetch(
          `${API_BASE_URL}/download-file/${fileId}`
        );

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || "Download failed");
        }

        // Try to get filename from Content-Disposition header as backup
        const contentDisposition = response.headers.get("Content-Disposition");
        if (contentDisposition) {
          const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
          if (filenameMatch && filenameMatch[1]) {
            filename = filenameMatch[1];
          }
        }

        const blob = await response.blob();

        if (blob.size === 0) {
          throw new Error("File is empty or not found");
        }

        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }

      async function bulkAddToWorkspace() {
        const fileIds = getSelectedFileIds();
        if (fileIds.length === 0) {
          showToast("No files selected", "error");
          return;
        }

        // Use the existing add to workspace modal but for multiple files
        openBulkAddToWorkspaceModal(fileIds);
      }

      function openBulkAddToWorkspaceModal(fileIds) {
        getAllWorkspaces().then((workspaces) => {
          if (workspaces.length === 0) {
            showToast("No workspaces available", "error");
            return;
          }

          let workspaceOptions = workspaces
            .map(
              (w) => `
        <div class="checkbox-option" style="display:flex;align-items:center;gap:10px;padding:8px;border-radius:6px;cursor:pointer;transition:background 0.2s;" 
             onmouseover="this.style.background='var(--bg-hover)'" 
             onmouseout="this.style.background='transparent'">
          <input type="checkbox" id="bulk_workspace_${w.workspace_id}" value="${w.workspace_id}" style="margin:0;width:16px;height:16px;">
          <label for="bulk_workspace_${w.workspace_id}" style="cursor:pointer;margin:0;flex:1;display:flex;align-items:center;gap:10px;">
            <i class="fa-solid fa-layer-group"></i>
            <span>${w.name}</span>
          </label>
        </div>
      `
            )
            .join("");

          const modalContent = `
        <h3>Add ${fileIds.length} File(s) to Workspace</h3>
        <div style="margin: 20px 0;">
          <div id="bulkWorkspaceCheckboxes" style="max-height:200px;overflow-y:auto;padding:8px;border:1px solid var(--border);border-radius:8px;">
            ${workspaceOptions}
          </div>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button class="btn-secondary" onclick="closeModal()">Cancel</button>
          <button onclick="confirmBulkAddToWorkspace([${fileIds.join(
            ","
          )}])">Add to Workspace</button>
        </div>
      `;

          openModal(modalContent);
        });
      }

      async function confirmBulkAddToWorkspace(fileIds) {
        const selectedCheckboxes = document.querySelectorAll(
          '#bulkWorkspaceCheckboxes input[type="checkbox"]:checked'
        );
        const workspaceIds = Array.from(selectedCheckboxes).map((cb) =>
          parseInt(cb.value)
        );

        if (workspaceIds.length === 0) {
          showToast("Please select at least one workspace", "error");
          return;
        }

        closeModal();
        showToast(
          `Adding ${fileIds.length} file(s) to ${workspaceIds.length} workspace(s)...`,
          "info"
        );

        let successCount = 0;
        let errorCount = 0;

        for (const fileId of fileIds) {
          try {
            const result = await updateFileWorkspacesBulk(fileId, workspaceIds);
            if (result && result.success) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error(`Error adding file ${fileId} to workspaces:`, error);
            errorCount++;
          }
        }

        clearSelection();

        if (successCount > 0) {
          showToast(
            `Successfully added ${successCount} file(s) to workspace(s)`,
            "success"
          );
        }
        if (errorCount > 0) {
          showToast(`${errorCount} file(s) failed to add`, "error");
        }

        await refreshAllViews();
      }

      async function bulkArchive() {
        const fileIds = getSelectedFileIds();
        if (fileIds.length === 0) {
          showToast("No files selected", "error");
          return;
        }

        const confirmMessage = `Are you sure you want to archive ${fileIds.length} file(s)?`;
        if (!confirm(confirmMessage)) {
          return;
        }

        showToast(`Archiving ${fileIds.length} file(s)...`, "info");

        let successCount = 0;
        let errorCount = 0;

        for (const fileId of fileIds) {
          try {
            const result = await archiveFile(fileId);
            if (result && result.success) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error(`Error archiving file ${fileId}:`, error);
            errorCount++;
          }
        }

        clearSelection();

        if (successCount > 0) {
          showToast(`Successfully archived ${successCount} file(s)`, "success");
        }
        if (errorCount > 0) {
          showToast(`${errorCount} file(s) failed to archive`, "error");
        }

        await refreshAllViews();
        await refreshStats();
      }

      // Enhanced download function with rename option
      async function downloadFile(fileId) {
        try {
          const files = await getAllFiles();
          const file = files.find((f) => f.file_id === fileId);
          if (!file) {
            showToast("File not found", "error");
            return;
          }

          const originalFilename = file.name;

          // Show download dialog with rename option
          const downloadDialog = `
            <h3>Download File</h3>
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Filename:</label>
                <input type="text" id="downloadFilenameInput" value="${originalFilename}" 
                       style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 6px; font-size: 14px;"
                       onkeydown="if(event.key === 'Enter') document.getElementById('downloadConfirmBtn').click(); if(event.key === 'Escape') closeModal();">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button id="downloadConfirmBtn" onclick="confirmDownload(${fileId})">Download</button>
            </div>
        `;

          openModal(downloadDialog);

          // Focus and select filename
          setTimeout(() => {
            const input = document.getElementById("downloadFilenameInput");
            if (input) {
              input.focus();
              input.select();
            }
          }, 100);
        } catch (error) {
          console.error("Download error:", error);
          showToast(`Download failed: ${error.message}`, "error");
        }
      }

      async function confirmDownload(fileId) {
        try {
          const downloadFilenameInput = document.getElementById(
            "downloadFilenameInput"
          );
          if (!downloadFilenameInput) {
            showToast("Download dialog not found", "error");
            return;
          }

          const downloadFilename = downloadFilenameInput.value.trim();

          if (!downloadFilename) {
            showToast("Please enter a filename", "error");
            return;
          }

          const files = await getAllFiles();
          const file = files.find((f) => f.file_id === fileId);
          if (!file) {
            showToast("File not found", "error");
            closeModal();
            return;
          }

          const originalFilename = file.name;
          let finalName = downloadFilename;

          // If user didn't change the name, use original
          if (downloadFilename === originalFilename) {
            finalName = originalFilename;
          } else {
            // User edited the name - ensure it has extension
            if (!finalName.includes(".")) {
              // If no extension, add the original extension
              const ext = originalFilename.split(".").pop();
              if (ext) finalName = `${finalName}.${ext}`;
            }
          }

          // Note: We cannot check if file exists in user's download folder due to browser security.
          // The browser will automatically add (1), (2), (3) etc. if a file with that name already exists.

          showToast("Preparing download...", "info");
          closeModal();

          const response = await authFetch(
            `${API_BASE_URL}/download-file/${fileId}`
          );

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || "Download failed");
          }

          // Create blob and download link
          const blob = await response.blob();

          // Check if blob is empty
          if (blob.size === 0) {
            throw new Error("File is empty or not found");
          }

          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = finalName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          showToast("File downloaded successfully", "success");

          // Log download activity
          const currentUser = await getCurrentUser();
          if (currentUser && file) {
            await logActivity({
              user_id: currentUser.user_id,
              activity: `Downloaded ${finalName}`,
            });
          }
        } catch (error) {
          console.error("Download error:", error);
          showToast(`Download failed: ${error.message}`, "error");
        }
      }

      // Enhanced move to archive function with confirmation
      async function moveToArchive(fileId) {
        console.log(`DEBUG: moveToArchive called for file ${fileId}`);

        const files = await getAllFiles();
        const file = files.find((f) => f.file_id === fileId);

        if (!file) {
          showToast("File not found", "error");
          return;
        }

        const fileName = file.original_name || file.name;

        openModal(`<h3>Archive File</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="small-muted">
                Are you sure you want to archive <strong>"${fileName}"</strong>?
            </div>
            <div class="small-muted">
                Archived files will be moved to the Archives section and can be restored later.
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i> Cancel
                </button>
                <button class="btn-danger" onclick="confirmArchiveFile(${fileId})">
                    <i class="fa-solid fa-box-archive"></i> Move to Archive
                </button>
            </div>
        </div>`);
      }

      // Function to get unique file types from all files
      function getUniqueFileExtensions(files) {
        const extensions = new Set();
        if (files && files.length > 0) {
          files.forEach((file) => {
            if (file.name) {
              const extension = getFileExtension(file.name);
              if (extension) {
                extensions.add(extension.toLowerCase());
              }
            }
          });
        }
        return Array.from(extensions).sort();
      }

      // Function to populate the file type dropdown
      function populateFileTypeDropdown(files) {
        const filterTypeSelect = document.getElementById("filterType");
        if (!filterTypeSelect) return;

        // Store current selection
        const currentSelection = filterTypeSelect.value;

        // Clear existing options except the first one
        while (filterTypeSelect.options.length > 1) {
          filterTypeSelect.remove(1);
        }

        // Get unique file extensions from actual files
        const fileExtensions = getUniqueFileExtensions(files);

        // Add file extension options
        fileExtensions.forEach((ext) => {
          if (ext) {
            // Only add if extension exists
            const option = document.createElement("option");
            option.value = ext;
            option.textContent = ext.toUpperCase();
            filterTypeSelect.appendChild(option);
          }
        });

        // Restore previous selection if it still exists
        if (currentSelection && fileExtensions.includes(currentSelection)) {
          filterTypeSelect.value = currentSelection;
        }
      }

      // Function to get file extension from filename
      function getFileExtension(filename) {
        const parts = filename.split(".");
        if (parts.length > 1) {
          return parts.pop().toLowerCase();
        }
        return ""; // No extension
      }

      // Update the renderFiles function to handle the dropdown filter
      async function renderFiles() {
        // Prevent multiple simultaneous renders
        if (isRenderingFiles) {
          console.log("DEBUG: renderFiles already in progress, skipping...");
          return;
        }

        isRenderingFiles = true;

        try {
          const grid = document.getElementById("filesGrid");
          if (!grid) {
            console.warn("DEBUG: filesGrid not found");
            return;
          }

          // Clear grid immediately
          grid.innerHTML = "";

          const files = await getAllFiles();

          // Populate the file type dropdown with current files
          populateFileTypeDropdown(files);

          // Deduplicate files by file_id to prevent duplicates
          const uniqueFiles = [];
          const seenIds = new Set();
          for (const file of files || []) {
            if (file && file.file_id && !seenIds.has(file.file_id)) {
              seenIds.add(file.file_id);
              uniqueFiles.push(file);
            }
          }

          const filterSelect = document.getElementById("filterType");
          const filter = filterSelect ? filterSelect.value : "";
          const sort = document.getElementById("sortFiles")?.value || "new";

          // Only show active files (not archived or deleted)
          let filteredFiles = uniqueFiles.filter((f) => f.status === "active");

          if (filter) {
            filteredFiles = filteredFiles.filter(
              (f) => f.type && f.type.toLowerCase() === filter.toLowerCase()
            );
          }

          if (sort === "new")
            filteredFiles.sort(
              (a, b) => new Date(b.created_at) - new Date(a.created_at)
            );
          if (sort === "old")
            filteredFiles.sort(
              (a, b) => new Date(a.created_at) - new Date(b.created_at)
            );
          if (sort === "name_asc")
            filteredFiles.sort((a, b) => a.name.localeCompare(b.name));
          if (sort === "name_desc")
            filteredFiles.sort((a, b) => b.name.localeCompare(a.name));

          if (!filteredFiles.length) {
            grid.innerHTML =
              '<div class="card small-muted" style="text-align:center;padding:40px">No documents found</div>';
            return;
          }

          for (const f of filteredFiles) {
            const div = document.createElement("div");
            div.className = "doc-adaptive";
            div.setAttribute("data-file-id", f.file_id);
            div.onclick = () => openFilePreview(f.file_id);
            const accessLabel = getPermissionLabel(f.current_user_permission);
            const canEdit = !!f.can_edit;
            const canRename = !!f.can_edit;
            const canManageShare = ["owner", "admin"].includes(
              f.current_user_permission
            );
            div.innerHTML = `
                <input type="checkbox" class="doc-checkbox" data-file-id="${
                  f.file_id
                }" 
                       onclick="event.stopPropagation(); updateBulkActionsBar()" 
                       onchange="updateBulkActionsBar()">
                <div class="doc-header">
                    <div class="doc-icon">${fileIcon(f.name)}</div>
                    <div class="doc-info">
                        <div class="doc-name" onclick="event.stopPropagation(); startRenameFile(${
                          f.file_id
                        }, this)">${f.name}</div>
                        <div class="doc-meta">${
                          (f.size / 1024) | 0
                        } KB  ${new Date(f.created_at).toLocaleString()}</div>
                        ${
                          accessLabel
                            ? `<div class="small-muted">Access: ${accessLabel}</div>`
                            : ""
                        }
                    </div>
                </div>
                <div class="doc-actions">
                    ${
                      canEdit
                        ? `
                    <button class="icon-btn" title="Edit Online" onclick="event.stopPropagation(); openFileEditor(${f.file_id})">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </button>`
                        : ""
                    }
                    ${
                      canRename
                        ? `
                    <button class="icon-btn" title="Rename" onclick="event.stopPropagation(); startRenameFileFromButton(${f.file_id})">
                        <i class="fa-solid fa-pen"></i>
                    </button>`
                        : ""
                    }
                    <button class="icon-btn" ${
                      canManageShare
                        ? ""
                        : 'style="opacity:0.4;cursor:not-allowed"'
                    } ${
              canManageShare
                ? `onclick="event.stopPropagation(); openFileShareModal(${f.file_id})"`
                : 'onclick="event.stopPropagation();"'
            } title="${
              canManageShare ? "Manage Sharing" : "Shared access (view only)"
            }">
                        ${
                          f.shared
                            ? '<i class="fa-solid fa-link"></i>'
                            : '<i class="fa-regular fa-circle"></i>'
                        }
                    </button>
                    <button class="icon-btn" onclick="event.stopPropagation(); downloadFile(${
                      f.file_id
                    })">
                        <i class="fa-solid fa-download"></i>
                    </button>
                    <button class="icon-btn" title="Manage Workspaces" onclick="event.stopPropagation(); openAddToWorkspaceModal(${
                      f.file_id
                    })">
                        <i class="fa-solid fa-layer-group"></i>
                    </button>
                    <button class="icon-btn" title="Archive" onclick="event.stopPropagation(); moveToArchive(${
                      f.file_id
                    })">
                        <i class="fa-solid fa-box-archive"></i>
                    </button>
                </div>
            `;
            grid.appendChild(div);
          }

          // Add bulk actions bar if not exists
          if (!document.getElementById("bulkActionsBar")) {
            const bulkBar = document.createElement("div");
            bulkBar.id = "bulkActionsBar";
            bulkBar.className = "bulk-actions-bar";
            bulkBar.innerHTML = `
                <span class="selected-count" id="selectedCount">0 selected</span>
                <button class="btn-secondary" onclick="bulkDownload()">
                    <i class="fa-solid fa-download"></i> Download
                </button>
                <button class="btn-secondary" onclick="bulkAddToWorkspace()">
                    <i class="fa-solid fa-layer-group"></i> Add to Workspace
                </button>
                <button class="btn-secondary" onclick="bulkArchive()">
                    <i class="fa-solid fa-box-archive"></i> Archive
                </button>
                <button class="btn-secondary" onclick="clearSelection()">
                    <i class="fa-solid fa-xmark"></i> Clear
                </button>
            `;
            document.body.appendChild(bulkBar);
          }

          updateBulkActionsBar();
        } catch (error) {
          console.error("DEBUG: Error in renderFiles:", error);
        } finally {
          isRenderingFiles = false;
        }
      }

      // Function to refresh all views automatically
      async function refreshAllViews() {
        console.log("DEBUG: Refreshing all views...");

        try {
          // Refresh stats first
          await refreshStats();
          console.log("DEBUG: Stats refreshed");

          // Refresh current view based on what's active
          if (currentView === "library") {
            // Get files and populate dropdown before rendering
            const files = await getAllFiles();
            populateFileTypeDropdown(files);
            await renderFiles();
            console.log("DEBUG: Library view refreshed");
          } else if (currentView === "workspace-detail" && currentWorkspaceId) {
            await renderWorkspaceDetail();
            console.log("DEBUG: Workspace detail view refreshed");
          } else if (currentView === "archives") {
            await renderArchives();
            console.log("DEBUG: Archives view refreshed");
          } else if (currentView === "workspaces") {
            await renderWorkspaces();
            console.log("DEBUG: Workspaces view refreshed");
          }

          // Also refresh dashboard if it's active
          if (currentView === "dashboard") {
            await renderDashboard();
            console.log("DEBUG: Dashboard refreshed");
          }

          console.log("DEBUG: All views refreshed successfully");
        } catch (error) {
          console.error("DEBUG: Error refreshing views:", error);
        }
      }

      // Updated Add to Workspace function with checkboxes
      async function openAddToWorkspaceModal(fileId) {
        const workspaces = await getAllWorkspaces();
        const currentUser = await getCurrentUser();

        if (!currentUser) {
          showToast("Please log in first", "error");
          return;
        }

        // Filter workspaces where current user is a member
        const userWorkspaces = workspaces.filter((w) => {
          return (
            w.members &&
            Array.isArray(w.members) &&
            w.members.includes(currentUser.user_id)
          );
        });

        if (!userWorkspaces.length) {
          showToast(
            "You are not a member of any workspaces. Please create a workspace first or ask to be added to one.",
            "error"
          );
          return;
        }

        // Get current workspaces for this file
        const fileWorkspaces = await getFileWorkspaces(fileId);
        const fileWorkspaceIds = fileWorkspaces.map((w) => w.workspace_id);

        console.log(
          `DEBUG: File ${fileId} is currently in workspaces:`,
          fileWorkspaceIds
        );

        const workspaceCheckboxes = userWorkspaces
          .map((w) => {
            const isInWorkspace = fileWorkspaceIds.includes(w.workspace_id);
            return `
                <div class="checkbox-option" style="display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;cursor:pointer;${
                  isInWorkspace ? "background:var(--accent-light);" : ""
                }">
                    <input type="checkbox" id="workspace_${
                      w.workspace_id
                    }" value="${w.workspace_id}" ${
              isInWorkspace ? "checked" : ""
            } data-was-checked="${isInWorkspace}" style="margin:0;width:16px;height:16px;">
                    <label for="workspace_${
                      w.workspace_id
                    }" style="cursor:pointer;margin:0;flex:1;display:flex;align-items:center;gap:10px;">
                        <div style="width:32px;height:32px;border-radius:8px;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center;">
                            <i class="fa-solid fa-layer-group"></i>
                        </div>
                        <div>
                            <div style="font-weight:600;color:var(--text)">${
                              w.name
                            }</div>
                            <div class="small-muted">${
                              w.description || "No description"
                            }</div>
                            ${
                              isInWorkspace
                                ? '<div class="small-muted" style="color:var(--success);"><i class="fa-solid fa-check"></i> File already in this workspace</div>'
                                : ""
                            }
                        </div>
                    </label>
                </div>
            `;
          })
          .join("");

        openModal(`<h3>Manage File in Workspaces</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="form-row">
                <label>Select workspaces to add/remove this file:</label>
                <div id="workspaceCheckboxesContainer" style="max-height:300px;overflow-y:auto;padding:8px;border:1px solid var(--border);border-radius:8px;">
                    ${workspaceCheckboxes}
                </div>
                <div class="small-muted" style="margin-top:8px;">
                    <i class="fa-solid fa-circle-info"></i> 
                    Checked = File will be in workspace, Unchecked = File will be removed from workspace
                </div>
            </div>
            
            <div id="selectedWorkspacesSummary" style="display:none;background:var(--accent-light);padding:12px;border-radius:8px;border-left:4px solid var(--accent);">
                <div style="font-weight:600;color:var(--accent);margin-bottom:4px;">Will be in these workspaces:</div>
                <div id="selectedWorkspacesList" class="small-muted"></div>
            </div>

            <div id="removedWorkspacesSummary" style="display:none;background:var(--warning-light);padding:12px;border-radius:8px;border-left:4px solid var(--warning);">
                <div style="font-weight:600;color:var(--warning);margin-bottom:4px;">Will be removed from these workspaces:</div>
                <div id="removedWorkspacesList" class="small-muted"></div>
            </div>
            
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i> Cancel
                </button>
                <button onclick="updateFileWorkspaces(${fileId})">
                    <i class="fa-solid fa-layer-group"></i> Update Workspaces
                </button>
            </div>
        </div>`);

        // Add click handlers for checkboxes
        document.querySelectorAll(".checkbox-option").forEach((option) => {
          option.addEventListener("click", function (e) {
            if (e.target.type !== "checkbox") {
              const checkbox = this.querySelector('input[type="checkbox"]');
              checkbox.checked = !checkbox.checked;
              updateWorkspacesSummary();
            }
          });
        });

        // Add change handlers for checkboxes
        document
          .querySelectorAll(
            '#workspaceCheckboxesContainer input[type="checkbox"]'
          )
          .forEach((checkbox) => {
            checkbox.addEventListener("change", updateWorkspacesSummary);
          });

        // Initial summary update
        updateWorkspacesSummary();
      }
      // to get file workspaces
      async function getFileWorkspaces(fileId) {
        try {
          const response = await authFetch(
            `${API_BASE_URL}/files/${fileId}/workspaces`
          );
          if (response.ok) {
            return await response.json();
          }
          return [];
        } catch (error) {
          console.error("Error getting file workspaces:", error);
          return [];
        }
      }

      // Function to update the selected workspaces summary
      function updateWorkspacesSummary() {
        const allCheckboxes = document.querySelectorAll(
          '#workspaceCheckboxesContainer input[type="checkbox"]'
        );
        const selectedCheckboxes = document.querySelectorAll(
          '#workspaceCheckboxesContainer input[type="checkbox"]:checked'
        );
        const unselectedCheckboxes = document.querySelectorAll(
          '#workspaceCheckboxesContainer input[type="checkbox"]:not(:checked)'
        );

        const summaryContainer = document.getElementById(
          "selectedWorkspacesSummary"
        );
        const selectedList = document.getElementById("selectedWorkspacesList");
        const removedContainer = document.getElementById(
          "removedWorkspacesSummary"
        );
        const removedList = document.getElementById("removedWorkspacesList");

        // Get workspace names for selected (will be in workspace)
        const selectedNames = Array.from(selectedCheckboxes).map((checkbox) => {
          const label = checkbox
            .closest(".checkbox-option")
            .querySelector("label");
          return label.querySelector("div > div:first-child").textContent;
        });

        // Get workspace names for unselected that were previously checked (will be removed)
        const removedNames = Array.from(unselectedCheckboxes)
          .map((checkbox) => {
            const wasPreviouslyChecked =
              checkbox.getAttribute("data-was-checked") === "true";
            if (wasPreviouslyChecked) {
              const label = checkbox
                .closest(".checkbox-option")
                .querySelector("label");
              return label.querySelector("div > div:first-child").textContent;
            }
            return null;
          })
          .filter((name) => name !== null);

        console.log(`DEBUG: Selected workspaces:`, selectedNames);
        console.log(`DEBUG: Removed workspaces:`, removedNames);

        // Update selected summary
        if (selectedNames.length > 0) {
          selectedList.innerHTML = selectedNames
            .map((name) => ` ${name}`)
            .join("<br>");
          summaryContainer.style.display = "block";
        } else {
          summaryContainer.style.display = "none";
        }

        // Update removed summary
        if (removedNames.length > 0) {
          removedList.innerHTML = removedNames
            .map((name) => ` ${name}`)
            .join("<br>");
          removedContainer.style.display = "block";
        } else {
          removedContainer.style.display = "none";
        }
      }

      // Function to add file to multiple workspaces
      async function updateFileWorkspaces(fileId) {
        const allCheckboxes = document.querySelectorAll(
          '#workspaceCheckboxesContainer input[type="checkbox"]'
        );
        const currentUser = await getCurrentUser();

        if (!currentUser) {
          showToast("Please log in first", "error");
          return;
        }

        try {
          showToast("Updating file workspaces...", "info");

          // Get selected workspace IDs
          const selectedWorkspaceIds = Array.from(allCheckboxes)
            .filter((checkbox) => checkbox.checked)
            .map((checkbox) => parseInt(checkbox.value));

          console.log(
            `DEBUG: Updating file ${fileId} to workspaces:`,
            selectedWorkspaceIds
          );

          // Use the new bulk update endpoint
          const result = await updateFileWorkspacesBulk(
            fileId,
            selectedWorkspaceIds
          );

          if (result && result.success) {
            showToast("Workspaces updated successfully", "success");
            closeModal();

            // Refresh ALL views
            await refreshAllViews();

            // Log activity
            const files = await getAllFiles();
            const file = files.find((f) => f.file_id === fileId);
            if (currentUser && file) {
              await logActivity({
                user_id: currentUser.user_id,
                activity: `Updated workspaces for "${
                  file.original_name || file.name
                }"`,
              });
            }
          } else {
            showToast(result.error || "Failed to update workspaces", "error");
          }
        } catch (error) {
          console.error("Error updating file workspaces:", error);
          showToast("Error updating workspaces", "error");
        }
      }

      // Add this new function for bulk updates
      async function updateFileWorkspacesBulk(fileId, workspaceIds) {
        try {
          const response = await authFetch(
            `${API_BASE_URL}/files/${fileId}/update-workspaces`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ workspace_ids: workspaceIds }),
            }
          );

          if (response.ok) {
            return await response.json();
          } else {
            const error = await response.json();
            return { success: false, error: error.error };
          }
        } catch (error) {
          console.error("Error updating file workspaces:", error);
          return { success: false, error: "Network error" };
        }
      }

      // Add this new function
      async function addFileToWorkspace(fileId, workspaceId) {
        try {
          const response = await authFetch(
            `${API_BASE_URL}/files/${fileId}/add-to-workspace`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ workspace_id: workspaceId }),
            }
          );

          if (response.ok) {
            return await response.json();
          }
          return { success: false };
        } catch (error) {
          console.error("Error adding file to workspace:", error);
          return { success: false };
        }
      }

      // Enhanced file preview with actual file content
      async function openFilePreview(fileId) {
        const files = await getAllFiles();
        const file = files.find((f) => f.file_id === fileId);
        if (!file) return;

        const users = await getAllUsers();
        const owner = users.find((u) => u.user_id === file.user_id) || {
          name: "Unknown",
        };
        const categories = await getAllCategories();
        const category = categories.find(
          (c) => c.category_id === file.category_id
        ) || { name: "None" };

        let previewContent = "";
        let previewType = "info";

        try {
          const response = await authFetch(
            `${API_BASE_URL}/file-preview/${fileId}`
          );

          if (response.ok) {
            const contentType = response.headers.get("content-type") || "";

            if (contentType.includes("application/json")) {
              const result = await response.json();
              if (result.type === "html") {
                previewContent = `<div class="rich-preview">${result.content}</div>`;
                previewType = "html";
              } else if (result.type === "text") {
                previewContent = `<pre style="white-space: pre-wrap; font-family: inherit; margin: 0; color: var(--text); background: var(--bg); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">${result.content}</pre>`;
                previewType = "text";
              } else {
                previewContent = `<div class="small-muted" style="text-align:center;padding:40px">${
                  result.message || "Preview not available for this file type"
                }</div>`;
                previewType = "unsupported";
              }
            } else if (contentType.startsWith("image/")) {
              const blob = await response.blob();
              const imageUrl = URL.createObjectURL(blob);
              previewContent = `<img src="${imageUrl}" alt="${
                file.original_name || file.name
              }" style="max-width:100%; max-height:400px; border-radius:8px;">`;
              previewType = "image";
            } else if (contentType.startsWith("application/pdf")) {
              const blob = await response.blob();
              const pdfUrl = URL.createObjectURL(blob);
              previewContent = `<embed src="${pdfUrl}" type="application/pdf" width="100%" height="500px" />`;
              previewType = "pdf";
            } else {
              const result = await response.json().catch(() => ({}));
              previewContent = `<div class="small-muted" style="text-align:center;padding:40px">${
                result.message || "Preview not available for this file type"
              }</div>`;
              previewType = "unsupported";
            }
          } else {
            throw new Error("Preview not available");
          }
        } catch (error) {
          console.error("Preview error:", error);
          // Fallback to text sample or basic info
          if (file.text_sample) {
            previewContent = `<pre style="white-space: pre-wrap; font-family: inherit; margin: 0; color: var(--text); background: var(--bg); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">${file.text_sample}</pre>`;
            previewType = "text";
          } else {
            previewContent = `<div class="small-muted" style="text-align:center;padding:40px">
                Preview not available for this file.<br><br>
                File: ${file.original_name || file.name}<br>
                Type: ${file.type.toUpperCase()}<br>
                Size: ${(file.size / 1024) | 0} KB
            </div>`;
            previewType = "info";
          }
        }

        const canRename = !!file.can_edit;

        openModal(
          `
        <div class="file-preview-header">
          <div style="display:flex;align-items:center;gap:12px">
            <div class="file-preview-icon">${fileIcon(
              file.original_name || file.name
            )}</div>
            <div>
              <h3 style="margin:0">${file.original_name || file.name}</h3>
              <div class="small-muted">${file.type.toUpperCase()}  ${
            (file.size / 1024) | 0
          } KB</div>
            </div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="icon-btn" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>
            
        <div class="file-preview-content">
          ${previewContent}
        </div>
            
        <div class="file-preview-meta">
    <div class="meta-item">
      <div class="meta-label">Owner</div>
      <div class="meta-value">${owner.name}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Uploaded</div>
      <div class="meta-value">${new Date(
        file.created_at
      ).toLocaleString()}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">File Size</div>
      <div class="meta-value">${(file.size / 1024) | 0} KB</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">File Type</div>
      <div class="meta-value">${file.type.toUpperCase()}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Category</div>
      <div class="meta-value">${file.document_type || "Not categorized"}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Status</div>
      <div class="meta-value">
        <span class="badge ${file.shared ? "badge-success" : ""}">
          ${file.shared ? "Shared" : "Private"}
        </span>
      </div>
    </div>
  </div>

        <div class="file-preview-actions">
          ${
            canRename
              ? `
          <button class="btn-secondary" onclick="openRenameFromPreview(${
            file.file_id
          }, '${(file.original_name || file.name).replace(/'/g, "\\'")}')">
            <i class="fa-solid fa-i-cursor"></i> Rename
          </button>`
              : ""
          }
          <button onclick="downloadFile(${file.file_id})">
            <i class="fa-solid fa-download"></i> Download
          </button>
          <button class="btn-secondary" onclick="openFileShareModal(${
            file.file_id
          });">
            <i class="fa-solid fa-share-nodes"></i> Share & Manage Access
          </button>
          <button class="btn-secondary" onclick="openAddToWorkspaceModal(${
            file.file_id
          }); closeModal();">
            <i class="fa-solid fa-layer-group"></i> Add to Workspace
          </button>
          <button class="btn-secondary" onclick="moveToArchive(${
            file.file_id
          }); closeModal();">
            <i class="fa-solid fa-box-archive"></i> Move to Archive
          </button>
        </div>
    `,
          "file-preview-modal"
        );
      }

      // Enhanced archive function with confirmation
      async function confirmArchiveFile(fileId) {
        console.log(`DEBUG: confirmArchiveFile called for file ${fileId}`);

        // Close modal immediately to prevent multiple clicks
        closeModal();

        try {
          showToast("Archiving file...", "info");

          const response = await authFetch(
            `${API_BASE_URL}/files/${fileId}/archive`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          const result = await response.json();
          console.log(
            `DEBUG: Archive API response for file ${fileId}:`,
            result
          );

          if (result.success) {
            showToast("File archived successfully", "success");
            console.log(
              `DEBUG: File ${fileId} archived successfully, refreshing views...`
            );

            // Refresh ALL views immediately
            await refreshAllViews();
            console.log(
              `DEBUG: Views refreshed after archiving file ${fileId}`
            );
          } else {
            console.log(
              `DEBUG: Archive failed for file ${fileId}:`,
              result.error
            );
            showToast(result.error || "Failed to archive file", "error");
          }
        } catch (error) {
          console.error("Archive network error:", error);
          showToast("Network error while archiving file", "error");
        }
      }

      // Workspace Management
      // Enhanced workspace creation - show all users including current user
      async function openCreateWorkspace() {
        const users = await getAllUsers();
        const currentUser = await getCurrentUser();

        if (!users || !currentUser) return;
        if (currentUser.role === "staff") {
          showToast(
            "You do not have permission to create workspaces.",
            "error"
          );
          return;
        }

        let allowedUsers = users;
        if (currentUser.role === "department_admin") {
          allowedUsers = users.filter(
            (u) =>
              u.department_id === currentUser.department_id &&
              u.role === "staff"
          );
        }
        if (!allowedUsers.find((u) => u.user_id === currentUser.user_id)) {
          allowedUsers = [...allowedUsers, currentUser];
        }

        // Show ALL users including current user
        const userOptions = allowedUsers
          .map(
            (u) => `
            <div class="multi-select-option" data-id="${u.user_id}">
                <div class="member-avatar" style="width:24px;height:24px;font-size:10px">
                    ${u.name
                      .split(" ")
                      .map((s) => s[0])
                      .slice(0, 2)
                      .join("")
                      .toUpperCase()}
                </div>
                <span>${u.name} ${
              u.user_id === currentUser.user_id ? "(You)" : ""
            } (${u.email})</span>
            </div>
        `
          )
          .join("");

        openModal(`<h3>Create Workspace</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="form-row">
                <label>Workspace Name *</label>
                <input id="ws_name" placeholder="Enter workspace name" required/>
            </div>
            <div class="form-row">
                <label>Description</label>
                <textarea id="ws_desc" placeholder="Enter workspace description"></textarea>
            </div>
            <div class="form-row">
                <label>Add Members</label>
                <div class="multi-select-container">
                    <input id="ws_member_search" placeholder="Search users to add..." oninput="filterMemberOptions()"/>
                    <div class="multi-select-dropdown" id="memberDropdown">
                        ${userOptions}
                    </div>
                </div>
                <div class="multi-select-selected" id="selectedMembers">
                    <div class="selected-member" data-id="${currentUser.user_id}">
                        ${currentUser.name} (You)
                    </div>
                </div>
                <div class="small-muted">Click users above to add them as members. You are automatically included.</div>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
                <button onclick="modalCreateWorkspace()"><i class="fa-solid fa-check"></i> Create Workspace</button>
            </div>
        </div>`);

        // Initialize member selection
        document
          .getElementById("ws_member_search")
          .addEventListener("focus", function () {
            document.getElementById("memberDropdown").classList.add("active");
          });

        document
          .querySelectorAll("#memberDropdown .multi-select-option")
          .forEach((option) => {
            option.addEventListener("click", function () {
              const memberId = this.getAttribute("data-id");
              addMemberToWorkspace(memberId);
            });
          });
      }

      function filterMemberOptions() {
        const search = document
          .getElementById("ws_member_search")
          .value.toLowerCase();
        const options = document.querySelectorAll(
          "#memberDropdown .multi-select-option"
        );

        options.forEach((option) => {
          const text = option.textContent.toLowerCase();
          if (text.includes(search)) {
            option.style.display = "flex";
          } else {
            option.style.display = "none";
          }
        });
      }

      function addMemberToWorkspace(memberId) {
        Promise.all([getAllUsers(), getCurrentUser()]).then(
          ([users, currentUser]) => {
            const user = users.find((u) => u.user_id == memberId);
            if (!user || !currentUser) return;

            if (
              currentUser.role === "department_admin" &&
              (user.department_id !== currentUser.department_id ||
                user.role !== "staff")
            ) {
              showToast(
                "You can only add staff from your department.",
                "error"
              );
              return;
            }

            const selectedContainer =
              document.getElementById("selectedMembers");
            const existing = selectedContainer.querySelector(
              `[data-id="${memberId}"]`
            );
            if (existing) return;

            const isCurrentUser = user.user_id === currentUser.user_id;
            const memberEl = document.createElement("div");
            memberEl.className = "selected-member";
            memberEl.setAttribute("data-id", memberId);
            memberEl.innerHTML = `
            ${user.name} ${isCurrentUser ? "(You)" : ""}
            <button class="remove-member" onclick="removeMemberFromWorkspace('${memberId}')">
                <i class="fa-solid fa-xmark"></i>
            </button>
        `;
            selectedContainer.appendChild(memberEl);

            document.getElementById("ws_member_search").value = "";
            document
              .getElementById("memberDropdown")
              .classList.remove("active");
          }
        );
      }

      function removeMemberFromWorkspace(memberId) {
        const memberEl = document.querySelector(
          `.selected-member[data-id="${memberId}"]`
        );
        if (memberEl) {
          memberEl.remove();
        }
      }

      // Enhanced workspace creation function
      async function modalCreateWorkspace() {
        const name = document.getElementById("ws_name").value.trim();
        const desc = document.getElementById("ws_desc").value.trim();

        if (!name) {
          showToast("Workspace name is required", "error");
          return;
        }

        const currentUser = await getCurrentUser();
        if (!currentUser) return;

        // Get selected members (includes current user automatically)
        const selectedMembers = Array.from(
          document.querySelectorAll(".selected-member")
        ).map((el) => parseInt(el.getAttribute("data-id")));

        // Ensure current user is included
        if (!selectedMembers.includes(currentUser.user_id)) {
          selectedMembers.push(currentUser.user_id);
        }

        const workspaceData = {
          name: name,
          description: desc,
          user_id: currentUser.user_id,
          members: selectedMembers,
        };

        console.log("Creating workspace with data:", workspaceData);

        const result = await createWorkspace(workspaceData);
        if (result && result.workspace_id) {
          showToast("Workspace created successfully", "success");
          closeModal();
          await renderWorkspaces();

          await logActivity({
            user_id: currentUser.user_id,
            activity: `Created workspace: ${name}`,
          });
        } else {
          showToast("Failed to create workspace", "error");
        }
      }

      // Enhanced workspace editing - allow removing yourself
      async function openEditWorkspace(workspaceId) {
        const workspaces = await getAllWorkspaces();
        const workspace = workspaces.find((w) => w.workspace_id == workspaceId);
        if (!workspace) {
          showToast("Workspace not found", "error");
          return;
        }

        const users = await getAllUsers();
        const currentUser = await getCurrentUser();
        if (!currentUser) return;
        let allowedUsers = users;
        if (currentUser.role === "department_admin") {
          allowedUsers = users.filter(
            (u) =>
              u.department_id === currentUser.department_id &&
              u.role === "staff"
          );
          if (!allowedUsers.find((u) => u.user_id === currentUser.user_id)) {
            allowedUsers = [...allowedUsers, currentUser];
          }
        }
        if (currentUser.role === "staff") {
          showToast("You do not have permission to edit workspaces.", "error");
          return;
        }

        // Show ALL users including current user
        const userOptions = allowedUsers
          .map(
            (u) => `
            <div class="multi-select-option" data-id="${u.user_id}">
                <div class="member-avatar" style="width:24px;height:24px;font-size:10px">
                    ${u.name
                      .split(" ")
                      .map((s) => s[0])
                      .slice(0, 2)
                      .join("")
                      .toUpperCase()}
                </div>
                <span>${u.name} ${
              u.user_id === currentUser.user_id ? "(You)" : ""
            } (${u.email})</span>
            </div>
        `
          )
          .join("");

        // Create selected members HTML - allow removing anyone including yourself
        const selectedMembersHTML = (workspace.members || [])
          .filter((memberId) => allowedUsers.some((u) => u.user_id == memberId))
          .map((memberId) => {
            const user =
              allowedUsers.find((u) => u.user_id == memberId) ||
              users.find((u) => u.user_id == memberId);
            if (!user) return "";
            const isCurrentUser = user.user_id === currentUser.user_id;
            return `
                <div class="selected-member" data-id="${memberId}">
                    ${user.name}${isCurrentUser ? " (You)" : ""}
                    <button class="remove-member" onclick="removeMemberFromEditWorkspace('${memberId}')">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            `;
          })
          .join("");

        openModal(`<h3>Edit Workspace</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="form-row">
                <label>Workspace Name *</label>
                <input id="ew_name" value="${
                  workspace.name
                }" placeholder="Enter workspace name" required/>
            </div>
            <div class="form-row">
                <label>Description</label>
                <textarea id="ew_desc" placeholder="Enter workspace description">${
                  workspace.description || ""
                }</textarea>
            </div>
            <div class="form-row">
                <label>Members</label>
                <div class="multi-select-container">
                    <input id="ew_member_search" placeholder="Search users to add..." oninput="filterEditMemberOptions()"/>
                    <div class="multi-select-dropdown" id="editMemberDropdown">
                        ${userOptions}
                    </div>
                </div>
                <div class="multi-select-selected" id="editSelectedMembers">
                    ${selectedMembersHTML}
                </div>
                <div class="small-muted">Click users above to add them as members. You can remove any member including yourself.</div>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
                <button onclick="modalSaveWorkspace(${workspaceId})"><i class="fa-solid fa-check"></i> Save Changes</button>
            </div>
        </div>`);

        // Initialize member selection for editing
        setTimeout(() => {
          const searchInput = document.getElementById("ew_member_search");
          const dropdown = document.getElementById("editMemberDropdown");

          if (searchInput) {
            searchInput.addEventListener("focus", function () {
              if (dropdown) {
                dropdown.classList.add("active");
              }
            });
          }

          // Hide already selected members from dropdown
          const selectedMemberIds = workspace.members || [];
          document
            .querySelectorAll("#editMemberDropdown .multi-select-option")
            .forEach((option) => {
              const memberId = option.getAttribute("data-id");
              if (selectedMemberIds.includes(parseInt(memberId))) {
                option.style.display = "none";
              } else {
                option.style.display = "flex";
              }

              option.addEventListener("click", function (e) {
                e.stopPropagation();
                const memberId = this.getAttribute("data-id");
                addMemberToEditWorkspace(memberId);
              });
            });
        }, 100);
      }

      function filterEditMemberOptions() {
        const search = document
          .getElementById("ew_member_search")
          .value.toLowerCase();
        const options = document.querySelectorAll(
          "#editMemberDropdown .multi-select-option"
        );

        // Get already selected member IDs
        const selectedMemberIds = Array.from(
          document.querySelectorAll("#editSelectedMembers .selected-member")
        ).map((el) => el.getAttribute("data-id"));

        options.forEach((option) => {
          const memberId = option.getAttribute("data-id");
          const isSelected = selectedMemberIds.includes(memberId);

          // If already selected, keep it hidden
          if (isSelected) {
            option.style.display = "none";
            return;
          }

          // Otherwise, filter by search
          const text = option.textContent.toLowerCase();
          if (text.includes(search)) {
            option.style.display = "flex";
          } else {
            option.style.display = "none";
          }
        });
      }

      function addMemberToEditWorkspace(memberId) {
        Promise.all([getAllUsers(), getCurrentUser()]).then(
          ([users, currentUser]) => {
            const user = users.find((u) => u.user_id == memberId);
            if (!user || !currentUser) return;

            if (
              currentUser.role === "department_admin" &&
              (user.department_id !== currentUser.department_id ||
                user.role !== "staff")
            ) {
              showToast(
                "You can only add staff from your department.",
                "error"
              );
              return;
            }

            const selectedContainer = document.getElementById(
              "editSelectedMembers"
            );
            if (!selectedContainer) return;

            const existing = selectedContainer.querySelector(
              `[data-id="${memberId}"]`
            );
            if (existing) return;

            const memberEl = document.createElement("div");
            memberEl.className = "selected-member";
            memberEl.setAttribute("data-id", memberId);
            memberEl.innerHTML = `
            ${user.name} ${user.user_id === currentUser.user_id ? "(You)" : ""}
            <button class="remove-member" onclick="removeMemberFromEditWorkspace('${memberId}')">
                <i class="fa-solid fa-xmark"></i>
            </button>
        `;
            selectedContainer.appendChild(memberEl);

            const option = document.querySelector(
              `#editMemberDropdown .multi-select-option[data-id="${memberId}"]`
            );
            if (option) {
              option.style.display = "none";
            }

            const searchInput = document.getElementById("ew_member_search");
            if (searchInput) {
              searchInput.value = "";
            }
            const dropdown = document.getElementById("editMemberDropdown");
            if (dropdown) {
              dropdown.classList.remove("active");
            }
          }
        );
      }

      function removeMemberFromEditWorkspace(memberId) {
        const memberEl = document.querySelector(
          `#editSelectedMembers .selected-member[data-id="${memberId}"]`
        );
        if (memberEl) {
          memberEl.remove();
        }

        // Show the option back in dropdown
        const option = document.querySelector(
          `#editMemberDropdown .multi-select-option[data-id="${memberId}"]`
        );
        if (option) {
          option.style.display = "flex";
        }
      }

      // Enhanced workspace saving
      async function modalSaveWorkspace(workspaceId) {
        const name = document.getElementById("ew_name").value.trim();

        if (!name) {
          showToast("Workspace name is required", "error");
          return;
        }

        const desc = document.getElementById("ew_desc").value.trim();

        // Get selected members as integers
        const selectedMembers = Array.from(
          document.querySelectorAll("#editSelectedMembers .selected-member")
        ).map((el) => parseInt(el.getAttribute("data-id")));

        console.log("DEBUG: Saving workspace with members:", selectedMembers);

        const workspaceData = {
          name: name,
          description: desc,
          members: selectedMembers, // Send as array of integers
        };

        const result = await updateWorkspace(workspaceId, workspaceData);
        if (result && result.success) {
          showToast("Workspace updated successfully", "success");
          closeModal();

          // Refresh views
          await renderWorkspaces();
          if (
            currentView === "workspace-detail" &&
            currentWorkspaceId == workspaceId
          ) {
            await renderWorkspaceDetail();
          }

          const currentUser = await getCurrentUser();
          await logActivity({
            user_id: currentUser.user_id,
            activity: `Updated workspace: ${name}`,
          });
        } else {
          showToast("Failed to update workspace", "error");
        }
      }
      // Enhanced delete workspace with confirmation
      async function deleteWorkspace(workspaceId) {
        const workspaces = await getAllWorkspaces();
        const workspace = workspaces.find((w) => w.workspace_id == workspaceId);

        if (!workspace) {
          showToast("Workspace not found", "error");
          return;
        }

        openModal(`<h3>Delete Workspace</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="danger">
                <i class="fa-solid fa-exclamation-triangle"></i> 
                <strong>Warning:</strong> This action cannot be undone.
            </div>
            <div class="small-muted">
                Are you sure you want to delete the workspace <strong>"${workspace.name}"</strong>?
            </div>
            <div class="small-muted">
                All files in this workspace will be moved to your personal library.
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i> Cancel
                </button>
                <button class="btn-danger" onclick="executeDeleteWorkspace(${workspaceId})">
                    <i class="fa-solid fa-trash"></i> Delete Workspace
                </button>
            </div>
        </div>`);
      }

      async function executeDeleteWorkspace(workspaceId) {
        try {
          closeModal();
          showToast("Deleting workspace...", "info");

          const result = await deleteWorkspaceAPI(workspaceId);
          if (result && result.success) {
            showToast("Workspace deleted successfully", "success");

            const currentUser = await getCurrentUser();
            const workspaces = await getAllWorkspaces();
            const workspace = workspaces.find(
              (w) => w.workspace_id == workspaceId
            );

            if (currentUser && workspace) {
              await logActivity({
                user_id: currentUser.user_id,
                activity: `Deleted workspace: ${workspace.name}`,
              });
            }

            // Navigate back to workspaces list
            if (
              currentView === "workspace-detail" &&
              currentWorkspaceId === workspaceId
            ) {
              goToWorkspaces();
            } else {
              await renderWorkspaces();
            }
          } else {
            showToast("Failed to delete workspace", "error");
          }
        } catch (error) {
          console.error("Delete workspace error:", error);
          showToast("Error deleting workspace", "error");
        }
      }

      async function renderWorkspaces() {
        const list = document.getElementById("workspacesList");
        list.innerHTML = "";

        console.log(" DEBUG: Starting renderWorkspaces");

        const workspaces = await getAllWorkspaces();
        const users = await getAllUsers();
        const currentUser = currentUserData || (await getCurrentUser());
        const visibleWorkspaces = (workspaces || []).filter((w) => {
          const members = Array.isArray(w.members) ? w.members : [];
          return (
            w.user_id === currentUser?.user_id ||
            members.includes(currentUser?.user_id)
          );
        });

        if (!visibleWorkspaces || visibleWorkspaces.length === 0) {
          list.innerHTML =
            '<div class="card small-muted" style="text-align:center;padding:40px">No workspaces yet</div>';
          return;
        }

        console.log(
          ` DEBUG: Rendering ${visibleWorkspaces.length} workspaces`
        );

        for (const w of visibleWorkspaces) {
          // Get member details
          const memberDetails = await Promise.all(
            (w.members || []).map(async (memberId) => {
              const user = users.find((u) => u.user_id == memberId);
              if (!user) return null;
              return {
                id: user.user_id,
                name: user.name,
                initials: user.name
                  .split(" ")
                  .map((s) => s[0])
                  .slice(0, 2)
                  .join("")
                  .toUpperCase(),
              };
            })
          ).then((results) => results.filter(Boolean));

          // Get files for this workspace using the NEW method
          const workspaceFiles = await getWorkspaceFiles(w.workspace_id);
          console.log(
            ` DEBUG: Workspace ${w.workspace_id} has ${workspaceFiles.length} files`
          );

          const card = document.createElement("div");
          card.className = "workspace-card";
          card.setAttribute("data-workspace-id", w.workspace_id);
          card.style.marginBottom = "16px";
          card.onclick = () => openWorkspace(w.workspace_id);
          card.innerHTML = `
        <div class="workspace-header" style="align-items:stretch;min-height:160px">
          <div style="flex:1;display:flex;flex-direction:column;justify-content:space-between">
            <div>
              <div style="font-weight:600;font-size:18px;margin-bottom:4px;color:var(--text)">${
                w.name
              }</div>
              <div class="small-muted" style="margin-bottom:12px">${
                w.description || "No description provided"
              }</div>
            </div>
            <div>
              <div class="workspace-meta">
                <div class="meta-item"><i class="fa-solid fa-file"></i> ${
                  workspaceFiles.length
                } files</div>
                <div class="meta-item"><i class="fa-solid fa-user"></i> ${
                  memberDetails.length
                } members</div>
                <div class="meta-item"><i class="fa-solid fa-calendar"></i> ${new Date(
                  w.created_at
                ).toLocaleDateString()}</div>
              </div>
              ${
                memberDetails.length > 0
                  ? `
                <div class="member-grid" style="margin-top:12px">
                  ${memberDetails
                    .slice(0, 5)
                    .map(
                      (m) => `
                    <div class="member-avatar" title="${m.name}">${m.initials}</div>
                  `
                    )
                    .join("")}
                  ${
                    memberDetails.length > 5
                      ? `<div class="member-more" title="${
                          memberDetails.length - 5
                        } more members">+${memberDetails.length - 5}</div>`
                      : ""
                  }
                </div>
              `
                  : ""
              }
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center">
            <div class="workspace-icon">
              <i class="fa-solid fa-layer-group"></i>
            </div>
            <button style="width:48px;height:48px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:12px" onclick="event.stopPropagation(); openEditWorkspace(${
              w.workspace_id
            })" title="Edit"><i class="fa-solid fa-pen"></i></button>
            <button class="btn-danger" style="width:48px;height:48px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:12px" onclick="event.stopPropagation(); deleteWorkspace(${
              w.workspace_id
            })" title="Delete"><i class="fa-solid fa-trash"></i></button>
          </div>
        </div>
      `;
          list.appendChild(card);
        }

        console.log(" DEBUG: Finished renderWorkspaces");
      }

      async function openWorkspace(id) {
        currentWorkspaceId = id;
        currentView = "workspace-detail";
        renderCurrentView();
      }

      async function renderWorkspaceDetail() {
        const container = document.getElementById("workspace-detail");
        if (!currentWorkspaceId) return;

        console.log(
          ` DEBUG: Rendering workspace detail for workspace ${currentWorkspaceId}`
        );

        const workspaces = await getAllWorkspaces();
        const currentUser = currentUserData || (await getCurrentUser());
        const allowedWorkspaces = (workspaces || []).filter((w) => {
          const members = Array.isArray(w.members) ? w.members : [];
          return (
            w.user_id === currentUser?.user_id ||
            members.includes(currentUser?.user_id)
          );
        });
        const workspace = allowedWorkspaces.find(
          (w) => w.workspace_id == currentWorkspaceId
        );
        if (!workspace) {
          showToast("You do not have access to this workspace.", "error");
          goToWorkspaces();
          return;
        }

        // Get files for this workspace using the NEW method
        const workspaceFiles = await getWorkspaceFiles(currentWorkspaceId);
        const users = await getAllUsers();

        console.log(
          ` DEBUG: Workspace ${currentWorkspaceId} has ${workspaceFiles.length} files`
        );

        const memberDetails = await Promise.all(
          (workspace.members || []).map(async (memberId) => {
            const user = users.find((u) => u.user_id == memberId);
            if (!user) return null;
            return {
              id: user.user_id,
              name: user.name,
              initials: user.name
                .split(" ")
                .map((s) => s[0])
                .slice(0, 2)
                .join("")
                .toUpperCase(),
            };
          })
        ).then((results) => results.filter(Boolean));

        container.innerHTML = `
      <div class="workspace-detail-header">
        <div class="workspace-detail-back">
          <button class="back-button" onclick="goToWorkspaces()">
            <i class="fa-solid fa-arrow-left"></i> Back to Workspaces
          </button>
        </div>
        <div class="workspace-detail-main">
          <div class="workspace-detail-info">
            <div class="workspace-detail-icon">
              <i class="fa-solid fa-layer-group"></i>
            </div>
            <div class="workspace-detail-content">
              <div>
                <h2>${workspace.name}</h2>
                <div class="small-muted">${
                  workspace.description || "No description provided"
                }</div>
              </div>
              <div class="workspace-detail-bottom">
                <div class="workspace-meta">
                  <div class="meta-item"><i class="fa-solid fa-file"></i> ${
                    workspaceFiles.length
                  } files</div>
                  <div class="meta-item"><i class="fa-solid fa-user"></i> ${
                    memberDetails.length
                  } members</div>
                  <div class="meta-item"><i class="fa-solid fa-calendar"></i> ${new Date(
                    workspace.created_at
                  ).toLocaleDateString()}</div>
                </div>
                ${
                  memberDetails.length > 0
                    ? `
                  <div class="member-grid">
                    ${memberDetails
                      .slice(0, 5)
                      .map(
                        (m) => `
                      <div class="member-avatar" title="${m.name}">${m.initials}</div>
                    `
                      )
                      .join("")}
                    ${
                      memberDetails.length > 5
                        ? `<div class="member-more" title="${
                            memberDetails.length - 5
                          } more members">+${memberDetails.length - 5}</div>`
                        : ""
                    }
                  </div>
                `
                    : ""
                }
              </div>
            </div>
          </div>
          <div class="workspace-detail-actions">
            <button onclick="openEditWorkspace(${
              workspace.workspace_id
            })" title="Edit"><i class="fa-solid fa-pen"></i></button>
            <button onclick="openAddFileModal()" title="Add Files"><i class="fa-solid fa-plus"></i></button>
            <button class="btn-danger" onclick="deleteWorkspace(${
              workspace.workspace_id
            }); goToWorkspaces();" title="Delete"><i class="fa-solid fa-trash"></i></button>
          </div>
        </div>
      </div>
      
      <div class="toolbar">
        <input placeholder="Search files in this workspace..." id="workspaceFileSearch" oninput="searchWorkspaceFiles()" style="max-width:300px"/>
        <select id="sortWorkspaceFiles" onchange="renderWorkspaceFiles()">
          <option value="new">Sort: Newest</option>
          <option value="old">Sort: Oldest</option>
          <option value="name">Sort: Name</option>
        </select>
        <div style="flex:1"></div>
        <button class="btn-secondary" onclick="archiveSelectedWorkspaceFiles()"><i class="fa-solid fa-box-archive"></i> Move to Archive</button>
      </div>
      
      <div id="workspaceFilesGrid" class="grid"></div>
    `;

        renderWorkspaceFiles();
        console.log(" DEBUG: Finished renderWorkspaceDetail");
      }

      function goToWorkspaces() {
        currentView = "workspaces";
        currentWorkspaceId = null;

        // Save current view to localStorage
        localStorage.setItem("dms_current_view", "workspaces");

        renderCurrentView();
      }

      // Guard to prevent multiple simultaneous renders for workspace files
      let isRenderingWorkspaceFiles = false;

      // Replace the renderWorkspaceFiles function
      async function renderWorkspaceFiles() {
        // Prevent multiple simultaneous renders
        if (isRenderingWorkspaceFiles) {
          console.log(
            "DEBUG: renderWorkspaceFiles already in progress, skipping..."
          );
          return;
        }

        isRenderingWorkspaceFiles = true;

        try {
          const grid = document.getElementById("workspaceFilesGrid");
          if (!grid) {
            console.warn("DEBUG: workspaceFilesGrid not found");
            return;
          }

          // Clear grid immediately
          grid.innerHTML = "";

          console.log(
            ` DEBUG: Rendering workspace files for workspace ${currentWorkspaceId}`
          );

          // Get files specifically for this workspace using the NEW endpoint
          const files = await getWorkspaceFiles(currentWorkspaceId);

          // Deduplicate files by file_id to prevent duplicates
          const uniqueFiles = [];
          const seenIds = new Set();
          for (const file of files || []) {
            if (file && file.file_id && !seenIds.has(file.file_id)) {
              seenIds.add(file.file_id);
              uniqueFiles.push(file);
            }
          }

          console.log(
            ` DEBUG: Found ${uniqueFiles.length} unique files for workspace ${currentWorkspaceId}`
          );

          const search =
            document
              .getElementById("workspaceFileSearch")
              ?.value.trim()
              .toLowerCase() || "";
          const sort =
            document.getElementById("sortWorkspaceFiles")?.value || "new";

          let filteredFiles = uniqueFiles;
          if (search) {
            filteredFiles = filteredFiles.filter((f) =>
              f.name.toLowerCase().includes(search)
            );
          }

          if (sort === "new")
            filteredFiles.sort(
              (a, b) => new Date(b.created_at) - new Date(a.created_at)
            );
          if (sort === "old")
            filteredFiles.sort(
              (a, b) => new Date(a.created_at) - new Date(b.created_at)
            );
          if (sort === "name")
            filteredFiles.sort((a, b) => a.name.localeCompare(b.name));

          if (!filteredFiles.length) {
            grid.innerHTML =
              '<div class="card small-muted" style="text-align:center;padding:40px">No files in this workspace yet</div>';
            return;
          }

          for (const f of filteredFiles) {
            const div = document.createElement("div");
            div.className = "doc-adaptive";
            div.setAttribute("data-file-id", f.file_id);
            div.onclick = () => openFilePreview(f.file_id);
            div.innerHTML = `
        <input type="checkbox" class="doc-checkbox" data-file-id="${f.file_id}" 
               onclick="event.stopPropagation(); updateBulkActionsBar()" 
               onchange="updateBulkActionsBar()">
        <div class="doc-header">
          <div class="doc-icon">${fileIcon(f.name)}</div>
          <div class="doc-info">
            <div class="doc-name" onclick="event.stopPropagation(); startRenameFile(${
              f.file_id
            }, this)">${f.name}</div>
            <div class="doc-meta">${(f.size / 1024) | 0} KB  ${new Date(
              f.created_at
            ).toLocaleString()}</div>
          </div>
        </div>
        <div class="doc-actions">
          <button class="icon-btn" title="Rename" onclick="event.stopPropagation(); startRenameFileFromButton(${
            f.file_id
          })">
            <i class="fa-solid fa-pen"></i>
          </button>
          <button class="icon-btn" onclick="event.stopPropagation(); toggleShare(${
            f.file_id
          })">
            ${
              f.shared
                ? '<i class="fa-solid fa-link"></i>'
                : '<i class="fa-regular fa-circle"></i>'
            }
          </button>
          <button class="icon-btn" onclick="event.stopPropagation(); downloadFile(${
            f.file_id
          })">
            <i class="fa-solid fa-download"></i>
          </button>
          <button class="icon-btn" title="Archive" onclick="event.stopPropagation(); moveToArchive(${
            f.file_id
          })">
            <i class="fa-solid fa-box-archive"></i>
          </button>
        </div>
      `;
            grid.appendChild(div);
          }

          updateBulkActionsBar();

          console.log(" DEBUG: Finished renderWorkspaceFiles");
        } catch (error) {
          console.error("DEBUG: Error in renderWorkspaceFiles:", error);
        } finally {
          isRenderingWorkspaceFiles = false;
        }
      }

      // Add this function if it doesn't exist
      async function getWorkspaceFiles(workspaceId) {
        try {
          console.log(` DEBUG: Getting files for workspace ${workspaceId}`);
          const response = await authFetch(
            `${API_BASE_URL}/workspaces/${workspaceId}/files`
          );
          if (response.ok) {
            const files = await response.json();
            console.log(
              ` DEBUG: Got ${files.length} files for workspace ${workspaceId}`
            );
            return files;
          } else {
            console.log(
              ` DEBUG: Failed to get files for workspace ${workspaceId}`
            );
            return [];
          }
        } catch (error) {
          console.error("Error getting workspace files:", error);
          return [];
        }
      }

      function searchWorkspaceFiles() {
        renderWorkspaceFiles();
      }

      function archiveSelectedWorkspaceFiles() {
        showToast(
          "Select UI not implemented in prototype  use action per-file"
        );
      }

      // Enhanced delete workspace with confirmation
      async function deleteWorkspace(workspaceId) {
        const workspaces = await getAllWorkspaces();
        const workspace = workspaces.find((w) => w.workspace_id == workspaceId);

        if (!workspace) {
          showToast("Workspace not found", "error");
          return;
        }

        openModal(`<h3>Delete Workspace</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="danger">
                <i class="fa-solid fa-exclamation-triangle"></i> 
                <strong>Warning:</strong> This action cannot be undone.
            </div>
            <div class="small-muted">
                Are you sure you want to delete the workspace <strong>"${workspace.name}"</strong>?
            </div>
            <div class="small-muted">
                All files in this workspace will be moved to your personal library.
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i> Cancel
                </button>
                <button class="btn-danger" onclick="executeDeleteWorkspace(${workspaceId})">
                    <i class="fa-solid fa-trash"></i> Delete Workspace
                </button>
            </div>
        </div>`);
      }

      async function executeDeleteWorkspace(workspaceId) {
        try {
          closeModal();
          showToast("Deleting workspace...", "info");

          const result = await deleteWorkspaceAPI(workspaceId);
          if (result && result.success) {
            showToast("Workspace deleted successfully", "success");

            const currentUser = await getCurrentUser();
            const workspaces = await getAllWorkspaces();
            const workspace = workspaces.find(
              (w) => w.workspace_id == workspaceId
            );

            if (currentUser && workspace) {
              await logActivity({
                user_id: currentUser.user_id,
                activity: `Deleted workspace: ${workspace.name}`,
              });
            }

            // Navigate back to workspaces list
            if (
              currentView === "workspace-detail" &&
              currentWorkspaceId === workspaceId
            ) {
              goToWorkspaces();
            } else {
              await renderWorkspaces();
            }
          } else {
            showToast("Failed to delete workspace", "error");
          }
        } catch (error) {
          console.error("Delete workspace error:", error);
          showToast("Error deleting workspace", "error");
        }
      }

      // User Management
      async function renderUsers() {
        const tbody = document.querySelector("#usersTable tbody");
        tbody.innerHTML = "";

        const users = await getAllUsers();
        const departments = await getAllDepartments();
        const currentUser = await getCurrentUser();

        if (currentUser?.role === "staff") {
          tbody.innerHTML =
            '<tr><td colspan="7" class="small-muted" style="text-align:center;padding:20px">Access denied.</td></tr>';
          showToast("Access denied.", "error");
          return;
        }

        // Populate department filter
        const deptFilter = document.getElementById("filterUserDept");
        if (deptFilter) {
          const currentDeptValue = deptFilter.value;
          deptFilter.innerHTML =
            '<option value="">All Departments</option>' +
            departments
              .map(
                (d) => `<option value="${d.department_id}">${d.name}</option>`
              )
              .join("");
          if (currentDeptValue) deptFilter.value = currentDeptValue;
        }

        // Get filter values
        const search = (document.getElementById("searchUsers")?.value || "")
          .toLowerCase()
          .trim();
        const filterRole =
          document.getElementById("filterUserRole")?.value || "";
        const filterStatus =
          document.getElementById("filterUserStatus")?.value || "";
        const filterDept =
          document.getElementById("filterUserDept")?.value || "";
        const sortBy = document.getElementById("sortUsers")?.value || "id";

        // Calculate statistics scoped to current role
        const statsScope =
          currentUser && currentUser.role === "department_admin"
            ? users.filter(
                (u) =>
                  u.department_id === currentUser.department_id &&
                  u.role === "staff"
              )
            : users;
        const totalUsers = statsScope.length;
        const activeUsers = statsScope.filter(
          (u) => u.status === "active"
        ).length;
        const archivedUsers = statsScope.filter(
          (u) => u.status === "archived"
        ).length;

        const totalCountEl = document.getElementById("totalUsersCount");
        const activeCountEl = document.getElementById("activeUsersCount");
        const archivedCountEl = document.getElementById("archivedUsersCount");
        if (totalCountEl) totalCountEl.textContent = totalUsers;
        if (activeCountEl) activeCountEl.textContent = activeUsers;
        if (archivedCountEl) archivedCountEl.textContent = archivedUsers;

        // Remove duplicates
        const uniqueUsers = [];
        const seenUserIds = new Set();
        users.forEach((user) => {
          if (!seenUserIds.has(user.user_id)) {
            seenUserIds.add(user.user_id);
            uniqueUsers.push(user);
          }
        });

        // Apply filters
        let filteredUsers = uniqueUsers;

        if (currentUser && currentUser.role === "department_admin") {
          filteredUsers = filteredUsers.filter(
            (u) =>
              u.department_id === currentUser.department_id &&
              u.role === "staff"
          );
          if (deptFilter) {
            deptFilter.value = currentUser.department_id;
            deptFilter.disabled = true;
          }
        } else if (deptFilter) {
          deptFilter.disabled = false;
        }

        if (search) {
          filteredUsers = filteredUsers.filter(
            (u) =>
              u.name.toLowerCase().includes(search) ||
              u.email.toLowerCase().includes(search)
          );
        }

        if (filterRole) {
          filteredUsers = filteredUsers.filter((u) => u.role === filterRole);
        }

        if (filterStatus) {
          filteredUsers = filteredUsers.filter(
            (u) => u.status === filterStatus
          );
        }

        if (filterDept) {
          filteredUsers = filteredUsers.filter(
            (u) => u.department_id == filterDept
          );
        }

        // Sort users - only if sort option is selected
        if (sortBy === "name_asc") {
          filteredUsers.sort((a, b) => a.name.localeCompare(b.name));
        } else if (sortBy === "name_desc") {
          filteredUsers.sort((a, b) => b.name.localeCompare(a.name));
        }
        // If no sort selected, keep original order (by user_id)

        if (!filteredUsers.length) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="small-muted" style="text-align:center;padding:20px">No users found</td></tr>';
          return;
        }

        filteredUsers.forEach((u) => {
          const dept = departments.find(
            (d) => d.department_id === u.department_id
          ) || { name: "Not assigned" };
          const roleLabel =
            u.role === "system_admin"
              ? "System Admin"
              : u.role === "department_admin"
              ? "Department Admin"
              : "Staff";
          const roleBadgeClass =
            u.role === "system_admin"
              ? "badge-danger"
              : u.role === "department_admin"
              ? "badge-warning"
              : "";

          const tr = document.createElement("tr");
          tr.setAttribute("data-user-id", u.user_id);
          tr.innerHTML = `
      <td>${u.user_id}</td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent-dark));display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:12px;flex-shrink:0">
            ${u.name
              .split(" ")
              .map((s) => s[0])
              .slice(0, 2)
              .join("")
              .toUpperCase()}
          </div>
          <span style="color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px" title="${
            u.name
          }">${u.name}</span>
        </div>
      </td>
      <td style="color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:250px" title="${
        u.email
      }">${u.email}</td>
      <td style="text-align:center"><span class="badge ${roleBadgeClass}">${roleLabel}</span></td>
      <td style="text-align:center"><span class="badge">${dept.name}</span></td>
      <td style="text-align:center"><span class="badge ${
        u.status === "active" ? "badge-success" : "badge-warning"
      }">${u.status === "active" ? "Active" : "Archived"}</span></td>
      <td style="text-align:center">
        <div style="display:flex;gap:8px;align-items:center;justify-content:center;">
          <button class="icon-btn" onclick="openEditUser(${
            u.user_id
          })" title="Edit">
            <i class="fa-solid fa-pen"></i>
          </button>
          ${
            u.user_id !== currentUser.user_id
              ? `
            <button class="icon-btn" onclick="openArchiveUser(${u.user_id})" title="Archive">
              <i class="fa-solid fa-box-archive"></i>
            </button>
          `
              : `
            <button class="icon-btn" disabled title="Current User">
              <i class="fa-solid fa-user"></i>
            </button>
          `
          }
        </div>
      </td>
    `;
          tbody.appendChild(tr);
        });
      }

      // Add user deletion function
      async function deleteUserAPI(userId) {
        return await apiCall(`/users/${userId}`, {
          method: "DELETE",
        });
      }

      const USER_REPORT_HEADERS = [
        "ID",
        "Full Name",
        "Email Address",
        "Role",
        "Department",
        "Status",
        "Date Created",
      ];
      const USER_REPORT_TITLE = "User Management Report";
      const USER_REPORT_BRAND = "DOCUMENT MANAGEMENT SYSTEM";
      const SCRIPT_SOURCES = {
        JSZip: [
          "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js",
          "https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js",
        ],
      };
      const scriptLoadPromises = {};

      function getReportTimestamp(date = new Date()) {
        return date.toLocaleString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function loadScript(url) {
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = url;
          script.async = true;
          script.onload = () => {
            script.remove();
            resolve();
          };
          script.onerror = () => {
            script.remove();
            reject(new Error(`Failed to load script: ${url}`));
          };
          document.head.appendChild(script);
        });
      }

      function ensureLibrary(globalName) {
        if (window[globalName]) {
          return Promise.resolve(window[globalName]);
        }
        const sources = SCRIPT_SOURCES[globalName];
        if (!sources || sources.length === 0) {
          return Promise.resolve(undefined);
        }
        if (!scriptLoadPromises[globalName]) {
          scriptLoadPromises[globalName] = (async () => {
            for (const src of sources) {
              try {
                await loadScript(src);
                if (window[globalName]) {
                  return window[globalName];
                }
              } catch (error) {
                console.warn(
                  `Failed to load ${globalName} from ${src}:`,
                  error
                );
              }
            }
            throw new Error(`Failed to load ${globalName} library.`);
          })();
        }
        return scriptLoadPromises[globalName];
      }

      function getUserRoleLabel(role) {
        if (role === "system_admin") return "System Administrator";
        if (role === "department_admin") return "Department Administrator";
        return "Staff";
      }

      function formatUserCreatedDate(dateInput) {
        try {
          return new Date(dateInput || Date.now()).toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        } catch (err) {
          console.warn("Date formatting error:", err);
          return "";
        }
      }

      function buildUserReportRows(users, departments) {
        return users.map((u) => {
          const dept = departments.find(
            (d) => d.department_id === u.department_id
          ) || { name: "Not assigned" };
          return [
            u.user_id,
            u.name || "",
            u.email || "",
            getUserRoleLabel(u.role),
            dept.name || "Not assigned",
            u.status === "active" ? "Active" : "Archived",
            formatUserCreatedDate(u.created_at),
          ];
        });
      }

      function getUserReportStats(users) {
        const active = users.filter((u) => u.status === "active").length;
        const archived = users.filter((u) => u.status === "archived").length;
        return {
          total: users.length,
          active,
          archived,
        };
      }

      function triggerReportDownload(blob, filename) {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }

      // Open export menu
      async function openExportMenu() {
        // Get filtered data for preview
        const { filteredUsers, departments } = await getFilteredUsersData();
        const stats = getUserReportStats(filteredUsers);
        const reportRows = buildUserReportRows(filteredUsers, departments);
        const previewRows = reportRows
          .slice(0, 5)
          .map(
            (row, index) => `
      <tr style="background-color: ${index % 2 === 0 ? "#ffffff" : "#f8f9fa"};">
        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; font-size: 12px;">${
          row[0]
        }</td>
        <td style="padding: 8px; border: 1px solid #dee2e6; font-size: 12px;">${escapeHtml(
          row[1]
        )}</td>
        <td style="padding: 8px; border: 1px solid #dee2e6; font-size: 12px;">${escapeHtml(
          row[2]
        )}</td>
        <td style="padding: 8px; border: 1px solid #dee2e6; font-size: 12px;">${escapeHtml(
          row[3]
        )}</td>
        <td style="padding: 8px; border: 1px solid #dee2e6; font-size: 12px;">${escapeHtml(
          row[4]
        )}</td>
        <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center; font-size: 12px;">
          <span style="padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; ${
            row[5] === "Active"
              ? "background-color: #d4edda; color: #155724;"
              : "background-color: #fff3cd; color: #856404;"
          }">${row[5]}</span>
        </td>
        <td style="padding: 8px; border: 1px solid #dee2e6; font-size: 12px;">${escapeHtml(
          row[6]
        )}</td>
      </tr>
  `
          )
          .join("");

        const previewMore =
          filteredUsers.length > 5
            ? `<tr><td colspan="7" style="padding: 8px; text-align: center; font-size: 11px; color: #6c757d; font-style: italic;">... and ${
                filteredUsers.length - 5
              } more rows</td></tr>`
            : "";

        const generatedAt = getReportTimestamp();

        openModal(
          `<h3>Export User List</h3>
    <div style="display:flex;flex-direction:column;gap:20px">
      <!-- Preview Section -->
      <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px">
        <div style="display:flex;flex-wrap:wrap;justify-content:space-between;gap:16px;margin-bottom:12px">
          <div>
            <div style="font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px;font-size:16px;">
              <i class="fa-solid fa-eye"></i> User Management Report Preview
            </div>
            <div class="small-muted">Snapshot of the data that will be exported. Read-only.</div>
          </div>
          <div class="small-muted" style="font-size:12px;text-align:right">
            <div><strong>Generated:</strong> ${generatedAt}</div>
            <div><strong>Records:</strong> ${stats.total}</div>
          </div>
        </div>
        <div style="margin-bottom:12px;display:flex;gap:16px;font-size:12px">
          <div><strong>Total Users:</strong> ${stats.total}</div>
          <div><strong>Active:</strong> ${stats.active}</div>
          <div><strong>Archived:</strong> ${stats.archived}</div>
        </div>
        <div style="overflow-x:auto;max-height:200px;overflow-y:auto">
          <table style="width:100%;border-collapse:collapse;font-size:11px">
            <thead>
              <tr style="background-color:#34495e;color:white">
                <th style="padding:8px;border:1px solid #2c3e50;text-align:center;font-size:11px">ID</th>
                <th style="padding:8px;border:1px solid #2c3e50;font-size:11px">Name</th>
                <th style="padding:8px;border:1px solid #2c3e50;font-size:11px">Email</th>
                <th style="padding:8px;border:1px solid #2c3e50;font-size:11px">Role</th>
                <th style="padding:8px;border:1px solid #2c3e50;font-size:11px">Department</th>
                <th style="padding:8px;border:1px solid #2c3e50;text-align:center;font-size:11px">Status</th>
                <th style="padding:8px;border:1px solid #2c3e50;font-size:11px">Date Created</th>
              </tr>
            </thead>
            <tbody>
              ${previewRows}
              ${previewMore}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Format Selection -->
      <div>
        <div class="small-muted" style="margin-bottom:12px">
          Choose the export format:
        </div>
        <div style="display:flex;flex-direction:column;gap:12px">
          <button onclick="exportUsersList('excel')" style="display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);cursor:pointer;transition:all 0.2s;">
            <i class="fa-solid fa-file-excel" style="color:#217346;font-size:24px;"></i>
            <div style="flex:1;text-align:left">
              <div style="font-weight:600;color:var(--text)">Excel (.xlsx)</div>
              <div class="small-muted">Export as Microsoft Excel spreadsheet</div>
            </div>
            <i class="fa-solid fa-chevron-right" style="color:var(--muted);"></i>
          </button>
          <button onclick="exportUsersList('pdf')" style="display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);cursor:pointer;transition:all 0.2s;">
            <i class="fa-solid fa-file-pdf" style="color:#DC143C;font-size:24px;"></i>
            <div style="flex:1;text-align:left">
              <div style="font-weight:600;color:var(--text)">PDF (.pdf)</div>
              <div class="small-muted">Export as PDF document</div>
            </div>
            <i class="fa-solid fa-chevron-right" style="color:var(--muted);"></i>
          </button>
          <button onclick="exportUsersList('docx')" style="display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);cursor:pointer;transition:all 0.2s;">
            <i class="fa-solid fa-file-word" style="color:#2B579A;font-size:24px;"></i>
            <div style="flex:1;text-align:left">
              <div style="font-weight:600;color:var(--text)">Word (.docx)</div>
              <div class="small-muted">Export as Microsoft Word document</div>
            </div>
            <i class="fa-solid fa-chevron-right" style="color:var(--muted);"></i>
          </button>
        </div>
      </div>
      
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button class="btn-secondary" onclick="closeModal()">
          <i class="fa-solid fa-xmark"></i> Cancel
        </button>
      </div>
    </div>`,
          "modal-large"
        );
      }

      // Get filtered users data (shared by all export functions)
      async function getFilteredUsersData() {
        const users = await getAllUsers();
        const departments = await getAllDepartments();

        // Get current filters
        const search = (document.getElementById("searchUsers")?.value || "")
          .toLowerCase()
          .trim();
        const filterRole =
          document.getElementById("filterUserRole")?.value || "";
        const filterStatus =
          document.getElementById("filterUserStatus")?.value || "";
        const filterDept =
          document.getElementById("filterUserDept")?.value || "";
        const sortBy =
          document.getElementById("sortUsers")?.value || "name_asc";

        // Apply same filters as renderUsers
        let filteredUsers = users || [];

        // Remove duplicates
        const uniqueUsers = [];
        const seenUserIds = new Set();
        filteredUsers.forEach((user) => {
          if (!seenUserIds.has(user.user_id)) {
            seenUserIds.add(user.user_id);
            uniqueUsers.push(user);
          }
        });

        if (search) {
          filteredUsers = uniqueUsers.filter(
            (u) =>
              u.name.toLowerCase().includes(search) ||
              u.email.toLowerCase().includes(search)
          );
        } else {
          filteredUsers = uniqueUsers;
        }

        if (filterRole) {
          filteredUsers = filteredUsers.filter((u) => u.role === filterRole);
        }

        if (filterStatus) {
          filteredUsers = filteredUsers.filter(
            (u) => u.status === filterStatus
          );
        }

        if (filterDept) {
          filteredUsers = filteredUsers.filter(
            (u) => u.department_id == filterDept
          );
        }

        // Sort users
        if (sortBy === "name_asc") {
          filteredUsers.sort((a, b) => a.name.localeCompare(b.name));
        } else if (sortBy === "name_desc") {
          filteredUsers.sort((a, b) => b.name.localeCompare(a.name));
        } else {
          // Default: Sort by ID (1 to last)
          filteredUsers.sort((a, b) => a.user_id - b.user_id);
        }

        return { filteredUsers, departments };
      }

      // Export users list
      async function exportUsersList(format) {
        try {
          closeModal();

          // Show confirmation modal dialog
          const defaultFileName = `User_Management_Report_${
            new Date().toISOString().split("T")[0]
          }`;

          return new Promise((resolve) => {
            openModal(`<h3 style="color: var(--warning); display: flex; align-items: center; gap: 8px;">
        <i class="fa-solid fa-triangle-exclamation"></i> Export Confirmation
      </h3>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="small-muted">
          Are you sure you want to export the user data as <strong>${format.toUpperCase()}</strong>?
        </div>
        <div class="form-row">
          <label>File Name (Optional)</label>
          <input type="text" id="exportFileNameInput" value="${defaultFileName}" placeholder="${defaultFileName}" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px" />
          <div class="small-muted" style="margin-top:4px">
            Leave empty to use default name: ${defaultFileName}
          </div>
        </div>
        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button class="btn-secondary" onclick="closeModal()">
            <i class="fa-solid fa-xmark"></i> Cancel
          </button>
          <button onclick="handleExportConfirm('${format}')">
            <i class="fa-solid fa-download"></i> Export
          </button>
        </div>
      </div>`);
          });
        } catch (error) {
          console.error("Export error:", error);
          showToast(
            `Failed to export user list as ${format.toUpperCase()}`,
            "error"
          );
        }
      }

      // Handle export confirmation
      async function handleExportConfirm(format) {
        // Read filename BEFORE closing modal
        const fileNameInput = document.getElementById("exportFileNameInput");
        const defaultFileName = `User_Management_Report_${
          new Date().toISOString().split("T")[0]
        }`;
        const fileName = fileNameInput
          ? fileNameInput.value.trim() || defaultFileName
          : defaultFileName;

        closeModal();

        showToast(`Preparing ${format.toUpperCase()} export...`, "info");

        try {
          const { filteredUsers, departments } = await getFilteredUsersData();

          if (format === "excel") {
            await exportToExcel(filteredUsers, departments, fileName);
          } else if (format === "pdf") {
            await exportToPDF(filteredUsers, departments, fileName);
          } else if (format === "docx") {
            await exportToDOCX(filteredUsers, departments, fileName);
          } else {
            throw new Error("Invalid export format");
          }

          showToast(
            `User list exported successfully as ${format.toUpperCase()}`,
            "success"
          );
        } catch (error) {
          console.error(`Export ${format} failed:`, error);
          showToast(
            error?.message ||
              `Failed to export user list as ${format.toUpperCase()}`,
            "error"
          );
        }
      }

      // Export to Excel using SheetJS for a native XLSX file
      async function exportToExcel(users, departments, filename) {
        if (!window.XLSX) {
          throw new Error("Excel export library failed to load.");
        }

        try {
          const reportRows = buildUserReportRows(users, departments);
          const stats = getUserReportStats(users);
          const generatedAt = getReportTimestamp();

          const summaryLine = `Total Users: ${stats.total} | Active: ${stats.active} | Archived: ${stats.archived}`;
          const metadataRows = [
            [USER_REPORT_BRAND],
            [USER_REPORT_TITLE],
            [`Generated: ${generatedAt}`],
            [summaryLine],
            [],
          ];

          const worksheetData = [
            ...metadataRows,
            USER_REPORT_HEADERS,
            ...reportRows,
          ];
          const worksheet = window.XLSX.utils.aoa_to_sheet(worksheetData);
          worksheet["!cols"] = [
            { wch: 10 },
            { wch: 34 },
            { wch: 50 },
            { wch: 28 },
            { wch: 32 },
            { wch: 16 },
            { wch: 30 },
          ];

          const totalColumns = USER_REPORT_HEADERS.length;
          worksheet["!merges"] = [
            { s: { r: 0, c: 0 }, e: { r: 0, c: totalColumns - 1 } },
            { s: { r: 1, c: 0 }, e: { r: 1, c: totalColumns - 1 } },
            { s: { r: 2, c: 0 }, e: { r: 2, c: totalColumns - 1 } },
            { s: { r: 3, c: 0 }, e: { r: 3, c: totalColumns - 1 } },
          ];

          const setCellStyle = (cellAddress, style) => {
            if (worksheet[cellAddress]) {
              worksheet[cellAddress].s = style;
            }
          };

          setCellStyle("A1", {
            font: { bold: true, sz: 16 },
            alignment: { horizontal: "center" },
          });
          setCellStyle("A2", {
            font: { bold: true, sz: 14 },
            alignment: { horizontal: "center" },
          });
          setCellStyle("A3", {
            font: { italic: true },
            alignment: { horizontal: "center" },
          });
          setCellStyle("A4", {
            font: { bold: true },
            alignment: { horizontal: "center", wrapText: true },
          });

          const headerRowIndex = metadataRows.length;
          for (let col = 0; col < totalColumns; col++) {
            const cellAddress = window.XLSX.utils.encode_cell({
              r: headerRowIndex,
              c: col,
            });
            setCellStyle(cellAddress, {
              font: { bold: true, color: { rgb: "FFFFFFFF" } },
              fill: { fgColor: { rgb: "34495E" } },
              alignment: { horizontal: "center" },
            });
          }

          const workbook = window.XLSX.utils.book_new();
          window.XLSX.utils.book_append_sheet(
            workbook,
            worksheet,
            "User Report"
          );

          const workbookArray = window.XLSX.write(workbook, {
            bookType: "xlsx",
            type: "array",
            cellStyles: true,
          });

          const blob = new Blob([workbookArray], {
            type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
          });
          const exportFileName =
            filename ||
            `User_Management_Report_${new Date().toISOString().split("T")[0]}`;
          triggerReportDownload(blob, `${exportFileName}.xlsx`);
        } catch (error) {
          console.error("Excel export error:", error);
          throw error;
        }
      }

      // Helper function to escape HTML
      function escapeHtml(text) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        };
        return String(text).replace(/[&<>"']/g, (m) => map[m]);
      }

      function escapeXml(text) {
        if (text === null || text === undefined) return "";
        return escapeHtml(String(text));
      }

      function docxParagraphXml(text, options = {}) {
        const {
          bold = false,
          italic = false,
          size = 22,
          color = "2C3E50",
          align = "left",
          spacingAfter = 160,
        } = options;

        const runProps = [];
        if (bold) runProps.push("<w:b/>");
        if (italic) runProps.push("<w:i/>");
        if (size) runProps.push(`<w:sz w:val="${Math.round(size * 2)}"/>`);
        if (color) runProps.push(`<w:color w:val="${color}"/>`);
        const rPr = runProps.length
          ? `<w:rPr>${runProps.join("")}</w:rPr>`
          : "";
        const run = `<w:r>${rPr}<w:t xml:space="preserve">${escapeXml(
          text
        )}</w:t></w:r>`;

        const pProps = [];
        if (align && align !== "left") {
          pProps.push(`<w:jc w:val="${align}"/>`);
        }
        if (spacingAfter !== undefined) {
          pProps.push(`<w:spacing w:after="${spacingAfter}"/>`);
        }
        const pPr = pProps.length ? `<w:pPr>${pProps.join("")}</w:pPr>` : "";
        return `<w:p>${pPr}${run}</w:p>`;
      }

      function docxTableCellXml(text, { header = false, zebra = false } = {}) {
        const shading = header
          ? `<w:shd w:val="clear" w:color="auto" w:fill="34495E"/>`
          : zebra
          ? `<w:shd w:val="clear" w:color="auto" w:fill="F8F9FA"/>`
          : "";
        const tcPrParts = [`<w:tcW w:w="1800" w:type="dxa"/>`];
        if (shading) tcPrParts.push(shading);

        const paragraph = docxParagraphXml(text, {
          bold: header,
          color: header ? "FFFFFF" : "2C3E50",
          align: header ? "center" : "left",
          spacingAfter: 80,
          size: 20,
        });

        return `<w:tc><w:tcPr>${tcPrParts.join(
          ""
        )}</w:tcPr>${paragraph}</w:tc>`;
      }

      function docxTableXml(headers, rows) {
        const headerRow = `<w:tr>${headers
          .map((header) => docxTableCellXml(header, { header: true }))
          .join("")}</w:tr>`;
        const bodyRows = rows
          .map(
            (row, rowIndex) =>
              `<w:tr>${row
                .map((cell) =>
                  docxTableCellXml(cell, { zebra: rowIndex % 2 === 1 })
                )
                .join("")}</w:tr>`
          )
          .join("");

        const gridCols = headers.map(() => '<w:gridCol w:w="1800"/>').join("");
        return `
    <w:tbl>
      <w:tblPr>
        <w:tblW w:w="0" w:type="auto"/>
        <w:tblBorders>
          <w:top w:val="single" w:sz="4" w:space="0" w:color="D1D5DB"/>
          <w:left w:val="single" w:sz="4" w:space="0" w:color="D1D5DB"/>
          <w:bottom w:val="single" w:sz="4" w:space="0" w:color="D1D5DB"/>
          <w:right w:val="single" w:sz="4" w:space="0" w:color="D1D5DB"/>
          <w:insideH w:val="single" w:sz="4" w:space="0" w:color="E2E8F0"/>
          <w:insideV w:val="single" w:sz="4" w:space="0" w:color="E2E8F0"/>
        </w:tblBorders>
        <w:tblLook w:val="04A0" w:firstRow="1" w:lastRow="0" w:firstColumn="1" w:lastColumn="0" w:noHBand="0" w:noVBand="1"/>
      </w:tblPr>
      <w:tblGrid>
        ${gridCols}
      </w:tblGrid>
      ${headerRow}
      ${bodyRows}
    </w:tbl>
  `;
      }

      function buildDocxDocumentXml({
        generatedAt,
        summaryLine,
        headers,
        rows,
      }) {
        const namespaceAttrs = [
          'xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas"',
          'xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"',
          'xmlns:o="urn:schemas-microsoft-com:office:office"',
          'xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"',
          'xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math"',
          'xmlns:v="urn:schemas-microsoft-com:vml"',
          'xmlns:wp14="http://schemas.microsoft.com/office/word/2010/wordprocessingDrawing"',
          'xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"',
          'xmlns:w10="urn:schemas-microsoft-com:office:word"',
          'xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"',
          'xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml"',
          'xmlns:wpg="http://schemas.microsoft.com/office/word/2010/wordprocessingGroup"',
          'xmlns:wpi="http://schemas.microsoft.com/office/word/2010/wordprocessingInk"',
          'xmlns:wne="http://schemas.microsoft.com/office/word/2006/wordml"',
          'xmlns:wps="http://schemas.microsoft.com/office/word/2010/wordprocessingShape"',
          'mc:Ignorable="w14 wp14"',
        ].join(" ");

        const headerParagraphs = [
          docxParagraphXml(USER_REPORT_BRAND, {
            bold: true,
            size: 32,
            align: "center",
            spacingAfter: 120,
          }),
          docxParagraphXml(USER_REPORT_TITLE, {
            bold: true,
            size: 28,
            align: "center",
            spacingAfter: 160,
          }),
          docxParagraphXml(`Generated: ${generatedAt}`, { spacingAfter: 80 }),
          docxParagraphXml(summaryLine, { bold: true, spacingAfter: 200 }),
        ];

        const tableXml = docxTableXml(headers, rows);
        const footerParagraph = docxParagraphXml(
          "Confidential - For Internal Use Only",
          {
            italic: true,
            align: "center",
            spacingAfter: 0,
          }
        );

        const bodyContent = [
          ...headerParagraphs,
          tableXml,
          footerParagraph,
          `<w:sectPr>
      <w:pgSz w:w="16838" w:h="11906" w:orient="landscape"/>
      <w:pgMar w:top="720" w:right="720" w:bottom="720" w:left="720" w:header="720" w:footer="720" w:gutter="0"/>
      <w:cols w:space="360"/>
      <w:docGrid w:linePitch="360"/>
    </w:sectPr>`,
        ].join("");

        return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document ${namespaceAttrs}>
  <w:body>
    ${bodyContent}
  </w:body>
</w:document>`;
      }

      function getDocxContentTypesXml() {
        return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
  <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
  <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>
  <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
</Types>`;
      }

      function getDocxPackageRelsXml() {
        return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
  <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>
  <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>
</Relationships>`;
      }

      function getDocxDocumentRelsXml() {
        return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
</Relationships>`;
      }

      function getDocxStylesXml() {
        return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" mc:Ignorable="w14">
  <w:docDefaults>
    <w:rPrDefault>
      <w:rPr>
        <w:rFonts w:ascii="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/>
        <w:sz w:val="22"/>
        <w:szCs w:val="22"/>
      </w:rPr>
    </w:rPrDefault>
    <w:pPrDefault>
      <w:pPr>
        <w:spacing w:after="160"/>
      </w:pPr>
    </w:pPrDefault>
  </w:docDefaults>
  <w:style w:type="paragraph" w:default="1" w:styleId="Normal">
    <w:name w:val="Normal"/>
    <w:qFormat/>
    <w:pPr><w:spacing w:after="160"/></w:pPr>
    <w:rPr>
      <w:rFonts w:ascii="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/>
      <w:sz w:val="22"/>
      <w:szCs w:val="22"/>
    </w:rPr>
  </w:style>
</w:styles>`;
      }

      function getDocxAppXml() {
        return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties" xmlns:vt="http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes">
  <Application>DMS Portal</Application>
  <DocSecurity>0</DocSecurity>
  <ScaleCrop>false</ScaleCrop>
  <HeadingPairs>
    <vt:vector size="2" baseType="variant">
      <vt:variant><vt:lpstr>Title</vt:lpstr></vt:variant>
      <vt:variant><vt:i4>1</vt:i4></vt:variant>
    </vt:vector>
  </HeadingPairs>
  <TitlesOfParts>
    <vt:vector size="1" baseType="lpstr">
      <vt:lpstr>${escapeXml(USER_REPORT_TITLE)}</vt:lpstr>
    </vt:vector>
  </TitlesOfParts>
  <Company>DMS</Company>
  <LinksUpToDate>false</LinksUpToDate>
  <SharedDoc>false</SharedDoc>
  <HyperlinksChanged>false</HyperlinksChanged>
  <AppVersion>16.0000</AppVersion>
</Properties>`;
      }

      function getDocxCoreXml(timestamp) {
        const dateObj =
          timestamp instanceof Date ? timestamp : new Date(timestamp);
        const iso = dateObj.toISOString();
        return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:dcmitype="http://purl.org/dc/dcmitype/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <dc:title>${escapeXml(USER_REPORT_TITLE)}</dc:title>
  <dc:subject>User Management Export</dc:subject>
  <dc:creator>DMS Portal</dc:creator>
  <cp:lastModifiedBy>DMS Portal</cp:lastModifiedBy>
  <dcterms:created xsi:type="dcterms:W3CDTF">${iso}</dcterms:created>
  <dcterms:modified xsi:type="dcterms:W3CDTF">${iso}</dcterms:modified>
</cp:coreProperties>`;
      }

      // Export to PDF using jsPDF + autoTable
      async function exportToPDF(users, departments, filename) {
        const jsPDF = window.jspdf && window.jspdf.jsPDF;
        if (!jsPDF) {
          throw new Error("PDF export library failed to load.");
        }

        const reportRows = buildUserReportRows(users, departments);
        const stats = getUserReportStats(users);
        const generatedAt = getReportTimestamp();

        try {
          const doc = new jsPDF({
            orientation: "landscape",
            unit: "pt",
            format: "a4",
          });
          if (typeof doc.autoTable !== "function") {
            throw new Error("PDF table plugin is unavailable.");
          }
          const pageWidth = doc.internal.pageSize.getWidth();
          const pageHeight = doc.internal.pageSize.getHeight();

          doc.setFontSize(18);
          doc.text(USER_REPORT_BRAND, pageWidth / 2, 45, { align: "center" });
          doc.setFontSize(14);
          doc.text(USER_REPORT_TITLE, pageWidth / 2, 70, { align: "center" });
          doc.setFontSize(10);
          doc.text(`Generated: ${generatedAt}`, 40, 95);
          doc.text(
            `Total Users: ${stats.total} | Active: ${stats.active} | Archived: ${stats.archived}`,
            40,
            110
          );

          doc.autoTable({
            head: [USER_REPORT_HEADERS],
            body: reportRows,
            startY: 130,
            styles: { fontSize: 9, cellPadding: 5 },
            columnStyles: {
              0: { halign: "center", cellWidth: 40 },
              5: { halign: "center", cellWidth: 60 },
            },
            headStyles: { fillColor: [52, 73, 94] },
            alternateRowStyles: { fillColor: [248, 249, 250] },
          });

          doc.setFontSize(9);
          doc.text(
            "Confidential - For Internal Use Only",
            pageWidth / 2,
            pageHeight - 30,
            { align: "center" }
          );

          const exportFileName =
            filename ||
            `User_Management_Report_${new Date().toISOString().split("T")[0]}`;
          doc.save(`${exportFileName}.pdf`);
        } catch (error) {
          console.error("PDF export error:", error);
          throw error;
        }
      }

      // Export to DOCX using manual OpenXML packaging with JSZip
      async function exportToDOCX(users, departments, filename) {
        const JSZip = await ensureLibrary("JSZip");
        if (!JSZip) {
          throw new Error("DOCX export requires the JSZip library.");
        }

        const reportRows = buildUserReportRows(users, departments);
        const stats = getUserReportStats(users);
        const generatedDate = new Date();
        const generatedAt = getReportTimestamp(generatedDate);
        const summaryLine = `Total Users: ${stats.total} | Active: ${stats.active} | Archived: ${stats.archived}`;

        try {
          const documentXml = buildDocxDocumentXml({
            generatedAt,
            summaryLine,
            headers: USER_REPORT_HEADERS,
            rows: reportRows,
          });

          const zip = new JSZip();
          zip.file("[Content_Types].xml", getDocxContentTypesXml());
          zip.folder("_rels").file(".rels", getDocxPackageRelsXml());

          const docPropsFolder = zip.folder("docProps");
          docPropsFolder.file("core.xml", getDocxCoreXml(generatedDate));
          docPropsFolder.file("app.xml", getDocxAppXml());

          const wordFolder = zip.folder("word");
          wordFolder.file("document.xml", documentXml);
          wordFolder.file("styles.xml", getDocxStylesXml());
          wordFolder
            .folder("_rels")
            .file("document.xml.rels", getDocxDocumentRelsXml());

          const blob = await zip.generateAsync({
            type: "blob",
            mimeType:
              "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
          });

          const exportFileName =
            filename ||
            `User_Management_Report_${new Date().toISOString().split("T")[0]}`;
          triggerReportDownload(blob, `${exportFileName}.docx`);
        } catch (error) {
          console.error("DOCX export error:", error);
          throw error;
        }
      }

      // Archive user function
      async function openArchiveUser(userId) {
        const user = await apiCall(`/users/${userId}`);
        if (!user) {
          showToast("User not found", "error");
          return;
        }

        const currentUser = await getCurrentUser();
        if (user.user_id === currentUser.user_id) {
          showToast("You cannot archive your own account", "error");
          return;
        }

        openModal(`<h3>Archive User</h3>
    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="small-muted">
        Are you sure you want to archive user <strong>"${user.name}"</strong>?
      </div>
      <div class="small-muted">
        Archived users will be moved to the Archives section and can be restored later.
      </div>
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button class="btn-secondary" onclick="closeModal()">
          <i class="fa-solid fa-xmark"></i> Cancel
        </button>
        <button onclick="executeArchiveUser(${userId})">
          <i class="fa-solid fa-box-archive"></i> Archive User
        </button>
      </div>
    </div>`);
      }

      async function executeArchiveUser(userId) {
        try {
          closeModal();
          showToast("Archiving user...", "info");

          // Use apiCall instead of direct fetch
          const result = await apiCall(`/users/${userId}/archive`, {
            method: "POST",
            body: { status: "archived" },
          });

          if (result && result.success) {
            showToast("User archived successfully", "success");

            // Refresh all views including archives
            await refreshAllViews();

            // If we're in user management, refresh it
            if (currentView === "userMgmt") {
              await renderUsers();
            }

            // If we're in archives, refresh it
            if (currentView === "archives") {
              await renderArchives();
            }

            const currentUser = await getCurrentUser();
            const user = await apiCall(`/users/${userId}`);
            if (currentUser && user) {
              await logActivity({
                user_id: currentUser.user_id,
                activity: `Archived user: ${user.name}`,
              });
            }
          } else {
            showToast(result?.error || "Failed to archive user", "error");
          }
        } catch (error) {
          console.error("Archive user error:", error);
          showToast(
            "Error archiving user: " + (error.message || "Unknown error"),
            "error"
          );
        }
      }

      // Open delete confirmation modal (for permanent delete from archive)
      async function openDeleteUser(userId) {
        const user = await apiCall(`/users/${userId}`);
        if (!user) {
          showToast("User not found", "error");
          return;
        }

        const currentUser = await getCurrentUser();
        if (user.user_id === currentUser.user_id) {
          showToast("You cannot delete your own account", "error");
          return;
        }

        openModal(`<h3>Permanently Delete User</h3>
    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="danger">
        <i class="fa-solid fa-exclamation-triangle"></i> 
        <strong>Warning:</strong> This action cannot be undone. The user will be permanently deleted.
      </div>
      <div class="small-muted">
        Are you sure you want to permanently delete user <strong>${user.name}</strong> (${user.email})?
      </div>
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
        <button class="btn-danger" onclick="executeDeleteUserPermanent(${userId})">
          <i class="fa-solid fa-trash"></i> Delete Permanently
        </button>
      </div>
    </div>`);
      }

      // Confirm and execute user deletion
      async function confirmDeleteUser(userId, userName) {
        const result = await deleteUserAPI(userId);
        if (result && result.success) {
          showToast(`User "${userName}" deleted successfully`, "success");
          closeModal();
          await renderUsers();
          await refreshStats();

          const currentUser = await getCurrentUser();
          if (currentUser) {
            await logActivity({
              user_id: currentUser.user_id,
              activity: `Deleted user: ${userName}`,
            });
          }
        } else {
          showToast("Failed to delete user", "error");
        }
      }

      // Update the openEditUser function to handle department validation properly
      async function openEditUser(userId) {
        const user = await apiCall(`/users/${userId}`);
        const departments = await getAllDepartments();

        if (!user) {
          showToast("User not found", "error");
          return;
        }

        const deptOptions = departments
          .map(
            (d) =>
              `<option value="${d.department_id}" ${
                d.department_id == user.department_id ? "selected" : ""
              }>${d.name}</option>`
          )
          .join("");

        openModal(`<h3>Edit User</h3>
    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="form-row">
        <label>Full Name</label>
        <input id="eu_name" value="${user.name}"/>
      </div>
      <div class="form-row">
        <label>Email</label>
        <input id="eu_email" value="${user.email}" type="email"/>
      </div>
      <div class="form-row">
        <label>Role</label>
        <select id="eu_role">
          <option value="system_admin" ${
            user.role === "system_admin" ? "selected" : ""
          }>System Admin</option>
          <option value="department_admin" ${
            user.role === "department_admin" ? "selected" : ""
          }>Department Admin</option>
          <option value="staff" ${
            user.role === "staff" ? "selected" : ""
          }>Staff</option>
        </select>
      </div>
      <div class="form-row">
        <label>Department</label>
        <select id="eu_dept">
          <option value="">Select Department</option>
          ${deptOptions}
        </select>
      </div>
      <div class="form-row">
        <label>Status</label>
        <select id="eu_status">
          <option value="active" ${
            user.status === "active" ? "selected" : ""
          }>Active</option>
          <option value="archived" ${
            user.status === "archived" ? "selected" : ""
          }>Archived</option>
        </select>
      </div>
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
        <button onclick="modalSaveUser(${userId})"><i class="fa-solid fa-check"></i> Save</button>
      </div>
    </div>`);
      }

      // Update the modalSaveUser function
      async function modalSaveUser(userId) {
        const name = document.getElementById("eu_name").value.trim();
        const email = document.getElementById("eu_email").value.trim();
        const role = document.getElementById("eu_role").value;
        const departmentId = document.getElementById("eu_dept").value;
        const status = document.getElementById("eu_status").value;

        if (!name || !email || !departmentId) {
          showToast("Please fill all required fields", "error");
          return;
        }

        if (departmentId === "") {
          showToast("Please select a department", "error");
          return;
        }

        const updateData = {
          name: name,
          email: email,
          role: role,
          department_id: departmentId ? parseInt(departmentId) : null,
          status: status,
        };

        console.log("DEBUG: Updating user with data:", updateData);

        const result = await updateUser(userId, updateData);
        console.log("DEBUG: Update result:", result);

        if (result && result.success) {
          showToast("User updated successfully", "success");
          closeModal();
          await renderUsers();
          await refreshStats();

          const currentUser = await getCurrentUser();
          if (currentUser) {
            await logActivity({
              user_id: currentUser.user_id,
              activity: `Updated user: ${name}`,
            });
          }
        } else {
          const errorMsg = result?.error || "Failed to update user";
          console.error("Update failed:", errorMsg);
          showToast(errorMsg, "error");
        }
      }

      // Update the openAddUser function to include password confirmation
      async function openAddUser() {
        const departments = await getAllDepartments();
        const deptOptions = departments
          .map((d) => `<option value="${d.department_id}">${d.name}</option>`)
          .join("");

        openModal(`<h3>Add User</h3>
    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="form-row">
        <label>Full Name</label>
        <input id="mu_name" placeholder="Full name"/>
      </div>
      <div class="form-row">
        <label>Email</label>
        <input id="mu_email" placeholder="Email" type="email"/>
      </div>
      <div class="form-row">
        <label>Password</label>
        <input id="mu_pass" placeholder="Password" type="password"/>
      </div>
      <div class="form-row">
        <label>Confirm Password</label>
        <input id="mu_pass_confirm" placeholder="Confirm password" type="password"/>
      </div>
      <div class="form-row">
        <label>Role</label>
        <select id="mu_role">
          <option value="system_admin">System Admin</option>
          <option value="department_admin">Department Admin</option>
          <option value="staff" selected>Staff</option>
        </select>
      </div>
      <div class="form-row">
        <label>Department</label>
        <select id="mu_dept">
          <option value="">Select Department</option>
          ${deptOptions}
        </select>
      </div>
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
        <button onclick="modalAddUser()"><i class="fa-solid fa-check"></i> Save</button>
      </div>
    </div>`);
      }

      // Update the modalAddUser function with password confirmation
      async function modalAddUser() {
        const name = document.getElementById("mu_name").value.trim();
        const email = document.getElementById("mu_email").value.trim();
        const password = document.getElementById("mu_pass").value;
        const passwordConfirm =
          document.getElementById("mu_pass_confirm").value;
        const role = document.getElementById("mu_role").value;
        const departmentId = document.getElementById("mu_dept").value;

        if (!name || !email || !password || !departmentId) {
          showToast("Please fill all required fields", "error");
          return;
        }

        if (departmentId === "") {
          showToast("Please select a department", "error");
          return;
        }

        if (password !== passwordConfirm) {
          showToast("Passwords do not match", "error");
          return;
        }

        if (password.length < 6) {
          showToast("Password must be at least 6 characters long", "error");
          return;
        }

        const userData = {
          name: name,
          email: email,
          password: password,
          role: role,
          department_id: departmentId ? parseInt(departmentId) : null,
        };

        console.log("DEBUG: Creating user with data:", userData);
        console.log("DEBUG: Role value:", role);

        const result = await createUser(userData);
        console.log("DEBUG: Create result:", result);

        if (result && (result.user_id || result.success)) {
          showToast("User created successfully", "success");
          closeModal();
          await renderUsers();
          await refreshStats();

          const currentUser = await getCurrentUser();
          if (currentUser) {
            await logActivity({
              user_id: currentUser.user_id,
              activity: `Added user: ${name}`,
            });
          }
        } else {
          const errorMsg = result?.error || "Failed to create user";
          console.error("Create failed:", errorMsg);
          showToast(errorMsg, "error");
        }
      }

      // Department Management (already working)
      async function openAddDepartment() {
        const users = await getAllUsers();
        const currentUser = await getCurrentUser();

        // Show ALL active users
        const userOptions = users
          .filter((u) => u.status === "active")
          .map(
            (u) => `
        <div class="multi-select-option" data-id="${u.user_id}">
          <div class="member-avatar" style="width:24px;height:24px;font-size:10px">
            ${u.name
              .split(" ")
              .map((s) => s[0])
              .slice(0, 2)
              .join("")
              .toUpperCase()}
          </div>
          <span>${u.name} ${
              u.user_id === currentUser.user_id ? "(You)" : ""
            } (${u.email})</span>
        </div>
      `
          )
          .join("");

        openModal(`<h3>Add Department</h3>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="form-row">
          <label>Department name</label>
          <input id="d_name" placeholder="Department name"/>
        </div>
        <div class="form-row">
          <label>Members</label>
          <div class="multi-select-container">
            <input id="dept_member_search" placeholder="Search users to add..." oninput="filterDeptMemberOptions()"/>
            <div class="multi-select-dropdown" id="deptMemberDropdown">
              ${userOptions}
            </div>
          </div>
          <div class="multi-select-selected" id="deptSelectedMembers">
            <div class="small-muted" style="text-align:center;padding:10px">No members selected</div>
          </div>
          <div class="small-muted">Click users above to add them to this department.</div>
        </div>
        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
          <button onclick="modalAddDept()"><i class="fa-solid fa-check"></i> Save</button>
        </div>
      </div>`);

        // Initialize member selection
        setTimeout(() => {
          const searchInput = document.getElementById("dept_member_search");
          if (searchInput) {
            searchInput.addEventListener("focus", function () {
              document
                .getElementById("deptMemberDropdown")
                .classList.add("active");
            });
          }

          document
            .querySelectorAll("#deptMemberDropdown .multi-select-option")
            .forEach((option) => {
              option.addEventListener("click", function () {
                const memberId = this.getAttribute("data-id");
                addMemberToDepartment(memberId);
              });
            });
        }, 100);
      }

      function filterDeptMemberOptions() {
        const search = document
          .getElementById("dept_member_search")
          .value.toLowerCase();
        const options = document.querySelectorAll(
          "#deptMemberDropdown .multi-select-option"
        );

        options.forEach((option) => {
          const text = option.textContent.toLowerCase();
          option.style.display = text.includes(search) ? "flex" : "none";
        });
      }

      async function addMemberToDepartment(userId) {
        const users = await getAllUsers();
        const user = users.find((u) => u.user_id == userId);
        if (!user) return;

        const selectedContainer = document.getElementById(
          "deptSelectedMembers"
        );
        const existing = selectedContainer.querySelector(
          `[data-id="${userId}"]`
        );
        if (existing) return;

        // Remove "No members selected" message
        const noMembersMsg = selectedContainer.querySelector(".small-muted");
        if (
          noMembersMsg &&
          noMembersMsg.textContent.includes("No members selected")
        ) {
          noMembersMsg.remove();
        }

        const memberEl = document.createElement("div");
        memberEl.className = "selected-member";
        memberEl.setAttribute("data-id", userId);
        memberEl.innerHTML = `
      ${user.name}
      <button class="remove-member" onclick="removeMemberFromDepartment('${userId}')">
        <i class="fa-solid fa-xmark"></i>
      </button>
    `;
        selectedContainer.appendChild(memberEl);

        // Hide the option from dropdown
        const option = document.querySelector(
          `#deptMemberDropdown .multi-select-option[data-id="${userId}"]`
        );
        if (option) {
          option.style.display = "none";
        }

        // Clear search and hide dropdown
        document.getElementById("dept_member_search").value = "";
        document
          .getElementById("deptMemberDropdown")
          .classList.remove("active");
      }

      function removeMemberFromDepartment(userId) {
        const memberEl = document.querySelector(
          `#deptSelectedMembers .selected-member[data-id="${userId}"]`
        );
        if (memberEl) {
          memberEl.remove();
        }

        // Show the option back in dropdown
        const option = document.querySelector(
          `#deptMemberDropdown .multi-select-option[data-id="${userId}"]`
        );
        if (option) {
          option.style.display = "flex";
        }

        // Show "No members selected" if empty
        const selectedContainer = document.getElementById(
          "deptSelectedMembers"
        );
        if (selectedContainer && selectedContainer.children.length === 0) {
          selectedContainer.innerHTML =
            '<div class="small-muted" style="text-align:center;padding:10px">No members selected</div>';
        }
      }

      async function modalAddDept() {
        const name = document.getElementById("d_name").value.trim();
        if (!name) {
          showToast("Enter department name", "error");
          return;
        }

        const currentUser = await getCurrentUser();
        if (!currentUser) {
          showToast("User not found", "error");
          return;
        }

        // Get selected members
        const selectedMembers = Array.from(
          document.querySelectorAll("#deptSelectedMembers .selected-member")
        ).map((el) => parseInt(el.getAttribute("data-id")));

        const result = await createDepartment({
          name: name,
          user_id: currentUser.user_id,
        });
        if (result && result.department_id) {
          // Assign members to department
          if (selectedMembers.length > 0) {
            for (const userId of selectedMembers) {
              await updateUser(userId, { department_id: result.department_id });
            }
          }

          showToast("Department added successfully", "success");
          closeModal();
          await renderDepartments();
          await logActivity({
            user_id: currentUser.user_id,
            activity: `Added department: ${name}`,
          });
        }
      }

      async function renderDepartments() {
        const out = document.getElementById("departmentsList");
        const departments = await getAllDepartments();
        const users = await getAllUsers();
        const currentUser = await getCurrentUser();

        out.innerHTML = "";

        if (!departments || departments.length === 0) {
          out.innerHTML =
            '<div class="card small-muted" style="text-align:center;padding:40px">No departments</div>';
          return;
        }

        let visibleDepartments = departments;
        if (currentUser?.role === "department_admin") {
          visibleDepartments = departments.filter(
            (d) => d.department_id === currentUser.department_id
          );
        }

        if (!visibleDepartments.length) {
          out.innerHTML =
            '<div class="card small-muted" style="text-align:center;padding:40px">No departments available.</div>';
          return;
        }

        visibleDepartments.forEach((d) => {
          let deptUsers = users.filter(
            (u) => u.department_id == d.department_id && u.status === "active"
          );
          if (currentUser?.role === "department_admin") {
            deptUsers = deptUsers.filter((u) => u.role === "staff");
          }

          const card = document.createElement("div");
          card.className = "card";
          card.style.marginBottom = "12px";
          card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px">
          <div style="flex:1;display:flex;align-items:flex-start;gap:12px">
            <div style="width:40px;height:40px;border-radius:8px;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center;flex-shrink:0">
              <i class="fa-solid fa-users-rectangle"></i>
            </div>
            <div style="flex:1">
              <div style="font-weight:600;color:var(--text);margin-bottom:8px">${
                d.name
              }</div>
              <div class="small-muted" style="margin-bottom:12px">Department ID: ${
                d.department_id
              }  ${deptUsers.length} member(s)</div>
              ${
                deptUsers.length > 0
                  ? `
                <div style="margin-top:12px">
                  <div class="small-muted" style="margin-bottom:8px;font-weight:600">Assigned Users:</div>
                  <div style="display:flex;flex-wrap:wrap;gap:8px">
                    ${deptUsers
                      .map(
                        (u) => `
                      <div style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--accent-light);border-radius:6px;font-size:13px">
                        <div style="width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent-dark));display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:10px;flex-shrink:0">
                          ${u.name
                            .split(" ")
                            .map((s) => s[0])
                            .slice(0, 2)
                            .join("")
                            .toUpperCase()}
                        </div>
                        <span style="color:var(--text)">${u.name}</span>
                        <span class="small-muted">(${
                          u.role === "system_admin"
                            ? "System Admin"
                            : u.role === "department_admin"
                            ? "Dept Admin"
                            : "Staff"
                        })</span>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                </div>
              `
                  : `
                <div class="small-muted" style="padding:8px;background:var(--bg);border-radius:6px;text-align:center">
                  No users assigned to this department
                </div>
              `
              }
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-shrink:0;align-items:flex-start">
            <button class="icon-btn" onclick="openEditDepartment(${
              d.department_id
            }, '${d.name.replace(/'/g, "\\'")}')" title="Edit">
              <i class="fa-solid fa-pen"></i>
            </button>
            <button class="icon-btn" onclick="deleteDepartment(${
              d.department_id
            }, '${d.name.replace(
            /'/g,
            "\\'"
          )}')" title="Delete" style="color:var(--danger)">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>
      `;
          out.appendChild(card);
        });
      }

      async function openEditDepartment(departmentId, departmentName) {
        const users = await getAllUsers();
        const departments = await getAllDepartments();
        const dept = departments.find((d) => d.department_id == departmentId);
        const currentUser = await getCurrentUser();
        if (!dept) {
          showToast("Department not found", "error");
          return;
        }
        if (
          currentUser?.role === "department_admin" &&
          currentUser.department_id != departmentId
        ) {
          showToast("You can only manage your own department.", "error");
          return;
        }
        let currentDeptUsers = users.filter(
          (u) => u.department_id == departmentId && u.status === "active"
        );
        if (currentUser?.role === "department_admin") {
          currentDeptUsers = currentDeptUsers.filter((u) => u.role === "staff");
        }
        let availableUsers = users.filter(
          (u) => u.status === "active" && u.department_id != departmentId
        );
        if (currentUser?.role === "department_admin") {
          availableUsers = users.filter(
            (u) =>
              u.status === "active" &&
              u.department_id === departmentId &&
              u.role === "staff"
          );
        }

        const userOptions = availableUsers
          .map(
            (u) => `
        <div class="multi-select-option" data-id="${u.user_id}">
          <div class="member-avatar" style="width:24px;height:24px;font-size:10px">
            ${u.name
              .split(" ")
              .map((s) => s[0])
              .slice(0, 2)
              .join("")
              .toUpperCase()}
          </div>
          <span>${u.name} ${
              u.user_id === currentUser.user_id ? "(You)" : ""
            } (${u.email})</span>
        </div>
      `
          )
          .join("");

        const currentMembersHTML =
          currentDeptUsers.length > 0
            ? currentDeptUsers
                .map(
                  (u) => `
      <div class="selected-member" data-id="${u.user_id}">
        ${u.name}
        <button class="remove-member" onclick="removeMemberFromEditDepartment('${u.user_id}', ${departmentId})">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    `
                )
                .join("")
            : '<div class="small-muted" style="text-align:center;padding:10px">No members yet</div>';

        openModal(`<h3>Edit Department</h3>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="form-row">
          <label>Department name</label>
          <input id="ed_dept_name" placeholder="Department name" value="${departmentName.replace(
            /"/g,
            "&quot;"
          )}"/>
        </div>
        <div class="form-row">
          <label>Members</label>
          <div class="multi-select-container">
            <input id="ed_dept_member_search" placeholder="Search users to add..." oninput="filterEditDeptMemberOptions()"/>
            <div class="multi-select-dropdown" id="edDeptMemberDropdown">
              ${userOptions}
            </div>
          </div>
          <div class="multi-select-selected" id="edDeptSelectedMembers">
            ${currentMembersHTML}
          </div>
          <div class="small-muted">Click users above to add them to this department. You can remove any member.</div>
        </div>
        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
          <button onclick="saveEditDepartment(${departmentId})"><i class="fa-solid fa-check"></i> Save</button>
        </div>
      </div>`);

        // Initialize member selection
        setTimeout(() => {
          const searchInput = document.getElementById("ed_dept_member_search");
          if (searchInput) {
            searchInput.addEventListener("focus", function () {
              document
                .getElementById("edDeptMemberDropdown")
                .classList.add("active");
            });
          }

          document
            .querySelectorAll("#edDeptMemberDropdown .multi-select-option")
            .forEach((option) => {
              option.addEventListener("click", function () {
                const memberId = this.getAttribute("data-id");
                addMemberToEditDepartment(memberId, departmentId);
              });
            });
        }, 100);

        // Store department ID for member functions
        window.currentEditDeptId = departmentId;
      }

      function filterEditDeptMemberOptions() {
        const search = document
          .getElementById("ed_dept_member_search")
          .value.toLowerCase();
        const options = document.querySelectorAll(
          "#edDeptMemberDropdown .multi-select-option"
        );

        options.forEach((option) => {
          const text = option.textContent.toLowerCase();
          option.style.display = text.includes(search) ? "flex" : "none";
        });
      }

      async function addMemberToEditDepartment(userId, departmentId) {
        const users = await getAllUsers();
        const user = users.find((u) => u.user_id == userId);
        if (!user) return;

        const selectedContainer = document.getElementById(
          "edDeptSelectedMembers"
        );
        const existing = selectedContainer.querySelector(
          `[data-id="${userId}"]`
        );
        if (existing) return;

        // Remove "No members yet" message
        const noMembersMsg = selectedContainer.querySelector(".small-muted");
        if (
          noMembersMsg &&
          noMembersMsg.textContent.includes("No members yet")
        ) {
          noMembersMsg.remove();
        }

        const memberEl = document.createElement("div");
        memberEl.className = "selected-member";
        memberEl.setAttribute("data-id", userId);
        memberEl.innerHTML = `
      ${user.name}
      <button class="remove-member" onclick="removeMemberFromEditDepartment('${userId}', ${departmentId})">
        <i class="fa-solid fa-xmark"></i>
      </button>
    `;
        selectedContainer.appendChild(memberEl);

        // Hide the option from dropdown
        const option = document.querySelector(
          `#edDeptMemberDropdown .multi-select-option[data-id="${userId}"]`
        );
        if (option) {
          option.style.display = "none";
        }

        // Clear search and hide dropdown
        document.getElementById("ed_dept_member_search").value = "";
        document
          .getElementById("edDeptMemberDropdown")
          .classList.remove("active");
      }

      async function removeMemberFromEditDepartment(userId, departmentId) {
        // Update user to remove from department (set department_id to null)
        const result = await updateUser(userId, { department_id: null });
        if (result && result.success) {
          const memberEl = document.querySelector(
            `#edDeptSelectedMembers .selected-member[data-id="${userId}"]`
          );
          if (memberEl) {
            memberEl.remove();
          }

          // Show the option back in dropdown
          const option = document.querySelector(
            `#edDeptMemberDropdown .multi-select-option[data-id="${userId}"]`
          );
          if (option) {
            option.style.display = "flex";
          }

          // Show "No members yet" if empty
          const selectedContainer = document.getElementById(
            "edDeptSelectedMembers"
          );
          if (selectedContainer && selectedContainer.children.length === 0) {
            selectedContainer.innerHTML =
              '<div class="small-muted" style="text-align:center;padding:10px">No members yet</div>';
          }

          showToast("Member removed from department", "success");
        } else {
          showToast("Failed to remove member", "error");
        }
      }

      async function saveEditDepartment(departmentId) {
        const name = document.getElementById("ed_dept_name").value.trim();
        if (!name) {
          showToast("Enter department name", "error");
          return;
        }

        // Get selected members
        const selectedMembers = Array.from(
          document.querySelectorAll("#edDeptSelectedMembers .selected-member")
        ).map((el) => parseInt(el.getAttribute("data-id")));

        // Update each selected member's department_id
        let successCount = 0;
        for (const userId of selectedMembers) {
          const result = await updateUser(userId, {
            department_id: departmentId,
          });
          if (result && result.success) {
            successCount++;
          }
        }

        // Note: Department name update would require a backend endpoint
        // For now, we'll just update members
        if (successCount > 0 || selectedMembers.length === 0) {
          showToast("Department updated successfully", "success");
          closeModal();
          await renderDepartments();

          const currentUser = await getCurrentUser();
          if (currentUser) {
            await logActivity({
              user_id: currentUser.user_id,
              activity: `Updated department: ${name}`,
            });
          }
        } else {
          showToast("Failed to update department", "error");
        }
      }

      async function deleteDepartment(departmentId, departmentName) {
        if (
          !confirm(
            `Are you sure you want to delete department "${departmentName}"? This action cannot be undone.`
          )
        ) {
          return;
        }

        const result = await deleteDepartmentAPI(departmentId);
        if (result) {
          showToast(
            `Department "${departmentName}" deleted successfully`,
            "success"
          );

          const currentUser = await getCurrentUser();
          if (currentUser) {
            await logActivity({
              user_id: currentUser.user_id,
              activity: `Deleted department: ${departmentName}`,
            });
          }

          await renderDepartments();
        } else {
          showToast("Failed to delete department", "error");
        }
      }

      // Category Management
      async function openAddCategory() {
        openModal(`<h3>Add Category</h3>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="form-row">
          <label>Category Name</label>
          <input id="c_name" placeholder="Category name"/>
        </div>
        <div class="form-row">
          <label>Description</label>
          <textarea id="c_desc" placeholder="Description (optional)"></textarea>
        </div>
        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
          <button onclick="modalAddCat()"><i class="fa-solid fa-check"></i> Save</button>
        </div>
      </div>`);
      }

      async function modalAddCat() {
        const name = document.getElementById("c_name").value.trim();
        const desc = document.getElementById("c_desc").value.trim();

        if (!name) {
          showToast("Category name is required", "error");
          return;
        }

        const categoryData = {
          name: name,
          description: desc || null,
          auto_created: false,
          is_unclassified: false,
        };

        const result = await createCategory(categoryData);
        if (result && result.category_id) {
          showToast("Category added successfully", "success");
          closeModal();
          await renderCategories();

          const currentUser = await getCurrentUser();
          if (currentUser) {
            await logActivity({
              user_id: currentUser.user_id,
              activity: `Added category: ${name}`,
            });
          }
        }
      }

      async function renderCategories() {
        const out = document.getElementById("categoriesList");
        let categories = await getAllCategories();
        const files = await getAllFiles();

        categories = categories || [];

        categories.sort((a, b) => {
          const nameA = a.name.toLowerCase();
          const nameB = b.name.toLowerCase();
          return categoriesSortOrder === "asc"
            ? nameA.localeCompare(nameB)
            : nameB.localeCompare(nameA);
        });

        out.innerHTML = "";

        if (!categories.length) {
          out.innerHTML =
            '<div class="card small-muted" style="text-align:center;padding:40px">No categories</div>';
          return;
        }

        for (const c of categories) {
          // Get files that belong to this category by category_id OR by document_type matching category name
          const categoryFiles = files.filter(
            (f) =>
              f.status === "active" &&
              (f.category_id === c.category_id ||
                (f.document_type &&
                  f.document_type.toLowerCase() === c.name.toLowerCase()))
          );

          const fileCount = categoryFiles.length;

          const card = document.createElement("div");
          card.className = "card";
          if (c.is_unclassified) {
            card.classList.add("category-unclassified");
          }
          card.style.marginBottom = "12px";

          card.innerHTML = `
            <div class="category-header" style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
                <div style="display:flex;align-items:center;gap:12px;flex:1;">
                    <div style="width:40px;height:40px;border-radius:8px;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center">
                        <i class="fa-solid fa-list"></i>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;color:var(--text)">${
                          c.name
                        }</div>
                        <div class="small-muted">${
                          c.description || "No description"
                        }  ${fileCount} file${fileCount !== 1 ? "s" : ""}</div>
                    </div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <i class="fa-solid fa-chevron-down category-arrow" style="transition: transform 0.3s ease;color:var(--text-muted);margin-right:16px;"></i>
                    <button onclick="event.stopPropagation(); openEditCategory(${
                      c.category_id
                    })"><i class="fa-solid fa-pen"></i> Edit</button>
                </div>
            </div>
            <div class="category-files" style="display:none;margin-top:16px;border-top:1px solid var(--border);padding-top:16px;">
                ${
                  fileCount > 0
                    ? categoryFiles
                        .map(
                          (f) => `
                    <div class="doc-adaptive" style="margin-bottom:8px;" onclick="openFilePreview(${
                      f.file_id
                    })">
                        <div class="doc-header">
                            <div class="doc-icon">${fileIcon(f.name)}</div>
                            <div class="doc-info">
                                <div class="doc-name">${f.name}</div>
                                <div class="doc-meta">
                                    ${f.type.toUpperCase()}  
                                    ${(f.size / 1024) | 0} KB  
                                    ${new Date(f.created_at).toLocaleString()}
                                </div>
                            </div>
                        </div>
                        <div class="doc-actions">
                            <button class="icon-btn" onclick="event.stopPropagation(); downloadFile(${
                              f.file_id
                            })">
                                <i class="fa-solid fa-download"></i>
                            </button>
                            <button class="icon-btn" title="Archive" onclick="event.stopPropagation(); moveToArchive(${
                              f.file_id
                            })">
                                <i class="fa-solid fa-box-archive"></i>
                            </button>
                        </div>
                    </div>
                `
                        )
                        .join("")
                    : '<div class="small-muted" style="text-align:center;padding:20px;">No files in this category</div>'
                }
            </div>
        `;

          const header = card.querySelector(".category-header");
          const filesSection = card.querySelector(".category-files");
          const arrow = card.querySelector(".category-arrow");

          header.addEventListener("click", (e) => {
            if (e.target.closest("button")) return;
            const isExpanded = filesSection.style.display === "block";
            filesSection.style.display = isExpanded ? "none" : "block";
            arrow.style.transform = isExpanded
              ? "rotate(0deg)"
              : "rotate(180deg)";
          });

          out.appendChild(card);
        }
      }

      async function openEditCategory(categoryId) {
        const categories = await getAllCategories();
        const category = categories.find((c) => c.category_id == categoryId);

        if (!category) {
          showToast("Category not found", "error");
          return;
        }

        openModal(`<h3>Edit Category</h3>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="form-row">
          <label>Category Name</label>
          <input id="editCatName" value="${
            category.name
          }" placeholder="Category name"/>
        </div>
        <div class="form-row">
          <label>Description</label>
          <textarea id="editCatDesc" placeholder="Description (optional)">${
            category.description || ""
          }</textarea>
        </div>
        ${
          category.auto_created
            ? `
          <div class="small-muted" style="color:var(--warning);background:var(--accent-light);padding:8px 12px;border-radius:8px;">
            <i class="fa-solid fa-robot"></i> Auto-classified
          </div>
        `
            : ""
        }
        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
          <button onclick="saveEditedCategory(${categoryId})"><i class="fa-solid fa-check"></i> Save Changes</button>
        </div>
      </div>`);
      }

      async function saveEditedCategory(categoryId) {
        const name = document.getElementById("editCatName").value.trim();
        const desc = document.getElementById("editCatDesc").value.trim();

        if (!name) {
          showToast("Category name is required", "error");
          return;
        }

        const categoryData = {
          name: name,
          description: desc || null,
        };

        const result = await updateCategory(categoryId, categoryData);
        if (result && result.success) {
          showToast("Category updated successfully", "success");
          closeModal();
          await renderCategories();

          const currentUser = await getCurrentUser();
          if (currentUser) {
            await logActivity({
              user_id: currentUser.user_id,
              activity: `Updated category: ${name}`,
            });
          }
        }
      }

      function sortCategories() {
        categoriesSortOrder = categoriesSortOrder === "asc" ? "desc" : "asc";

        const sortIcon = document.getElementById("sortIcon");
        const sortBtn = document.getElementById("sortCategoriesBtn");

        if (categoriesSortOrder === "asc") {
          sortIcon.className = "fa-solid fa-sort-alpha-down";
          sortBtn.title = "Sort A-Z";
        } else {
          sortIcon.className = "fa-solid fa-sort-alpha-up";
          sortBtn.title = "Sort Z-A";
        }

        renderCategories();
      }

      async function saveDocumentTypeAsCategory(documentType) {
        if (!documentType) return null;

        const categories = await getAllCategories();
        const existingCategory = categories.find(
          (cat) => cat.name.toLowerCase() === documentType.toLowerCase()
        );

        if (existingCategory) {
          return existingCategory.category_id;
        }

        const isUnclassified =
          documentType === "Unclassified" ||
          documentType.includes("Unclassified");
        const result = await createCategory({
          name: documentType,
          description: isUnclassified ? "Unknown file types" : "",
          auto_created: true,
          is_unclassified: isUnclassified,
        });

        if (result && result.category_id) {
          const currentUser = await getCurrentUser();
          if (currentUser) {
            await logActivity({
              user_id: currentUser.user_id,
              activity: `Auto-created category: ${documentType}`,
            });
          }
          return result.category_id;
        }

        return null;
      }

      // Archives
      async function renderArchives() {
        const out = document.getElementById("archivesList");
        out.innerHTML = "";

        const filterSelect = document.getElementById("archiveFilterType");
        const sortSelect = document.getElementById("archiveSortOrder");
        const currentUser = await getCurrentUser();
        const isStaff = currentUser?.role === "staff";
        const isDeptAdmin = currentUser?.role === "department_admin";

        let filterType = filterSelect?.value || "all";
        if (isStaff) {
          filterType = "files";
          if (filterSelect) {
            filterSelect.value = "files";
            filterSelect.disabled = true;
            Array.from(filterSelect.options || []).forEach((opt) => {
              if (opt.value !== "files") opt.style.display = "none";
            });
          }
        } else if (filterSelect) {
          filterSelect.disabled = false;
          Array.from(filterSelect.options || []).forEach(
            (opt) => (opt.style.display = "block")
          );
        }

        const sortOrder = sortSelect?.value || "newest";

        const files = await getAllFiles();
        const users = await getAllUsers();
        const allowedUserIds =
          currentUser && currentUser.role !== "system_admin"
            ? new Set(
                currentUser.role === "department_admin" &&
                currentUser.department_id
                  ? users
                      .filter(
                        (u) => u.department_id === currentUser.department_id
                      )
                      .map((u) => u.user_id)
                  : [currentUser.user_id]
              )
            : null;
        if (
          allowedUserIds &&
          currentUser &&
          !allowedUserIds.has(currentUser.user_id)
        ) {
          allowedUserIds.add(currentUser.user_id);
        }

        let archivedFiles = files.filter((f) => f.status === "archived");
        if (allowedUserIds) {
          archivedFiles = archivedFiles.filter((f) =>
            allowedUserIds.has(f.user_id)
          );
        }

        let archivedUsers = users.filter((u) => u.status === "archived");
        if (allowedUserIds) {
          archivedUsers = archivedUsers.filter((u) =>
            allowedUserIds.has(u.user_id)
          );
        }

        let itemsToShow = [];

        if (filterType === "files" || filterType === "all") {
          archivedFiles.forEach((f) =>
            itemsToShow.push({ type: "file", data: f })
          );
        }

        if (!isStaff && (filterType === "users" || filterType === "all")) {
          archivedUsers.forEach((u) =>
            itemsToShow.push({ type: "user", data: u })
          );
        }

        if (!itemsToShow.length) {
          out.innerHTML =
            '<div class="card small-muted" style="text-align:center;padding:40px">No archived items</div>';
          const selectAll = document.getElementById("selectAllArchived");
          if (selectAll) selectAll.checked = false;
          const bulkRestoreBtn = document.getElementById("bulkRestoreBtn");
          const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
          if (bulkRestoreBtn) bulkRestoreBtn.style.display = "none";
          if (bulkDeleteBtn) bulkDeleteBtn.style.display = "none";
          return;
        }

        const nameValue = (item) => {
          const value = item?.data?.name || item?.data?.original_name || "";
          return (value || "").toString().toLowerCase();
        };

        const dateValue = (item) => {
          const data = item.data || {};
          const dateStr =
            data.updated_at ||
            data.created_at ||
            data.archived_at ||
            data.deleted_at ||
            data.last_modified;
          return dateStr ? new Date(dateStr).getTime() : 0;
        };

        itemsToShow.sort((a, b) => {
          if (sortOrder === "oldest") {
            return dateValue(a) - dateValue(b);
          }
          if (sortOrder === "name_asc") {
            return nameValue(a).localeCompare(nameValue(b));
          }
          if (sortOrder === "name_desc") {
            return nameValue(b).localeCompare(nameValue(a));
          }
          // Default newest
          return dateValue(b) - dateValue(a);
        });

        const departments = await getAllDepartments();

        for (const item of itemsToShow) {
          const div = document.createElement("div");
          div.className = "card";
          div.style.marginBottom = "12px";

          if (item.type === "file") {
            const f = item.data;
            div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="display:flex;gap:12px;align-items:center">
                        <input type="checkbox" class="archive-checkbox" data-type="file" data-id="${
                          f.file_id
                        }" onchange="updateArchiveBulkButtons()" style="width: 18px; height: 18px; cursor: pointer;">
                    <div class="doc-icon">${fileIcon(f.name)}</div>
                    <div>
                        <div style="font-weight:600;color:var(--text)">${
                          f.name
                        }</div>
                        <div class="small-muted">
                                <span class="badge" style="background:var(--accent-light);color:var(--accent);padding:2px 8px;border-radius:4px;font-size:11px;">File</span>
                            Original: ${f.original_name}  
                            ${new Date(f.created_at).toLocaleString()}  
                            ${(f.size / 1024) | 0} KB
                        </div>
                    </div>
                </div>
                <div style="display:flex;gap:8px;">
                    <button onclick="restoreFile(${
                      f.file_id
                    })"><i class="fa-solid fa-rotate-left"></i> Restore</button>
                    <button class="btn-danger" onclick="confirmDeleteFile(${
                      f.file_id
                    })"><i class="fa-solid fa-trash"></i> Delete</button>
                </div>
            </div>
        `;
          } else {
            const u = item.data;
            const dept = departments.find(
              (d) => d.department_id === u.department_id
            ) || { name: "Not assigned" };
            const roleLabel =
              u.role === "system_admin"
                ? "System Admin"
                : u.role === "head_admin"
                ? "Head Admin"
                : "Staff";
            div.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div style="display:flex;gap:12px;align-items:center">
                        <input type="checkbox" class="archive-checkbox" data-type="user" data-id="${
                          u.user_id
                        }" onchange="updateArchiveBulkButtons()" style="width: 18px; height: 18px; cursor: pointer;">
                        <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent-dark));display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:14px">
                            ${u.name
                              .split(" ")
                              .map((s) => s[0])
                              .slice(0, 2)
                              .join("")
                              .toUpperCase()}
                        </div>
                        <div>
                            <div style="font-weight:600;color:var(--text)">${
                              u.name
                            }</div>
                            <div class="small-muted">
                                <span class="badge" style="background:var(--warning-light);color:var(--warning);padding:2px 8px;border-radius:4px;font-size:11px;">User</span>
                                ${u.email}  ${dept.name}  ${roleLabel}
                            </div>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button onclick="restoreUser(${
                          u.user_id
                        })"><i class="fa-solid fa-rotate-left"></i> Restore</button>
                        <button class="btn-danger" onclick="confirmDeleteUserPermanent(${
                          u.user_id
                        })"><i class="fa-solid fa-trash"></i> Delete</button>
                    </div>
                </div>
            `;
          }
          out.appendChild(div);
        }

        updateArchiveBulkButtons();
      }

      // Select All functions
      function toggleSelectAllFiles() {
        const selectAll = document.getElementById("selectAllFiles");
        const checkboxes = document.querySelectorAll(".doc-checkbox");
        checkboxes.forEach((cb) => {
          cb.checked = selectAll.checked;
        });
        updateBulkActionsBar();
      }

      function toggleSelectAllArchived() {
        const selectAll = document.getElementById("selectAllArchived");
        const checkboxes = document.querySelectorAll(".archive-checkbox");
        checkboxes.forEach((cb) => {
          cb.checked = selectAll.checked;
        });
        updateArchiveBulkButtons();
      }

      function updateArchiveBulkButtons() {
        const checkboxes = document.querySelectorAll(
          ".archive-checkbox:checked"
        );
        const count = checkboxes.length;
        const restoreBtn = document.getElementById("bulkRestoreBtn");
        const deleteBtn = document.getElementById("bulkDeleteBtn");

        if (count > 0) {
          restoreBtn.style.display = "inline-block";
          deleteBtn.style.display = "inline-block";
        } else {
          restoreBtn.style.display = "none";
          deleteBtn.style.display = "none";
        }

        const selectAll = document.getElementById("selectAllArchived");
        if (selectAll) {
          const allCheckboxes = document.querySelectorAll(".archive-checkbox");
          selectAll.checked =
            allCheckboxes.length > 0 &&
            allCheckboxes.length === checkboxes.length;
        }
      }

      async function bulkRestoreArchived() {
        const checkboxes = document.querySelectorAll(
          ".archive-checkbox:checked"
        );
        if (checkboxes.length === 0) {
          showToast("No items selected", "error");
          return;
        }

        const files = [];
        const users = [];

        checkboxes.forEach((cb) => {
          const type = cb.getAttribute("data-type");
          const id = parseInt(cb.getAttribute("data-id"));
          if (type === "file") {
            files.push(id);
          } else if (type === "user") {
            users.push(id);
          }
        });

        let successCount = 0;
        let errorCount = 0;

        showToast(
          `Restoring ${files.length + users.length} item(s)...`,
          "info"
        );

        for (const fileId of files) {
          try {
            const response = await authFetch(
              `${API_BASE_URL}/files/${fileId}/restore`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
              }
            );
            const result = await response.json();
            if (result && result.success) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error(`Error restoring file ${fileId}:`, error);
            errorCount++;
          }
        }

        for (const userId of users) {
          try {
            const response = await authFetch(
              `${API_BASE_URL}/users/${userId}/restore`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
              }
            );
            const result = await response.json();
            if (result && result.success) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error(`Error restoring user ${userId}:`, error);
            errorCount++;
          }
        }

        // Show appropriate message based on results
        if (errorCount === 0 && successCount > 0) {
          showToast(`Successfully restored ${successCount} item(s)`, "success");
        } else if (successCount > 0 && errorCount > 0) {
          showToast(
            `Restored ${successCount} item(s), ${errorCount} failed`,
            "warning"
          );
        } else if (errorCount > 0) {
          showToast(`Failed to restore ${errorCount} item(s)`, "error");
        }

        await refreshAllViews();
      }

      async function bulkDeleteArchived() {
        const checkboxes = document.querySelectorAll(
          ".archive-checkbox:checked"
        );
        if (checkboxes.length === 0) {
          showToast("No items selected", "error");
          return;
        }

        const confirmMsg = `Are you sure you want to permanently delete ${checkboxes.length} item(s)? This action cannot be undone.`;
        if (!confirm(confirmMsg)) {
          return;
        }

        const files = [];
        const users = [];

        checkboxes.forEach((cb) => {
          const type = cb.getAttribute("data-type");
          const id = parseInt(cb.getAttribute("data-id"));
          if (type === "file") {
            files.push(id);
          } else if (type === "user") {
            users.push(id);
          }
        });

        let successCount = 0;
        let errorCount = 0;

        showToast(`Deleting ${files.length + users.length} item(s)...`, "info");

        for (const fileId of files) {
          try {
            const result = await deleteFile(fileId);
            if (result && result.success) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error(`Error deleting file ${fileId}:`, error);
            errorCount++;
          }
        }

        for (const userId of users) {
          try {
            const result = await deleteUserAPI(userId);
            if (result && result.success) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (error) {
            console.error(`Error deleting user ${userId}:`, error);
            errorCount++;
          }
        }

        if (successCount > 0) {
          showToast(`Successfully deleted ${successCount} item(s)`, "success");
        }
        if (errorCount > 0) {
          showToast(`${errorCount} item(s) failed to delete`, "error");
        }

        await refreshAllViews();
      }

      async function restoreUser(userId) {
        try {
          showToast("Restoring user...", "info");

          const result = await apiCall(`/users/${userId}/restore`, {
            method: "POST",
            body: {},
          });

          if (result && result.success) {
            showToast("User restored successfully", "success");

            // Refresh all views
            await refreshAllViews();

            // If we're in user management, refresh it
            if (currentView === "userMgmt") {
              await renderUsers();
            }

            // If we're in archives, refresh it
            if (currentView === "archives") {
              await renderArchives();
            }

            // Navigate to user management to show restored user
            if (currentView === "archives") {
              currentView = "userMgmt";
              document
                .querySelectorAll(".nav-item")
                .forEach((n) => n.classList.remove("active"));
              const userMgmtNav = document.querySelector(
                '.nav-item[data-view="userMgmt"]'
              );
              if (userMgmtNav) userMgmtNav.classList.add("active");
              await renderCurrentView();
            }

            const currentUser = await getCurrentUser();
            const user = await apiCall(`/users/${userId}`);
            if (currentUser && user) {
              await logActivity({
                user_id: currentUser.user_id,
                activity: `Restored user: ${user.name}`,
              });
            }
            return result;
          } else {
            showToast(result?.error || "Failed to restore user", "error");
            return { success: false };
          }
        } catch (error) {
          console.error("Restore user error:", error);
          showToast(
            "Error restoring user: " + (error.message || "Unknown error"),
            "error"
          );
          return { success: false };
        }
      }

      async function confirmDeleteUserPermanent(userId) {
        const user = await apiCall(`/users/${userId}`);
        if (!user) {
          showToast("User not found", "error");
          return;
        }

        const currentUser = await getCurrentUser();
        if (user.user_id === currentUser.user_id) {
          showToast("You cannot delete your own account", "error");
          return;
        }

        openModal(`<h3>Permanently Delete User</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="danger">
                <i class="fa-solid fa-exclamation-triangle"></i> 
                <strong>Warning:</strong> This action cannot be undone. The user will be permanently deleted.
            </div>
            <div class="small-muted">
                Are you sure you want to permanently delete <strong>"${user.name}"</strong>?
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i> Cancel
                </button>
                <button class="btn-danger" onclick="executeDeleteUserPermanent(${userId})">
                    <i class="fa-solid fa-trash"></i> Delete Permanently
                </button>
            </div>
        </div>`);
      }

      async function executeDeleteUserPermanent(userId) {
        try {
          closeModal();
          showToast("Deleting user...", "info");

          const result = await deleteUserAPI(userId);
          if (result && result.success) {
            showToast("User deleted permanently", "success");
            await refreshAllViews();

            const currentUser = await getCurrentUser();
            if (currentUser) {
              await logActivity({
                user_id: currentUser.user_id,
                activity: `Permanently deleted user ID: ${userId}`,
              });
            }
          } else {
            showToast("Failed to delete user", "error");
          }
        } catch (error) {
          console.error("Delete user error:", error);
          showToast("Error deleting user", "error");
        }
      }

      async function confirmDeleteFile(fileId) {
        const files = await getAllFiles();
        const file = files.find((f) => f.file_id === fileId);

        if (!file) return;

        openModal(`<h3>Delete File</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="danger">
                <i class="fa-solid fa-exclamation-triangle"></i> 
                <strong>Warning:</strong> This action cannot be undone.
            </div>
            <div class="small-muted">
                Are you sure you want to permanently delete <strong>"${
                  file.original_name || file.name
                }"</strong>?
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i> Cancel
                </button>
                <button class="btn-danger" onclick="deleteFilePermanently(${fileId})">
                    <i class="fa-solid fa-trash"></i> Delete Permanently
                </button>
            </div>
        </div>`);
      }

      async function deleteFilePermanently(fileId) {
        const result = await deleteFile(fileId);
        if (result && result.success) {
          showToast("File deleted permanently", "success");
          closeModal();
          await renderArchives();

          const currentUser = await getCurrentUser();
          const files = await getAllFiles();
          const file = files.find((f) => f.file_id === fileId);
          if (currentUser && file) {
            await logActivity({
              user_id: currentUser.user_id,
              activity: `Permanently deleted ${
                file.original_name || file.name
              }`,
            });
          }
        }
      }

      async function restoreFile(fileId) {
        console.log(`DEBUG: restoreFile called for file ${fileId}`);

        try {
          showToast("Restoring file...", "info");

          const response = await authFetch(
            `${API_BASE_URL}/files/${fileId}/restore`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            showToast(
              errorData.error || `Failed to restore file (${response.status})`,
              "error"
            );
            return;
          }

          const result = await response.json();
          console.log(
            `DEBUG: Restore API response for file ${fileId}:`,
            result
          );

          if (result && result.success) {
            showToast("File restored successfully", "success");

            // Refresh all views to show updated file lists
            await refreshAllViews();

            // Log activity
            const currentUser = await getCurrentUser();
            if (currentUser) {
              await logActivity({
                user_id: currentUser.user_id,
                activity: `Restored file ID: ${fileId}`,
              });
            }
          } else {
            showToast(result.error || "Failed to restore file", "error");
          }
        } catch (error) {
          console.error("Restore error:", error);
          showToast("Network error while restoring file", "error");
        }
      }

      // Dashboard
      async function renderDashboard() {
        await refreshStats();

        const activities = await getActivities();
        const feed = document.getElementById("activityFeed");

        if (!activities || activities.length === 0) {
          feed.innerHTML =
            '<div class="small-muted" style="text-align:center;padding:20px">No activity yet</div>';
          return;
        }

        feed.innerHTML = "";
        activities
          .slice()
          .reverse()
          .slice(0, 8)
          .forEach((a) => {
            const div = document.createElement("div");
            div.className = "activity-item";
            div.innerHTML = `
        <div class="activity-icon">
          <i class="fa-solid fa-circle-info"></i>
        </div>
        <div class="activity-content">
          <div>${a.activity}</div>
          <div class="activity-time">${new Date(
            a.timestamp
          ).toLocaleString()}</div>
        </div>
      `;
            feed.appendChild(div);
          });
      }

      async function refreshStats() {
        const files = await getAllFiles();
        const users = await getAllUsers();

        if (files) {
          document.getElementById("statTotal").textContent = files.filter(
            (f) => f.status === "active"
          ).length;
          document.getElementById("statShared").textContent = files.filter(
            (f) => f.shared && f.status === "active"
          ).length;
          const weekAgo = Date.now() - 7 * 24 * 3600 * 1000;
          document.getElementById("statRecent").textContent = files.filter(
            (f) =>
              new Date(f.created_at).getTime() > weekAgo &&
              f.status === "active"
          ).length;
        }

        if (users) {
          document.getElementById("statUsers").textContent = users.length;
        }
      }

      // Settings
      async function renderSettings() {
        const settings = await getSettings();
        if (settings) {
          document.getElementById("settingCompany").value =
            settings.company || "";
          document.getElementById("settingMax").value =
            settings.max_file_mb || 50;
          document.getElementById("settingTypes").value =
            settings.allowed_types || "";
        }
      }

      async function saveSettings() {
        const company = document.getElementById("settingCompany").value;
        const maxFileMB = Number(document.getElementById("settingMax").value);
        const allowedTypes = document.getElementById("settingTypes").value;

        const result = await updateSettings({
          company: company,
          max_file_mb: maxFileMB,
          allowed_types: allowedTypes,
        });

        if (result && result.success) {
          showToast("Settings saved", "success");

          const currentUser = await getCurrentUser();
          if (currentUser) {
            await logActivity({
              user_id: currentUser.user_id,
              activity: "Updated system settings",
            });
          }
        }
      }

      // Modal functions
      function openModal(html, className = "") {
        const root = document.getElementById("modalRoot");
        root.innerHTML = `<div class="modal-back" id="modalBG"><div class="modal ${className}">${html}</div></div>`;
        root.style.display = "block";
        document.getElementById("modalBG").addEventListener("click", (ev) => {
          if (ev.target.id === "modalBG") closeModal();
        });
      }

      function closeModal() {
        document.getElementById("modalRoot").innerHTML = "";
        document.getElementById("modalRoot").style.display = "none";
      }

      // Document Classification
      async function classifyUploadedFile(file) {
        try {
          const formData = new FormData();
          formData.append("file", file);

          showToast(`Classifying ${file.name}...`);

          const response = await authFetch(
            `${API_BASE_URL}/classify-document`,
            {
              method: "POST",
              body: formData,
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.error) {
            console.warn("Classification warning:", result.error);
            return {
              documentType: result.documentType || "Unclassified",
              confidence: result.confidence || "Low",
              error: result.error,
            };
          }

          return {
            documentType: result.documentType,
            confidence: result.confidence,
            textSample: result.textSample,
          };
        } catch (error) {
          console.error("Classification API error:", error);
          return await mockDocumentClassification(file);
        }
      }

      async function mockDocumentClassification(file) {
        const fileName = file.name.toLowerCase();
        let documentType = "Unclassified";
        let confidence = "Low";

        if (fileName.includes("resume") || fileName.includes("cv")) {
          documentType = "Resume / CV";
          confidence = "Medium";
        } else if (
          fileName.includes("offer") ||
          fileName.includes("employment")
        ) {
          documentType = "Offer Letter / Employment Contract";
          confidence = "Medium";
        } else if (fileName.includes("resignation")) {
          documentType = "Resignation Letter";
          confidence = "Medium";
        } else if (
          fileName.includes("leave") ||
          fileName.includes("vacation")
        ) {
          documentType = "Leave Request";
          confidence = "Medium";
        }

        return {
          documentType,
          confidence,
          textSample: `Mock classification for ${file.name}`,
        };
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
