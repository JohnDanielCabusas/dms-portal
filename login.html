<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DMS Portal — Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        },
                        gray: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        success: {
                            50: '#ecfdf5',
                            500: '#10b981',
                        },
                        danger: {
                            50: '#fef2f2',
                            500: '#ef4444',
                            600: '#dc2626',
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui', 'Arial', 'sans-serif'],
                    },
                    borderRadius: {
                        'lg': '12px',
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    }
                }
            }
        }
    </script>
   
    <style>
        .toast-message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 320px;
        }
       
        /* Dark mode styles - matching app.html */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
       
        body.dark-mode .bg-gray-50 {
            background-color: #1a1a1a;
        }
       
        body.dark-mode .bg-white {
            background-color: #2d2d2d;
        }
       
        body.dark-mode .text-gray-900 {
            color: #e0e0e0;
        }
       
        body.dark-mode .text-gray-500 {
            color: #a0a0a0;
        }
       
        body.dark-mode .border-gray-200 {
            border-color: #404040;
        }
       
        body.dark-mode .border-gray-300 {
            border-color: #505050;
        }
       
        body.dark-mode .bg-gray-200 {
            background-color: #404040;
        }
       
        body.dark-mode .hover\:bg-gray-300:hover {
            background-color: #505050;
        }
       
        body.dark-mode .text-gray-700 {
            color: #b0b0b0;
        }
       
        body.dark-mode .hover\:text-gray-700:hover {
            color: #d0d0d0;
        }
       
        /* Hide browser's default password reveal icon */
        input[type="password"]::-ms-reveal,
        input[type="password"]::-ms-clear {
            display: none;
        }
       
        input[type="password"]::-webkit-credentials-auto-fill-button,
        input[type="password"]::-webkit-contacts-auto-fill-button {
            visibility: hidden;
            position: absolute;
            right: 0;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans h-screen flex items-center justify-center p-6 transition-colors">
    <!-- Dark Mode Toggle Button -->
    <button id="themeToggle" onclick="toggleTheme()" class="fixed top-4 right-4 w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300 transition-colors z-50">
        <i id="themeIcon" class="fa-solid fa-moon text-gray-700"></i>
    </button>
   
    <div class="w-full max-w-md">
        <div class="text-center mb-8">
            <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center text-white font-bold text-2xl mx-auto mb-4 shadow-card">
                DM
            </div>
            <h1 class="text-2xl font-bold bg-gradient-to-r from-primary-500 to-primary-700 bg-clip-text text-transparent">DMS PORTAL</h1>
        </div>


        <div class="bg-white p-8 rounded-xl shadow-card border border-gray-200 transition-colors">
            <!-- Login View -->
            <div id="loginView">
                <h2 class="text-2xl font-semibold mb-2">Welcome Back</h2>
                <div class="text-sm text-gray-500 mb-6">Sign in to access your Document Management System</div>
               
                <div class="mb-4">
                    <label for="loginEmail" class="block text-sm text-gray-500 mb-2">Email</label>
                    <input id="loginEmail" type="email" placeholder="you@example.com" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
                </div>
               
                <div class="mb-4">
                    <label for="loginPassword" class="block text-sm text-gray-500 mb-2">Password</label>
                    <div class="relative">
                        <input id="loginPassword" type="password" placeholder="Enter your password" class="w-full px-4 py-3 pr-10 rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
                        <button type="button" id="togglePasswordBtn" onclick="togglePasswordVisibility(event)" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none z-10">
                            <i id="passwordIcon" class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>
               
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center">
                        <input type="checkbox" id="remember" class="text-primary-500 focus:ring-primary-500 rounded"/>
                        <label for="remember" class="ml-2 text-sm text-gray-500">Remember me</label>
                    </div>
                    <div>
                        <a class="text-primary-500 hover:text-primary-600 cursor-pointer text-sm font-medium transition-colors" onclick="showForgot()">Forgot password?</a>
                    </div>
                </div>
               
                <button onclick="doLogin()" class="w-full py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                    <i class="fa-solid fa-right-to-bracket"></i> Sign In
                </button>
            
            </div>


            <!-- Forgot Password View -->
            <div id="forgotView" class="hidden">
                <h2 class="text-2xl font-semibold mb-2">Reset Password</h2>
                <div class="text-sm text-gray-500 mb-6">Enter your email to receive a verification code</div>
               
                <div class="mb-6">
                    <label for="forgotEmail" class="block text-sm text-gray-500 mb-2">Email Address</label>
                    <input id="forgotEmail" type="email" placeholder="you@example.com" class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
                </div>
               
                <button id="sendCodeBtn" onclick="sendResetCode()" class="w-full py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                    <i class="fa-solid fa-paper-plane"></i> Send Verification Code
                </button>
               
                <div class="text-center mt-4">
                    <a class="text-primary-500 hover:text-primary-600 cursor-pointer text-sm font-medium transition-colors flex items-center justify-center gap-1" onclick="showLogin()">
                        <i class="fa-solid fa-arrow-left"></i> Back to Login
                    </a>
                </div>
            </div>


 <!-- Reset Code Verification View -->
<div id="resetCodeView" class="hidden">
    <h2 class="text-2xl font-semibold mb-2">Enter Verification Code</h2>
    <div class="text-sm text-gray-500 mb-6">We've sent a 6-digit code to your email</div>
   
    <div class="mb-6">
        <label class="block text-sm text-gray-500 mb-2">Verification Code</label>
        <div class="flex gap-3 mb-4">
            <input type="text" maxlength="1" id="code1" oninput="moveToNext(1)" class="w-full h-12 text-center text-lg font-semibold rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
            <input type="text" maxlength="1" id="code2" oninput="moveToNext(2)" class="w-full h-12 text-center text-lg font-semibold rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
            <input type="text" maxlength="1" id="code3" oninput="moveToNext(3)" class="w-full h-12 text-center text-lg font-semibold rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
            <input type="text" maxlength="1" id="code4" oninput="moveToNext(4)" class="w-full h-12 text-center text-lg font-semibold rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
            <input type="text" maxlength="1" id="code5" oninput="moveToNext(5)" class="w-full h-12 text-center text-lg font-semibold rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
            <input type="text" maxlength="1" id="code6" oninput="moveToNext(6)" class="w-full h-12 text-center text-lg font-semibold rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
        </div>
    </div>
   
    <button onclick="verifyResetCode()" class="w-full py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
        <i class="fa-solid fa-check"></i> Verify Code
    </button>
   
    <!-- TIMER SECTION -->
    <div class="text-center mt-4">
        <div id="timer" class="text-sm text-gray-500 hidden">
            Resend code in <span id="countdown">60</span> seconds
        </div>
        <a id="resendLink" class="text-primary-500 hover:text-primary-600 cursor-pointer text-sm font-medium transition-colors hidden" onclick="sendResetCode()">Resend Code</a>
    </div>
    <!-- END TIMER SECTION -->
   
    <div class="text-center mt-4">
        <a class="text-primary-500 hover:text-primary-600 cursor-pointer text-sm font-medium transition-colors flex items-center justify-center gap-1" onclick="showLogin()">
            <i class="fa-solid fa-arrow-left"></i> Back to Login
        </a>
    </div>
</div>


            <!-- New Password View -->
            <div id="newPasswordView" class="hidden">
                <h2 class="text-2xl font-semibold mb-2">Set New Password</h2>
                <div class="text-sm text-gray-500 mb-6">Enter your new password</div>
               
                <div class="mb-4">
                    <label for="newPassword" class="block text-sm text-gray-500 mb-2">New Password</label>
                    <div class="relative">
                        <input id="newPassword" type="password" placeholder="Enter new password" class="w-full px-4 py-3 pr-10 rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
                        <button type="button" onclick="toggleResetPasswordVisibility('newPassword', 'newPasswordIcon')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none z-10">
                            <i id="newPasswordIcon" class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>
               
                <div class="mb-6">
                    <label for="confirmPassword" class="block text-sm text-gray-500 mb-2">Confirm Password</label>
                    <div class="relative">
                        <input id="confirmPassword" type="password" placeholder="Confirm new password" class="w-full px-4 py-3 pr-10 rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
                        <button type="button" onclick="toggleResetPasswordVisibility('confirmPassword', 'confirmPasswordIcon')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none z-10">
                            <i id="confirmPasswordIcon" class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>
               
                <button onclick="doResetPassword()" class="w-full py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                    <i class="fa-solid fa-key"></i> Reset Password
                </button>
               
                <div class="text-center mt-4">
                    <a class="text-primary-500 hover:text-primary-600 cursor-pointer text-sm font-medium transition-colors flex items-center justify-center gap-1" onclick="showLogin()">
                        <i class="fa-solid fa-arrow-left"></i> Back to Login
                    </a>
                </div>
            </div>
        </div>
       
        <div class="text-center mt-6 text-sm text-gray-500">
            © DMS Portal. All rights reserved.
        </div>
    </div>


    <script>
    const API_BASE_URL = "http://localhost:5000/api";


    // Dark Mode Toggle - matching app.html implementation
    function initTheme() {
        const savedTheme = localStorage.getItem("dms-theme") || "light";
        const themeToggle = document.getElementById("themeToggle");
        const icon = themeToggle ? themeToggle.querySelector("i") : null;
       
        if (savedTheme === "dark") {
            document.body.classList.add("dark-mode");
            if (icon) {
                icon.classList.remove("fa-moon");
                icon.classList.add("fa-sun");
            }
        } else {
            document.body.classList.remove("dark-mode");
            if (icon) {
                icon.classList.remove("fa-sun");
                icon.classList.add("fa-moon");
            }
        }
    }


    function toggleTheme() {
        const themeToggle = document.getElementById("themeToggle");
        const icon = themeToggle ? themeToggle.querySelector("i") : null;
       
        document.body.classList.toggle("dark-mode");
        if (document.body.classList.contains("dark-mode")) {
            localStorage.setItem("dms-theme", "dark");
            if (icon) {
                icon.classList.remove("fa-moon");
                icon.classList.add("fa-sun");
            }
        } else {
            localStorage.setItem("dms-theme", "light");
            if (icon) {
                icon.classList.remove("fa-sun");
                icon.classList.add("fa-moon");
            }
        }
    }


    // Password Visibility Toggle
    function togglePasswordVisibility(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
       
        const passwordInput = document.getElementById("loginPassword");
        const passwordIcon = document.getElementById("passwordIcon");
        const toggleBtn = document.getElementById("togglePasswordBtn");
       
        // Ensure only one icon exists
        if (toggleBtn) {
            const existingIcons = toggleBtn.querySelectorAll("i");
            if (existingIcons.length > 1) {
                // Remove duplicates, keep only the first one
                for (let i = 1; i < existingIcons.length; i++) {
                    existingIcons[i].remove();
                }
            }
        }
       
        if (passwordInput && passwordIcon) {
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                passwordIcon.className = "fa-solid fa-eye-slash";
            } else {
                passwordInput.type = "password";
                passwordIcon.className = "fa-solid fa-eye";
            }
        }
    }
   
    // Ensure password icon is not duplicated - run immediately and on load
    function ensureSinglePasswordIcon() {
        const toggleBtn = document.getElementById("togglePasswordBtn");
        if (toggleBtn) {
            const icons = toggleBtn.querySelectorAll("i");
            if (icons.length > 1) {
                // Keep only the first icon, remove all duplicates
                for (let i = 1; i < icons.length; i++) {
                    icons[i].remove();
                }
            }
            // Ensure button has exactly one icon
            if (icons.length === 0) {
                toggleBtn.innerHTML = '<i id="passwordIcon" class="fa-solid fa-eye"></i>';
            }
        }
    }
    
    // Toggle password visibility for reset password fields
    function toggleResetPasswordVisibility(inputId, iconId) {
        const passwordInput = document.getElementById(inputId);
        const passwordIcon = document.getElementById(iconId);
        
        if (passwordInput && passwordIcon) {
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                passwordIcon.className = "fa-solid fa-eye-slash";
            } else {
                passwordInput.type = "password";
                passwordIcon.className = "fa-solid fa-eye";
            }
        }
    }
   
    // Run immediately
    ensureSinglePasswordIcon();
   
    // Also run on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', ensureSinglePasswordIcon);
   
    // Run on any input/focus events to catch duplicates
    document.addEventListener('DOMContentLoaded', function() {
        const passwordInput = document.getElementById("loginPassword");
        if (passwordInput) {
            passwordInput.addEventListener('focus', ensureSinglePasswordIcon);
            passwordInput.addEventListener('input', ensureSinglePasswordIcon);
            passwordInput.addEventListener('click', ensureSinglePasswordIcon);
        }
    });


    // Initialize theme on load
    initTheme();


    // Utility functions
    function showToast(msg, type = 'info'){
        const toast = document.createElement('div');
        let bgColor = 'bg-primary-500';
        let icon = 'fa-circle-info';
       
        if (type === 'success') {
            bgColor = 'bg-success-500';
            icon = 'fa-circle-check';
        } else if (type === 'error') {
            bgColor = 'bg-danger-500';
            icon = 'fa-circle-exclamation';
        }
       
        toast.className = `toast-message ${bgColor} text-white p-3 rounded-lg shadow-lg flex items-center gap-2`;
        toast.innerHTML = `<i class="fa-solid ${icon}"></i><span>${msg}</span>`;
        document.body.appendChild(toast);
        setTimeout(() => { document.body.removeChild(toast); }, 3000);
    }


    async function apiCall(endpoint, options = {}) {
        try {
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };


            if (config.body && typeof config.body === 'object') {
                config.body = JSON.stringify(config.body);
            }


            const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
           
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
           
            return await response.json();
        } catch (error) {
            console.error('API call failed:', error);
            showToast('Network error. Please try again.', 'error');
            return null;
        }
    }


    async function doLogin(){
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const remember = document.getElementById('remember').checked;


        if (!email || !password) {
            showToast('Please fill all fields', 'error');
            return;
        }


        // Get all users and find matching credentials
        const users = await apiCall('/users');
        if (!users) {
            showToast('Cannot connect to server', 'error');
            return;
        }


        const user = users.find(u => u.email === email && u.password === password);
       
        if (user) {
            // Check if user is archived
            if (user.status === 'archived') {
                showToast('Your account has been archived. Please contact your administrator.', 'error');
                return;
            }
            // Create session in database
            const sessionResult = await apiCall('/sessions', {
                method: 'POST',
                body: {
                    user_id: user.user_id,
                    email: user.email
                }
            });


            // Store session in localStorage
            localStorage.setItem("dms_session_v1", JSON.stringify({
                userId: user.user_id,
                email: user.email,
                timestamp: Date.now()
            }));
           
            // Log login activity
            await apiCall('/activities', {
                method: 'POST',
                body: {
                    user_id: user.user_id,
                    activity: `User logged in`
                }
            });
           
            showToast(`Welcome back, ${user.name}!`, 'success');
            setTimeout(() => {
                window.location.href = 'app.html';
            }, 1000);
        } else {
            showToast('Invalid email or password', 'error');
        }
    }


    function showForgot(){
        document.getElementById('loginView').classList.add('hidden');
        document.getElementById('forgotView').classList.remove('hidden');
    }


    function showLogin(){
        document.getElementById('loginView').classList.remove('hidden');
        document.getElementById('forgotView').classList.add('hidden');
        document.getElementById('resetCodeView').classList.add('hidden');
        document.getElementById('newPasswordView').classList.add('hidden');
    }


let countdownTimer;
let countdownTime = 60;


function startTimer() {
    const timerElement = document.getElementById('timer');
    const resendLink = document.getElementById('resendLink');
    const countdownElement = document.getElementById('countdown');
   
    timerElement.classList.remove('hidden');
    resendLink.classList.add('hidden');
    countdownTime = 60;
    countdownElement.textContent = countdownTime;
   
    clearInterval(countdownTimer);
   
    countdownTimer = setInterval(() => {
        countdownTime--;
        countdownElement.textContent = countdownTime;
       
        if (countdownTime <= 0) {
            clearInterval(countdownTimer);
            timerElement.classList.add('hidden');
            resendLink.classList.remove('hidden');
        }
    }, 1000);
}


    // Global variables for password reset
    let currentResetEmail = '';
    let currentResetCode = '';

    async function sendResetCode(){
    const email = document.getElementById('forgotEmail').value.trim();
    if (!email) {
        showToast('Please enter your email', 'error');
        return;
    }

    // Show loading state
    const sendBtn = event.target;
    const originalHTML = sendBtn.innerHTML;
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending Code...';

    try {
        // Check if user exists
        const users = await apiCall('/users');
        if (!users) {
            showToast('Cannot connect to server', 'error');
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalHTML;
            return;
        }


        const user = users.find(u => u.email === email);
       
        if (!user) {
            showToast('No account found with that email', 'error');
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalHTML;
            return;
        }


        // Generate a 6-digit code
        const code = Math.floor(100000 + Math.random() * 900000).toString();
        
        // Store for verification
        currentResetEmail = email;
        currentResetCode = code;
       
        // Send email via PHP
        const emailResult = await apiCall('/send-reset-email', {
        method: 'POST',
        body: {
            email: email,
            code: code
        }
    });


    if (emailResult && emailResult.success) {
        showToast('Verification code sent to your email', 'success');
    } else {
        // Fallback to showing code if email fails
        showToast(`Email failed. Demo code: ${code}`, 'error');
    }


        // Store reset code in database
        await apiCall('/reset-codes', {
            method: 'POST',
            body: {
                email: email,
                code: code
            }
        });


        // Show verification view and start timer
        document.getElementById('forgotView').classList.add('hidden');
        document.getElementById('resetCodeView').classList.remove('hidden');
        startTimer();
        
        // Reset button state
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalHTML;
    } catch (error) {
        showToast('An error occurred. Please try again.', 'error');
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalHTML;
    }
   
    // Clear input fields
    document.getElementById('code1').value = '';
    document.getElementById('code2').value = '';
    document.getElementById('code3').value = '';
    document.getElementById('code4').value = '';
    document.getElementById('code5').value = '';
    document.getElementById('code6').value = '';
    document.getElementById('code1').focus();
}


    function moveToNext(index){
        const current = document.getElementById(`code${index}`);
        if (current.value.length === 1) {
            if (index < 6) {
                document.getElementById(`code${index + 1}`).focus();
            }
        }
    }


    async function verifyResetCode(){
        const code1 = document.getElementById('code1').value;
        const code2 = document.getElementById('code2').value;
        const code3 = document.getElementById('code3').value;
        const code4 = document.getElementById('code4').value;
        const code5 = document.getElementById('code5').value;
        const code6 = document.getElementById('code6').value;
       
        const enteredCode = code1 + code2 + code3 + code4 + code5 + code6;
       
        if (enteredCode.length !== 6) {
            showToast('Please enter the complete 6-digit code', 'error');
            return;
        }
        
        // Verify the code matches
        if (enteredCode !== currentResetCode) {
            showToast('Invalid verification code. Please check and try again.', 'error');
            // Clear the input fields
            document.getElementById('code1').value = '';
            document.getElementById('code2').value = '';
            document.getElementById('code3').value = '';
            document.getElementById('code4').value = '';
            document.getElementById('code5').value = '';
            document.getElementById('code6').value = '';
            document.getElementById('code1').focus();
            return;
        }
        
        // Code is correct, proceed to password reset
        showToast('Code verified successfully!', 'success');
        document.getElementById('resetCodeView').classList.add('hidden');
        document.getElementById('newPasswordView').classList.remove('hidden');
    }


async function doResetPassword(){
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
   
    if (!newPassword || !confirmPassword) {
        showToast('Please fill all fields', 'error');
        return;
    }
   
    if (newPassword !== confirmPassword) {
        showToast('Passwords do not match', 'error');
        return;
    }
   
    if (newPassword.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
    }
   
    // Use the stored email and code from verification
    const email = currentResetEmail;
    const code = currentResetCode;
    
    if (!email || !code) {
        showToast('Session expired. Please start over.', 'error');
        showLogin();
        return;
    }
    
    try {
        // Call the dedicated reset-password endpoint which will:
        // 1. Verify the reset code is valid
        // 2. Update the password in the database
        // 3. Mark the reset code as used
        const result = await apiCall('/reset-password', {
            method: 'POST',
            body: {
                email: email,
                code: code,
                password: newPassword
            }
        });

        if (result && result.success) {
            showToast('Password reset successfully!', 'success');
            console.log('✅ Password reset complete. Reset code has been marked as used.');
            setTimeout(() => {
                showLogin();
            }, 1500);
        } else {
            showToast(result?.error || 'Error resetting password', 'error');
        }
    } catch (error) {
        console.error('Error during password reset:', error);
        showToast('An unexpected error occurred during password reset', 'error');
    }
}


    // Allow login on Enter key press - THIS WAS MISSING AND NOW ADDED BACK
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            if (!document.getElementById('loginView').classList.contains('hidden')) {
                doLogin();
            } else if (!document.getElementById('forgotView').classList.contains('hidden')) {
                sendResetCode();
            } else if (!document.getElementById('resetCodeView').classList.contains('hidden')) {
                verifyResetCode();
            } else if (!document.getElementById('newPasswordView').classList.contains('hidden')) {
                doResetPassword();
            }
        }
    });
</script>
</body>
</html>

