<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DMS Portal</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg: #f8fafc;
        --card: #ffffff;
        --accent: #3b82f6;
        --accent-light: #dbeafe;
        --accent-dark: #1d4ed8;
        --text: #1e293b;
        --text-muted: #64748b;
        --text-light: #94a3b8;
        --sidebar: #ffffff;
        --danger: #ef4444;
        --success: #10b981;
        --warning: #f59e0b;
        --border: #e2e8f0;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --radius: 12px;
        --transition: all 0.2s ease-in-out;
      }

      .dark-mode {
        --bg: #0f172a;
        --card: #1e293b;
        --accent: #60a5fa;
        --accent-light: #1e3a8a;
        --accent-dark: #93c5fd;
        --text: #f1f5f9;
        --text-muted: #cbd5e1;
        --text-light: #94a3b8;
        --sidebar: #1e293b;
        --danger: #f87171;
        --success: #34d399;
        --warning: #fbbf24;
        --border: #334155;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2),
          0 2px 4px -1px rgba(0, 0, 0, 0.1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Inter", ui-sans-serif, system-ui, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        display: flex;
        flex-direction: column;
        transition: var(--transition);
      }

      /* ---------- TOPBAR ---------- */
      .topbar {
        height: 72px;
        background: var(--card);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 28px;
        border-bottom: 1px solid var(--border);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        z-index: 40;
        position: sticky;
        top: 0;
        transition: var(--transition);
        backdrop-filter: blur(10px);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 18px;
        flex: 0 0 auto;
      }

      .brand h1 {
        font-size: 22px;
        font-weight: 700;
        margin: 0;
        line-height: 1.2;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -0.3px;
      }

      .brand .small-muted {
        font-size: 11px;
        margin-top: 2px;
        opacity: 0.7;
      }

      .logo {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 19px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
        transition: var(--transition);
        flex-shrink: 0;
      }

      .logo:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
      }

      .top-actions {
        display: flex;
        align-items: center;
        gap: 20px;
        flex: 1;
        justify-content: flex-end;
        max-width: 800px;
      }

      .avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        transition: var(--transition);
        flex-shrink: 0;
        cursor: pointer;
      }

      .avatar:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }

      .search-wrapper {
        position: relative;
        flex: 1;
        max-width: 400px;
        min-width: 200px;
      }

      .search-wrapper i {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 14px;
        pointer-events: none;
        transition: var(--transition);
      }

      .search-wrapper:focus-within i {
        color: var(--accent);
      }

      .search {
        padding: 12px 16px 12px 44px;
        border-radius: 12px;
        border: 1.5px solid var(--border);
        background: var(--bg);
        color: var(--text);
        width: 100%;
        font-size: 14px;
        transition: var(--transition);
        font-weight: 400;
      }

      .search::placeholder {
        color: var(--text-muted);
        font-weight: 400;
      }

      .search:focus {
        outline: none;
        border-color: var(--accent);
        background: var(--card);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      }

      .search:hover:not(:focus) {
        border-color: var(--accent-light);
        background: var(--card);
      }

      .theme-toggle {
        background: var(--bg);
        border: 1.5px solid var(--border);
        font-size: 18px;
        color: var(--text-muted);
        cursor: pointer;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        flex-shrink: 0;
      }

      .theme-toggle:hover {
        background: var(--accent-light);
        color: var(--accent);
        border-color: var(--accent);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
      }

      .top-user-info {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 6px 12px 6px 6px;
        border-radius: 12px;
        transition: var(--transition);
        cursor: pointer;
        flex-shrink: 0;
      }

      .top-user-info:hover {
        background: var(--bg);
      }

      .top-user-info .user-details {
        text-align: right;
        min-width: 0;
      }

      .top-user-info .user-details div:first-child {
        font-weight: 600;
        font-size: 14px;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
      }

      .top-user-info .user-details div:last-child {
        font-size: 12px;
        margin-top: 2px;
      }

      @media (max-width: 768px) {
        .topbar {
          padding: 0 16px;
          height: 64px;
        }

        .brand {
          gap: 12px;
        }

        .brand h1 {
          font-size: 18px;
        }

        .brand .small-muted {
          display: none;
        }

        .logo {
          width: 40px;
          height: 40px;
          font-size: 17px;
        }

        .mobile-toggle {
          width: 40px;
          height: 40px;
        }

        .top-actions {
          gap: 12px;
        }

        .search-wrapper {
          max-width: 180px;
          min-width: 120px;
        }

        .top-user-info {
          gap: 10px;
          padding: 4px 8px 4px 4px;
        }

        .top-user-info .user-details {
          display: none;
        }

        .avatar {
          width: 40px;
          height: 40px;
        }

        .theme-toggle {
          width: 40px;
          height: 40px;
        }
      }

      /* Search highlight styles */
      .search-highlight {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.15),
          rgba(59, 130, 246, 0.25)
        );
        border: 2px solid var(--accent);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1),
          0 4px 12px rgba(59, 130, 246, 0.2);
        animation: searchPulse 0.6s ease-out;
      }

      @keyframes searchPulse {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
        }
      }

      .search-highlight-row {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1),
          rgba(59, 130, 246, 0.15)
        );
        border-left: 4px solid var(--accent);
        animation: searchPulseRow 0.6s ease-out;
      }

      @keyframes searchPulseRow {
        0% {
          background: rgba(59, 130, 246, 0.2);
        }
        100% {
          background: linear-gradient(
            135deg,
            rgba(59, 130, 246, 0.1),
            rgba(59, 130, 246, 0.15)
          );
        }
      }

      /* ---------- LAYOUT ---------- */
      .container {
        display: flex;
        flex: 1;
        min-height: 0;
      }

      .sidebar {
        width: 260px;
        background: var(--sidebar);
        border-right: 1px solid var(--border);
        padding-top: 24px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: transform 0.3s ease, width 0.3s ease;
        overflow-y: auto;
      }

      .nav-item {
        padding: 14px 20px;
        cursor: pointer;
        color: var(--text-muted);
        display: flex;
        gap: 12px;
        align-items: center;
        white-space: nowrap;
        overflow: hidden;
        border-radius: 10px;
        margin: 0 12px;
        transition: var(--transition);
        font-weight: 500;
      }

      .nav-item:hover {
        background: var(--accent-light);
        color: var(--accent);
      }

      .nav-item.active {
        background: var(--accent-light);
        color: var(--accent);
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
      }

      .nav-item i {
        font-size: 18px;
        width: 20px;
        text-align: center;
      }

      .main {
        flex: 1;
        padding: 24px;
        overflow: auto;
        transition: margin-left 0.3s ease;
        background: var(--bg);
      }

      .card {
        background: var(--card);
        padding: 20px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        transition: var(--transition);
        color: var(--text);
      }

      .card:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      .row {
        display: flex;
        gap: 16px;
        align-items: center;
      }

      .col {
        flex: 1;
      }

      h2 {
        margin: 0 0 16px;
        font-weight: 700;
        font-size: 24px;
        color: var(--text);
      }

      h3 {
        font-weight: 600;
        font-size: 18px;
        margin-bottom: 16px;
        color: var(--text);
      }

      button {
        background: var(--accent);
        color: #fff;
        border: 0;
        padding: 10px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      button:hover {
        background: var(--accent-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
      }

      .btn-secondary {
        background: var(--card);
        color: var(--text-muted);
        border: 1px solid var(--border);
        align-content: center;
      }

      .btn-secondary:hover {
        background: var(--bg);
        color: var(--accent);
        border-color: var(--accent);
        transform: translateY(-1px);
      }

      .btn-danger {
        background: var(--danger);
      }

      .btn-danger:hover {
        background: #dc2626;
        box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
      }

      .muted {
        color: var(--text-muted);
        font-size: 14px;
      }

      input,
      select,
      textarea {
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        font-size: 14px;
        transition: var(--transition);
        width: 100%;
      }

      input::placeholder,
      textarea::placeholder {
        color: var(--text-muted);
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
      }

      .doc {
        padding: 16px;
        border-radius: 10px;
        background: var(--card);
        border: 1px solid var(--border);
        display: flex;
        gap: 12px;
        align-items: center;
        transition: var(--transition);
        cursor: pointer;
        color: var(--text);
      }

      .doc:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-color: var(--accent);
      }

      .doc .icon {
        font-size: 24px;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--accent-light);
        color: var(--accent);
      }

      .small {
        font-size: 13px;
        color: var(--text-muted);
      }

      .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        color: var(--text);
      }

      .table th,
      .table td {
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
        text-align: left;
        color: var(--text);
      }

      .table th {
        font-weight: 600;
        color: var(--text-muted);
        background: var(--bg);
      }

      .badge {
        background: var(--accent-light);
        color: var(--accent);
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .badge-success {
        background: #d1fae5;
        color: var(--success);
      }

      .badge-warning {
        background: #fef3c7;
        color: var(--warning);
      }

      .badge-danger {
        background: #fee2e2;
        color: var(--danger);
      }

      .dark-mode .badge-success {
        background: #064e3b;
        color: #34d399;
      }

      .dark-mode .badge-warning {
        background: #78350f;
        color: #fbbf24;
      }

      .dark-mode .badge-danger {
        background: #7f1d1d;
        color: #f87171;
      }

      .danger {
        background: #fef2f2;
        color: var(--danger);
        border: 1px solid #fecaca;
        padding: 8px 12px;
        border-radius: 8px;
      }

      .modal-back {
        position: fixed;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
        backdrop-filter: blur(4px);
        padding: 20px; /* ensure modal doesn't touch viewport edges */
      }

      .modal {
        width: 640px;
        max-width: 96%;
        background: var(--card);
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        color: var(--text);
        box-sizing: border-box;
      }

      .modal h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: var(--text);
      }

      .flex-between {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .small-muted {
        font-size: 13px;
        color: var(--text-light);
      }

      .icon-btn {
        background: var(--bg);
        border: 1px solid var(--border);
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        color: var(--text-muted);
      }

      .icon-btn:hover {
        background: var(--accent-light);
        color: var(--accent);
        border-color: var(--accent);
        transform: translateY(-1px);
      }

      .stat-card {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 20px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--text);
      }

      .stat-label {
        font-size: 14px;
        color: var(--text-muted);
      }

      .stat-trend {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .trend-up {
        color: var(--success);
      }

      .trend-down {
        color: var(--danger);
      }

      .mobile-toggle {
        display: flex;
        background: var(--bg);
        border: 1.5px solid var(--border);
        font-size: 20px;
        cursor: pointer;
        color: var(--text-muted);
        transition: var(--transition);
        z-index: 100;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .mobile-toggle:hover {
        background: var(--accent-light);
        color: var(--accent);
        border-color: var(--accent);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 90;
        backdrop-filter: blur(2px);
      }

      .overlay.active {
        opacity: 1;
        pointer-events: all;
      }

      .sidebar.collapsed {
        width: 80px;
      }

      .sidebar.collapsed .nav-item {
        padding: 14px;
        justify-content: center;
      }

      .sidebar.collapsed .nav-item span {
        display: none;
      }

      .sidebar.collapsed .nav-item i {
        margin-right: 0;
      }

      .sidebar.collapsed .sidebar-user-info {
        display: none;
      }

      .sidebar.collapsed .logout-btn {
        display: none;
      }

      @media (max-width: 991px) {
        .sidebar {
          position: fixed;
          top: 70px;
          left: 0;
          height: calc(100% - 70px);
          transform: translateX(-100%);
          z-index: 100;
        }

        .sidebar.active {
          transform: translateX(0);
        }

        .main {
          margin-left: 0 !important;
          width: 100%;
        }

        .search {
          min-width: 180px;
        }
      }
      /* Enhanced checkbox styling */
      .checkbox-option:hover {
          background: var(--accent-light);
          border-color: var(--accent);
      }

      .checkbox-option input[type="checkbox"] {
          accent-color: var(--accent);
      }

      .checkbox-option input[type="checkbox"]:checked + label {
          color: var(--accent);
      }

      /* Desktop behavior */
      @media (min-width: 992px) {
        .overlay {
          display: none !important;
        }
      }

      /* Form elements */
      .form-row {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 16px;
      }

      .form-row label {
        font-weight: 500;
        font-size: 14px;
        color: var(--text-muted);
      }

      .activity-item {
        display: flex;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
        color: var(--text);
      }

      .activity-item:last-child {
        border-bottom: none;
      }

      .activity-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--accent-light);
        color: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .activity-content {
        flex: 1;
        color: var(--text);
      }

      .activity-time {
        font-size: 12px;
        color: var(--text-light);
      }

      .workspace-card {
        padding: 20px;
        border-radius: 12px;
        background: var(--card);
        border: 1px solid var(--border);
        transition: var(--transition);
        cursor: pointer;
        color: var(--text);
      }

      .workspace-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-color: var(--accent);
      }

      .workspace-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }

      .workspace-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
      }

      .workspace-meta {
        display: flex;
        gap: 12px;
        margin-top: 12px;
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--text-muted);
      }

      /* ---------- ADAPTIVE FILE CARDS ---------- */
      .doc-adaptive {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        border-radius: 10px;
        background: var(--card);
        border: 1px solid var(--border);
        transition: var(--transition);
        cursor: pointer;
        color: var(--text);
      }

      .doc-adaptive:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-color: var(--accent);
      }

      .doc-header {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }

      .doc-icon {
        font-size: 24px;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--accent-light);
        color: var(--accent);
        flex-shrink: 0;
      }

      .doc-info {
        flex: 1;
        min-width: 0;
      }

      .doc-name {
        font-weight: 600;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .doc-meta {
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 4px;
      }

      .doc-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        flex-wrap: wrap;
      }

      /* ---------- MEMBER AVATAR GRID ---------- */
      .member-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }

      .member-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 12px;
        box-shadow: var(--shadow);
        position: relative;
      }

      .member-more {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--bg);
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-size: 12px;
      }

      @media (max-width: 768px) {
        .doc-actions {
          justify-content: space-between;
        }

        .doc-actions button {
          flex: 1;
          justify-content: center;
        }

        .toolbar {
          flex-direction: column;
          align-items: stretch;
        }

        .toolbar input,
        .toolbar select {
          max-width: 100%;
        }
      }

      .multi-select-container {
        position: relative;
      }

      .multi-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: var(--shadow);
        z-index: 10;
        max-height: 200px;
        overflow-y: auto;
        display: none;
      }

      .multi-select-dropdown.active {
        display: block;
      }

      .multi-select-option {
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--text);
      }

      .multi-select-option:hover {
        background: var(--accent-light);
        color: var(--accent);
      }

      .multi-select-selected {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .selected-member {
        background: var(--accent-light);
        color: var(--accent);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .remove-member {
        background: none;
        border: none;
        color: var(--accent);
        cursor: pointer;
        padding: 0;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .workspace-detail-header {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }

      .workspace-detail-back {
        margin-bottom: 20px;
      }

      .workspace-detail-main {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 24px;
      }

      .workspace-detail-info {
        display: flex;
        gap: 20px;
        align-items: stretch;
        flex: 1;
        min-width: 0;
      }

      .workspace-detail-icon {
        width: 72px;
        height: 72px;
        border-radius: 16px;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 28px;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
      }

      .workspace-detail-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 72px;
        height: 100%;
      }

      .workspace-detail-content h2 {
        margin: 0 0 8px 0;
        font-size: 24px;
        font-weight: 700;
        color: var(--text);
        line-height: 1.2;
      }

      .workspace-detail-content .small-muted {
        margin-bottom: 20px;
        font-size: 14px;
        line-height: 1.5;
      }

      .workspace-detail-bottom {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .workspace-detail-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .workspace-detail-actions button {
        width: 48px;
        height: 48px;
        padding: 0;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 500;
        gap: 0;
        flex-shrink: 0;
      }

      .workspace-detail-actions button i {
        margin: 0;
      }

      @media (max-width: 768px) {
        .workspace-detail-header {
          padding: 16px;
        }

        .workspace-detail-main {
          flex-direction: column;
          gap: 20px;
        }

        .workspace-detail-info {
          flex-direction: column;
          gap: 16px;
        }

        .workspace-detail-icon {
          width: 56px;
          height: 56px;
          font-size: 24px;
        }

        .workspace-detail-content {
          min-height: auto;
        }

        .workspace-detail-content h2 {
          font-size: 20px;
        }

        .workspace-detail-actions {
          flex-direction: row;
          justify-content: flex-start;
          width: 100%;
        }

        .workspace-detail-actions button {
          flex: 1;
          max-width: 120px;
        }
      }

      /* ---------- CATEGORY ---------- */
      .category-header:hover {
        background: var(--accent-light);
        border-radius: 8px;
        padding: 8px;
        margin: -8px;
        transition: var(--transition);
      }

      .category-files .doc-adaptive {
        padding: 12px;
        gap: 8px;
      }

      .category-files .doc-header {
        gap: 8px;
      }

      .category-files .doc-icon {
        width: 32px;
        height: 32px;
        font-size: 18px;
      }

      .category-files .doc-name {
        font-size: 14px;
      }

      .category-files .doc-meta {
        font-size: 12px;
      }

      .category-files .doc-actions {
        gap: 6px;
      }

      .category-files .icon-btn {
        padding: 6px;
        width: 32px;
        height: 32px;
      }

      .category-unclassified {
        background: var(--border);
        border-color: var(--text-muted);
      }

      .dark-mode .category-unclassified {
        background: #222b37;
        border-color: rgb(39, 46, 57);
      }

      .category-unclassified .category-header:hover {
        background: var(--text-muted);
        color: var(--card);
      }

      .dark-mode .category-unclassified .category-header:hover {
        background: #475569;
      }

      /* ---------- FILE PREVIEW MODAL ---------- */
      .file-preview-modal {
        width: 100%;
        max-width: 900px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        padding: 20px;
        background: var(--card);
        border-radius: 10px;
      }

      .file-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }

      .file-preview-content {
        flex: 1;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-height: 60vh;
        overflow-y: auto;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        background: var(--bg);
      }

      .file-preview-content iframe {
        width: 100%;
        height: 500px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: white;
      }

      .file-preview-content img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .file-preview-main {
        display: flex;
        gap: 20px;
      }

      .file-preview-icon {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        background: var(--accent-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        color: var(--accent);
        flex-shrink: 0;
      }

      .file-preview-details {
        flex: 1;
      }

      .file-preview-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-top: 20px;
      }

      .meta-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .meta-label {
        font-size: 12px;
        color: var(--text-muted);
        font-weight: 500;
      }

      .meta-value {
        font-size: 14px;
        color: var(--text);
      }

      .file-preview-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        justify-content: flex-end;
        width: 100%;
        padding-top: 8px;
        flex-wrap: wrap;
      }

      .back-button {
        background: var(--card);
        color: var(--text-muted);
        border: 1px solid var(--border);
        padding: 10px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .back-button:hover {
        background: var(--accent-light);
        color: var(--accent);
        border-color: var(--accent);
      }

      /* ---------- USER SETTINGS MODAL ---------- */

      .user-settings-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
      }

      .user-settings-content {
        width: 480px;
        max-width: 90%;
        max-height: 90vh;
        background: var(--card);
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .user-settings-header {
        padding: 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .user-settings-body {
        padding: 24px;
        flex: 1;
        overflow-y: auto;
      }

      .user-settings-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      .profile-image-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border);
      }

      .profile-image-container {
        position: relative;
        width: 100px;
        height: 100px;
        margin-bottom: 16px;
      }

      .profile-image {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--accent-dark));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 32px;
        cursor: pointer;
        transition: var(--transition);
      }

      .profile-image:hover {
        transform: scale(1.05);
      }

      .profile-image-upload {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 32px;
        height: 32px;
        background: var(--accent);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        border: 2px solid var(--card);
      }

      .profile-image-upload input {
        display: none;
      }

      .profile-image-remove {
        position: absolute;
        top: -4px;
        right: -4px;
        width: 24px;
        height: 24px;
        background: var(--danger);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        border: 2px solid var(--card);
        font-size: 12px;
        opacity: 0;
        transition: var(--transition);
        z-index: 10;
      }

      .profile-image-container:hover .profile-image-remove {
        opacity: 1;
        transform: scale(1.1);
      }

      .profile-image-remove:hover {
        background: #dc2626;
        transform: scale(1.2);
      }

      .form-section {
        margin-bottom: 24px;
      }

      .form-section:last-child {
        margin-bottom: 0;
      }

      .form-section h4 {
        margin-bottom: 16px;
        color: var(--text);
        font-weight: 600;
      }

      .password-fields {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .current-password-field {
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="brand">
        <button class="mobile-toggle" id="menuToggle" title="Toggle Menu">
          <i class="fa-solid fa-bars"></i>
        </button>

        <div class="logo">DM</div>

        <div>
          <h1>DMS</h1>
          <div class="small-muted">Document Management System</div>
        </div>
      </div>

      <div class="top-actions">
        <button class="theme-toggle" id="themeToggle" title="Toggle Theme">
          <i class="fa-solid fa-moon"></i>
        </button>
        <div class="search-wrapper">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input
            class="search"
            id="globalSearch"
            placeholder="Search files, users, workspaces..."
            oninput="onGlobalSearch(event)"
          />
        </div>
        <div id="topUser" class="top-user-info" onclick="openUserSettings()">
          <div class="avatar" id="topAvatar">JD</div>
          <div class="user-details">
            <div id="topName">Guest</div>
            <div class="small-muted" id="topRole">Visitor</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay for mobile view -->
    <div class="overlay" id="overlay"></div>

    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div
          class="sidebar-user-info"
          style="padding: 0 20px; margin-bottom: 16px"
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div class="small-muted">Signed in as</div>
            <div class="small-muted"><span id="sidebarRole">Guest</span></div>
          </div>
          <div style="margin-top: 8px; font-weight: 600" id="sidebarUser">
            Not signed
          </div>
        </div>
        <div id="nav">
          <div
            class="nav-item active"
            data-view="dashboard"
            onclick="navigate(event)"
          >
            <i class="fa-solid fa-grip"></i><span>Dashboard</span>
          </div>
          <div class="nav-item" data-view="library" onclick="navigate(event)">
            <i class="fa-solid fa-folder-open"></i><span>My Library</span>
          </div>
          <div
            class="nav-item"
            data-view="workspaces"
            onclick="navigate(event)"
          >
            <i class="fa-solid fa-layer-group"></i><span>Workspaces</span>
          </div>
          <div class="nav-item" data-view="userMgmt" onclick="navigate(event)">
            <i class="fa-solid fa-users-gear"></i><span>User Management</span>
          </div>
          <div
            class="nav-item"
            data-view="departments"
            onclick="navigate(event)"
          >
            <i class="fa-solid fa-users-rectangle"></i><span>Departments</span>
          </div>
          <div
            class="nav-item"
            data-view="categories"
            onclick="navigate(event)"
          >
            <i class="fa-solid fa-list"></i><span>Categories</span>
          </div>
          <div class="nav-item" data-view="archives" onclick="navigate(event)">
            <i class="fa-solid fa-box-archive"></i><span>Archives</span>
          </div>
          <div class="nav-item" data-view="settings" onclick="navigate(event)">
            <i class="fa-solid fa-gear"></i><span>System Settings</span>
          </div>
          <div style="flex: 1"></div>
          <div class="logout-btn" style="padding: 12px">
            <button
              class="btn-secondary"
              onclick="logout()"
              style="width: 100%; justify-content: center"
            >
              <i class="fa-solid fa-right-from-bracket"></i> Logout
            </button>
          </div>
        </div>
      </div>

      <main class="main" id="main">
        <div id="appViews" style="display: none">
          <section id="dashboard" class="view">
            <div class="flex-between" style="margin-bottom: 24px">
              <div>
                <h2>Admin Dashboard</h2>
                <div class="small-muted">
                  Overview of system activity and quick actions
                </div>
              </div>
              <div style="display: flex; gap: 12px">
                <button onclick="openAddFileModal()">
                  <i class="fa-solid fa-upload"></i> Upload File
                </button>
                <button onclick="openCreateWorkspace()">
                  <i class="fa-solid fa-plus"></i> Create Workspace
                </button>
              </div>
            </div>

            <div
              class="grid"
              style="
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                margin-bottom: 24px;
              "
            >
              <div class="card stat-card">
                <div class="flex-between">
                  <div class="stat-value" id="statTotal">0</div>
                  <div class="badge"><i class="fa-solid fa-file"></i></div>
                </div>
                <div class="stat-label">Total Documents</div>
                <div class="stat-trend trend-up">
                  <i class="fa-solid fa-arrow-up"></i> 12% from last week
                </div>
              </div>
              <div class="card stat-card">
                <div class="flex-between">
                  <div class="stat-value" id="statShared">0</div>
                  <div class="badge">
                    <i class="fa-solid fa-share-nodes"></i>
                  </div>
                </div>
                <div class="stat-label">Shared Files</div>
                <div class="stat-trend trend-up">
                  <i class="fa-solid fa-arrow-up"></i> 5% from last week
                </div>
              </div>
              <div class="card stat-card">
                <div class="flex-between">
                  <div class="stat-value" id="statRecent">0</div>
                  <div class="badge"><i class="fa-solid fa-clock"></i></div>
                </div>
                <div class="stat-label">Recent Files</div>
                <div class="stat-trend trend-down">
                  <i class="fa-solid fa-arrow-down"></i> 3% from last week
                </div>
              </div>
              <div class="card stat-card">
                <div class="flex-between">
                  <div class="stat-value" id="statUsers">0</div>
                  <div class="badge"><i class="fa-solid fa-users"></i></div>
                </div>
                <div class="stat-label">Total Users</div>
                <div class="stat-trend trend-up">
                  <i class="fa-solid fa-arrow-up"></i> 8% from last week
                </div>
              </div>
            </div>

            <div class="card">
              <h3>Recent Activity</h3>
              <div
                id="activityFeed"
                style="min-height: 90px"
                class="small-muted"
              >
                No activity yet
              </div>
            </div>
          </section>

          <section id="library" class="view" style="display: none">
            <div class="flex-between" style="margin-bottom: 24px">
              <div>
                <h2>My Library</h2>
                <div class="small-muted">
                  Upload, organize and preview your documents
                </div>
              </div>
              <div style="display: flex; gap: 12px; align-items: center">
                <button onclick="openAddFileModal()">
                  <i class="fa-solid fa-upload"></i> Upload
                </button>
                <button class="icon-btn" onclick="openShareModal()">
                  <i class="fa-solid fa-share-nodes"></i>
                </button>
              </div>
            </div>

            <div class="toolbar">
              <input
                placeholder="Filter by type (pdf, image, docx)..."
                id="filterType"
                oninput="renderFiles()"
                style="max-width: 300px"
              />
              <select id="sortFiles" onchange="renderFiles()">
                <option value="new">Sort: Newest</option>
                <option value="old">Sort: Oldest</option>
                <option value="name">Sort: Name</option>
              </select>
              <div style="flex: 1"></div>
              <button class="btn-secondary" onclick="archiveSelected()">
                <i class="fa-solid fa-box-archive"></i> Move to Archive
              </button>
            </div>

            <div id="filesGrid" class="grid"></div>
          </section>

          <section id="workspaces" class="view" style="display: none">
            <div class="flex-between" style="margin-bottom: 24px">
              <h2>Workspaces</h2>
              <button onclick="openCreateWorkspace()">
                <i class="fa-solid fa-plus"></i> New Workspace
              </button>
            </div>
            <div style="margin-top: 12px" id="workspacesList"></div>
          </section>

          <section
            id="workspace-detail"
            class="view"
            style="display: none"
          ></section>

          <section id="userMgmt" class="view" style="display: none">
  <div class="flex-between" style="margin-bottom: 24px">
    <h2>User Management</h2>
    <div>
      <button onclick="openAddUser()">
        <i class="fa-solid fa-user-plus"></i> Add User
      </button>
    </div>
  </div>
  <div class="toolbar" style="margin-bottom: 20px">
    <select
      id="filterUserRole"
      onchange="renderUsers()"
      style="max-width: 200px"
    >
      <option value="">All Roles</option>
      <option value="staff">Staff</option>
      <option value="admin">Admin</option>
    </select>
  </div>
  <div class="card">
    <table class="table" id="usersTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Email</th>
          <th style="text-align: center">Role</th>
          <th style="text-align: center">Department</th>
          <th style="text-align: center">Status</th>
          <th style="text-align: center">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

          <!-- Departments -->
          <section id="departments" class="view" style="display: none">
            <div class="flex-between" style="margin-bottom: 24px">
              <h2>Departments</h2>
              <button onclick="openAddDepartment()">
                <i class="fa-solid fa-plus"></i> Add Department
              </button>
            </div>
            <div id="departmentsList" style="margin-top: 12px"></div>
          </section>

          <!-- Categories -->
          <section id="categories" class="view" style="display: none">
            <div class="flex-between" style="margin-bottom: 24px">
              <h2>Categories</h2>
              <div style="display: flex; gap: 12px; align-items: center">
                <button
                  class="btn-secondary"
                  onclick="sortCategories()"
                  id="sortCategoriesBtn"
                >
                  <i class="fa-solid fa-sort-alpha-down" id="sortIcon"></i> Sort
                </button>
                <button onclick="openAddCategory()">
                  <i class="fa-solid fa-plus"></i> Add Category
                </button>
              </div>
            </div>
            <div id="categoriesList" style="margin-top: 12px"></div>
          </section>

          <section id="archives" class="view" style="display: none">
            <h2 style="margin-bottom: 24px">Archives / Recycle Bin</h2>
            <div id="archivesList" style="margin-top: 12px"></div>
          </section>

          <section id="settings" class="view" style="display: none">
            <h2 style="margin-bottom: 24px">System Settings</h2>
            <div class="card">
              <div class="form-row">
                <label class="small-muted">Company name</label
                ><input id="settingCompany" />
              </div>
              <div class="form-row">
                <label class="small-muted">Max file size (MB)</label
                ><input id="settingMax" type="number" min="1" />
              </div>
              <div class="form-row">
                <label class="small-muted"
                  >Allowed types (comma separated)</label
                ><input id="settingTypes" />
              </div>
              <div style="margin-top: 16px">
                <button onclick="saveSettings()">
                  <i class="fa-solid fa-floppy-disk"></i> Save Changes
                </button>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <div id="modalRoot" style="display: none"></div>

    <!-- User Setting Modal -->
    <div
      id="userSettingsModal"
      class="user-settings-modal"
      style="display: none"
    >
      <div class="user-settings-content">
        <div class="user-settings-header">
          <h3 style="margin: 0; color: var(--text)">User Settings</h3>
          <button class="icon-btn" onclick="closeUserSettings()">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div class="user-settings-body">
          <!-- Profile Image Section -->
          <div class="profile-image-section">
            <div class="profile-image-container">
              <div class="profile-image" id="profileImageDisplay">JD</div>
              <div
                class="profile-image-upload"
                onclick="document.getElementById('profileImageInput').click()"
              >
                <i class="fa-solid fa-camera"></i>
                <input
                  type="file"
                  id="profileImageInput"
                  accept="image/*"
                  onchange="handleProfileImageUpload(event)"
                  style="display: none"
                />
              </div>
            </div>
            <div class="small-muted" style="text-align: center">
              Click the camera icon to upload a new profile image
            </div>
          </div>

          <!-- Personal Information Section -->
          <div class="form-section">
            <h4>Personal Information</h4>
            <div class="form-row">
              <label>Full Name</label>
              <input
                type="text"
                id="userNameInput"
                placeholder="Enter your full name"
              />
            </div>
            <div class="form-row">
              <label>Email Address</label>
              <input
                type="email"
                id="userEmailInput"
                placeholder="Enter your email address"
              />
            </div>
          </div>

          <!-- Password Change Section -->
          <div class="form-section">
            <h4>Change Password</h4>
            <div class="password-fields">
              <div class="form-row current-password-field">
                <label>Current Password</label>
                <input
                  type="password"
                  id="currentPasswordInput"
                  placeholder="Enter current password"
                />
              </div>
              <div class="form-row">
                <label>New Password</label>
                <input
                  type="password"
                  id="newPasswordInput"
                  placeholder="Enter new password"
                />
              </div>
              <div class="form-row">
                <label>Confirm New Password</label>
                <input
                  type="password"
                  id="confirmPasswordInput"
                  placeholder="Confirm new password"
                />
              </div>
            </div>
          </div>
        </div>

        <div class="user-settings-footer">
          <button class="btn-secondary" onclick="closeUserSettings()">
            Cancel
          </button>
          <button onclick="saveUserSettings()">
            <i class="fa-solid fa-floppy-disk"></i> Save Changes
          </button>
        </div>
      </div>
    </div>

    <script>
  const API_BASE_URL = "http://localhost:5000/api";

  // Utilities
  function uid(prefix = "id") {
    return prefix + "_" + Math.random().toString(36).slice(2, 9);
  }
  
  function nowStr() {
    return new Date().toISOString();
  }
  
let currentToast = null;
let toastTimeout = null;

function showToast(msg, type = 'info') {
    console.log(`DEBUG: Showing toast: ${msg} (${type})`);
    
    // Clear existing toast and timeout
    if (currentToast) {
        document.body.removeChild(currentToast);
        currentToast = null;
    }
    if (toastTimeout) {
        clearTimeout(toastTimeout);
        toastTimeout = null;
    }
    
    const toast = document.createElement("div");
    let bgColor = 'var(--accent)';
    let icon = 'fa-circle-info';
    
    if (type === 'success') {
        bgColor = 'var(--success)';
        icon = 'fa-circle-check';
    } else if (type === 'error') {
        bgColor = 'var(--danger)';
        icon = 'fa-circle-exclamation';
    }
    
    toast.style.cssText = `position:fixed;bottom:20px;right:20px;background:${bgColor};color:white;padding:12px 20px;border-radius:8px;z-index:1000;box-shadow:0 4px 6px rgba(0,0,0,0.1);display:flex;align-items:center;gap:8px;`;
    toast.innerHTML = `<i class="fa-solid ${icon}"></i><span>${msg}</span>`;
    document.body.appendChild(toast);
    
    currentToast = toast;
    
    toastTimeout = setTimeout(() => {
        if (currentToast === toast) {
            document.body.removeChild(toast);
            currentToast = null;
            toastTimeout = null;
        }
    }, 3000);
}

  // Database API functions
  async function apiCall(endpoint, options = {}) {
    try {
      const config = {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      };

      if (config.body && typeof config.body === 'object') {
        config.body = JSON.stringify(config.body);
      }

      const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('API call failed:', error);
      showToast('Database operation failed', 'error');
      return null;
    }
  }

  // User management
  async function getCurrentUser() {
    const session = JSON.parse(localStorage.getItem("dms_session_v1") || "null");
    if (!session) return null;
    
    const users = await apiCall('/users');
    return users ? users.find(u => u.user_id === session.userId) || null : null;
  }

  async function getAllUsers() {
    return await apiCall('/users');
  }

  async function createUser(userData) {
    return await apiCall('/users', {
      method: 'POST',
      body: userData
    });
  }

  async function updateUser(userId, userData) {
    return await apiCall(`/users/${userId}`, {
      method: 'PUT',
      body: userData
    });
  }

  async function archiveUser(userId, archiveData) {
    return await apiCall(`/users/${userId}/archive`, {
      method: 'POST',
      body: archiveData
    });
  }

  // File operations
  async function getAllFiles() {
    return await apiCall('/files');
  }

  async function createFile(fileData) {
    return await apiCall('/files', {
      method: 'POST',
      body: fileData
    });
  }

  async function updateFile(fileId, updates) {
    return await apiCall(`/files/${fileId}`, {
      method: 'PUT',
      body: updates
    });
  }

  async function archiveFile(fileId) {
    return await apiCall(`/files/${fileId}/archive`, {
      method: 'POST'
    });
  }

  async function deleteFile(fileId) {
    return await apiCall(`/files/${fileId}`, {
      method: 'DELETE'
    });
  }

  // Department operations
  async function getAllDepartments() {
    return await apiCall('/departments');
  }

  async function createDepartment(departmentData) {
    return await apiCall('/departments', {
      method: 'POST',
      body: departmentData
    });
  }

  async function deleteDepartmentAPI(departmentId) {
    return await apiCall(`/departments/${departmentId}`, {
      method: 'DELETE'
    });
  }

  // Category operations
  async function getAllCategories() {
    return await apiCall('/categories');
  }

  async function createCategory(categoryData) {
    return await apiCall('/categories', {
      method: 'POST',
      body: categoryData
    });
  }

  async function updateCategory(categoryId, categoryData) {
    return await apiCall(`/categories/${categoryId}`, {
      method: 'PUT',
      body: categoryData
    });
  }

  // Workspace operations
  async function getAllWorkspaces() {
    return await apiCall('/workspaces');
  }

  async function createWorkspace(workspaceData) {
    return await apiCall('/workspaces', {
      method: 'POST',
      body: workspaceData
    });
  }

  async function updateWorkspace(workspaceId, workspaceData) {
    return await apiCall(`/workspaces/${workspaceId}`, {
        method: 'PUT',
        body: workspaceData
    });
}

  async function deleteWorkspaceAPI(workspaceId) {
    return await apiCall(`/workspaces/${workspaceId}`, {
      method: 'DELETE'
    });
  }

  // Settings operations
  async function getSettings() {
    return await apiCall('/settings');
  }

  async function updateSettings(settingsData) {
    return await apiCall('/settings', {
      method: 'PUT',
      body: settingsData
    });
  }

  // Activity operations
  async function getActivities() {
    return await apiCall('/activities');
  }

  async function logActivity(activityData) {
    return await apiCall('/activities', {
      method: 'POST',
      body: activityData
    });
  }

  // Authentication
  function checkAuth() {
    const session = JSON.parse(localStorage.getItem("dms_session_v1") || "null");
    if (!session) {
      window.location.href = "login.html";
      return false;
    }
    return true;
  }

  function clearSession() {
    localStorage.removeItem("dms_session_v1");
    window.location.href = "login.html";
  }

  let currentView = "dashboard";
  let sidebarCollapsed = false;
  let currentWorkspaceId = null;
  let categoriesSortOrder = "asc";

  // Initialize application
  async function init() {
    if (!checkAuth()) return;

    const user = await getCurrentUser();
    if (user) {
      updateTopUser(user);
      enterApp();
      initSidebarToggle();
      initThemeToggle();
    } else {
      clearSession();
    }
  }

  function initThemeToggle() {
    const themeToggle = document.getElementById("themeToggle");
    const icon = themeToggle.querySelector("i");

    const savedTheme = localStorage.getItem("dms-theme") || "light";
    if (savedTheme === "dark") {
      document.body.classList.add("dark-mode");
      icon.classList.remove("fa-moon");
      icon.classList.add("fa-sun");
    }

    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      if (document.body.classList.contains("dark-mode")) {
        localStorage.setItem("dms-theme", "dark");
        icon.classList.remove("fa-moon");
        icon.classList.add("fa-sun");
      } else {
        localStorage.setItem("dms-theme", "light");
        icon.classList.remove("fa-sun");
        icon.classList.add("fa-moon");
      }
    });
  }

  function initSidebarToggle() {
    const menuToggle = document.getElementById("menuToggle");
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    const main = document.getElementById("main");

    menuToggle.addEventListener("click", () => {
      if (window.innerWidth < 992) {
        sidebar.classList.toggle("active");
        overlay.classList.toggle("active");
      } else {
        sidebarCollapsed = !sidebarCollapsed;
        if (sidebarCollapsed) {
          sidebar.classList.add("collapsed");
        } else {
          sidebar.classList.remove("collapsed");
        }
      }
    });

    overlay.addEventListener("click", () => {
      sidebar.classList.remove("active");
      overlay.classList.remove("active");
    });
  }

  function logout() {
    if (confirm("Are you sure you want to logout?")) {
      clearSession();
    }
  }

  function updateTopUser(user) {
    const topName = document.getElementById("topName");
    const topRole = document.getElementById("topRole");
    const topAvatar = document.getElementById("topAvatar");
    const sidebarUser = document.getElementById("sidebarUser");
    const sidebarRole = document.getElementById("sidebarRole");

    if (user) {
      topName.textContent = user.name;
      topRole.textContent = user.role === "admin" ? "Administrator" : "Staff";
      
      if (user.profile_image) {
        topAvatar.innerHTML = `<img src="${user.profile_image}" alt="Profile" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
      } else {
        topAvatar.textContent = user.name
          .split(" ")
          .map((s) => s[0])
          .slice(0, 2)
          .join("")
          .toUpperCase();
        topAvatar.style.background = "linear-gradient(135deg, var(--accent), var(--accent-dark))";
        topAvatar.style.color = "white";
        topAvatar.style.display = "flex";
        topAvatar.style.alignItems = "center";
        topAvatar.style.justifyContent = "center";
      }
      
      sidebarUser.textContent = user.name;
      sidebarRole.textContent = user.role;
    }
  }

function enterApp() {
    document.getElementById("appViews").style.display = "block";
    document.getElementById("sidebar").style.display = "flex";
    
    // Restore previous view from localStorage
    const savedView = localStorage.getItem('dms_current_view');
    const savedWorkspace = localStorage.getItem('dms_current_workspace');
    
    if (savedView && savedView !== "dashboard") {
        // Remove active class from all nav items
        document.querySelectorAll(".nav-item").forEach((n) => n.classList.remove("active"));
        
        // Set the saved view
        currentView = savedView;
        
        // Restore workspace if applicable
        if (savedWorkspace && savedView === "workspace-detail") {
            currentWorkspaceId = parseInt(savedWorkspace);
        }
        
        // Activate the correct nav item
        const navItem = document.querySelector(`.nav-item[data-view="${savedView}"]`);
        if (navItem) {
            navItem.classList.add("active");
        } else {
            // Fallback to dashboard if saved view doesn't exist
            currentView = "dashboard";
            document.querySelector('.nav-item[data-view="dashboard"]').classList.add("active");
        }
    }
    
    renderCurrentView();
    refreshStats();
}

  // User Settings Modal Functions
  let originalProfileImage = null;
  let tempProfileImage = null;

  function openUserSettings() {
    getCurrentUser().then(user => {
      if (!user) return;

      originalProfileImage = user.profile_image || null;
      tempProfileImage = null;

      document.getElementById("userNameInput").value = user.name || "";
      document.getElementById("userEmailInput").value = user.email || "";

      updateProfileImageDisplay(user.profile_image, user.name);

      document.getElementById("currentPasswordInput").value = "";
      document.getElementById("newPasswordInput").value = "";
      document.getElementById("confirmPasswordInput").value = "";

      document.getElementById("userSettingsModal").style.display = "flex";
    });
  }

  function closeUserSettings() {
    if (tempProfileImage && originalProfileImage !== tempProfileImage) {
      getCurrentUser().then(user => {
        if (user) {
          updateProfileImageDisplay(originalProfileImage, user.name);
        }
      });
    }
    
    tempProfileImage = null;
    originalProfileImage = null;
    document.getElementById("userSettingsModal").style.display = "none";
  }

  function updateProfileImageDisplay(profileImage, userName) {
    const profileImageDisplay = document.getElementById("profileImageDisplay");
    const profileImageContainer = document.querySelector('.profile-image-container');
    
    profileImageDisplay.innerHTML = '';
    profileImageDisplay.style.background = '';
    profileImageDisplay.style.color = '';
    
    const existingRemoveBtn = profileImageContainer.querySelector('.profile-image-remove');
    if (existingRemoveBtn) {
      existingRemoveBtn.remove();
    }

    if (profileImage) {
      profileImageDisplay.innerHTML = `<img src="${profileImage}" alt="Profile" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;

      const removeBtn = document.createElement('div');
      removeBtn.className = 'profile-image-remove';
      removeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
      removeBtn.onclick = (e) => {
        e.stopPropagation();
        removeProfileImage();
      };
      profileImageContainer.appendChild(removeBtn);
    } else {
      const initials = userName
        .split(" ")
        .map((s) => s[0])
        .slice(0, 2)
        .join("")
        .toUpperCase();
      profileImageDisplay.textContent = initials;
      profileImageDisplay.style.background = "linear-gradient(135deg, var(--accent), var(--accent-dark))";
      profileImageDisplay.style.color = "white";
      profileImageDisplay.style.display = "flex";
      profileImageDisplay.style.alignItems = "center";
      profileImageDisplay.style.justifyContent = "center";
    }

    profileImageDisplay.style.cursor = "pointer";
    profileImageDisplay.onclick = () => document.getElementById('profileImageInput').click();
  }

  function removeProfileImage() {
    if (!confirm("Remove profile image?")) return;
    
    tempProfileImage = null;
    
    getCurrentUser().then(user => {
      if (user) {
        updateProfileImageDisplay(null, document.getElementById("userNameInput").value || user.name);
        showToast("Profile image removed. Don't forget to save changes!");
      }
    });
  }

  function handleProfileImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.type.startsWith("image/")) {
      showToast("Please select a valid image file");
      return;
    }

    if (file.size > 5 * 1024 * 1024) {
      showToast("Image size should be less than 5MB");
      return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
      tempProfileImage = e.target.result;
      
      updateProfileImageDisplay(tempProfileImage, document.getElementById("userNameInput").value || "User");
      
      showToast("Profile image updated. Don't forget to save changes!");
    };
    reader.readAsDataURL(file);
  }

  async function saveUserSettings() {
    const user = await getCurrentUser();
    if (!user) return;

    const name = document.getElementById("userNameInput").value.trim();
    const email = document.getElementById("userEmailInput").value.trim();
    const currentPassword = document.getElementById("currentPasswordInput").value;
    const newPassword = document.getElementById("newPasswordInput").value;
    const confirmPassword = document.getElementById("confirmPasswordInput").value;

    if (!name || !email) {
      showToast("Name and email are required");
      return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showToast("Please enter a valid email address");
      return;
    }

    // For password change - in real app, verify current password via API
    if (currentPassword || newPassword || confirmPassword) {
      if (!currentPassword) {
        showToast("Current password is required to change password");
        return;
      }

      if (!newPassword) {
        showToast("New password is required");
        return;
      }

      if (newPassword.length < 6) {
        showToast("New password must be at least 6 characters long");
        return;
      }

      if (newPassword !== confirmPassword) {
        showToast("New passwords do not match");
        return;
      }
    }

    const updateData = {
      name: name,
      email: email,
      role: user.role,
      department_id: user.department_id,
      status: user.status
    };

    if (tempProfileImage) {
      updateData.profile_image = tempProfileImage;
    } else if (tempProfileImage === null) {
      updateData.profile_image = null;
    }

    if (newPassword) {
      updateData.password = newPassword;
    }

    const result = await updateUser(user.user_id, updateData);
    if (result && result.success) {
      showToast("User settings saved successfully", "success");
      closeUserSettings();
      
      // Refresh user data
      const updatedUser = await getCurrentUser();
      updateTopUser(updatedUser);
    }
  }

  // Navigation
function navigate(e) {
    const target = e.currentTarget || e.target;
    const view = target.dataset.view;
    if (!view) return;

    getCurrentUser().then(user => {
        if (!user) return;

        if (["dashboard", "userMgmt", "settings"].includes(view) && user.role !== "admin") {
            showToast("Access denied. Admin only.");
            return;
        }

        document.querySelectorAll(".nav-item").forEach((n) => n.classList.remove("active"));
        target.classList.add("active");
        currentView = view;
        currentWorkspaceId = null;
        
        // Save current view to localStorage
        localStorage.setItem('dms_current_view', view);
        
        renderCurrentView();

        if (window.innerWidth < 992) {
            document.getElementById("sidebar").classList.remove("active");
            document.getElementById("overlay").classList.remove("active");
        }
    });
}

function goHome() {
    currentView = "dashboard";
    currentWorkspaceId = null;
    document.querySelectorAll(".nav-item").forEach((n) => n.classList.remove("active"));
    document.querySelector('.nav-item[data-view="dashboard"]').classList.add("active");
    
    // Save current view to localStorage
    localStorage.setItem('dms_current_view', 'dashboard');
    
    renderCurrentView();
}

  async function renderCurrentView() {
    document.querySelectorAll(".view").forEach((v) => (v.style.display = "none"));
    const el = document.getElementById(currentView);
    if (el) el.style.display = "block";

    const user = await getCurrentUser();
    if (!user || user.role !== "admin") {
      document.querySelector('[data-view="userMgmt"]').style.display = "none";
      document.querySelector('[data-view="dashboard"]').style.display = "none";
      document.querySelector('[data-view="settings"]').style.display = "none";

      if (currentView === "dashboard" || currentView === "userMgmt" || currentView === "settings") {
        currentView = "library";
        document.querySelector('.nav-item[data-view="library"]').classList.add("active");
        document.querySelector('.nav-item[data-view="dashboard"]').classList.remove("active");
        document.getElementById("library").style.display = "block";
      }
    } else {
      document.querySelector('[data-view="userMgmt"]').style.display = "flex";
      document.querySelector('[data-view="dashboard"]').style.display = "flex";
      document.querySelector('[data-view="settings"]').style.display = "flex";
    }

    if (currentView === "dashboard") await renderDashboard();
    if (currentView === "library") await renderFiles();
    if (currentView === "workspaces") await renderWorkspaces();
    if (currentView === "workspace-detail") await renderWorkspaceDetail();
    if (currentView === "userMgmt") await renderUsers();
    if (currentView === "departments") await renderDepartments();
    if (currentView === "categories") await renderCategories();
    if (currentView === "archives") await renderArchives();
    if (currentView === "settings") await renderSettings();
  }

  function fileIcon(name) {
    const ext = (name.split(".").pop() || "").toLowerCase();
    if (["png", "jpg", "jpeg", "gif", "bmp", "svg"].includes(ext)) return "";
    if (ext === "pdf") return "";
    if (["doc", "docx"].includes(ext)) return "";
    if (["xls", "xlsx", "csv"].includes(ext)) return "";
    if (["ppt", "pptx"].includes(ext)) return "";
    if (["zip", "rar", "7z"].includes(ext)) return "";
    if (ext === "txt") return "";
    return "";
  }

  // File Management
async function openAddFileModal() {
    const workspaces = await getAllWorkspaces();
    const categories = await getAllCategories();
    const currentUser = await getCurrentUser();

    // Filter workspaces where current user is a member
    const userWorkspaces = workspaces.filter(w => {
        return w.members && Array.isArray(w.members) && w.members.includes(currentUser.user_id);
    });

    const workspaceCheckboxes = userWorkspaces
        .map(w => `
            <div class="checkbox-option" style="display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all 0.2s ease;">
                <input type="checkbox" id="upload_workspace_${w.workspace_id}" value="${w.workspace_id}" style="margin:0;width:16px;height:16px;">
                <label for="upload_workspace_${w.workspace_id}" style="cursor:pointer;margin:0;flex:1;display:flex;align-items:center;gap:10px;">
                    <div style="width:32px;height:32px;border-radius:8px;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center;">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                    <div>
                        <div style="font-weight:600;color:var(--text)">${w.name}</div>
                        <div class="small-muted">${w.description || "No description"}  ${w.members ? w.members.length : 0} members</div>
                    </div>
                </label>
            </div>
        `).join("");

    const categoryOptions = (categories || [])
        .map((c) => `<option value="${c.category_id}">${c.name}</option>`)
        .join("");

    openModal(`<h3>Upload Files</h3>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="form-row">
          <label>Select Files</label>
          <input type="file" id="fileInputModal" multiple style="padding:8px" />
        </div>
        
        <div class="form-row">
          <label style="font-weight:600;color:var(--text);margin-bottom:8px;">Add to Workspace(s) (Optional)</label>
          <div id="uploadWorkspaceCheckboxes" style="max-height:200px;overflow-y:auto;padding:8px;border:1px solid var(--border);border-radius:8px;">
            ${userWorkspaces.length > 0 ? workspaceCheckboxes : '<div class="small-muted" style="text-align:center;padding:20px;">You are not a member of any workspaces</div>'}
          </div>
          <div class="small-muted" style="margin-top:8px;display:flex;align-items:center;gap:6px;">
            <i class="fa-solid fa-circle-info" style="color:var(--accent);"></i> 
            Files will be uploaded once to each selected workspace. No duplicates in My Library.
          </div>
        </div>
        
        <div id="uploadSelectedWorkspaces" style="display:none;background:var(--accent-light);padding:12px;border-radius:8px;border-left:4px solid var(--accent);">
          <div style="font-weight:600;color:var(--accent);margin-bottom:6px;display:flex;align-items:center;gap:6px;">
            <i class="fa-solid fa-check-circle"></i>
            Selected Workspaces:
          </div>
          <div id="uploadSelectedWorkspacesList" class="small-muted" style="color:var(--accent-dark);"></div>
        </div>
        
        <div class="form-row">
    <label>Category</label>
    <select id="uploadCategory">
        <option value="">Select Category (Optional)</option>
        ${categoryOptions}
    </select>
    <div class="small-muted" style="margin-top:4px;">
        <i class="fa-solid fa-circle-info"></i> 
        Files will be automatically classified and can also be manually categorized.
    </div>
</div>
        
        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
          <button onclick="handleFilesFromModal()"><i class="fa-solid fa-upload"></i> Upload Files</button>
        </div>
      </div>`);

    // Add click handlers for workspace checkboxes
    setTimeout(() => {
        document.querySelectorAll('#uploadWorkspaceCheckboxes .checkbox-option').forEach(option => {
            option.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox') {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    updateUploadSelectedWorkspaces();
                }
            });
        });

        // Add change handlers for checkboxes
        document.querySelectorAll('#uploadWorkspaceCheckboxes input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateUploadSelectedWorkspaces);
        });
    }, 100);
}

// Function to update selected workspaces in upload modal
function updateUploadSelectedWorkspaces() {
    const selectedCheckboxes = document.querySelectorAll('#uploadWorkspaceCheckboxes input[type="checkbox"]:checked');
    const summaryContainer = document.getElementById('uploadSelectedWorkspaces');
    const selectedList = document.getElementById('uploadSelectedWorkspacesList');
    
    if (selectedCheckboxes.length > 0) {
        const selectedNames = Array.from(selectedCheckboxes).map(checkbox => {
            const label = checkbox.closest('.checkbox-option').querySelector('label');
            return label.querySelector('div > div:first-child').textContent;
        });
        
        selectedList.innerHTML = selectedNames.map(name => ` ${name}`).join('<br>');
        summaryContainer.style.display = 'block';
    } else {
        summaryContainer.style.display = 'none';
    }
}

// Replace the handleFilesFromModal function
async function handleFilesFromModal() {
    const fileInput = document.getElementById("fileInputModal");
    const categorySelect = document.getElementById("uploadCategory");

    const files = Array.from(fileInput.files || []);
    const selectedWorkspaceCheckboxes = document.querySelectorAll('#uploadWorkspaceCheckboxes input[type="checkbox"]:checked');
    const selectedWorkspaceIds = Array.from(selectedWorkspaceCheckboxes).map(checkbox => parseInt(checkbox.value));
    const categoryId = categorySelect && categorySelect.value && categorySelect.value.trim() !== "" ? categorySelect.value : null;

    if (!files.length) {
        showToast("Please select at least one file", "error");
        return;
    }

    const settings = await getSettings();
    const maxMB = settings?.max_file_mb || 50;
    const allowed = (settings?.allowed_types || "").split(",").map(s => s.trim().toLowerCase()).filter(Boolean);

    const currentUser = await getCurrentUser();
    if (!currentUser) {
        showToast("User not found", "error");
        return;
    }

    let processed = 0;
    let errors = 0;

    for (const file of files) {
        const ext = (file.name.split(".").pop() || "").toLowerCase();
        
        if (allowed.length && !allowed.includes(ext)) {
            showToast(`File "${file.name}" not allowed by system settings`, "error");
            errors++;
            continue;
        }
        
        if (file.size > maxMB * 1024 * 1024) {
            showToast(`"${file.name}" exceeds max size ${maxMB}MB`, "error");
            errors++;
            continue;
        }

        try {
            // Upload file once with ALL selected workspaces
            await uploadSingleFile(file, currentUser.user_id, selectedWorkspaceIds, categoryId);
            processed++;
            
            if (selectedWorkspaceIds.length > 0) {
                showToast(`Uploaded: ${file.name} to ${selectedWorkspaceIds.length} workspace(s)`, 'success');
            } else {
                showToast(`Uploaded: ${file.name}`, 'success');
            }
            
        } catch (err) {
            console.error("Error uploading file:", file.name, err);
            showToast(`Failed to upload: ${file.name}`, 'error');
            errors++;
        }
    }

    if (processed > 0) {
        const workspaceText = selectedWorkspaceIds.length > 0 ? ` to ${selectedWorkspaceIds.length} workspace(s)` : '';
        showToast(`Successfully uploaded ${processed} files${workspaceText}`, "success");
        await logActivity({ user_id: currentUser.user_id, activity: `Uploaded ${processed} files${workspaceText}` });
    }
    if (errors > 0) {
        showToast(`${errors} files failed to upload`, "error");
    }

    closeModal();

    // Refresh the appropriate view
    await refreshAllViews();
    await refreshStats();
}

// Make sure uploadSingleFile is using the new parameter order
async function uploadSingleFile(file, userId, workspaceIds, categoryId) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('user_id', userId);
    
    // Pass workspace IDs as array
    if (workspaceIds && workspaceIds.length > 0) {
        workspaceIds.forEach(workspaceId => {
            formData.append('workspace_ids', workspaceId);
        });
    }
    
    if (categoryId) formData.append('category_id', categoryId);

    const response = await fetch(`${API_BASE_URL}/upload-file`, {
        method: 'POST',
        body: formData
    });

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || `Upload failed: ${response.status}`);
    }

    const result = await response.json();
    
    if (result.error) {
        throw new Error(result.error);
    }

    return result;
}

async function renderFiles() {
    const grid = document.getElementById("filesGrid");
    grid.innerHTML = "";
    
    const files = await getAllFiles();
    const filter = document.getElementById("filterType").value.trim().toLowerCase();
    const sort = document.getElementById("sortFiles").value;
    
    // Only show active files (not archived or deleted)
    let filteredFiles = (files || []).filter(f => f.status === 'active');
    
    if (filter) {
      filteredFiles = filteredFiles.filter(f => 
        f.type.includes(filter) || f.name.toLowerCase().includes(filter)
      );
    }
    
    if (sort === "new") filteredFiles.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    if (sort === "old") filteredFiles.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    if (sort === "name") filteredFiles.sort((a, b) => a.name.localeCompare(b.name));

    if (!filteredFiles.length) {
      grid.innerHTML = '<div class="card small-muted" style="text-align:center;padding:40px">No documents found</div>';
      return;
    }
    
    for (const f of filteredFiles) {
      const div = document.createElement("div");
      div.className = "doc-adaptive";
      div.setAttribute("data-file-id", f.file_id);
      div.onclick = () => openFilePreview(f.file_id);
      div.innerHTML = `
        <div class="doc-header">
          <div class="doc-icon">${fileIcon(f.name)}</div>
          <div class="doc-info">
            <div class="doc-name">${f.name}</div>
            <div class="doc-meta">${(f.size / 1024) | 0} KB  ${new Date(f.created_at).toLocaleString()}</div>
          </div>
        </div>
        <div class="doc-actions">
    <button class="icon-btn" onclick="event.stopPropagation(); toggleShare(${f.file_id})">
        ${f.shared ? '<i class="fa-solid fa-link"></i>' : '<i class="fa-regular fa-circle"></i>'}
    </button>
    <button class="icon-btn" onclick="event.stopPropagation(); downloadFile(${f.file_id})">
        <i class="fa-solid fa-download"></i>
    </button>
    <button class="icon-btn" title="Manage Workspaces" onclick="event.stopPropagation(); openAddToWorkspaceModal(${f.file_id})">
        <i class="fa-solid fa-layer-group"></i>
    </button>
    <button class="icon-btn" title="Archive" onclick="event.stopPropagation(); moveToArchive(${f.file_id})">
        <i class="fa-solid fa-box-archive"></i>
    </button>
</div>
      `;
      grid.appendChild(div);
    }
}

// Debug function to check file status
async function debugFile(fileId) {
    const files = await getAllFiles();
    const file = files.find(f => f.file_id === fileId);
    if (file) {
        console.log('File details:', file);
        showToast(`File: ${file.name}, Status: ${file.status}, Path: ${file.file_path}`, 'info');
    } else {
        showToast('File not found', 'error');
    }
}
  async function toggleShare(fileId) {
    const files = await getAllFiles();
    const file = files.find(f => f.file_id === fileId);
    if (!file) return;

    const result = await updateFile(fileId, { shared: !file.shared });
    if (result && result.success) {
      await renderFiles();
      await refreshStats();
      
      const currentUser = await getCurrentUser();
      if (currentUser) {
        await logActivity({ 
          user_id: currentUser.user_id, 
          activity: `${file.shared ? "Shared" : "Unshared"} ${file.name}` 
        });
      }
    }
  }

  // Enhanced download function
async function downloadFile(fileId) {
    try {
        showToast('Preparing download...', 'info');
        
        const response = await fetch(`${API_BASE_URL}/download-file/${fileId}`);
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Download failed');
        }
        
        // Get filename from Content-Disposition header or use file name
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `file_${fileId}`;
        
        if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
            if (filenameMatch) {
                filename = filenameMatch[1];
            }
        }
        
        // Create blob and download link
        const blob = await response.blob();
        
        // Check if blob is empty
        if (blob.size === 0) {
            throw new Error('File is empty or not found');
        }
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showToast('File downloaded successfully', 'success');
        
        // Log download activity
        const currentUser = await getCurrentUser();
        const files = await getAllFiles();
        const file = files.find(f => f.file_id === fileId);
        if (currentUser && file) {
            await logActivity({ 
                user_id: currentUser.user_id, 
                activity: `Downloaded ${file.original_name || file.name}` 
            });
        }
        
    } catch (error) {
        console.error('Download error:', error);
        showToast(`Download failed: ${error.message}`, 'error');
    }
}

// Enhanced move to archive function with confirmation
async function moveToArchive(fileId) {
    console.log(`DEBUG: moveToArchive called for file ${fileId}`);
    
    const files = await getAllFiles();
    const file = files.find(f => f.file_id === fileId);
    
    if (!file) {
        showToast("File not found", "error");
        return;
    }

    const fileName = file.original_name || file.name;
    
    openModal(`<h3>Archive File</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="small-muted">
                Are you sure you want to archive <strong>"${fileName}"</strong>?
            </div>
            <div class="small-muted">
                Archived files will be moved to the Archives section and can be restored later.
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i> Cancel
                </button>
                <button class="btn-danger" onclick="confirmArchiveFile(${fileId})">
                    <i class="fa-solid fa-box-archive"></i> Move to Archive
                </button>
            </div>
        </div>`);
}


// Function to refresh all views automatically
async function refreshAllViews() {
    console.log("DEBUG: Refreshing all views...");
    
    try {
        // Refresh stats first
        await refreshStats();
        console.log("DEBUG: Stats refreshed");
        
        // Refresh current view based on what's active
        if (currentView === "library") {
            await renderFiles();
            console.log("DEBUG: Library view refreshed");
        } else if (currentView === "workspace-detail" && currentWorkspaceId) {
            await renderWorkspaceDetail();
            console.log("DEBUG: Workspace detail view refreshed");
        } else if (currentView === "archives") {
            await renderArchives();
            console.log("DEBUG: Archives view refreshed");
        } else if (currentView === "workspaces") {
            await renderWorkspaces();
            console.log("DEBUG: Workspaces view refreshed");
        }
        
        // Also refresh dashboard if it's active
        if (currentView === "dashboard") {
            await renderDashboard();
            console.log("DEBUG: Dashboard refreshed");
        }
        
        console.log("DEBUG: All views refreshed successfully");
        
    } catch (error) {
        console.error("DEBUG: Error refreshing views:", error);
    }
}

// Updated Add to Workspace function with checkboxes
async function openAddToWorkspaceModal(fileId) {
    const workspaces = await getAllWorkspaces();
    const currentUser = await getCurrentUser();
    
    if (!currentUser) {
        showToast("Please log in first", "error");
        return;
    }

    // Filter workspaces where current user is a member
    const userWorkspaces = workspaces.filter(w => {
        return w.members && Array.isArray(w.members) && w.members.includes(currentUser.user_id);
    });
    
    if (!userWorkspaces.length) {
        showToast("You are not a member of any workspaces. Please create a workspace first or ask to be added to one.", "error");
        return;
    }

    // Get current workspaces for this file
    const fileWorkspaces = await getFileWorkspaces(fileId);
    const fileWorkspaceIds = fileWorkspaces.map(w => w.workspace_id);
    
    console.log(`DEBUG: File ${fileId} is currently in workspaces:`, fileWorkspaceIds);
    
    const workspaceCheckboxes = userWorkspaces
        .map(w => {
            const isInWorkspace = fileWorkspaceIds.includes(w.workspace_id);
            return `
                <div class="checkbox-option" style="display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;cursor:pointer;${isInWorkspace ? 'background:var(--accent-light);' : ''}">
                    <input type="checkbox" id="workspace_${w.workspace_id}" value="${w.workspace_id}" ${isInWorkspace ? 'checked' : ''} data-was-checked="${isInWorkspace}" style="margin:0;width:16px;height:16px;">
                    <label for="workspace_${w.workspace_id}" style="cursor:pointer;margin:0;flex:1;display:flex;align-items:center;gap:10px;">
                        <div style="width:32px;height:32px;border-radius:8px;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center;">
                            <i class="fa-solid fa-layer-group"></i>
                        </div>
                        <div>
                            <div style="font-weight:600;color:var(--text)">${w.name}</div>
                            <div class="small-muted">${w.description || "No description"}</div>
                            ${isInWorkspace ? '<div class="small-muted" style="color:var(--success);"><i class="fa-solid fa-check"></i> File already in this workspace</div>' : ''}
                        </div>
                    </label>
                </div>
            `;
        }).join('');

    openModal(`<h3>Manage File in Workspaces</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="form-row">
                <label>Select workspaces to add/remove this file:</label>
                <div id="workspaceCheckboxesContainer" style="max-height:300px;overflow-y:auto;padding:8px;border:1px solid var(--border);border-radius:8px;">
                    ${workspaceCheckboxes}
                </div>
                <div class="small-muted" style="margin-top:8px;">
                    <i class="fa-solid fa-circle-info"></i> 
                    Checked = File will be in workspace, Unchecked = File will be removed from workspace
                </div>
            </div>
            
            <div id="selectedWorkspacesSummary" style="display:none;background:var(--accent-light);padding:12px;border-radius:8px;border-left:4px solid var(--accent);">
                <div style="font-weight:600;color:var(--accent);margin-bottom:4px;">Will be in these workspaces:</div>
                <div id="selectedWorkspacesList" class="small-muted"></div>
            </div>

            <div id="removedWorkspacesSummary" style="display:none;background:var(--warning-light);padding:12px;border-radius:8px;border-left:4px solid var(--warning);">
                <div style="font-weight:600;color:var(--warning);margin-bottom:4px;">Will be removed from these workspaces:</div>
                <div id="removedWorkspacesList" class="small-muted"></div>
            </div>
            
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i> Cancel
                </button>
                <button onclick="updateFileWorkspaces(${fileId})">
                    <i class="fa-solid fa-layer-group"></i> Update Workspaces
                </button>
            </div>
        </div>`);

    // Add click handlers for checkboxes
    document.querySelectorAll('.checkbox-option').forEach(option => {
        option.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox') {
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                updateWorkspacesSummary();
            }
        });
    });

    // Add change handlers for checkboxes
    document.querySelectorAll('#workspaceCheckboxesContainer input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateWorkspacesSummary);
    });

    // Initial summary update
    updateWorkspacesSummary();
}
// to get file workspaces
async function getFileWorkspaces(fileId) {
    try {
        const response = await fetch(`${API_BASE_URL}/files/${fileId}/workspaces`);
        if (response.ok) {
            return await response.json();
        }
        return [];
    } catch (error) {
        console.error('Error getting file workspaces:', error);
        return [];
    }
}

// Function to update the selected workspaces summary
function updateWorkspacesSummary() {
    const allCheckboxes = document.querySelectorAll('#workspaceCheckboxesContainer input[type="checkbox"]');
    const selectedCheckboxes = document.querySelectorAll('#workspaceCheckboxesContainer input[type="checkbox"]:checked');
    const unselectedCheckboxes = document.querySelectorAll('#workspaceCheckboxesContainer input[type="checkbox"]:not(:checked)');
    
    const summaryContainer = document.getElementById('selectedWorkspacesSummary');
    const selectedList = document.getElementById('selectedWorkspacesList');
    const removedContainer = document.getElementById('removedWorkspacesSummary');
    const removedList = document.getElementById('removedWorkspacesList');
    
    // Get workspace names for selected (will be in workspace)
    const selectedNames = Array.from(selectedCheckboxes).map(checkbox => {
        const label = checkbox.closest('.checkbox-option').querySelector('label');
        return label.querySelector('div > div:first-child').textContent;
    });
    
    // Get workspace names for unselected that were previously checked (will be removed)
    const removedNames = Array.from(unselectedCheckboxes).map(checkbox => {
        const wasPreviouslyChecked = checkbox.getAttribute('data-was-checked') === 'true';
        if (wasPreviouslyChecked) {
            const label = checkbox.closest('.checkbox-option').querySelector('label');
            return label.querySelector('div > div:first-child').textContent;
        }
        return null;
    }).filter(name => name !== null);
    
    console.log(`DEBUG: Selected workspaces:`, selectedNames);
    console.log(`DEBUG: Removed workspaces:`, removedNames);
    
    // Update selected summary
    if (selectedNames.length > 0) {
        selectedList.innerHTML = selectedNames.map(name => ` ${name}`).join('<br>');
        summaryContainer.style.display = 'block';
    } else {
        summaryContainer.style.display = 'none';
    }
    
    // Update removed summary
    if (removedNames.length > 0) {
        removedList.innerHTML = removedNames.map(name => ` ${name}`).join('<br>');
        removedContainer.style.display = 'block';
    } else {
        removedContainer.style.display = 'none';
    }
}

// Function to add file to multiple workspaces
async function updateFileWorkspaces(fileId) {
    const allCheckboxes = document.querySelectorAll('#workspaceCheckboxesContainer input[type="checkbox"]');
    const currentUser = await getCurrentUser();
    
    if (!currentUser) {
        showToast("Please log in first", "error");
        return;
    }

    try {
        showToast("Updating file workspaces...", "info");
        
        // Get selected workspace IDs
        const selectedWorkspaceIds = Array.from(allCheckboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => parseInt(checkbox.value));
        
        console.log(`DEBUG: Updating file ${fileId} to workspaces:`, selectedWorkspaceIds);
        
        // Use the new bulk update endpoint
        const result = await updateFileWorkspacesBulk(fileId, selectedWorkspaceIds);
        
        if (result && result.success) {
            showToast("Workspaces updated successfully", "success");
            closeModal();
            
            // Refresh ALL views
            await refreshAllViews();
            
            // Log activity
            const files = await getAllFiles();
            const file = files.find(f => f.file_id === fileId);
            if (currentUser && file) {
                await logActivity({ 
                    user_id: currentUser.user_id, 
                    activity: `Updated workspaces for "${file.original_name || file.name}"` 
                });
            }
        } else {
            showToast(result.error || "Failed to update workspaces", "error");
        }
        
    } catch (error) {
        console.error("Error updating file workspaces:", error);
        showToast("Error updating workspaces", "error");
    }
}

// Add this new function for bulk updates
async function updateFileWorkspacesBulk(fileId, workspaceIds) {
    try {
        const response = await fetch(`${API_BASE_URL}/files/${fileId}/update-workspaces`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ workspace_ids: workspaceIds })
        });

        if (response.ok) {
            return await response.json();
        } else {
            const error = await response.json();
            return { success: false, error: error.error };
        }
    } catch (error) {
        console.error('Error updating file workspaces:', error);
        return { success: false, error: 'Network error' };
    }
}

// Add this new function
async function addFileToWorkspace(fileId, workspaceId) {
    try {
        const response = await fetch(`${API_BASE_URL}/files/${fileId}/add-to-workspace`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ workspace_id: workspaceId })
        });

        if (response.ok) {
            return await response.json();
        }
        return { success: false };
    } catch (error) {
        console.error('Error adding file to workspace:', error);
        return { success: false };
    }
}

  // Enhanced file preview with actual file content
async function openFilePreview(fileId) {
    const files = await getAllFiles();
    const file = files.find(f => f.file_id === fileId);
    if (!file) return;

    const users = await getAllUsers();
    const owner = users.find(u => u.user_id === file.user_id) || { name: "Unknown" };
    const categories = await getAllCategories();
    const category = categories.find(c => c.category_id === file.category_id) || { name: "None" };

    let previewContent = '';
    let previewType = 'info';

    try {
        // Fetch actual file preview from server
        const response = await fetch(`${API_BASE_URL}/file-preview/${fileId}`);
        
        if (response.ok) {
            const contentType = response.headers.get('content-type');
            
            if (contentType && contentType.startsWith('image/')) {
                // Handle image preview
                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);
                previewContent = `<img src="${imageUrl}" alt="${file.original_name || file.name}" style="max-width:100%; max-height:400px; border-radius:8px;">`;
                previewType = 'image';
            } else if (contentType === 'application/pdf') {
                // Handle PDF preview
                const blob = await response.blob();
                const pdfUrl = URL.createObjectURL(blob);
                previewContent = `<embed src="${pdfUrl}" type="application/pdf" width="100%" height="500px" />`;
                previewType = 'pdf';
            } else if (contentType.includes('word') || contentType.includes('document')) {
                // Handle DOCX files - show text content
                const result = await response.json();
                if (result.type === 'text') {
                    previewContent = `<pre style="white-space: pre-wrap; font-family: inherit; margin: 0; color: var(--text); background: var(--bg); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">${result.content}</pre>`;
                    previewType = 'text';
                } else {
                    previewContent = `<div class="small-muted" style="text-align:center;padding:40px">Preview not available for DOCX files in this view</div>`;
                    previewType = 'unsupported';
                }
            } else {
                // Handle text content
                const result = await response.json();
                if (result.type === 'text') {
                    previewContent = `<pre style="white-space: pre-wrap; font-family: inherit; margin: 0; color: var(--text); background: var(--bg); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">${result.content}</pre>`;
                    previewType = 'text';
                } else {
                    previewContent = `<div class="small-muted" style="text-align:center;padding:40px">${result.message || 'Preview not available for this file type'}</div>`;
                    previewType = 'unsupported';
                }
            }
        } else {
            throw new Error('Preview not available');
        }
    } catch (error) {
        console.error('Preview error:', error);
        // Fallback to text sample or basic info
        if (file.text_sample) {
            previewContent = `<pre style="white-space: pre-wrap; font-family: inherit; margin: 0; color: var(--text); background: var(--bg); padding: 16px; border-radius: 8px; border: 1px solid var(--border);">${file.text_sample}</pre>`;
            previewType = 'text';
        } else {
            previewContent = `<div class="small-muted" style="text-align:center;padding:40px">
                Preview not available for this file.<br><br>
                File: ${file.original_name || file.name}<br>
                Type: ${file.type.toUpperCase()}<br>
                Size: ${(file.size / 1024) | 0} KB
            </div>`;
            previewType = 'info';
        }
    }

    openModal(`
        <div class="file-preview-header">
          <div style="display:flex;align-items:center;gap:12px">
            <div class="file-preview-icon">${fileIcon(file.original_name || file.name)}</div>
            <div>
              <h3 style="margin:0">${file.original_name || file.name}</h3>
              <div class="small-muted">${file.type.toUpperCase()}  ${(file.size / 1024) | 0} KB</div>
            </div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="icon-btn" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>
            
        <div class="file-preview-content">
          ${previewContent}
        </div>
            
        <div class="file-preview-meta">
    <div class="meta-item">
      <div class="meta-label">Owner</div>
      <div class="meta-value">${owner.name}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Uploaded</div>
      <div class="meta-value">${new Date(file.created_at).toLocaleString()}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">File Size</div>
      <div class="meta-value">${(file.size / 1024) | 0} KB</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">File Type</div>
      <div class="meta-value">${file.type.toUpperCase()}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Category</div>
      <div class="meta-value">${file.document_type || "Not categorized"}</div>
    </div>
    <div class="meta-item">
      <div class="meta-label">Status</div>
      <div class="meta-value">
        <span class="badge ${file.shared ? "badge-success" : ""}">
          ${file.shared ? "Shared" : "Private"}
        </span>
      </div>
    </div>
  </div>

        <div class="file-preview-actions">
          <button onclick="downloadFile(${file.file_id})">
            <i class="fa-solid fa-download"></i> Download
          </button>
          <button class="btn-secondary" onclick="toggleShare(${file.file_id}); closeModal();">
            ${file.shared ? '<i class="fa-solid fa-link-slash"></i> Unshare' : '<i class="fa-solid fa-link"></i> Share'}
          </button>
          <button class="btn-secondary" onclick="openAddToWorkspaceModal(${file.file_id}); closeModal();">
            <i class="fa-solid fa-layer-group"></i> Add to Workspace
          </button>
          <button class="btn-secondary" onclick="moveToArchive(${file.file_id}); closeModal();">
            <i class="fa-solid fa-box-archive"></i> Move to Archive
          </button>
        </div>
    `, "file-preview-modal");
}

// Enhanced archive function with confirmation
async function confirmArchiveFile(fileId) {
    console.log(`DEBUG: confirmArchiveFile called for file ${fileId}`);
    
    // Close modal immediately to prevent multiple clicks
    closeModal();
    
    try {
        showToast("Archiving file...", "info");
        
        const response = await fetch(`${API_BASE_URL}/files/${fileId}/archive`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();
        console.log(`DEBUG: Archive API response for file ${fileId}:`, result);
        
        if (result.success) {
            showToast("File archived successfully", "success");
            console.log(`DEBUG: File ${fileId} archived successfully, refreshing views...`);
            
            // Refresh ALL views immediately
            await refreshAllViews();
            console.log(`DEBUG: Views refreshed after archiving file ${fileId}`);
            
        } else {
            console.log(`DEBUG: Archive failed for file ${fileId}:`, result.error);
            showToast(result.error || "Failed to archive file", "error");
        }
    } catch (error) {
        console.error("Archive network error:", error);
        showToast("Network error while archiving file", "error");
    }
}

  // Workspace Management
 // Enhanced workspace creation - show all users including current user
async function openCreateWorkspace() {
    const users = await getAllUsers();
    const currentUser = await getCurrentUser();
    
    if (!users || !currentUser) return;

    // Show ALL users including current user
    const userOptions = users
        .map(u => `
            <div class="multi-select-option" data-id="${u.user_id}">
                <div class="member-avatar" style="width:24px;height:24px;font-size:10px">
                    ${u.name.split(" ").map(s => s[0]).slice(0, 2).join("").toUpperCase()}
                </div>
                <span>${u.name} ${u.user_id === currentUser.user_id ? '(You)' : ''} (${u.email})</span>
            </div>
        `).join("");

    openModal(`<h3>Create Workspace</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="form-row">
                <label>Workspace Name *</label>
                <input id="ws_name" placeholder="Enter workspace name" required/>
            </div>
            <div class="form-row">
                <label>Description</label>
                <textarea id="ws_desc" placeholder="Enter workspace description"></textarea>
            </div>
            <div class="form-row">
                <label>Add Members</label>
                <div class="multi-select-container">
                    <input id="ws_member_search" placeholder="Search users to add..." oninput="filterMemberOptions()"/>
                    <div class="multi-select-dropdown" id="memberDropdown">
                        ${userOptions}
                    </div>
                </div>
                <div class="multi-select-selected" id="selectedMembers">
                    <div class="selected-member" data-id="${currentUser.user_id}">
                        ${currentUser.name} (You)
                    </div>
                </div>
                <div class="small-muted">Click users above to add them as members. You are automatically included.</div>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
                <button onclick="modalCreateWorkspace()"><i class="fa-solid fa-check"></i> Create Workspace</button>
            </div>
        </div>`);

    // Initialize member selection
    document.getElementById("ws_member_search").addEventListener("focus", function() {
        document.getElementById("memberDropdown").classList.add("active");
    });

    document.querySelectorAll("#memberDropdown .multi-select-option").forEach(option => {
        option.addEventListener("click", function() {
            const memberId = this.getAttribute("data-id");
            addMemberToWorkspace(memberId);
        });
    });
}

function filterMemberOptions() {
    const search = document.getElementById("ws_member_search").value.toLowerCase();
    const options = document.querySelectorAll("#memberDropdown .multi-select-option");

    options.forEach(option => {
        const text = option.textContent.toLowerCase();
        if (text.includes(search)) {
            option.style.display = "flex";
        } else {
            option.style.display = "none";
        }
    });
}

function addMemberToWorkspace(memberId) {
    const users = getAllUsers().then(users => {
        const user = users.find(u => u.user_id == memberId);
        if (!user) return;

        const selectedContainer = document.getElementById("selectedMembers");
        const existing = selectedContainer.querySelector(`[data-id="${memberId}"]`);
        if (existing) return;

        const memberEl = document.createElement("div");
        memberEl.className = "selected-member";
        memberEl.setAttribute("data-id", memberId);
        memberEl.innerHTML = `
            ${user.name} ${user.user_id == (getCurrentUser().then(u => u.user_id) || user.user_id) ? '(You)' : ''}
            <button class="remove-member" onclick="removeMemberFromWorkspace('${memberId}')">
                <i class="fa-solid fa-xmark"></i>
            </button>
        `;
        selectedContainer.appendChild(memberEl);

        // Clear search and hide dropdown
        document.getElementById("ws_member_search").value = "";
        document.getElementById("memberDropdown").classList.remove("active");
    });
}

function removeMemberFromWorkspace(memberId) {
    const memberEl = document.querySelector(`.selected-member[data-id="${memberId}"]`);
    if (memberEl) {
        memberEl.remove();
    }
}

// Enhanced workspace creation function
async function modalCreateWorkspace() {
    const name = document.getElementById("ws_name").value.trim();
    const desc = document.getElementById("ws_desc").value.trim();
    
    if (!name) {
        showToast("Workspace name is required", "error");
        return;
    }

    const currentUser = await getCurrentUser();
    if (!currentUser) return;

    // Get selected members (includes current user automatically)
    const selectedMembers = Array.from(document.querySelectorAll(".selected-member"))
        .map(el => parseInt(el.getAttribute("data-id")));

    // Ensure current user is included
    if (!selectedMembers.includes(currentUser.user_id)) {
        selectedMembers.push(currentUser.user_id);
    }

    const workspaceData = {
        name: name,
        description: desc,
        user_id: currentUser.user_id,
        members: selectedMembers
    };

    console.log("Creating workspace with data:", workspaceData);

    const result = await createWorkspace(workspaceData);
    if (result && result.workspace_id) {
        showToast("Workspace created successfully", "success");
        closeModal();
        await renderWorkspaces();
        
        await logActivity({ 
            user_id: currentUser.user_id, 
            activity: `Created workspace: ${name}` 
        });
    } else {
        showToast("Failed to create workspace", "error");
    }
}

// Enhanced workspace editing - allow removing yourself
async function openEditWorkspace(workspaceId) {
    const workspaces = await getAllWorkspaces();
    const workspace = workspaces.find(w => w.workspace_id == workspaceId);
    if (!workspace) {
        showToast("Workspace not found", "error");
        return;
    }

    const users = await getAllUsers();
    const currentUser = await getCurrentUser();

    // Show ALL users including current user
    const userOptions = users
        .map(u => `
            <div class="multi-select-option" data-id="${u.user_id}">
                <div class="member-avatar" style="width:24px;height:24px;font-size:10px">
                    ${u.name.split(" ").map(s => s[0]).slice(0, 2).join("").toUpperCase()}
                </div>
                <span>${u.name} ${u.user_id === currentUser.user_id ? '(You)' : ''} (${u.email})</span>
            </div>
        `).join("");

    // Create selected members HTML - allow removing anyone including yourself
    const selectedMembersHTML = (workspace.members || [])
        .map(memberId => {
            const user = users.find(u => u.user_id == memberId);
            if (!user) return '';
            const isCurrentUser = user.user_id === currentUser.user_id;
            return `
                <div class="selected-member" data-id="${memberId}">
                    ${user.name}${isCurrentUser ? ' (You)' : ''}
                    <button class="remove-member" onclick="removeMemberFromEditWorkspace('${memberId}')">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            `;
        }).join("");

    openModal(`<h3>Edit Workspace</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="form-row">
                <label>Workspace Name *</label>
                <input id="ew_name" value="${workspace.name}" placeholder="Enter workspace name" required/>
            </div>
            <div class="form-row">
                <label>Description</label>
                <textarea id="ew_desc" placeholder="Enter workspace description">${workspace.description || ''}</textarea>
            </div>
            <div class="form-row">
                <label>Members</label>
                <div class="multi-select-container">
                    <input id="ew_member_search" placeholder="Search users to add..." oninput="filterEditMemberOptions()"/>
                    <div class="multi-select-dropdown" id="editMemberDropdown">
                        ${userOptions}
                    </div>
                </div>
                <div class="multi-select-selected" id="editSelectedMembers">
                    ${selectedMembersHTML}
                </div>
                <div class="small-muted">Click users above to add them as members. You can remove any member including yourself.</div>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
                <button onclick="modalSaveWorkspace(${workspaceId})"><i class="fa-solid fa-check"></i> Save Changes</button>
            </div>
        </div>`);

    // Initialize member selection for editing
    setTimeout(() => {
        const searchInput = document.getElementById("ew_member_search");
        const dropdown = document.getElementById("editMemberDropdown");

        if (searchInput) {
            searchInput.addEventListener("focus", function() {
                if (dropdown) {
                    dropdown.classList.add("active");
                }
            });
        }

        // Hide already selected members from dropdown
        const selectedMemberIds = workspace.members || [];
        document.querySelectorAll("#editMemberDropdown .multi-select-option").forEach(option => {
            const memberId = option.getAttribute("data-id");
            if (selectedMemberIds.includes(parseInt(memberId))) {
                option.style.display = "none";
            } else {
                option.style.display = "flex";
            }

            option.addEventListener("click", function(e) {
                e.stopPropagation();
                const memberId = this.getAttribute("data-id");
                addMemberToEditWorkspace(memberId);
            });
        });
    }, 100);
}

function filterEditMemberOptions() {
    const search = document.getElementById("ew_member_search").value.toLowerCase();
    const options = document.querySelectorAll("#editMemberDropdown .multi-select-option");

    // Get already selected member IDs
    const selectedMemberIds = Array.from(
        document.querySelectorAll("#editSelectedMembers .selected-member")
    ).map(el => el.getAttribute("data-id"));

    options.forEach(option => {
        const memberId = option.getAttribute("data-id");
        const isSelected = selectedMemberIds.includes(memberId);

        // If already selected, keep it hidden
        if (isSelected) {
            option.style.display = "none";
            return;
        }

        // Otherwise, filter by search
        const text = option.textContent.toLowerCase();
        if (text.includes(search)) {
            option.style.display = "flex";
        } else {
            option.style.display = "none";
        }
    });
}

function addMemberToEditWorkspace(memberId) {
    const users = getAllUsers().then(users => {
        const user = users.find(u => u.user_id == memberId);
        if (!user) return;

        const selectedContainer = document.getElementById("editSelectedMembers");
        if (!selectedContainer) return;

        const existing = selectedContainer.querySelector(`[data-id="${memberId}"]`);
        if (existing) return;

        const currentUser = getCurrentUser().then(currentUser => {
            const memberEl = document.createElement("div");
            memberEl.className = "selected-member";
            memberEl.setAttribute("data-id", memberId);
            memberEl.innerHTML = `
                ${user.name} ${user.user_id === currentUser.user_id ? '(You)' : ''}
                <button class="remove-member" onclick="removeMemberFromEditWorkspace('${memberId}')">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            `;
            selectedContainer.appendChild(memberEl);

            // Hide the option from dropdown
            const option = document.querySelector(
                `#editMemberDropdown .multi-select-option[data-id="${memberId}"]`
            );
            if (option) {
                option.style.display = "none";
            }

            const searchInput = document.getElementById("ew_member_search");
            if (searchInput) {
                searchInput.value = "";
            }
            const dropdown = document.getElementById("editMemberDropdown");
            if (dropdown) {
                dropdown.classList.remove("active");
            }
        });
    });
}

function removeMemberFromEditWorkspace(memberId) {
    const memberEl = document.querySelector(
        `#editSelectedMembers .selected-member[data-id="${memberId}"]`
    );
    if (memberEl) {
        memberEl.remove();
    }

    // Show the option back in dropdown
    const option = document.querySelector(
        `#editMemberDropdown .multi-select-option[data-id="${memberId}"]`
    );
    if (option) {
        option.style.display = "flex";
    }
}

// Enhanced workspace saving
async function modalSaveWorkspace(workspaceId) {
    const name = document.getElementById("ew_name").value.trim();
    
    if (!name) {
        showToast("Workspace name is required", "error");
        return;
    }

    const desc = document.getElementById("ew_desc").value.trim();
    
    // Get selected members as integers
    const selectedMembers = Array.from(document.querySelectorAll("#editSelectedMembers .selected-member"))
        .map(el => parseInt(el.getAttribute("data-id")));

    console.log("DEBUG: Saving workspace with members:", selectedMembers);

    const workspaceData = {
        name: name,
        description: desc,
        members: selectedMembers  // Send as array of integers
    };

    const result = await updateWorkspace(workspaceId, workspaceData);
    if (result && result.success) {
        showToast("Workspace updated successfully", "success");
        closeModal();
        
        // Refresh views
        await renderWorkspaces();
        if (currentView === "workspace-detail" && currentWorkspaceId == workspaceId) {
            await renderWorkspaceDetail();
        }
        
        const currentUser = await getCurrentUser();
        await logActivity({ 
            user_id: currentUser.user_id, 
            activity: `Updated workspace: ${name}` 
        });
    } else {
        showToast("Failed to update workspace", "error");
    }
}
// Enhanced delete workspace with confirmation
async function deleteWorkspace(workspaceId) {
    const workspaces = await getAllWorkspaces();
    const workspace = workspaces.find(w => w.workspace_id == workspaceId);
    
    if (!workspace) {
        showToast("Workspace not found", "error");
        return;
    }

    openModal(`<h3>Delete Workspace</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="danger">
                <i class="fa-solid fa-exclamation-triangle"></i> 
                <strong>Warning:</strong> This action cannot be undone.
            </div>
            <div class="small-muted">
                Are you sure you want to delete the workspace <strong>"${workspace.name}"</strong>?
            </div>
            <div class="small-muted">
                All files in this workspace will be moved to your personal library.
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i> Cancel
                </button>
                <button class="btn-danger" onclick="executeDeleteWorkspace(${workspaceId})">
                    <i class="fa-solid fa-trash"></i> Delete Workspace
                </button>
            </div>
        </div>`);
}

async function executeDeleteWorkspace(workspaceId) {
    try {
        closeModal();
        showToast("Deleting workspace...", "info");
        
        const result = await deleteWorkspaceAPI(workspaceId);
        if (result && result.success) {
            showToast("Workspace deleted successfully", "success");
            
            const currentUser = await getCurrentUser();
            const workspaces = await getAllWorkspaces();
            const workspace = workspaces.find(w => w.workspace_id == workspaceId);
            
            if (currentUser && workspace) {
                await logActivity({ 
                    user_id: currentUser.user_id, 
                    activity: `Deleted workspace: ${workspace.name}` 
                });
            }
            
            // Navigate back to workspaces list
            if (currentView === "workspace-detail" && currentWorkspaceId === workspaceId) {
                goToWorkspaces();
            } else {
                await renderWorkspaces();
            }
        } else {
            showToast("Failed to delete workspace", "error");
        }
    } catch (error) {
        console.error("Delete workspace error:", error);
        showToast("Error deleting workspace", "error");
    }
}

async function renderWorkspaces() {
    const list = document.getElementById("workspacesList");
    list.innerHTML = "";
    
    console.log(" DEBUG: Starting renderWorkspaces");
    
    const workspaces = await getAllWorkspaces();
    const users = await getAllUsers();

    if (!workspaces || workspaces.length === 0) {
      list.innerHTML = '<div class="card small-muted" style="text-align:center;padding:40px">No workspaces yet</div>';
      return;
    }

    console.log(` DEBUG: Rendering ${workspaces.length} workspaces`);

    for (const w of workspaces) {
      // Get member details
      const memberDetails = await Promise.all(
        (w.members || []).map(async memberId => {
          const user = users.find(u => u.user_id == memberId);
          if (!user) return null;
          return {
            id: user.user_id,
            name: user.name,
            initials: user.name.split(" ").map(s => s[0]).slice(0, 2).join("").toUpperCase()
          };
        })
      ).then(results => results.filter(Boolean));

      // Get files for this workspace using the NEW method
      const workspaceFiles = await getWorkspaceFiles(w.workspace_id);
      console.log(` DEBUG: Workspace ${w.workspace_id} has ${workspaceFiles.length} files`);

      const card = document.createElement("div");
      card.className = "workspace-card";
      card.setAttribute("data-workspace-id", w.workspace_id);
      card.style.marginBottom = "16px";
      card.onclick = () => openWorkspace(w.workspace_id);
      card.innerHTML = `
        <div class="workspace-header" style="align-items:stretch;min-height:160px">
          <div style="flex:1;display:flex;flex-direction:column;justify-content:space-between">
            <div>
              <div style="font-weight:600;font-size:18px;margin-bottom:4px;color:var(--text)">${w.name}</div>
              <div class="small-muted" style="margin-bottom:12px">${w.description || "No description provided"}</div>
            </div>
            <div>
              <div class="workspace-meta">
                <div class="meta-item"><i class="fa-solid fa-file"></i> ${workspaceFiles.length} files</div>
                <div class="meta-item"><i class="fa-solid fa-user"></i> ${memberDetails.length} members</div>
                <div class="meta-item"><i class="fa-solid fa-calendar"></i> ${new Date(w.created_at).toLocaleDateString()}</div>
              </div>
              ${memberDetails.length > 0 ? `
                <div class="member-grid" style="margin-top:12px">
                  ${memberDetails.slice(0, 5).map(m => `
                    <div class="member-avatar" title="${m.name}">${m.initials}</div>
                  `).join("")}
                  ${memberDetails.length > 5 ? `<div class="member-more" title="${memberDetails.length - 5} more members">+${memberDetails.length - 5}</div>` : ""}
                </div>
              ` : ""}
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center">
            <div class="workspace-icon">
              <i class="fa-solid fa-layer-group"></i>
            </div>
            <button style="width:48px;height:48px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:12px" onclick="event.stopPropagation(); openEditWorkspace(${w.workspace_id})" title="Edit"><i class="fa-solid fa-pen"></i></button>
            <button class="btn-danger" style="width:48px;height:48px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:12px" onclick="event.stopPropagation(); deleteWorkspace(${w.workspace_id})" title="Delete"><i class="fa-solid fa-trash"></i></button>
          </div>
        </div>
      `;
      list.appendChild(card);
    }
    
    console.log(" DEBUG: Finished renderWorkspaces");
}

  async function openWorkspace(id) {
    currentWorkspaceId = id;
    currentView = "workspace-detail";
    renderCurrentView();
  }

 async function renderWorkspaceDetail() {
    const container = document.getElementById("workspace-detail");
    if (!currentWorkspaceId) return;

    console.log(` DEBUG: Rendering workspace detail for workspace ${currentWorkspaceId}`);

    const workspaces = await getAllWorkspaces();
    const workspace = workspaces.find(w => w.workspace_id == currentWorkspaceId);
    if (!workspace) return;

    // Get files for this workspace using the NEW method
    const workspaceFiles = await getWorkspaceFiles(currentWorkspaceId);
    const users = await getAllUsers();

    console.log(` DEBUG: Workspace ${currentWorkspaceId} has ${workspaceFiles.length} files`);

    const memberDetails = await Promise.all(
      (workspace.members || []).map(async memberId => {
        const user = users.find(u => u.user_id == memberId);
        if (!user) return null;
        return {
          id: user.user_id,
          name: user.name,
          initials: user.name.split(" ").map(s => s[0]).slice(0, 2).join("").toUpperCase()
        };
      })
    ).then(results => results.filter(Boolean));

    container.innerHTML = `
      <div class="workspace-detail-header">
        <div class="workspace-detail-back">
          <button class="back-button" onclick="goToWorkspaces()">
            <i class="fa-solid fa-arrow-left"></i> Back to Workspaces
          </button>
        </div>
        <div class="workspace-detail-main">
          <div class="workspace-detail-info">
            <div class="workspace-detail-icon">
              <i class="fa-solid fa-layer-group"></i>
            </div>
            <div class="workspace-detail-content">
              <div>
                <h2>${workspace.name}</h2>
                <div class="small-muted">${workspace.description || "No description provided"}</div>
              </div>
              <div class="workspace-detail-bottom">
                <div class="workspace-meta">
                  <div class="meta-item"><i class="fa-solid fa-file"></i> ${workspaceFiles.length} files</div>
                  <div class="meta-item"><i class="fa-solid fa-user"></i> ${memberDetails.length} members</div>
                  <div class="meta-item"><i class="fa-solid fa-calendar"></i> ${new Date(workspace.created_at).toLocaleDateString()}</div>
                </div>
                ${memberDetails.length > 0 ? `
                  <div class="member-grid">
                    ${memberDetails.slice(0, 5).map(m => `
                      <div class="member-avatar" title="${m.name}">${m.initials}</div>
                    `).join("")}
                    ${memberDetails.length > 5 ? `<div class="member-more" title="${memberDetails.length - 5} more members">+${memberDetails.length - 5}</div>` : ""}
                  </div>
                ` : ""}
              </div>
            </div>
          </div>
          <div class="workspace-detail-actions">
            <button onclick="openEditWorkspace(${workspace.workspace_id})" title="Edit"><i class="fa-solid fa-pen"></i></button>
            <button onclick="openAddFileModal()" title="Add Files"><i class="fa-solid fa-plus"></i></button>
            <button class="btn-danger" onclick="deleteWorkspace(${workspace.workspace_id}); goToWorkspaces();" title="Delete"><i class="fa-solid fa-trash"></i></button>
          </div>
        </div>
      </div>
      
      <div class="toolbar">
        <input placeholder="Search files in this workspace..." id="workspaceFileSearch" oninput="searchWorkspaceFiles()" style="max-width:300px"/>
        <select id="sortWorkspaceFiles" onchange="renderWorkspaceFiles()">
          <option value="new">Sort: Newest</option>
          <option value="old">Sort: Oldest</option>
          <option value="name">Sort: Name</option>
        </select>
        <div style="flex:1"></div>
        <button class="btn-secondary" onclick="archiveSelectedWorkspaceFiles()"><i class="fa-solid fa-box-archive"></i> Move to Archive</button>
      </div>
      
      <div id="workspaceFilesGrid" class="grid"></div>
    `;

    renderWorkspaceFiles();
    console.log(" DEBUG: Finished renderWorkspaceDetail");
}

function goToWorkspaces() {
    currentView = "workspaces";
    currentWorkspaceId = null;
    
    // Save current view to localStorage
    localStorage.setItem('dms_current_view', 'workspaces');
    
    renderCurrentView();
}

// Replace the renderWorkspaceFiles function
async function renderWorkspaceFiles() {
    const grid = document.getElementById("workspaceFilesGrid");
    if (!grid) return;

    grid.innerHTML = "";
    
    console.log(` DEBUG: Rendering workspace files for workspace ${currentWorkspaceId}`);
    
    // Get files specifically for this workspace using the NEW endpoint
    const files = await getWorkspaceFiles(currentWorkspaceId);
    
    console.log(` DEBUG: Found ${files.length} files for workspace ${currentWorkspaceId}`, files);

    const search = document.getElementById("workspaceFileSearch")?.value.trim().toLowerCase() || "";
    const sort = document.getElementById("sortWorkspaceFiles")?.value || "new";

    let filteredFiles = files || [];
    if (search) {
      filteredFiles = filteredFiles.filter(f => f.name.toLowerCase().includes(search));
    }
    
    if (sort === "new") filteredFiles.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    if (sort === "old") filteredFiles.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    if (sort === "name") filteredFiles.sort((a, b) => a.name.localeCompare(b.name));

    if (!filteredFiles.length) {
      grid.innerHTML = '<div class="card small-muted" style="text-align:center;padding:40px">No files in this workspace yet</div>';
      return;
    }

    for (const f of filteredFiles) {
      const div = document.createElement("div");
      div.className = "doc-adaptive";
      div.setAttribute("data-file-id", f.file_id);
      div.onclick = () => openFilePreview(f.file_id);
      div.innerHTML = `
        <div class="doc-header">
          <div class="doc-icon">${fileIcon(f.name)}</div>
          <div class="doc-info">
            <div class="doc-name">${f.name}</div>
            <div class="doc-meta">${(f.size / 1024) | 0} KB  ${new Date(f.created_at).toLocaleString()}</div>
          </div>
        </div>
        <div class="doc-actions">
          <button class="icon-btn" onclick="event.stopPropagation(); toggleShare(${f.file_id})">
            ${f.shared ? '<i class="fa-solid fa-link"></i>' : '<i class="fa-regular fa-circle"></i>'}
          </button>
          <button class="icon-btn" onclick="event.stopPropagation(); downloadFile(${f.file_id})">
            <i class="fa-solid fa-download"></i>
          </button>
          <button class="icon-btn" title="Archive" onclick="event.stopPropagation(); moveToArchive(${f.file_id})">
            <i class="fa-solid fa-box-archive"></i>
          </button>
        </div>
      `;
      grid.appendChild(div);
    }
    
    console.log(" DEBUG: Finished renderWorkspaceFiles");
}

// Add this function if it doesn't exist
async function getWorkspaceFiles(workspaceId) {
    try {
        console.log(` DEBUG: Getting files for workspace ${workspaceId}`);
        const response = await fetch(`${API_BASE_URL}/workspaces/${workspaceId}/files`);
        if (response.ok) {
            const files = await response.json();
            console.log(` DEBUG: Got ${files.length} files for workspace ${workspaceId}`);
            return files;
        } else {
            console.log(` DEBUG: Failed to get files for workspace ${workspaceId}`);
            return [];
        }
    } catch (error) {
        console.error('Error getting workspace files:', error);
        return [];
    }
}

  function searchWorkspaceFiles() {
    renderWorkspaceFiles();
  }

  function archiveSelectedWorkspaceFiles() {
    showToast("Select UI not implemented in prototype  use action per-file");
  }

  // Enhanced delete workspace with confirmation
async function deleteWorkspace(workspaceId) {
    const workspaces = await getAllWorkspaces();
    const workspace = workspaces.find(w => w.workspace_id == workspaceId);
    
    if (!workspace) {
        showToast("Workspace not found", "error");
        return;
    }

    openModal(`<h3>Delete Workspace</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="danger">
                <i class="fa-solid fa-exclamation-triangle"></i> 
                <strong>Warning:</strong> This action cannot be undone.
            </div>
            <div class="small-muted">
                Are you sure you want to delete the workspace <strong>"${workspace.name}"</strong>?
            </div>
            <div class="small-muted">
                All files in this workspace will be moved to your personal library.
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i> Cancel
                </button>
                <button class="btn-danger" onclick="executeDeleteWorkspace(${workspaceId})">
                    <i class="fa-solid fa-trash"></i> Delete Workspace
                </button>
            </div>
        </div>`);
}

async function executeDeleteWorkspace(workspaceId) {
    try {
        closeModal();
        showToast("Deleting workspace...", "info");
        
        const result = await deleteWorkspaceAPI(workspaceId);
        if (result && result.success) {
            showToast("Workspace deleted successfully", "success");
            
            const currentUser = await getCurrentUser();
            const workspaces = await getAllWorkspaces();
            const workspace = workspaces.find(w => w.workspace_id == workspaceId);
            
            if (currentUser && workspace) {
                await logActivity({ 
                    user_id: currentUser.user_id, 
                    activity: `Deleted workspace: ${workspace.name}` 
                });
            }
            
            // Navigate back to workspaces list
            if (currentView === "workspace-detail" && currentWorkspaceId === workspaceId) {
                goToWorkspaces();
            } else {
                await renderWorkspaces();
            }
        } else {
            showToast("Failed to delete workspace", "error");
        }
    } catch (error) {
        console.error("Delete workspace error:", error);
        showToast("Error deleting workspace", "error");
    }
}

  // User Management
async function renderUsers() {
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";
  
  const users = await getAllUsers();
  const departments = await getAllDepartments();
  const filterRole = document.getElementById("filterUserRole").value;
  const currentUser = await getCurrentUser();
  
  let filteredUsers = users || [];
  
  if (filterRole) {
    filteredUsers = filteredUsers.filter(u => u.role === filterRole);
  }
  
  // Remove duplicates by user_id to prevent doubling
  const uniqueUsers = [];
  const seenUserIds = new Set();
  
  filteredUsers.forEach(user => {
    if (!seenUserIds.has(user.user_id)) {
      seenUserIds.add(user.user_id);
      uniqueUsers.push(user);
    }
  });
  
  // Sort users by user_id to get proper sequential order
  uniqueUsers.sort((a, b) => a.user_id - b.user_id);
  
  if (!uniqueUsers.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="small-muted" style="text-align:center;padding:20px">No users found</td></tr>';
    return;
  }
  
  // Get the maximum existing user_id to determine next ID
  const maxUserId = Math.max(...uniqueUsers.map(u => u.user_id));
  
  uniqueUsers.forEach((u, i) => {
    const dept = departments.find(d => d.department_id === u.department_id) || { name: "Not assigned" };
    const tr = document.createElement("tr");
    tr.setAttribute("data-user-id", u.user_id);
    tr.innerHTML = `
      <td>${u.user_id}</td> <!-- Use actual user_id instead of array index -->
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent-dark));display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:12px">
            ${u.name.split(" ").map((s) => s[0]).slice(0, 2).join("").toUpperCase()}
          </div>
          <span style="color:var(--text)">${u.name}</span>
        </div>
      </td>
      <td style="color:var(--text)">${u.email}</td>
      <td style="text-align:center"><span class="badge ${u.role === "admin" ? "badge-warning" : ""}">${u.role === "admin" ? "Admin" : "Staff"}</span></td>
      <td style="text-align:center"><span class="badge">${dept.name}</span></td>
      <td style="text-align:center"><span class="badge ${u.status === "active" ? "badge-success" : u.status === "archived" ? "badge-warning" : "badge-danger"}">${u.status === "archived" ? "Archived" : u.status === "active" ? "Active" : "Inactive"}</span></td>
      <td style="text-align:center">
        <div style="display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;width:100%">
          <button onclick="openEditUser(${u.user_id})" style="width:90px;padding:6px 12px;font-size:13px;display:flex;align-items:center;justify-content:center;gap:6px"><i class="fa-solid fa-pen"></i> Edit</button>
          ${u.user_id !== currentUser.user_id ? `
            <button class="btn-danger" onclick="openDeleteUser(${u.user_id})" style="width:90px;padding:6px 12px;font-size:13px;display:flex;align-items:center;justify-content:center;gap:6px">
              <i class="fa-solid fa-trash"></i> Delete
            </button>
          ` : `
            <button class="btn-secondary" disabled style="width:90px;padding:6px 12px;font-size:13px;display:flex;align-items:center;justify-content:center;gap:6px">
              <i class="fa-solid fa-user"></i> Current
            </button>
          `}
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Add user deletion function
async function deleteUserAPI(userId) {
  return await apiCall(`/users/${userId}`, {
    method: 'DELETE'
  });
}

// Open delete confirmation modal
async function openDeleteUser(userId) {
  const user = await apiCall(`/users/${userId}`);
  if (!user) {
    showToast("User not found", "error");
    return;
  }

  const currentUser = await getCurrentUser();
  if (user.user_id === currentUser.user_id) {
    showToast("You cannot delete your own account", "error");
    return;
  }

  openModal(`<h3>Delete User</h3>
    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="danger">
        <i class="fa-solid fa-exclamation-triangle"></i> 
        <strong>Warning:</strong> This action cannot be undone.
      </div>
      <div class="small-muted">
        Are you sure you want to delete user <strong>${user.name}</strong> (${user.email})?
      </div>
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
        <button class="btn-danger" onclick="confirmDeleteUser(${userId}, '${user.name.replace(/'/g, "\\'")}')">
          <i class="fa-solid fa-trash"></i> Delete User
        </button>
      </div>
    </div>`);
}

// Confirm and execute user deletion
async function confirmDeleteUser(userId, userName) {
  const result = await deleteUserAPI(userId);
  if (result && result.success) {
    showToast(`User "${userName}" deleted successfully`, "success");
    closeModal();
    await renderUsers();
    await refreshStats();
    
    const currentUser = await getCurrentUser();
    if (currentUser) {
      await logActivity({ 
        user_id: currentUser.user_id, 
        activity: `Deleted user: ${userName}` 
      });
    }
  } else {
    showToast("Failed to delete user", "error");
  }
}

// Update the openEditUser function to handle department validation properly
async function openEditUser(userId) {
  const user = await apiCall(`/users/${userId}`);
  const departments = await getAllDepartments();
  
  if (!user) {
    showToast("User not found", "error");
    return;
  }

  const deptOptions = departments.map(d => 
    `<option value="${d.department_id}" ${d.department_id == user.department_id ? "selected" : ""}>${d.name}</option>`
  ).join("");

  openModal(`<h3>Edit User</h3>
    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="form-row">
        <label>Full Name</label>
        <input id="eu_name" value="${user.name}"/>
      </div>
      <div class="form-row">
        <label>Email</label>
        <input id="eu_email" value="${user.email}" type="email"/>
      </div>
      <div class="form-row">
        <label>Role</label>
        <select id="eu_role">
          <option value="staff" ${user.role === "staff" ? "selected" : ""}>Staff</option>
          <option value="admin" ${user.role === "admin" ? "selected" : ""}>Admin</option>
        </select>
      </div>
      <div class="form-row">
        <label>Department</label>
        <select id="eu_dept">
          <option value="">Select Department</option>
          ${deptOptions}
        </select>
      </div>
      <div class="form-row">
        <label>Status</label>
        <select id="eu_status">
          <option value="active" ${user.status === "active" ? "selected" : ""}>Active</option>
          <option value="inactive" ${user.status === "inactive" ? "selected" : ""}>Inactive</option>
          <option value="archived" ${user.status === "archived" ? "selected" : ""}>Archived</option>
        </select>
      </div>
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
        <button onclick="modalSaveUser(${userId})"><i class="fa-solid fa-check"></i> Save</button>
      </div>
    </div>`);
}

// Update the modalSaveUser function
async function modalSaveUser(userId) {
  const name = document.getElementById("eu_name").value.trim();
  const email = document.getElementById("eu_email").value.trim();
  const role = document.getElementById("eu_role").value;
  const departmentId = document.getElementById("eu_dept").value;
  const status = document.getElementById("eu_status").value;

  if (!name || !email || !departmentId) {
    showToast("Please fill all required fields", "error");
    return;
  }

  if (departmentId === "") {
    showToast("Please select a department", "error");
    return;
  }

  const updateData = {
    name: name,
    email: email,
    role: role,
    department_id: departmentId,
    status: status
  };

  const result = await updateUser(userId, updateData);
  if (result && result.success) {
    showToast("User updated successfully", "success");
    closeModal();
    await renderUsers();
    
    const currentUser = await getCurrentUser();
    if (currentUser) {
      await logActivity({ 
        user_id: currentUser.user_id, 
        activity: `Updated user: ${name}` 
      });
    }
  } else {
    showToast("Failed to update user", "error");
  }
}

// Update the openAddUser function to include password confirmation
async function openAddUser() {
  const departments = await getAllDepartments();
  const deptOptions = departments.map(d => `<option value="${d.department_id}">${d.name}</option>`).join("");

  openModal(`<h3>Add User</h3>
    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="form-row">
        <label>Full Name</label>
        <input id="mu_name" placeholder="Full name"/>
      </div>
      <div class="form-row">
        <label>Email</label>
        <input id="mu_email" placeholder="Email" type="email"/>
      </div>
      <div class="form-row">
        <label>Password</label>
        <input id="mu_pass" placeholder="Password" type="password"/>
      </div>
      <div class="form-row">
        <label>Confirm Password</label>
        <input id="mu_pass_confirm" placeholder="Confirm password" type="password"/>
      </div>
      <div class="form-row">
        <label>Role</label>
        <select id="mu_role">
          <option value="staff">Staff</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="form-row">
        <label>Department</label>
        <select id="mu_dept">
          <option value="">Select Department</option>
          ${deptOptions}
        </select>
      </div>
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
        <button onclick="modalAddUser()"><i class="fa-solid fa-check"></i> Save</button>
      </div>
    </div>`);
}

// Update the modalAddUser function with password confirmation
async function modalAddUser() {
  const name = document.getElementById("mu_name").value.trim();
  const email = document.getElementById("mu_email").value.trim();
  const password = document.getElementById("mu_pass").value;
  const passwordConfirm = document.getElementById("mu_pass_confirm").value;
  const role = document.getElementById("mu_role").value;
  const departmentId = document.getElementById("mu_dept").value;

  if (!name || !email || !password || !departmentId) {
    showToast("Please fill all required fields", "error");
    return;
  }

  if (departmentId === "") {
    showToast("Please select a department", "error");
    return;
  }

  if (password !== passwordConfirm) {
    showToast("Passwords do not match", "error");
    return;
  }

  if (password.length < 6) {
    showToast("Password must be at least 6 characters long", "error");
    return;
  }

  const userData = {
    name: name,
    email: email,
    password: password,
    role: role,
    department_id: departmentId
  };

  const result = await createUser(userData);
  if (result && result.user_id) {
    showToast("User created successfully", "success");
    closeModal();
    await renderUsers();
    await refreshStats();
    
    const currentUser = await getCurrentUser();
    if (currentUser) {
      await logActivity({ 
        user_id: currentUser.user_id, 
        activity: `Added user: ${name}` 
      });
    }
  } else {
    showToast("Failed to create user", "error");
  }
}

  // Department Management (already working)
  async function openAddDepartment() {
    openModal(`<h3>Add Department</h3>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="form-row">
          <label>Department name</label>
          <input id="d_name" placeholder="Department name"/>
        </div>
        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
          <button onclick="modalAddDept()"><i class="fa-solid fa-check"></i> Save</button>
        </div>
      </div>`);
  }

  async function modalAddDept() {
    const name = document.getElementById("d_name").value.trim();
    if (!name) {
      showToast("Enter department name", "error");
      return;
    }

    const currentUser = await getCurrentUser();
    if (!currentUser) {
      showToast("User not found", "error");
      return;
    }

    const result = await createDepartment({ name: name, user_id: currentUser.user_id });
    if (result && result.department_id) {
      showToast("Department added successfully", "success");
      closeModal();
      await renderDepartments();
      await logActivity({ user_id: currentUser.user_id, activity: `Added department: ${name}` });
    }
  }

  async function renderDepartments() {
    const out = document.getElementById("departmentsList");
    const departments = await getAllDepartments();
    
    out.innerHTML = "";
    
    if (!departments || departments.length === 0) {
      out.innerHTML = '<div class="card small-muted" style="text-align:center;padding:40px">No departments</div>';
      return;
    }
    
    departments.forEach((d) => {
      const card = document.createElement("div");
      card.className = "card";
      card.style.marginBottom = "12px";
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:40px;height:40px;border-radius:8px;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center">
              <i class="fa-solid fa-users-rectangle"></i>
            </div>
            <div>
              <div style="font-weight:600;color:var(--text)">${d.name}</div>
              <div class="small-muted">Department ID: ${d.department_id}</div>
            </div>
          </div>
          <button class="btn-danger" onclick="deleteDepartment(${d.department_id}, '${d.name.replace(/'/g, "\\'")}')">
            <i class="fa-solid fa-trash"></i> Delete
          </button>
        </div>
      `;
      out.appendChild(card);
    });
  }

  async function deleteDepartment(departmentId, departmentName) {
    if (!confirm(`Are you sure you want to delete department "${departmentName}"? This action cannot be undone.`)) {
      return;
    }

    const result = await deleteDepartmentAPI(departmentId);
    if (result) {
      showToast(`Department "${departmentName}" deleted successfully`, "success");
      
      const currentUser = await getCurrentUser();
      if (currentUser) {
        await logActivity({ user_id: currentUser.user_id, activity: `Deleted department: ${departmentName}` });
      }
      
      await renderDepartments();
    } else {
      showToast("Failed to delete department", "error");
    }
  }

  // Category Management
  async function openAddCategory() {
    openModal(`<h3>Add Category</h3>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="form-row">
          <label>Category Name</label>
          <input id="c_name" placeholder="Category name"/>
        </div>
        <div class="form-row">
          <label>Description</label>
          <textarea id="c_desc" placeholder="Description (optional)"></textarea>
        </div>
        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
          <button onclick="modalAddCat()"><i class="fa-solid fa-check"></i> Save</button>
        </div>
      </div>`);
  }

  async function modalAddCat() {
    const name = document.getElementById("c_name").value.trim();
    const desc = document.getElementById("c_desc").value.trim();

    if (!name) {
      showToast("Category name is required", "error");
      return;
    }

    const categoryData = {
      name: name,
      description: desc || null,
      auto_created: false,
      is_unclassified: false
    };

    const result = await createCategory(categoryData);
    if (result && result.category_id) {
      showToast("Category added successfully", "success");
      closeModal();
      await renderCategories();
      
      const currentUser = await getCurrentUser();
      if (currentUser) {
        await logActivity({ 
          user_id: currentUser.user_id, 
          activity: `Added category: ${name}` 
        });
      }
    }
  }

async function renderCategories() {
    const out = document.getElementById("categoriesList");
    let categories = await getAllCategories();
    const files = await getAllFiles();
    
    categories = categories || [];
    
    categories.sort((a, b) => {
        const nameA = a.name.toLowerCase();
        const nameB = b.name.toLowerCase();
        return categoriesSortOrder === "asc" ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
    });

    out.innerHTML = "";
    
    if (!categories.length) {
        out.innerHTML = '<div class="card small-muted" style="text-align:center;padding:40px">No categories</div>';
        return;
    }
    
    for (const c of categories) {
        // Get files that belong to this category by category_id OR by document_type matching category name
        const categoryFiles = files.filter(f => 
            f.status === 'active' && 
            (f.category_id === c.category_id || 
             (f.document_type && f.document_type.toLowerCase() === c.name.toLowerCase()))
        );
        
        const fileCount = categoryFiles.length;

        const card = document.createElement("div");
        card.className = "card";
        if (c.is_unclassified) {
            card.classList.add("category-unclassified");
        }
        card.style.marginBottom = "12px";

        card.innerHTML = `
            <div class="category-header" style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
                <div style="display:flex;align-items:center;gap:12px;flex:1;">
                    <div style="width:40px;height:40px;border-radius:8px;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center">
                        <i class="fa-solid fa-list"></i>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;color:var(--text)">${c.name}</div>
                        <div class="small-muted">${c.description || "No description"}  ${fileCount} file${fileCount !== 1 ? "s" : ""}</div>
                    </div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <i class="fa-solid fa-chevron-down category-arrow" style="transition: transform 0.3s ease;color:var(--text-muted);margin-right:16px;"></i>
                    <button onclick="event.stopPropagation(); openEditCategory(${c.category_id})"><i class="fa-solid fa-pen"></i> Edit</button>
                </div>
            </div>
            <div class="category-files" style="display:none;margin-top:16px;border-top:1px solid var(--border);padding-top:16px;">
                ${fileCount > 0 ? categoryFiles.map(f => `
                    <div class="doc-adaptive" style="margin-bottom:8px;" onclick="openFilePreview(${f.file_id})">
                        <div class="doc-header">
                            <div class="doc-icon">${fileIcon(f.name)}</div>
                            <div class="doc-info">
                                <div class="doc-name">${f.name}</div>
                                <div class="doc-meta">
                                    ${f.type.toUpperCase()}  
                                    ${(f.size / 1024) | 0} KB  
                                    ${new Date(f.created_at).toLocaleString()}
                                </div>
                            </div>
                        </div>
                        <div class="doc-actions">
                            <button class="icon-btn" onclick="event.stopPropagation(); downloadFile(${f.file_id})">
                                <i class="fa-solid fa-download"></i>
                            </button>
                            <button class="icon-btn" title="Archive" onclick="event.stopPropagation(); moveToArchive(${f.file_id})">
                                <i class="fa-solid fa-box-archive"></i>
                            </button>
                        </div>
                    </div>
                `).join("") : '<div class="small-muted" style="text-align:center;padding:20px;">No files in this category</div>'}
            </div>
        `;

        const header = card.querySelector(".category-header");
        const filesSection = card.querySelector(".category-files");
        const arrow = card.querySelector(".category-arrow");

        header.addEventListener("click", (e) => {
            if (e.target.closest("button")) return;
            const isExpanded = filesSection.style.display === "block";
            filesSection.style.display = isExpanded ? "none" : "block";
            arrow.style.transform = isExpanded ? "rotate(0deg)" : "rotate(180deg)";
        });

        out.appendChild(card);
    }
}

  async function openEditCategory(categoryId) {
    const categories = await getAllCategories();
    const category = categories.find(c => c.category_id == categoryId);

    if (!category) {
      showToast("Category not found", "error");
      return;
    }

    openModal(`<h3>Edit Category</h3>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="form-row">
          <label>Category Name</label>
          <input id="editCatName" value="${category.name}" placeholder="Category name"/>
        </div>
        <div class="form-row">
          <label>Description</label>
          <textarea id="editCatDesc" placeholder="Description (optional)">${category.description || ""}</textarea>
        </div>
        ${category.auto_created ? `
          <div class="small-muted" style="color:var(--warning);background:var(--accent-light);padding:8px 12px;border-radius:8px;">
            <i class="fa-solid fa-robot"></i> Auto-classified
          </div>
        ` : ""}
        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button class="btn-secondary" onclick="closeModal()"><i class="fa-solid fa-xmark"></i> Cancel</button>
          <button onclick="saveEditedCategory(${categoryId})"><i class="fa-solid fa-check"></i> Save Changes</button>
        </div>
      </div>`);
  }

  async function saveEditedCategory(categoryId) {
    const name = document.getElementById("editCatName").value.trim();
    const desc = document.getElementById("editCatDesc").value.trim();

    if (!name) {
      showToast("Category name is required", "error");
      return;
    }

    const categoryData = {
      name: name,
      description: desc || null
    };

    const result = await updateCategory(categoryId, categoryData);
    if (result && result.success) {
      showToast("Category updated successfully", "success");
      closeModal();
      await renderCategories();
      
      const currentUser = await getCurrentUser();
      if (currentUser) {
        await logActivity({ 
          user_id: currentUser.user_id, 
          activity: `Updated category: ${name}` 
        });
      }
    }
  }

  function sortCategories() {
    categoriesSortOrder = categoriesSortOrder === "asc" ? "desc" : "asc";
    
    const sortIcon = document.getElementById("sortIcon");
    const sortBtn = document.getElementById("sortCategoriesBtn");
    
    if (categoriesSortOrder === "asc") {
      sortIcon.className = "fa-solid fa-sort-alpha-down";
      sortBtn.title = "Sort A-Z";
    } else {
      sortIcon.className = "fa-solid fa-sort-alpha-up";
      sortBtn.title = "Sort Z-A";
    }
    
    renderCategories();
  }

  async function saveDocumentTypeAsCategory(documentType) {
    if (!documentType) return null;

    const categories = await getAllCategories();
    const existingCategory = categories.find(cat => cat.name.toLowerCase() === documentType.toLowerCase());

    if (existingCategory) {
      return existingCategory.category_id;
    }

    const isUnclassified = documentType === "Unclassified" || documentType.includes("Unclassified");
    const result = await createCategory({
      name: documentType,
      description: isUnclassified ? "Unknown file types" : "",
      auto_created: true,
      is_unclassified: isUnclassified
    });

    if (result && result.category_id) {
      const currentUser = await getCurrentUser();
      if (currentUser) {
        await logActivity({ user_id: currentUser.user_id, activity: `Auto-created category: ${documentType}` });
      }
      return result.category_id;
    }

    return null;
  }

  // Archives
async function renderArchives() {
    const out = document.getElementById("archivesList");
    out.innerHTML = "";
    
    const files = await getAllFiles();
    const archivedFiles = files.filter(f => f.status === "archived");
    
    if (!archivedFiles.length) {
        out.innerHTML = '<div class="card small-muted" style="text-align:center;padding:40px">No archived files</div>';
        return;
    }
    
    for (const f of archivedFiles) {
        const div = document.createElement("div");
        div.className = "card";
        div.style.marginBottom = "12px";
        div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="display:flex;gap:12px;align-items:center">
                    <div class="doc-icon">${fileIcon(f.name)}</div>
                    <div>
                        <div style="font-weight:600;color:var(--text)">${f.name}</div>
                        <div class="small-muted">
                            Original: ${f.original_name}  
                            ${new Date(f.created_at).toLocaleString()}  
                            ${(f.size / 1024) | 0} KB
                        </div>
                    </div>
                </div>
                <div style="display:flex;gap:8px;">
                    <button onclick="restoreFile(${f.file_id})"><i class="fa-solid fa-rotate-left"></i> Restore</button>
                    <button class="btn-danger" onclick="confirmDeleteFile(${f.file_id})"><i class="fa-solid fa-trash"></i> Delete</button>
                </div>
            </div>
        `;
        out.appendChild(div);
    }
}

async function confirmDeleteFile(fileId) {
    const files = await getAllFiles();
    const file = files.find(f => f.file_id === fileId);
    
    if (!file) return;
    
    openModal(`<h3>Delete File</h3>
        <div style="display:flex;flex-direction:column;gap:16px">
            <div class="danger">
                <i class="fa-solid fa-exclamation-triangle"></i> 
                <strong>Warning:</strong> This action cannot be undone.
            </div>
            <div class="small-muted">
                Are you sure you want to permanently delete <strong>"${file.original_name || file.name}"</strong>?
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end">
                <button class="btn-secondary" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i> Cancel
                </button>
                <button class="btn-danger" onclick="deleteFilePermanently(${fileId})">
                    <i class="fa-solid fa-trash"></i> Delete Permanently
                </button>
            </div>
        </div>`);
}

async function deleteFilePermanently(fileId) {
    const result = await deleteFile(fileId);
    if (result && result.success) {
        showToast("File deleted permanently", "success");
        closeModal();
        await renderArchives();
        
        const currentUser = await getCurrentUser();
        const files = await getAllFiles();
        const file = files.find(f => f.file_id === fileId);
        if (currentUser && file) {
            await logActivity({ 
                user_id: currentUser.user_id, 
                activity: `Permanently deleted ${file.original_name || file.name}` 
            });
        }
    }
}

async function restoreFile(fileId) {
    console.log(`DEBUG: restoreFile called for file ${fileId}`);
    
    try {
        showToast("Restoring file...", "info");
        
        const response = await fetch(`${API_BASE_URL}/files/${fileId}/restore`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();
        console.log(`DEBUG: Restore API response for file ${fileId}:`, result);
        
        if (result.success) {
            showToast("File restored successfully", "success");
            
            // Refresh all views to show updated file lists
            await refreshAllViews();
            
            // Log activity
            const currentUser = await getCurrentUser();
            if (currentUser) {
                await logActivity({ 
                    user_id: currentUser.user_id, 
                    activity: `Restored file ID: ${fileId}` 
                });
            }
        } else {
            showToast(result.error || "Failed to restore file", "error");
        }
    } catch (error) {
        console.error("Restore error:", error);
        showToast("Network error while restoring file", "error");
    }
}

  // Dashboard
  async function renderDashboard() {
    await refreshStats();
    
    const activities = await getActivities();
    const feed = document.getElementById("activityFeed");
    
    if (!activities || activities.length === 0) {
      feed.innerHTML = '<div class="small-muted" style="text-align:center;padding:20px">No activity yet</div>';
      return;
    }
    
    feed.innerHTML = "";
    activities.slice().reverse().slice(0, 8).forEach((a) => {
      const div = document.createElement("div");
      div.className = "activity-item";
      div.innerHTML = `
        <div class="activity-icon">
          <i class="fa-solid fa-circle-info"></i>
        </div>
        <div class="activity-content">
          <div>${a.activity}</div>
          <div class="activity-time">${new Date(a.timestamp).toLocaleString()}</div>
        </div>
      `;
      feed.appendChild(div);
    });
  }

  async function refreshStats() {
    const files = await getAllFiles();
    const users = await getAllUsers();
    
    if (files) {
      document.getElementById("statTotal").textContent = files.filter(f => f.status === "active").length;
      document.getElementById("statShared").textContent = files.filter(f => f.shared && f.status === "active").length;
      const weekAgo = Date.now() - 7 * 24 * 3600 * 1000;
      document.getElementById("statRecent").textContent = files.filter(f => new Date(f.created_at).getTime() > weekAgo && f.status === "active").length;
    }
    
    if (users) {
      document.getElementById("statUsers").textContent = users.length;
    }
  }

  // Settings
  async function renderSettings() {
    const settings = await getSettings();
    if (settings) {
      document.getElementById("settingCompany").value = settings.company || "";
      document.getElementById("settingMax").value = settings.max_file_mb || 50;
      document.getElementById("settingTypes").value = settings.allowed_types || "";
    }
  }

  async function saveSettings() {
    const company = document.getElementById("settingCompany").value;
    const maxFileMB = Number(document.getElementById("settingMax").value);
    const allowedTypes = document.getElementById("settingTypes").value;

    const result = await updateSettings({
      company: company,
      max_file_mb: maxFileMB,
      allowed_types: allowedTypes
    });

    if (result && result.success) {
      showToast("Settings saved", "success");
      
      const currentUser = await getCurrentUser();
      if (currentUser) {
        await logActivity({ user_id: currentUser.user_id, activity: "Updated system settings" });
      }
    }
  }

  // Modal functions
  function openModal(html, className = "") {
    const root = document.getElementById("modalRoot");
    root.innerHTML = `<div class="modal-back" id="modalBG"><div class="modal ${className}">${html}</div></div>`;
    root.style.display = "block";
    document.getElementById("modalBG").addEventListener("click", (ev) => {
      if (ev.target.id === "modalBG") closeModal();
    });
  }

  function closeModal() {
    document.getElementById("modalRoot").innerHTML = "";
    document.getElementById("modalRoot").style.display = "none";
  }

  // Document Classification
  async function classifyUploadedFile(file) {
    try {
      const formData = new FormData();
      formData.append("file", file);

      showToast(`Classifying ${file.name}...`);

      const response = await fetch(`${API_BASE_URL}/classify-document`, {
        method: "POST",
        body: formData,
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();

      if (result.error) {
        console.warn("Classification warning:", result.error);
        return {
          documentType: result.documentType || "Unclassified",
          confidence: result.confidence || "Low",
          error: result.error,
        };
      }

      return {
        documentType: result.documentType,
        confidence: result.confidence,
        textSample: result.textSample,
      };
    } catch (error) {
      console.error("Classification API error:", error);
      return await mockDocumentClassification(file);
    }
  }

  async function mockDocumentClassification(file) {
    const fileName = file.name.toLowerCase();
    let documentType = "Unclassified";
    let confidence = "Low";

    if (fileName.includes("resume") || fileName.includes("cv")) {
      documentType = "Resume / CV";
      confidence = "Medium";
    } else if (fileName.includes("offer") || fileName.includes("employment")) {
      documentType = "Offer Letter / Employment Contract";
      confidence = "Medium";
    } else if (fileName.includes("resignation")) {
      documentType = "Resignation Letter";
      confidence = "Medium";
    } else if (fileName.includes("leave") || fileName.includes("vacation")) {
      documentType = "Leave Request";
      confidence = "Medium";
    }

    return {
      documentType,
      confidence,
      textSample: `Mock classification for ${file.name}`,
    };
  }

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', init);
</script>
  </body>
</html>
